<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Static problems</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">Static problems</a><ul>
<li><a class="reference internal" href="#soap-film">Soap Film</a></li>
<li><a class="reference internal" href="#electrostatics">Electrostatics</a></li>
<li><a class="reference internal" href="#aerodynamics">Aerodynamics</a></li>
<li><a class="reference internal" href="#error-estimation">Error estimation</a></li>
<li><a class="reference internal" href="#periodic-boundary-conditions">Periodic Boundary Conditions</a></li>
<li><a class="reference internal" href="#poisson-problems-with-mixed-boundary-condition">Poisson Problems with mixed boundary condition</a></li>
<li><a class="reference internal" href="#poisson-with-mixed-finite-element">Poisson with mixed finite element</a></li>
<li><a class="reference internal" href="#metric-adaptation-and-residual-error-indicator">Metric Adaptation and residual error indicator</a></li>
<li><a class="reference internal" href="#adaptation-using-residual-error-indicator">Adaptation using residual error indicator</a></li>
</ul>
</li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="math notranslate nohighlight">
\[\def\p{{\partial}}
\def\d{{\text{d}}}\]</div>
<div class="section" id="static-problems">
<h1>Static problems<a class="headerlink" href="#static-problems" title="Permalink to this headline">¶</a></h1>
<div class="section" id="soap-film">
<span id="modelstatissoap"></span><h2>Soap Film<a class="headerlink" href="#soap-film" title="Permalink to this headline">¶</a></h2>
<p>Our starting point here will be the mathematical model to find the shape of <strong>soap film</strong> which is glued to the ring on the <span class="math notranslate nohighlight">\(xy-\)</span>plane:</p>
<div class="math notranslate nohighlight">
\[C=\{(x,y);\;x=\cos t,\,y=\sin t,\,0\leq t\leq 2\pi \}\]</div>
<p>We assume the shape of the film is described by the graph <span class="math notranslate nohighlight">\((x,y,u(x,y))\)</span> of the vertical displacement <span class="math notranslate nohighlight">\(u(x,y)\, (x^2+y^2&lt;1)\)</span> under a vertical pressure <span class="math notranslate nohighlight">\(p\)</span> in terms of force per unit area and an initial tension <span class="math notranslate nohighlight">\(\mu\)</span> in terms of force per unit length.</p>
<p>Consider the “small plane” ABCD, A:<span class="math notranslate nohighlight">\((x,y,u(x,y))\)</span>, B:<span class="math notranslate nohighlight">\((x,y,u(x+\delta x,y))\)</span>, C:<span class="math notranslate nohighlight">\((x,y,u(x+\delta x,y+\delta y))\)</span> and D:<span class="math notranslate nohighlight">\((x,y,u(x,y+\delta y))\)</span>.</p>
<p>Denote by <span class="math notranslate nohighlight">\(\vec{n}(x,y)=(n_x(x,y),n_y(x,y),n_z(x,y))\)</span> the normal vector of the surface <span class="math notranslate nohighlight">\(z=u(x,y)\)</span>.
We see that the vertical force due to the tension <span class="math notranslate nohighlight">\(\mu\)</span> acting along the edge AD is <span class="math notranslate nohighlight">\(-\mu n_x(x,y)\delta y\)</span> and the the vertical force acting along the edge AD is:</p>
<div class="math notranslate nohighlight">
\[\mu n_x(x+\delta x,y)\delta y\simeq \mu\left(n_x(x,y)+\frac{\p n_x}{\p x}\delta x\right)(x,y)\delta y\]</div>
<div class="figure" id="examplestaticproblemssoapfilm">
<img alt="../_images/StaticProblems_SoapFilm.png" src="../_images/StaticProblems_SoapFilm.png" />
</div>
<p>Similarly, for the edges AB and DC we have:</p>
<div class="math notranslate nohighlight">
\[-\mu n_y(x,y)\delta x,\quad\mu\left(n_y(x,y)+\p n_y/\p y\right)(x,y)\delta x\]</div>
<p>The force in the vertical direction on the surface ABCD due to the tension <span class="math notranslate nohighlight">\(\mu\)</span> is given by:</p>
<div class="math notranslate nohighlight">
\[\mu\left(\p n_x/\p x\right)\delta x\delta y+T\left(\p n_y/\p y\right)\delta y\delta x\]</div>
<p>Assuming small displacements, we have:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcccl}
    \nu_x&amp;=&amp;(\p u/\p x)/\sqrt{1+(\p u/\p x)^2+(\p u/\p y)^2}&amp;\simeq&amp; \p u/\p x,\\
    \nu_y&amp;=&amp;(\p u/\p y)/\sqrt{1+(\p u/\p x)^2+(\p u/\p y)^2}&amp;\simeq&amp; \p u/\p y
\end{array}\end{split}\]</div>
<p>Letting <span class="math notranslate nohighlight">\(\delta x\to dx,\, \delta y\to dy\)</span>, we have the equilibrium of the vertical displacement of soap film on ABCD by <span class="math notranslate nohighlight">\(p\)</span>:</p>
<div class="math notranslate nohighlight">
\[\mu dx dy\p^2 u/\p x^2 +\mu dx dy\p^2 u/\p y^2 + p dx dy = 0\]</div>
<p>Using the Laplace operator <span class="math notranslate nohighlight">\(\Delta = \p^2 /\p x^2 + \p^2 /\p y^2\)</span>, we can find the virtual displacement write the following:</p>
<div class="math notranslate nohighlight">
\[-\Delta u = f\quad \mbox{in }\Omega\]</div>
<p>where <span class="math notranslate nohighlight">\(f=p/\mu\)</span>, <span class="math notranslate nohighlight">\(\Omega =\{(x,y);\;x^{2}+y^{2}&lt;1\}\)</span>.</p>
<p><a class="reference internal" href="../tutorial/poisson.html#tutorialpoisson"><span class="std std-ref">Poisson’s equation</span></a> appears also in <strong>electrostatics</strong> taking the form of <span class="math notranslate nohighlight">\(f=\rho / \epsilon\)</span> where <span class="math notranslate nohighlight">\(\rho\)</span> is the charge density, <span class="math notranslate nohighlight">\(\epsilon\)</span> the dielectric constant and <span class="math notranslate nohighlight">\(u\)</span> is named as electrostatic potential.</p>
<p>The soap film is glued to the ring <span class="math notranslate nohighlight">\(\p \Omega =C\)</span>, then we have the boundary condition:</p>
<div class="math notranslate nohighlight">
\[u=0\quad \mbox{on }\p \Omega\]</div>
<p>If the force is gravity, for simplify, we assume that <span class="math notranslate nohighlight">\(f=-1\)</span>.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">nn</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">ue</span> <span class="o">=</span> <span class="p">(</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="kr">y</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="c1">//ue: exact solution</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">a</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">mesh</span> <span class="n">disk</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">nn</span><span class="p">));</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">femp1</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">femp1</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="nf">laplace</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">disk</span><span class="p">)(</span> <span class="c1">//bilinear form</span>
        <span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">disk</span><span class="p">)(</span> <span class="c1">//linear form</span>
        <span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">//boundary condition</span>
    <span class="p">;</span>

<span class="c1">// Solve</span>
<span class="n">laplace</span><span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="c1">// Error</span>
<span class="n">femp1</span> <span class="kp">err</span> <span class="o">=</span> <span class="n">u</span> <span class="o">-</span> <span class="n">ue</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="kp">err</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error L2 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">sqrt</span><span class="p">(</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">disk</span><span class="p">)(</span><span class="kp">err</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span><span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error H10 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">sqrt</span><span class="p">(</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">disk</span><span class="p">)((</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">-</span><span class="kr">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">disk</span><span class="p">)((</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">-</span><span class="kr">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span><span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">/// Re-run with a mesh adaptation ///</span>

<span class="c1">// Mesh adaptation</span>
<span class="n">disk</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">err</span><span class="o">=</span><span class="mf">0.01</span><span class="p">);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="c1">// Solve</span>
<span class="n">laplace</span><span class="p">;</span>
<span class="nf">plot</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="c1">// Error</span>
<span class="kp">err</span> <span class="o">=</span> <span class="n">u</span> <span class="o">-</span> <span class="n">ue</span><span class="p">;</span> <span class="c1">//become FE-function on adapted mesh</span>
<span class="nf">plot</span><span class="p">(</span><span class="kp">err</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error L2 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">sqrt</span><span class="p">(</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">disk</span><span class="p">)(</span><span class="kp">err</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span><span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error H10 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">sqrt</span><span class="p">(</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">disk</span><span class="p">)((</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">-</span><span class="kr">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">disk</span><span class="p">)((</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">-</span><span class="kr">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span><span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</div>
<div class="inline2 figure" id="examplestaticproblemssoapfilmsol">
<img alt="../_images/StaticProblems_SoapFilmSol.png" src="../_images/StaticProblems_SoapFilmSol.png" />
<p class="caption"><span class="caption-number">Fig. 178 </span><span class="caption-text">Isovalue of <span class="math notranslate nohighlight">\(u\)</span></span></p>
</div>
<div class="inline2 figure" id="examplestaticproblemssoapfilm3d">
<img alt="../_images/StaticProblems_SoapFilm3D.png" src="../_images/StaticProblems_SoapFilm3D.png" />
<p class="caption"><span class="caption-number">Fig. 179 </span><span class="caption-text">A side view of <span class="math notranslate nohighlight">\(u\)</span></span></p>
</div>
<p>In the 37th line, the <span class="math notranslate nohighlight">\(L^2\)</span>-error estimation between the exact solution <span class="math notranslate nohighlight">\(u_e\)</span>,</p>
<div class="math notranslate nohighlight">
\[\|u_h - u_e\|_{0,\Omega}=\left(\int_{\Omega}|u_h-u_e|^2\, \d x\d y\right)^{1/2}\]</div>
<p>and in the following line, the <span class="math notranslate nohighlight">\(H^1\)</span>-error seminorm estimation:</p>
<div class="math notranslate nohighlight">
\[|u_h - u_e|_{1,\Omega}=\left(\int_{\Omega}|\nabla u_h-\nabla u_e|^2\, \d x\d y\right)^{1/2}\]</div>
<p>are done on the initial mesh.
The results are <span class="math notranslate nohighlight">\(\|u_h - u_e\|_{0,\Omega}=0.000384045,\, |u_h - u_e|_{1,\Omega}=0.0375506\)</span>.</p>
<p>After the adaptation, we have <span class="math notranslate nohighlight">\(\|u_h - u_e\|_{0,\Omega}=0.000109043,\, |u_h - u_e|_{1,\Omega}=0.0188411\)</span>.
So the numerical solution is improved by adaptation of mesh.</p>
</div>
<div class="section" id="electrostatics">
<h2>Electrostatics<a class="headerlink" href="#electrostatics" title="Permalink to this headline">¶</a></h2>
<p>We assume that there is no current and a time independent charge distribution.
Then the electric field <span class="math notranslate nohighlight">\(\mathbf{E}\)</span> satisfies:</p>
<div class="math notranslate nohighlight" id="equation-eqn-maxwell">
<span class="eqno">(45)<a class="headerlink" href="#equation-eqn-maxwell" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{array}{rcl}
    \mathrm{div}\mathbf{E} &amp;=&amp; \rho/\epsilon\\
    \mathrm{curl}\mathbf{E} &amp;=&amp; 0
\end{array}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\rho\)</span> is the charge density and <span class="math notranslate nohighlight">\(\epsilon\)</span> is called the permittivity of free space.</p>
<p>From the equation <a class="reference internal" href="#equation-eqn-maxwell">(45)</a> We can introduce the electrostatic potential such that <span class="math notranslate nohighlight">\(\mathbf{E}=-\nabla \phi\)</span>.
Then we have Poisson’s equation <span class="math notranslate nohighlight">\(-\Delta \phi=f\)</span>, <span class="math notranslate nohighlight">\(f=-\rho/\epsilon\)</span>.</p>
<p>We now obtain the equipotential line which is the level curve of <span class="math notranslate nohighlight">\(\phi\)</span>, when there are no charges except conductors <span class="math notranslate nohighlight">\(\{C_i\}_{1,\cdots,K}\)</span>.
Let us assume <span class="math notranslate nohighlight">\(K\)</span> conductors <span class="math notranslate nohighlight">\(C_1,\cdots,C_K\)</span> within an enclosure <span class="math notranslate nohighlight">\(C_0\)</span>.</p>
<p>Each one is held at an electrostatic potential <span class="math notranslate nohighlight">\(\varphi_i\)</span>.
We assume that the enclosure <span class="math notranslate nohighlight">\(C0\)</span> is held at potential 0.
In order to know <span class="math notranslate nohighlight">\(\varphi(x)\)</span> at any point <span class="math notranslate nohighlight">\(x\)</span> of the domain <span class="math notranslate nohighlight">\(\Omega\)</span>, we must solve:</p>
<div class="math notranslate nohighlight">
\[-\Delta \varphi =0\quad \textrm{ in }\Omega\]</div>
<p>where <span class="math notranslate nohighlight">\(\Omega\)</span> is the interior of <span class="math notranslate nohighlight">\(C_0\)</span> minus the conductors <span class="math notranslate nohighlight">\(C_i\)</span>, and <span class="math notranslate nohighlight">\(\Gamma\)</span> is the boundary of <span class="math notranslate nohighlight">\(\Omega\)</span>, that is <span class="math notranslate nohighlight">\(\sum_{i=0}^N C_i\)</span>.</p>
<p>Here <span class="math notranslate nohighlight">\(g\)</span> is any function of <span class="math notranslate nohighlight">\(x\)</span> equal to <span class="math notranslate nohighlight">\(\varphi_i\)</span> on <span class="math notranslate nohighlight">\(C_i\)</span> and to 0 on <span class="math notranslate nohighlight">\(C_0\)</span>.
The boundary equation is a reduced form for:</p>
<div class="math notranslate nohighlight">
\[\varphi =\varphi_{i}\;\text{on }C_{i},\;i=1...N,\varphi =0\;\text{on }C_{0}.\]</div>
<p>First we give the geometrical informations; <span class="math notranslate nohighlight">\(C_0=\{(x,y);\; x^2+y^2=5^2\}\)</span>, <span class="math notranslate nohighlight">\(C_1=\{(x,y):\;\frac{1}{0.3^2}(x-2)^2+\frac{1}{3^2}y^2=1\}\)</span>, <span class="math notranslate nohighlight">\(C_2=\{(x,y):\; \frac{1}{0.3^2}(x+2)^2+\frac{1}{3^2}y^2=1\}\)</span>.</p>
<p>Let <span class="math notranslate nohighlight">\(\Omega\)</span> be the disk enclosed by <span class="math notranslate nohighlight">\(C_0\)</span> with the elliptical holes enclosed by <span class="math notranslate nohighlight">\(C_1\)</span> and <span class="math notranslate nohighlight">\(C_2\)</span>.
Note that <span class="math notranslate nohighlight">\(C_0\)</span> is described counterclockwise, whereas the elliptical holes are described clockwise, because the boundary must be oriented so that the computational domain is to its left.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">C0</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);}</span>
<span class="kt">border</span> <span class="nf">C1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.3</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);}</span>
<span class="kt">border</span> <span class="nf">C2</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.3</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);}</span>

<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">C0</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="n">C1</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="n">C2</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">));</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="nf">Electro</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span> <span class="c1">//bilinear</span>
        <span class="nf">dx</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">C0</span><span class="p">,</span> <span class="n">uh</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">//boundary condition on C_0</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">C1</span><span class="p">,</span> <span class="n">uh</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">//+1 volt on C_1</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">C2</span><span class="p">,</span> <span class="n">uh</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">//-1 volt on C_2</span>
    <span class="p">;</span>

<span class="c1">// Solve</span>
<span class="n">Electro</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uh</span><span class="p">);</span>
</pre></div>
</div>
<div class="inline2 figure" id="examplestaticproblemselectrostaticsmesh">
<img alt="../_images/StaticProblems_ElectrostaticsMesh.png" src="../_images/StaticProblems_ElectrostaticsMesh.png" />
<p class="caption"><span class="caption-number">Fig. 180 </span><span class="caption-text">Disk with two elliptical holes</span></p>
</div>
<div class="inline2 figure" id="examplestaticproblemselectrostatics">
<img alt="../_images/StaticProblems_Electrostatics.png" src="../_images/StaticProblems_Electrostatics.png" />
<p class="caption"><span class="caption-number">Fig. 181 </span><span class="caption-text">Equipotential lines where <span class="math notranslate nohighlight">\(C_1\)</span> is located in right hand side</span></p>
</div>
</div>
<div class="section" id="aerodynamics">
<h2>Aerodynamics<a class="headerlink" href="#aerodynamics" title="Permalink to this headline">¶</a></h2>
<p>Let us consider a wing profile <span class="math notranslate nohighlight">\(S\)</span> in a uniform flow.
Infinity will be represented by a large circle <span class="math notranslate nohighlight">\(\Gamma_{\infty}\)</span>.
As previously, we must solve:</p>
<div class="math notranslate nohighlight" id="equation-eqn-naca-5-5">
<span class="eqno">(46)<a class="headerlink" href="#equation-eqn-naca-5-5" title="Permalink to this equation">¶</a></span>\[\Delta \varphi=0\quad\textrm{in }\Omega,
\quad \varphi|_S=c,\quad
\varphi|_{\Gamma_{\infty}}=u_{\infty 1x}-u_{\infty2x}\]</div>
<p>where <span class="math notranslate nohighlight">\(\Omega\)</span> is the area occupied by the fluid, <span class="math notranslate nohighlight">\(u_{\infty}\)</span> is the air speed at infinity, <span class="math notranslate nohighlight">\(c\)</span> is a constant to be determined so that <span class="math notranslate nohighlight">\(\p_n\varphi\)</span> is continuous at the trailing edge <span class="math notranslate nohighlight">\(P\)</span> of <span class="math notranslate nohighlight">\(S\)</span> (so-called Kutta-Joukowski condition).
Lift is proportional to <span class="math notranslate nohighlight">\(c\)</span>.</p>
<p>To find <span class="math notranslate nohighlight">\(c\)</span> we use a superposition method.
As all equations in <a class="reference internal" href="#equation-eqn-naca-5-5">(46)</a> are linear, the solution <span class="math notranslate nohighlight">\(\varphi_c\)</span> is a linear function of <span class="math notranslate nohighlight">\(c\)</span></p>
<div class="math notranslate nohighlight">
\[\varphi_c = \varphi_0 + c\varphi_1\]</div>
<p>where <span class="math notranslate nohighlight">\(\varphi_0\)</span> is a solution of <a class="reference internal" href="#equation-eqn-naca-5-5">(46)</a> with <span class="math notranslate nohighlight">\(c = 0\)</span> and <span class="math notranslate nohighlight">\(\varphi_1\)</span> is a solution with <span class="math notranslate nohighlight">\(c = 1\)</span> and zero speed at infinity.</p>
<p>With these two fields computed, we shall determine <span class="math notranslate nohighlight">\(c\)</span> by requiring the continuity of <span class="math notranslate nohighlight">\(\p \varphi /\p n\)</span> at the trailing edge.
An equation for the upper surface of a NACA0012 (this is a classical wing profile in aerodynamics; the rear of the wing is called the trailing edge) is:</p>
<div class="math notranslate nohighlight">
\[y = 0.17735\sqrt{x} - 0.075597x - 0.212836x^2 + 0.17363x^3 - 0.06254x^4\]</div>
<p>Taking an incidence angle <span class="math notranslate nohighlight">\(\alpha\)</span> such that <span class="math notranslate nohighlight">\(\tan \alpha = 0.1\)</span>, we must solve:</p>
<div class="math notranslate nohighlight">
\[-\Delta\varphi = 0\qquad \textrm{in }\Omega, \quad \varphi|_{\Gamma_1} = y - 0.1x,\quad \varphi |_{\Gamma_2} = c\]</div>
<p>where <span class="math notranslate nohighlight">\(\Gamma_2\)</span> is the wing profile and <span class="math notranslate nohighlight">\(\Gamma_1\)</span> is an approximation of infinity.
One finds <span class="math notranslate nohighlight">\(c\)</span> by solving:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{ccccccc}
    -\Delta\varphi_0 &amp;= 0 &amp;\textrm{in }\Omega&amp;,\qquad \varphi_0|_{\Gamma_1} &amp;= y - 0.1x&amp;, \quad \varphi_0|_{\Gamma_2} &amp;= 0,\\
    -\Delta\varphi_1 &amp;= 0 &amp;\textrm{in }\Omega&amp;, \qquad \varphi_1|_{\Gamma_1} &amp;= 0&amp;, \quad \varphi_1|_{\Gamma_2} &amp;= 1
\end{array}\end{split}\]</div>
<p>The solution <span class="math notranslate nohighlight">\(\varphi = \varphi_0+c\varphi_1\)</span> allows us to find <span class="math notranslate nohighlight">\(c\)</span> by writing that <span class="math notranslate nohighlight">\(\p_n\varphi\)</span> has no jump at the trailing edge <span class="math notranslate nohighlight">\(P = (1, 0)\)</span>.</p>
<p>We have <span class="math notranslate nohighlight">\(\p n\varphi -(\varphi (P^+)-\varphi (P))/\delta\)</span> where <span class="math notranslate nohighlight">\(P^+\)</span> is the point just above <span class="math notranslate nohighlight">\(P\)</span> in the direction normal to the profile at a distance <span class="math notranslate nohighlight">\(\delta\)</span>.
Thus the jump of <span class="math notranslate nohighlight">\(\p_n\varphi\)</span> is <span class="math notranslate nohighlight">\((\varphi_0|_{P^+} +c(\varphi_1|_{P^+} -1))+(\varphi_0|_{P^-} +c(\varphi_1|_{P^-} -1))\)</span> divided by <span class="math notranslate nohighlight">\(\delta\)</span> because the normal changes sign between the lower and upper surfaces. Thus</p>
<div class="math notranslate nohighlight">
\[c = -\frac{\varphi_0|_{P^+} + \varphi_0|_{P^-}}
{(\varphi_1|_{P^+} + \varphi_1|_{P^-} - 2)} ,\]</div>
<p>which can be programmed as:</p>
<div class="math notranslate nohighlight">
\[c = -\frac{\varphi_0(0.99, 0.01) + \varphi_0(0.99,-0.01)}
{(\varphi_1(0.99, 0.01) + \varphi_1(0.99,-0.01) - 2)} .\]</div>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">a</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);}</span>
<span class="kt">border</span> <span class="nf">upper</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span>
    <span class="kr">y</span><span class="o">=</span><span class="mf">0.17735</span><span class="o">*</span><span class="nf">sqrt</span><span class="p">(</span><span class="kp">t</span><span class="p">)</span><span class="o">-</span><span class="mf">0.075597</span><span class="o">*</span><span class="kp">t</span> <span class="o">-</span> <span class="mf">0.212836</span><span class="o">*</span><span class="p">(</span><span class="kp">t</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.17363</span><span class="o">*</span><span class="p">(</span><span class="kp">t</span><span class="o">^</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.06254</span><span class="o">*</span><span class="p">(</span><span class="kp">t</span><span class="o">^</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">border</span> <span class="nf">lower</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span>
    <span class="kr">y</span><span class="o">=-</span><span class="p">(</span><span class="mf">0.17735</span><span class="o">*</span><span class="nf">sqrt</span><span class="p">(</span><span class="kp">t</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.075597</span><span class="o">*</span><span class="kp">t</span> <span class="o">-</span> <span class="mf">0.212836</span><span class="o">*</span><span class="p">(</span><span class="kp">t</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.17363</span><span class="o">*</span><span class="p">(</span><span class="kp">t</span><span class="o">^</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.06254</span><span class="o">*</span><span class="p">(</span><span class="kp">t</span><span class="o">^</span><span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>
<span class="kt">border</span> <span class="nf">c</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">0.8</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mf">0.8</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);}</span>

<span class="kt">mesh</span> <span class="n">Zoom</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">+</span> <span class="n">upper</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span> <span class="o">+</span> <span class="n">lower</span><span class="p">(</span><span class="mi">35</span><span class="p">));</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">+</span> <span class="n">upper</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span> <span class="o">+</span> <span class="n">lower</span><span class="p">(</span><span class="mi">35</span><span class="p">));</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">psi0</span><span class="p">,</span> <span class="n">psi1</span><span class="p">,</span> <span class="n">vh</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">ZVh</span><span class="p">(</span><span class="n">Zoom</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span>

<span class="c1">// Problem</span>
<span class="kt">solve</span> <span class="nf">Joukowski0</span><span class="p">(</span><span class="n">psi0</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="nf">dx</span><span class="p">(</span><span class="n">psi0</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">psi0</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">psi0</span><span class="o">=</span><span class="kr">y</span><span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="kr">x</span><span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">psi0</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">psi0</span><span class="p">);</span>

<span class="kt">solve</span> <span class="nf">Joukowski1</span><span class="p">(</span><span class="n">psi1</span><span class="p">,</span><span class="n">vh</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="nf">dx</span><span class="p">(</span><span class="n">psi1</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">psi1</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">psi1</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">psi1</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">psi1</span><span class="p">);</span>

<span class="c1">//continuity of pressure at trailing edge</span>
<span class="kt">real</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">psi0</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">+</span> <span class="n">psi0</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span><span class="o">-</span><span class="mf">0.01</span><span class="p">);</span>
<span class="n">beta</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="n">psi1</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">+</span> <span class="n">psi1</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span><span class="o">-</span><span class="mf">0.01</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>

<span class="n">Vh</span> <span class="n">psi</span> <span class="o">=</span> <span class="n">beta</span><span class="o">*</span><span class="n">psi1</span> <span class="o">+</span> <span class="n">psi0</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">psi</span><span class="p">);</span>

<span class="n">ZVh</span> <span class="n">Zpsi</span> <span class="o">=</span> <span class="n">psi</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Zpsi</span><span class="p">,</span> <span class="kp">bw</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="n">ZVh</span> <span class="n">cp</span> <span class="o">=</span> <span class="o">-</span><span class="nf">dx</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="nf">dy</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>

<span class="n">ZVh</span> <span class="n">Zcp</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Zcp</span><span class="p">,</span> <span class="kp">nbiso</span><span class="o">=</span><span class="mi">40</span><span class="p">);</span>
</pre></div>
</div>
<div class="inline2 figure" id="examplestaticproblemsaerodynamics1">
<img alt="../_images/StaticProblems_Aerodynamics1.png" src="../_images/StaticProblems_Aerodynamics1.png" />
<p class="caption"><span class="caption-number">Fig. 182 </span><span class="caption-text">Isovalue of <span class="math notranslate nohighlight">\(cp = -(\p_x\psi)^2 - (\p_y\psi)^2\)</span></span></p>
</div>
<div class="inline2 figure" id="examplestaticproblemsaerodynamics2">
<img alt="../_images/StaticProblems_Aerodynamics2.png" src="../_images/StaticProblems_Aerodynamics2.png" />
<p class="caption"><span class="caption-number">Fig. 183 </span><span class="caption-text">Zooming of <span class="math notranslate nohighlight">\(cp\)</span></span></p>
</div>
</div>
<div class="section" id="error-estimation">
<h2>Error estimation<a class="headerlink" href="#error-estimation" title="Permalink to this headline">¶</a></h2>
<p>There are famous estimation between the numerical result <span class="math notranslate nohighlight">\(u_h\)</span> and the exact solution <span class="math notranslate nohighlight">\(u\)</span> of the <a class="reference internal" href="../tutorial/poisson.html#tutorialpoisson"><span class="std std-ref">Poisson’s problem</span></a>:</p>
<p>If triangulations <span class="math notranslate nohighlight">\(\{\mathcal{T}_h\}_{h\downarrow 0}\)</span> is regular (see <a class="reference internal" href="../documentation/meshGeneration.html#meshregulartriangulation"><span class="std std-ref">Regular Triangulation</span></a>), then we have the estimates:</p>
<div class="math notranslate nohighlight" id="equation-eqn-errorestimatation">
<span class="eqno">(47)<a class="headerlink" href="#equation-eqn-errorestimatation" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{array}{rcl}
    |\nabla u - \nabla u_h|_{0,\Omega} &amp;\le&amp; C_1h \\
    \|u - u_h\|_{0,\Omega} &amp;\le&amp; C_2h^2
\end{array}\end{split}\]</div>
<p>with constants <span class="math notranslate nohighlight">\(C_1,\, C_2\)</span> independent of <span class="math notranslate nohighlight">\(h\)</span>, if <span class="math notranslate nohighlight">\(u\)</span> is in <span class="math notranslate nohighlight">\(H^2(\Omega)\)</span>.
It is known that <span class="math notranslate nohighlight">\(u\in H^2(\Omega)\)</span> if <span class="math notranslate nohighlight">\(\Omega\)</span> is convex.</p>
<p>In this section we check <a class="reference internal" href="#equation-eqn-errorestimatation">(47)</a>.
We will pick up numericall error if we use the numerical derivative, so we will use the following for <a class="reference internal" href="#equation-eqn-errorestimatation">(47)</a>.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    \int_{\Omega}|\nabla u - \nabla u_h|^2\, \d x\d y &amp;=&amp;\int_{\Omega}\nabla u\cdot \nabla(u - 2u_h)\, \d x\d y+ \int_{\Omega}\nabla u_h\cdot \nabla u_h\, \d x\d y\\
    &amp;=&amp;\int_{\Omega}f(u-2u_h)\, \d x\d y+\int_{\Omega}fu_h\, \d x\d y
\end{array}\end{split}\]</div>
<p>The constants <span class="math notranslate nohighlight">\(C_1,\, C_2\)</span> are depend on <span class="math notranslate nohighlight">\(\mathcal{T}_h\)</span> and <span class="math notranslate nohighlight">\(f\)</span>, so we will find them by <strong>FreeFem++</strong>.</p>
<p>In general, we cannot get the solution <span class="math notranslate nohighlight">\(u\)</span> as a elementary functions even if spetical functions are added.
Instead of the exact solution, here we use the approximate solution <span class="math notranslate nohighlight">\(u_0\)</span> in <span class="math notranslate nohighlight">\(V_h(\mathcal{T}_h,P_2),\, h\sim 0\)</span>.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="kr">x</span><span class="o">*</span><span class="kr">y</span><span class="p">;</span>

<span class="c1">//Mesh</span>
<span class="kt">mesh</span> <span class="n">Th0</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">V0h</span><span class="p">(</span><span class="n">Th0</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span>
<span class="n">V0h</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">solve</span> <span class="nf">Poisson0</span> <span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th0</span><span class="p">)(</span>
        <span class="nf">dx</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th0</span><span class="p">)(</span>
        <span class="n">f</span><span class="o">*</span><span class="n">v0</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u0</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">u0</span><span class="p">);</span>

<span class="c1">// Error loop</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">errL2</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">errH1</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="c1">// Mesh</span>
    <span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">);</span>

    <span class="c1">// Fespace</span>
    <span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
    <span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
    <span class="kt">fespace</span> <span class="nf">Ph</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>
    <span class="n">Ph</span> <span class="n">h</span> <span class="o">=</span> <span class="kr">hTriangle</span><span class="p">;</span> <span class="c1">//get the size of all triangles</span>

    <span class="c1">// Problem</span>
    <span class="kt">solve</span> <span class="nf">Poisson</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
            <span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
            <span class="n">f</span><span class="o">*</span><span class="n">v</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="c1">// Error</span>
    <span class="n">V0h</span> <span class="n">uu</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span> <span class="c1">//interpolate solution on first mesh</span>
    <span class="n">errL2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th0</span><span class="p">)((</span><span class="n">uu</span> <span class="o">-</span> <span class="n">u0</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="n">h</span><span class="p">[].</span><span class="kr">max</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>
    <span class="n">errH1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th0</span><span class="p">)(</span><span class="n">f</span><span class="o">*</span><span class="p">(</span><span class="n">u0</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">uu</span> <span class="o">+</span> <span class="n">uu</span><span class="p">))</span> <span class="p">)</span><span class="o">/</span><span class="n">h</span><span class="p">[].</span><span class="kr">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Display</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;C1 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">errL2</span><span class="p">.</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;(&quot;</span><span class="o">&lt;&lt;</span><span class="n">errL2</span><span class="p">.</span><span class="kr">min</span><span class="o">&lt;&lt;</span><span class="s">&quot;)&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;C2 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">errH1</span><span class="p">.</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;(&quot;</span><span class="o">&lt;&lt;</span><span class="n">errH1</span><span class="p">.</span><span class="kr">min</span><span class="o">&lt;&lt;</span><span class="s">&quot;)&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>We can guess that <span class="math notranslate nohighlight">\(C_1=0.0179253(0.0173266)\)</span> and <span class="math notranslate nohighlight">\(C_2=0.0729566(0.0707543)\)</span>, where the numbers inside the parentheses are minimum in calculation.</p>
</div>
<div class="section" id="periodic-boundary-conditions">
<h2>Periodic Boundary Conditions<a class="headerlink" href="#periodic-boundary-conditions" title="Permalink to this headline">¶</a></h2>
<p>We now solve the Poisson equation:</p>
<div class="math notranslate nohighlight">
\[-\Delta u = sin(x+\pi/4.)*cos(y+\pi/4.)\]</div>
<p>on the square <span class="math notranslate nohighlight">\(]0,2\pi[^2\)</span> under bi-periodic boundary condition <span class="math notranslate nohighlight">\(u(0,y)=u(2\pi,y)\)</span> for all <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(u(x,0)=u(x,2\pi)\)</span> for all <span class="math notranslate nohighlight">\(x\)</span>.</p>
<p>These boundary conditions are achieved from the definition of the periodic finite element space.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="o">+</span><span class="kr">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="o">+</span><span class="kr">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">);</span> <span class="c1">//right hand side</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="kr">x</span><span class="o">*</span><span class="kr">pi</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">y</span><span class="o">*</span><span class="kr">pi</span><span class="p">]);</span>

<span class="c1">// Fespace</span>
<span class="c1">//defined the fespace with periodic condition</span>
<span class="c1">//label: 2 and 4 are left and right side with y the curve abscissa</span>
<span class="c1">//       1 and 2 are bottom and upper side with x the curve abscissa</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kr">x</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="kr">x</span><span class="p">]]);</span>
<span class="n">Vh</span> <span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="nf">laplace</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="nf">dx</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">f</span><span class="o">*</span><span class="n">vh</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Solve</span>
<span class="n">laplace</span><span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
</pre></div>
</div>
<div class="figure" id="examplestaticproblemsperiodicboundaryconditions">
<img alt="../_images/StaticProblems_PeriodicBoundaryConditions.png" src="../_images/StaticProblems_PeriodicBoundaryConditions.png" />
<p class="caption"><span class="caption-number">Fig. 184 </span><span class="caption-text">The isovalue of solution <span class="math notranslate nohighlight">\(u\)</span> with periodic boundary condition</span></p>
</div>
<p>The periodic condition does not necessarily require parallel boundaries.
The following example give such example.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Periodic boundary conditions - non-parallel boundaries</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">r2</span> <span class="o">=</span> <span class="mf">1.732</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="kr">y</span><span class="o">+</span><span class="kr">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kr">y</span><span class="o">+</span><span class="kr">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kr">y</span><span class="o">-</span><span class="kr">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kr">y</span><span class="o">-</span><span class="kr">x</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">a</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="kp">t</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">b</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">c</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">3</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">d</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="mi">1</span><span class="o">+</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">4</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">e</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=-</span><span class="n">r</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="mi">0</span><span class="p">;};</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="nf">d</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">e</span><span class="p">(</span><span class="kr">n</span><span class="p">));</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="c1">//warning for periodic condition:</span>
<span class="c1">//side a and c</span>
<span class="c1">//on side a (label 1) $ x \in [0,1] $ or $ x-y\in [-1,1] $</span>
<span class="c1">//on side c (label 3) $ x \in [-1,0]$ or $ x-y\in[-1,1] $</span>
<span class="c1">//so the common abscissa can be respectively $x$ and $x+1$</span>
<span class="c1">//or you can can try curviline abscissa $x-y$ and $x-y$</span>
<span class="c1">//1 first way</span>
<span class="c1">//fespace Vh(Th, P2, periodic=[[2, 1+x], [4, x], [1, x], [3, 1+x]]);</span>
<span class="c1">//2 second way</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="kr">x</span><span class="o">+</span><span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kr">x</span><span class="o">+</span><span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kr">x</span><span class="o">-</span><span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="kr">x</span><span class="o">-</span><span class="kr">y</span><span class="p">]]);</span>
<span class="n">Vh</span> <span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">real</span> <span class="n">intf</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f</span><span class="p">);</span>
<span class="kt">real</span> <span class="n">mTh</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="mi">1</span><span class="p">);</span>
<span class="kt">real</span> <span class="n">k</span> <span class="o">=</span>  <span class="n">intf</span> <span class="o">/</span> <span class="n">mTh</span><span class="p">;</span>
<span class="kt">problem</span> <span class="nf">laplace</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="nf">dx</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">vh</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Solve</span>
<span class="n">laplace</span><span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
</pre></div>
</div>
<div class="last figure" id="examplestaticproblemsperiodicboundaryconditions2">
<img alt="../_images/StaticProblems_PeriodicBoundaryConditions2.png" src="../_images/StaticProblems_PeriodicBoundaryConditions2.png" />
<p class="caption"><span class="caption-number">Fig. 185 </span><span class="caption-text">The isovalue of solution <span class="math notranslate nohighlight">\(u\)</span> for <span class="math notranslate nohighlight">\(\Delta u = ((y+x)^{2}+1)((y-x)^{2}+1) - k\)</span>, in <span class="math notranslate nohighlight">\(\Omega\)</span> and <span class="math notranslate nohighlight">\(\p_{n} u =0\)</span> on hole, and with two periodic boundary condition on external border</span></p>
</div>
</div>
<p>An other example with no equal border, just to see if the code works.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Periodic boundary conditions - non-equal border</p>
<div class="last highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Macro</span>
<span class="c1">//irregular boundary condition to build border AB</span>
<span class="kt">macro</span> <span class="nf">LINEBORDER</span><span class="p">(</span><span class="kp">A</span><span class="p">,</span> <span class="kp">B</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span>
    <span class="kt">border</span> <span class="kp">A</span><span class="o">#</span><span class="kp">B</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">){</span> <span class="kt">real</span> <span class="n">t1</span><span class="o">=</span><span class="mf">1.</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span>
    <span class="kr">x</span><span class="o">=</span><span class="kp">A</span><span class="o">#</span><span class="kr">x</span><span class="o">*</span><span class="n">t1</span><span class="o">+</span><span class="kp">B</span><span class="o">#</span><span class="kr">x</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span>
    <span class="kr">y</span><span class="o">=</span><span class="kp">A</span><span class="o">#</span><span class="kr">y</span><span class="o">*</span><span class="n">t1</span><span class="o">+</span><span class="kp">B</span><span class="o">#</span><span class="kr">y</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span>
    <span class="kr">label</span><span class="o">=</span><span class="n">lab</span><span class="p">;</span> <span class="p">}</span> <span class="c1">//EOM</span>
<span class="c1">// compute \||AB|\| A=(ax,ay) et B =(bx,by)</span>
<span class="kt">macro</span> <span class="nf">dist</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">)</span>
    <span class="nf">sqrt</span><span class="p">(</span><span class="nf">square</span><span class="p">((</span><span class="n">ax</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">bx</span><span class="p">))</span> <span class="o">+</span> <span class="nf">square</span><span class="p">((</span><span class="n">ay</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">by</span><span class="p">)))</span> <span class="c1">//EOM</span>
<span class="kt">macro</span> <span class="n">Grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="c1">//EOM</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">Ax</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">Ay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">Bx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">By</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">Cx</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">Cy</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">Dx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Dy</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">gx</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ax</span><span class="o">+</span><span class="n">Bx</span><span class="o">+</span><span class="n">Cx</span><span class="o">+</span><span class="n">Dx</span><span class="p">)</span><span class="o">/</span><span class="mf">4.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">gy</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ay</span><span class="o">+</span><span class="n">By</span><span class="o">+</span><span class="n">Cy</span><span class="o">+</span><span class="n">Dy</span><span class="p">)</span><span class="o">/</span><span class="mf">4.</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="n">LINEBORDER</span><span class="p">(</span><span class="kp">A</span><span class="p">,</span><span class="kp">B</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">LINEBORDER</span><span class="p">(</span><span class="kp">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">LINEBORDER</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">LINEBORDER</span><span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="kp">A</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="kt">mesh</span> <span class="n">Th</span><span class="o">=</span><span class="nf">buildmesh</span><span class="p">(</span><span class="n">AB</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span><span class="o">+</span><span class="n">BC</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span><span class="o">+</span><span class="n">CD</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span><span class="o">+</span><span class="n">DA</span><span class="p">(</span><span class="kr">n</span><span class="p">),</span><span class="kp">fixedborder</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">real</span> <span class="kr">l1</span> <span class="o">=</span> <span class="nf">dist</span><span class="p">(</span><span class="n">Ax</span><span class="p">,</span><span class="n">Ay</span><span class="p">,</span><span class="n">Bx</span><span class="p">,</span><span class="n">By</span><span class="p">);</span>
<span class="kt">real</span> <span class="kr">l2</span> <span class="o">=</span> <span class="nf">dist</span><span class="p">(</span><span class="n">Bx</span><span class="p">,</span><span class="n">By</span><span class="p">,</span><span class="n">Cx</span><span class="p">,</span><span class="n">Cy</span><span class="p">);</span>
<span class="kt">real</span> <span class="n">l3</span> <span class="o">=</span> <span class="nf">dist</span><span class="p">(</span><span class="n">Cx</span><span class="p">,</span><span class="n">Cy</span><span class="p">,</span><span class="n">Dx</span><span class="p">,</span><span class="n">Dy</span><span class="p">);</span>
<span class="kt">real</span> <span class="n">l4</span> <span class="o">=</span> <span class="nf">dist</span><span class="p">(</span><span class="n">Dx</span><span class="p">,</span><span class="n">Dy</span><span class="p">,</span><span class="n">Ax</span><span class="p">,</span><span class="n">Ay</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">s1</span> <span class="o">=</span> <span class="nf">dist</span><span class="p">(</span><span class="n">Ax</span><span class="p">,</span><span class="n">Ay</span><span class="p">,</span><span class="kr">x</span><span class="p">,</span><span class="kr">y</span><span class="p">)</span><span class="o">/</span><span class="kr">l1</span><span class="p">;</span> <span class="c1">//absisse on AB = ||AX||/||AB||</span>
<span class="kt">func</span> <span class="n">s2</span> <span class="o">=</span> <span class="nf">dist</span><span class="p">(</span><span class="n">Bx</span><span class="p">,</span><span class="n">By</span><span class="p">,</span><span class="kr">x</span><span class="p">,</span><span class="kr">y</span><span class="p">)</span><span class="o">/</span><span class="kr">l2</span><span class="p">;</span> <span class="c1">//absisse on BC = ||BX||/||BC||</span>
<span class="kt">func</span> <span class="n">s3</span> <span class="o">=</span> <span class="nf">dist</span><span class="p">(</span><span class="n">Cx</span><span class="p">,</span><span class="n">Cy</span><span class="p">,</span><span class="kr">x</span><span class="p">,</span><span class="kr">y</span><span class="p">)</span><span class="o">/</span><span class="n">l3</span><span class="p">;</span> <span class="c1">//absisse on CD = ||CX||/||CD||</span>
<span class="kt">func</span> <span class="n">s4</span> <span class="o">=</span> <span class="nf">dist</span><span class="p">(</span><span class="n">Dx</span><span class="p">,</span><span class="n">Dy</span><span class="p">,</span><span class="kr">x</span><span class="p">,</span><span class="kr">y</span><span class="p">)</span><span class="o">/</span><span class="n">l4</span><span class="p">;</span> <span class="c1">//absisse on DA = ||DX||/||DA||</span>
<span class="kr">verbosity</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="c1">//to see the abscisse value of the periodic condition</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="n">s1</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">s3</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">s2</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="n">s4</span><span class="p">]]);</span>
<span class="kr">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//reset verbosity</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

<span class="kt">real</span> <span class="n">cc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">cc</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)((</span><span class="kr">x</span><span class="o">-</span><span class="n">gx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kr">y</span><span class="o">-</span><span class="n">gy</span><span class="p">)</span><span class="o">-</span><span class="n">cc</span><span class="p">)</span><span class="o">/</span><span class="n">Th</span><span class="p">.</span><span class="kr">area</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;compatibility = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)((</span><span class="kr">x</span><span class="o">-</span><span class="n">gx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kr">y</span><span class="o">-</span><span class="n">gy</span><span class="p">)</span><span class="o">-</span><span class="n">cc</span><span class="p">)</span> <span class="o">&lt;&lt;</span><span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">solve</span> <span class="nf">Poisson</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">Grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">&#39;*</span><span class="n">Grad</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="mf">1e-10</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">-</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="mi">10</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="p">((</span><span class="kr">x</span><span class="o">-</span><span class="n">gx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kr">y</span><span class="o">-</span><span class="n">gy</span><span class="p">)</span><span class="o">-</span><span class="n">cc</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Periodic boundry conditions - Poisson cube-balloon</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;msh3&quot;</span> <span class="cp">load</span> <span class="s">&quot;tetgen&quot;</span> <span class="cp">load</span> <span class="s">&quot;</span><span class="nf">medit</span><span class="s">&quot;</span>

<span class="c1">// Parameters</span>
<span class="kt">real</span> <span class="n">hs</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="c1">//mesh size on sphere</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="kr">N</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">];</span>
<span class="kt">real</span> <span class="p">[</span><span class="kt">int</span><span class="p">,</span><span class="kt">int</span><span class="p">]</span> <span class="kp">B</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]];</span>
<span class="kt">int</span> <span class="p">[</span><span class="kt">int</span><span class="p">,</span><span class="kt">int</span><span class="p">]</span> <span class="n">L</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]];</span>

<span class="kt">real</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="nf">y0</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="mo">06</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">+</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">+</span><span class="nf">y0</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">z</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">+</span><span class="n">z0</span><span class="p">);</span>

<span class="c1">// Mesh</span>
<span class="kt">bool</span> <span class="n">buildTh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">mesh3</span> <span class="n">Th</span><span class="p">;</span>
<span class="k">try</span> <span class="p">{</span> <span class="c1">//a way to build one time the mesh or read it if the file exist</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">readmesh3</span><span class="p">(</span><span class="s">&quot;Th-hex-sph.mesh&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">catch</span> <span class="p">(...){</span>
    <span class="n">buildTh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">buildTh</span><span class="p">){</span>
    <span class="cp">include</span> <span class="s">&quot;MeshSurface.idp&quot;</span>

    <span class="c1">// Surface Mesh</span>
    <span class="kt">mesh3</span> <span class="n">ThH</span> <span class="o">=</span> <span class="n">SurfaceHex</span><span class="p">(</span><span class="kr">N</span><span class="p">,</span> <span class="kp">B</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kt">mesh3</span> <span class="n">ThS</span> <span class="o">=</span> <span class="n">Sphere</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">hs</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="kt">mesh3</span> <span class="n">ThHS</span> <span class="o">=</span> <span class="n">ThH</span> <span class="o">+</span> <span class="n">ThS</span><span class="p">;</span>

    <span class="kt">real</span> <span class="n">voltet</span> <span class="o">=</span> <span class="p">(</span><span class="n">hs</span><span class="o">^</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mf">6.</span><span class="p">;</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">domain</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">voltet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">voltet</span><span class="p">];</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">tetg</span><span class="p">(</span><span class="n">ThHS</span><span class="p">,</span> <span class="kp">switch</span><span class="o">=</span><span class="s">&quot;pqaAAYYQ&quot;</span><span class="p">,</span> <span class="kp">nbofregions</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="kp">regionlist</span><span class="o">=</span><span class="n">domain</span><span class="p">);</span>

    <span class="nf">savemesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="s">&quot;Th-hex-sph.mesh&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="n">Ph</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>
<span class="n">Ph</span> <span class="n">reg</span> <span class="o">=</span> <span class="kr">region</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; centre = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">reg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; exterieur = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">reg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kr">verbosity</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="kr">x</span><span class="p">,</span> <span class="kr">z</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kr">x</span><span class="p">,</span> <span class="kr">z</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="kr">z</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="kr">z</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">]]);</span>
<span class="kr">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">uh</span><span class="p">,</span><span class="n">vh</span><span class="p">;</span>

<span class="c1">// Macro</span>
<span class="kt">macro</span> <span class="nf">Grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span><span class="nf">dz</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="c1">// EOM</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="n">Poisson</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span>
        <span class="n">Grad</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">&#39;*</span><span class="n">Grad</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">2</span><span class="p">)(</span>
        <span class="n">Grad</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">&#39;*</span><span class="n">Grad</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">vh</span><span class="o">*</span><span class="n">f</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Solve</span>
<span class="n">Poisson</span><span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">nbiso</span><span class="o">=</span><span class="mi">6</span><span class="p">);</span>
<span class="nf">medit</span><span class="p">(</span><span class="s">&quot;uh&quot;</span><span class="p">,</span> <span class="n">Th</span><span class="p">,</span> <span class="n">uh</span><span class="p">);</span>
</pre></div>
</div>
<div class="inline2 figure" id="examplestaticproblemsperiodicboundaryconditionspoisson1">
<img alt="../_images/StaticProblems_PeriodicBoundaryConditionsPoisson1.png" src="../_images/StaticProblems_PeriodicBoundaryConditionsPoisson1.png" />
<p class="caption"><span class="caption-number">Fig. 186 </span><span class="caption-text">View of the surface isovalue of periodic solution <span class="math notranslate nohighlight">\(uh\)</span></span></p>
</div>
<div class="inline2 last figure" id="examplestaticproblemsperiodicboundaryconditionspoisson2">
<img alt="../_images/StaticProblems_PeriodicBoundaryConditionsPoisson2.png" src="../_images/StaticProblems_PeriodicBoundaryConditionsPoisson2.png" />
<p class="caption"><span class="caption-number">Fig. 187 </span><span class="caption-text">View a the cut of the solution <span class="math notranslate nohighlight">\(uh\)</span> with ffmedit</span></p>
</div>
</div>
</div>
<div class="section" id="poisson-problems-with-mixed-boundary-condition">
<span id="modelstaticpoissonwithmixedboundarycondition"></span><h2>Poisson Problems with mixed boundary condition<a class="headerlink" href="#poisson-problems-with-mixed-boundary-condition" title="Permalink to this headline">¶</a></h2>
<p>Here we consider the Poisson equation with mixed boundary conditions:</p>
<p>For given functions <span class="math notranslate nohighlight">\(f\)</span> and <span class="math notranslate nohighlight">\(g\)</span>, find <span class="math notranslate nohighlight">\(u\)</span> such that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcll}
    -\Delta u &amp;=&amp; f &amp; \textrm{ in }\Omega\\
    u &amp;=&amp; g &amp;\textrm{ on }\Gamma_D\\
    \p u/\p n &amp;=&amp; 0 &amp;\textrm{ on }\Gamma_N
\end{array}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\Gamma_D\)</span> is a part of the boundary <span class="math notranslate nohighlight">\(\Gamma\)</span> and <span class="math notranslate nohighlight">\(\Gamma_N=\Gamma\setminus \overline{\Gamma_D}\)</span>.</p>
<p>The solution <span class="math notranslate nohighlight">\(u\)</span> has the singularity at the points <span class="math notranslate nohighlight">\(\{\gamma_1,\gamma_2\}=\overline{\Gamma_D}\cap\overline{\Gamma_N}\)</span>.</p>
<p>When <span class="math notranslate nohighlight">\(\Omega=\{(x,y);\; -1&lt;x&lt;1,\, 0&lt;y&lt;1\}\)</span>, <span class="math notranslate nohighlight">\(\Gamma_N=\{(x,y);\; -1\le x&lt;0,\, y=0\}\)</span>, <span class="math notranslate nohighlight">\(\Gamma_D=\p \Omega\setminus \Gamma_N\)</span>, the singularity will appear at <span class="math notranslate nohighlight">\(\gamma_1=(0,0),\, \gamma_2(-1,0)\)</span>, and <span class="math notranslate nohighlight">\(u\)</span> has the expression:</p>
<div class="math notranslate nohighlight">
\[u=K_iu_S + u_R,\, u_R\in H^2(\textrm{near }\gamma_i),\, i=1,2\]</div>
<p>with a constants <span class="math notranslate nohighlight">\(K_i\)</span>.</p>
<p>Here <span class="math notranslate nohighlight">\(u_S = r_j^{1/2}\sin(\theta_j/2)\)</span> by the local polar coordinate <span class="math notranslate nohighlight">\((r_j,\theta_j\)</span> at <span class="math notranslate nohighlight">\(\gamma_j\)</span> such that <span class="math notranslate nohighlight">\((r_1,\theta_1)=(r,\theta)\)</span>.</p>
<p>Instead of polar coordinate system <span class="math notranslate nohighlight">\((r,\theta)\)</span>, we use that <span class="math notranslate nohighlight">\(r\)</span> = <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">sqrt</span></code> (<span class="math notranslate nohighlight">\(x^2+y^2\)</span>) and <span class="math notranslate nohighlight">\(\theta\)</span> = <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">atan2</span></code> (<span class="math notranslate nohighlight">\(y,x\)</span>) in <strong>FreeFem++</strong>.</p>
<p>Assume that <span class="math notranslate nohighlight">\(f=-2\times 30(x^2+y^2)\)</span> and <span class="math notranslate nohighlight">\(g=u_e=10(x^2+y^2)^{1/4}\sin\left([\tan^{-1}(y/x)]/2\right)+30(x^2y^2)\)</span>, where <span class="math notranslate nohighlight">\(u_e\)</span>S is the exact solution.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="mi">30</span><span class="o">*</span><span class="p">(</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="kr">y</span><span class="o">^</span><span class="mi">2</span><span class="p">);</span> <span class="c1">//given function</span>
<span class="c1">//the singular term of the solution is K*us (K: constant)</span>
<span class="kt">func</span> <span class="n">us</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="nf">atan2</span><span class="p">(</span><span class="kr">y</span><span class="p">,</span><span class="kr">x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nf">sqrt</span><span class="p">(</span> <span class="nf">sqrt</span><span class="p">(</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="kr">y</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="p">);</span>
<span class="kt">real</span> <span class="n">K</span> <span class="o">=</span> <span class="mf">10.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">ue</span> <span class="o">=</span> <span class="n">K</span><span class="o">*</span><span class="n">us</span> <span class="o">+</span> <span class="mi">30</span><span class="o">*</span><span class="p">(</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="kr">y</span><span class="o">^</span><span class="mi">2</span><span class="p">);</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="kr">N</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="mi">1</span><span class="o">+</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">D1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">D2</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">D3</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">D4</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;};</span>

<span class="kt">mesh</span> <span class="n">T0h</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="kr">N</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">D1</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">D2</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">D3</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="n">D4</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">T0h</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">V0h</span><span class="p">(</span><span class="n">T0h</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">V0h</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">;</span>

<span class="c1">//Problem</span>
<span class="kt">solve</span> <span class="nf">Poisson0</span> <span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">T0h</span><span class="p">)(</span>
        <span class="nf">dx</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">T0h</span><span class="p">)(</span>
        <span class="n">f</span><span class="o">*</span><span class="n">v0</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">u0</span><span class="o">=</span><span class="n">ue</span><span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Mesh adaptation by the singular term</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">T0h</span><span class="p">,</span> <span class="n">us</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">us</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">solve</span> <span class="nf">Poisson</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">ue</span><span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="c1">// Error in H1 norm</span>
<span class="n">Vh</span> <span class="n">uue</span> <span class="o">=</span> <span class="n">ue</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">H1e</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="nf">dx</span><span class="p">(</span><span class="n">uue</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">uue</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">uue</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="p">);</span>
<span class="n">Vh</span> <span class="n">err0</span> <span class="o">=</span> <span class="n">u0</span> <span class="o">-</span> <span class="n">ue</span><span class="p">;</span>
<span class="n">Vh</span> <span class="kp">err</span> <span class="o">=</span> <span class="n">u</span> <span class="o">-</span> <span class="n">ue</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">H1err0</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="nf">dx</span><span class="p">(</span><span class="n">err0</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">err0</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">err0</span><span class="o">^</span><span class="mi">2</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">H1err</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="nf">dx</span><span class="p">(</span><span class="kp">err</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="kp">err</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="kp">err</span><span class="o">^</span><span class="mi">2</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Relative error in first mesh = &quot;</span><span class="o">&lt;&lt;</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">H1err0</span><span class="p">)</span><span class="o">/</span><span class="n">H1e</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Relative error in adaptive mesh = &quot;</span><span class="o">&lt;&lt;</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">H1err</span><span class="p">)</span><span class="o">/</span><span class="n">H1e</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>From line 35 to 37, mesh adaptations are done using the base of singular term.</p>
<p>In line 61, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">H1e</span></code> = <span class="math notranslate nohighlight">\(|u_e|_{1,\Omega}\)</span> is calculated.</p>
<p>In lines 64 and 65, the relative errors are calculated, that is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    \|u^0_h-u_e\|_{1,\Omega}/H1e&amp;=&amp;0.120421\\
    \|u^a_h-u_e\|_{1,\Omega}/H1e&amp;=&amp;0.0150581
\end{array}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(u^0_h\)</span> is the numerical solution in <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">T0h</span></code> and <span class="math notranslate nohighlight">\(u^a_h\)</span> is <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">u</span></code> in this program.</p>
</div>
<div class="section" id="poisson-with-mixed-finite-element">
<h2>Poisson with mixed finite element<a class="headerlink" href="#poisson-with-mixed-finite-element" title="Permalink to this headline">¶</a></h2>
<p>Here we consider the Poisson equation with mixed boundary value problems:</p>
<p>For given functions <span class="math notranslate nohighlight">\(f\)</span> , <span class="math notranslate nohighlight">\(g_d\)</span>, <span class="math notranslate nohighlight">\(g_n\)</span>, find <span class="math notranslate nohighlight">\(p\)</span> such that</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcll}
    -\Delta p &amp;=&amp; 1 &amp; \textrm{ in }\Omega\\
    p &amp;=&amp; g_d &amp; \textrm{ on }\Gamma_D\\
    \p p/\p n &amp;=&amp; g_n &amp; \textrm{ on }\Gamma_N
\end{array}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\Gamma_D\)</span> is a part of the boundary <span class="math notranslate nohighlight">\(\Gamma\)</span> and <span class="math notranslate nohighlight">\(\Gamma_N=\Gamma\setminus \overline{\Gamma_D}\)</span>.</p>
<p>The mixed formulation is: find <span class="math notranslate nohighlight">\(p\)</span> and <span class="math notranslate nohighlight">\(\mathbf{u}\)</span> such that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcll}
    \nabla p + \mathbf{u} &amp;=&amp; \mathbf{0} &amp; \textrm{ in }\Omega\\
    \nabla. \mathbf{u} &amp;=&amp; f &amp; \textrm{ in }\Omega\\
    p &amp;=&amp; g_d &amp; \textrm{ on }\Gamma_D\\
    \p u. n &amp;=&amp; \mathbf{g}_n.n &amp; \textrm{ on }\Gamma_N
\end{array}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{g}_n\)</span> is a vector such that <span class="math notranslate nohighlight">\(\mathbf{g}_n.n = g_n\)</span>.</p>
<p>The variational formulation is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    \forall \mathbf{v} \in \mathbb{V}_0: &amp; \int_\Omega p \nabla.v + \mathbf{v} \mathbf{v} &amp;= \int_{\Gamma_d} g_d \mathbf{v}.n\\
    \forall {q} \in \mathbb{P}: &amp; \int_\Omega q \nabla.u &amp;= \int_\Omega q f\nonumber\\
    &amp; \p u. n &amp;= \mathbf{g}_n.n \quad \textrm{on }\Gamma_N
\end{array}\end{split}\]</div>
<p>where the functional space are:</p>
<div class="math notranslate nohighlight">
\[\mathbb{P}= L^2(\Omega),
\qquad\mathbb{V}= H(div)=\{\mathbf{v}\in L^2(\Omega)^2,\nabla.\mathbf{v}\in L^2(\Omega)\}\]</div>
<p>and:</p>
<div class="math notranslate nohighlight">
\[\mathbb{V}_0 = \{\mathbf{v}\in \mathbb{V};\quad\mathbf{v}. n = 0 \quad\mathrm{on }\;\;\Gamma_N\}\]</div>
<p>To write the <strong>FreeFem++</strong> example, we have just to choose the finites elements spaces.</p>
<p>Here <span class="math notranslate nohighlight">\(\mathbb{V}\)</span> space is discretize with Raviart-Thomas finite element <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nc">RT0</span></code> and <span class="math notranslate nohighlight">\(\mathbb{P}\)</span> is discretize by constant finite element <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nc">P0</span></code>.</p>
<p><strong>Example 9.10</strong> LaplaceRT.edp</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">func</span> <span class="n">gd</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">g1n</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">g2n</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">RT0</span><span class="p">);</span>
<span class="n">Vh</span> <span class="p">[</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">];</span>
<span class="n">Vh</span> <span class="p">[</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">];</span>

<span class="kt">fespace</span> <span class="nf">Ph</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>
<span class="n">Ph</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="nf">laplaceMixte</span> <span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">q</span><span class="p">],</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">GMRES</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.0e-10</span><span class="p">,</span> <span class="kp">tgv</span><span class="o">=</span><span class="mf">1e30</span><span class="p">,</span> <span class="nf">dimKrylov</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="mf">1e-15</span> <span class="c1">//this term is here to be sure</span>
        <span class="c1">// that all sub matrix are inversible (LU requirement)</span>
        <span class="o">+</span> <span class="n">u1</span><span class="o">*</span><span class="n">v1</span>
        <span class="o">+</span> <span class="n">u2</span><span class="o">*</span><span class="n">v2</span>
        <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="o">+</span><span class="nf">dy</span><span class="p">(</span><span class="n">v2</span><span class="p">))</span>
        <span class="o">+</span> <span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">+</span><span class="nf">dy</span><span class="p">(</span><span class="n">u2</span><span class="p">))</span><span class="o">*</span><span class="n">q</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)</span> <span class="p">(</span>
        <span class="n">q</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)(</span>
        <span class="n">gd</span><span class="o">*</span><span class="p">(</span><span class="n">v1</span><span class="o">*</span><span class="kr">N</span><span class="p">.</span><span class="kr">x</span> <span class="o">+</span><span class="n">v2</span><span class="o">*</span><span class="kr">N</span><span class="p">.</span><span class="kr">y</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="n">g1n</span><span class="p">,</span> <span class="n">u2</span><span class="o">=</span><span class="n">g2n</span><span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Solve</span>
<span class="n">laplaceMixte</span><span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">],</span> <span class="kp">coef</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="metric-adaptation-and-residual-error-indicator">
<h2>Metric Adaptation and residual error indicator<a class="headerlink" href="#metric-adaptation-and-residual-error-indicator" title="Permalink to this headline">¶</a></h2>
<p>We do metric mesh adaption and compute the classical residual error indicator <span class="math notranslate nohighlight">\(\eta_{T}\)</span> on the element <span class="math notranslate nohighlight">\(T\)</span> for the Poisson problem.</p>
<p>First, we solve the same problem as in a previous example.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="kp">viso</span><span class="p">(</span><span class="mi">21</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kp">viso</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="kp">viso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">^</span><span class="p">(</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mf">16.</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">);</span>
<span class="kt">real</span> <span class="n">error</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="kr">x</span><span class="o">-</span><span class="kr">y</span><span class="p">);</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">ba</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="kp">bb</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">bc</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">3</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">bd</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">4</span><span class="p">;}</span>
<span class="kt">border</span> <span class="kr">be</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">5</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">bf</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">6</span><span class="p">;}</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">ba</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="kp">bb</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">bc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">bd</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="kr">be</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">bf</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Nh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>
<span class="n">Nh</span> <span class="n">rho</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="nf">Probem1</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qforder</span><span class="o">=</span><span class="mi">5</span><span class="p">)(</span>
        <span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="mf">1.0e-10</span>
        <span class="o">+</span> <span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qforder</span><span class="o">=</span><span class="mi">5</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="p">;</span>
</pre></div>
</div>
<p>Now, the local error indicator <span class="math notranslate nohighlight">\(\eta_{T}\)</span> is:</p>
<div class="math notranslate nohighlight">
\[\eta_{T} =\left( h_{T}^{2} || f + \Delta u_{{h}} ||_{L^{2}(T)}^{2} +\sum_{e\in \mathcal{E}_{K}} h_{e} \,||\, [ \frac{\p u_{h}}{\p n_{k}}] \,||^{2}_{L^{2}(e)} \right)^{\frac{1}{2}}\]</div>
<p>where <span class="math notranslate nohighlight">\(h_{T}\)</span> is the longest edge of <span class="math notranslate nohighlight">\(T\)</span>, <span class="math notranslate nohighlight">\({\cal E}_T\)</span> is the set of <span class="math notranslate nohighlight">\(T\)</span> edge not on <span class="math notranslate nohighlight">\(\Gamma=\p \Omega\)</span>, <span class="math notranslate nohighlight">\(n_{T}\)</span> is the outside unit normal to <span class="math notranslate nohighlight">\(K\)</span>, <span class="math notranslate nohighlight">\(h_{e}\)</span> is the length of edge <span class="math notranslate nohighlight">\(e\)</span>, <span class="math notranslate nohighlight">\([ g ]\)</span> is the jump of the function <span class="math notranslate nohighlight">\(g\)</span> across edge (left value minus right value).</p>
<p>Of course, we can use a variational form to compute <span class="math notranslate nohighlight">\(\eta_{T}^{2}\)</span>, with test function constant function in each triangle.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Error</span>
<span class="kt">varf</span> <span class="nf">indicator2</span> <span class="p">(</span><span class="n">uu</span><span class="p">,</span> <span class="n">chiK</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">intalledges</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">chiK</span><span class="o">*</span><span class="kr">lenEdge</span><span class="o">*</span><span class="nf">square</span><span class="p">(</span><span class="nf">jump</span><span class="p">(</span><span class="kr">N</span><span class="p">.</span><span class="kr">x</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="kr">N</span><span class="p">.</span><span class="kr">y</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">chiK</span><span class="o">*</span><span class="nf">square</span><span class="p">(</span><span class="kr">hTriangle</span><span class="o">*</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="nf">dxx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dyy</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Mesh adaptation loop</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="c1">// Solve</span>
    <span class="n">Probem1</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[].</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[].</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

    <span class="c1">// Error</span>
    <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">indicator2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nh</span><span class="p">);</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;rho = min &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rho</span><span class="p">[].</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; max=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rho</span><span class="p">[].</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;indicator density&quot;</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">viso</span><span class="o">=</span><span class="kp">viso</span><span class="p">,</span> <span class="kp">nbiso</span><span class="o">=</span><span class="kp">viso</span><span class="p">.</span><span class="kr">n</span><span class="p">);</span>

    <span class="c1">// Mesh adaptation</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;Mesh (before adaptation)&quot;</span><span class="p">);</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)],</span> <span class="kp">err</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">anisomax</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;Mesh (after adaptation)&quot;</span><span class="p">);</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span><span class="p">;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">error</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If the method is correct, we expect to look the graphics by an almost constant function <span class="math notranslate nohighlight">\(\eta\)</span> on your computer as in <a class="reference internal" href="#examplestaticproblemsmetricadaptation"><span class="std std-numref">Fig. 188</span></a> and <a class="reference internal" href="#examplestaticproblemsmetricadaptation2"><span class="std std-numref">Fig. 189</span></a>.</p>
<div class="inline2 figure" id="examplestaticproblemsmetricadaptation">
<img alt="../_images/StaticProblems_MetricAdaptation.png" src="../_images/StaticProblems_MetricAdaptation.png" />
<p class="caption"><span class="caption-number">Fig. 188 </span><span class="caption-text">Density of the error indicator with isotropic <span class="math notranslate nohighlight">\(P_{2}\)</span> metric</span></p>
</div>
<div class="inline2 figure" id="examplestaticproblemsmetricadaptation2">
<img alt="../_images/StaticProblems_MetricAdaptation2.png" src="../_images/StaticProblems_MetricAdaptation2.png" />
<p class="caption"><span class="caption-number">Fig. 189 </span><span class="caption-text">Density of the error indicator with isotropic <span class="math notranslate nohighlight">\(P_{2}\)</span> metric</span></p>
</div>
</div>
<div class="section" id="adaptation-using-residual-error-indicator">
<span id="modelstaticproblemadaptationusingresidualerrorindicator"></span><h2>Adaptation using residual error indicator<a class="headerlink" href="#adaptation-using-residual-error-indicator" title="Permalink to this headline">¶</a></h2>
<p>In the previous example we compute the error indicator, now we use it, to adapt the mesh.
The new mesh size is given by the following formulae:</p>
<div class="math notranslate nohighlight">
\[h_{n+1}(x) = \frac{h_{n}(x)}{f_{n}(\eta_K(x))}\]</div>
<p>where <span class="math notranslate nohighlight">\(\eta_n(x)\)</span> is the level of error at point <span class="math notranslate nohighlight">\(x\)</span> given by the local error indicator, <span class="math notranslate nohighlight">\(h_n\)</span> is the previous “mesh size” field, and <span class="math notranslate nohighlight">\(f_n\)</span> is a user function define by <span class="math notranslate nohighlight">\(f_n = min(3,max(1/3,\eta_n / \eta_n^* ))\)</span> where <span class="math notranslate nohighlight">\(\eta_n^* = mean(\eta_n) c\)</span>, and <span class="math notranslate nohighlight">\(c\)</span> is an user coefficient generally close to one.</p>
<p>First a macro <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">MeshSizecomputation</span></code> is defined to get a <span class="math notranslate nohighlight">\(P_1\)</span> mesh size as the average of edge length.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// macro the get the current mesh size parameter</span>
<span class="c1">// in:</span>
<span class="c1">// Th the mesh</span>
<span class="c1">// Vh P1 fespace on Th</span>
<span class="c1">// out :</span>
<span class="c1">// h: the Vh finite element finite set to the current mesh size</span>
<span class="kt">macro</span> <span class="nf">MeshSizecomputation</span> <span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">count</span><span class="p">(</span><span class="n">Th</span><span class="p">.</span><span class="kr">nv</span><span class="p">);</span>
    <span class="cm">/*mesh size (lenEdge = integral(e) 1 ds)*/</span>
    <span class="kt">varf</span> <span class="n">vmeshsizen</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">intalledges</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kr">qfnbpE</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">v</span><span class="p">);</span>
    <span class="cm">/*number of edges per vertex*/</span>
    <span class="kt">varf</span> <span class="n">vedgecount</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">intalledges</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kr">qfnbpE</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">v</span><span class="o">/</span><span class="kr">lenEdge</span><span class="p">);</span>
    <span class="cm">/*mesh size*/</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">vedgecount</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="n">h</span><span class="p">[]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="n">h</span><span class="p">[]</span> <span class="o">=</span> <span class="n">vmeshsizen</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;count min = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">count</span><span class="p">.</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; max = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">count</span><span class="p">.</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">h</span><span class="p">[]</span> <span class="o">=</span> <span class="n">h</span><span class="p">[].</span><span class="o">/</span><span class="n">count</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-- bound meshsize = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">h</span><span class="p">[].</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">h</span><span class="p">[].</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">//</span>
</pre></div>
</div>
<p>A second macro to re-mesh according to the new mesh size.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// macro to remesh according the de residual indicator</span>
<span class="c1">// in:</span>
<span class="c1">// Th the mesh</span>
<span class="c1">// Ph P0 fespace on Th</span>
<span class="c1">// Vh P1 fespace on Th</span>
<span class="c1">// vindicator the varf to evaluate the indicator</span>
<span class="c1">// coef on etameam</span>
<span class="kt">macro</span> <span class="nf">ReMeshIndicator</span> <span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">Ph</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="n">vindicator</span><span class="p">,</span> <span class="kp">coef</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Vh</span> <span class="n">h</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="cm">/*evaluate the mesh size*/</span>
    <span class="n">MeshSizecomputation</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
    <span class="n">Ph</span> <span class="n">etak</span><span class="p">;</span>
    <span class="n">etak</span><span class="p">[]</span> <span class="o">=</span> <span class="n">vindicator</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Ph</span><span class="p">);</span>
    <span class="n">etak</span><span class="p">[]</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">etak</span><span class="p">[]);</span>
    <span class="kt">real</span> <span class="n">etastar</span><span class="o">=</span> <span class="kp">coef</span><span class="o">*</span><span class="p">(</span><span class="n">etak</span><span class="p">[].</span><span class="kr">sum</span><span class="o">/</span><span class="n">etak</span><span class="p">[].</span><span class="kr">n</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;etastar = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">etastar</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; sum = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">etak</span><span class="p">[].</span><span class="kr">sum</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="cm">/*etaK is discontinous*/</span>
    <span class="cm">/*we use P1 L2 projection with mass lumping*/</span>
    <span class="n">Vh</span> <span class="n">fn</span><span class="p">,</span> <span class="kp">sigma</span><span class="p">;</span>
    <span class="kt">varf</span> <span class="n">veta</span><span class="p">(</span><span class="kr">unused</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">etak</span><span class="o">*</span><span class="n">v</span><span class="p">);</span>
    <span class="kt">varf</span> <span class="n">vun</span><span class="p">(</span><span class="kr">unused</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="mi">1</span><span class="o">*</span><span class="n">v</span><span class="p">);</span>
    <span class="n">fn</span><span class="p">[]</span> <span class="o">=</span> <span class="n">veta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="kp">sigma</span><span class="p">[]</span> <span class="o">=</span> <span class="n">vun</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="n">fn</span><span class="p">[]</span> <span class="o">=</span> <span class="n">fn</span><span class="p">[].</span><span class="o">/</span> <span class="kp">sigma</span><span class="p">[];</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="kr">max</span><span class="p">(</span><span class="kr">min</span><span class="p">(</span><span class="n">fn</span><span class="o">/</span><span class="n">etastar</span><span class="p">,</span><span class="mf">3.</span><span class="p">),</span><span class="mf">0.3333</span><span class="p">);</span>

    <span class="cm">/*new mesh size*/</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="n">fn</span><span class="p">;</span>
    <span class="cm">/*build the mesh*/</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">IsMetric</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="kp">splitpbedge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">nbvx</span><span class="o">=</span><span class="mi">10000</span><span class="p">);</span>
<span class="p">}</span> <span class="c1">//</span>
</pre></div>
</div>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">real</span> <span class="n">hinit</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span> <span class="c1">//initial mesh size</span>
<span class="kt">func</span> <span class="n">f</span><span class="o">=</span><span class="p">(</span><span class="kr">x</span><span class="o">-</span><span class="kr">y</span><span class="p">);</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">ba</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="kp">bb</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">bc</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">3</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">bd</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">4</span><span class="p">;}</span>
<span class="kt">border</span> <span class="kr">be</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">5</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">bf</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">6</span><span class="p">;}</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">ba</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="kp">bb</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">bc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">bd</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="kr">be</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">bf</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span> <span class="c1">//for the mesh size and solution</span>
<span class="n">Vh</span> <span class="n">h</span> <span class="o">=</span> <span class="n">hinit</span><span class="p">;</span> <span class="c1">//the FE function for the mesh size</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Ph</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span> <span class="c1">//for the error indicator</span>

<span class="c1">//Build a mesh with the given mesh size hinit</span>
<span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="kp">IsMetric</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">splitpbedge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">nbvx</span><span class="o">=</span><span class="mi">10000</span><span class="p">);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="nf">Poisson</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qforder</span><span class="o">=</span><span class="mi">5</span><span class="p">)(</span>
        <span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="mf">1.0e-10</span>
        <span class="o">+</span> <span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qforder</span><span class="o">=</span><span class="mi">5</span><span class="p">)(</span>
        <span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">indicator2</span> <span class="p">(</span><span class="kr">unused</span><span class="p">,</span> <span class="n">chiK</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">intalledges</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">chiK</span><span class="o">*</span><span class="kr">lenEdge</span><span class="o">*</span><span class="nf">square</span><span class="p">(</span><span class="nf">jump</span><span class="p">(</span><span class="kr">N</span><span class="p">.</span><span class="kr">x</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="kr">N</span><span class="p">.</span><span class="kr">y</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">chiK</span><span class="o">*</span><span class="nf">square</span><span class="p">(</span><span class="kr">hTriangle</span><span class="o">*</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="nf">dxx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dyy</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Mesh adaptation loop</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

    <span class="c1">// Solve</span>
    <span class="n">Poisson</span><span class="p">;</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

    <span class="kt">real</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="n">cc</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">ReMeshIndicator</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">Ph</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="n">indicator2</span><span class="p">,</span> <span class="n">cc</span><span class="p">);</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="inline2 figure" id="examplestaticproblemsadaptationresidualerror">
<img alt="../_images/StaticProblems_AdaptationResidualError.png" src="../_images/StaticProblems_AdaptationResidualError.png" />
<p class="caption"><span class="caption-number">Fig. 190 </span><span class="caption-text">The error indicator with isotropic <span class="math notranslate nohighlight">\(P_{1}\)</span></span></p>
</div>
<div class="inline2 figure" id="examplestaticproblemsadaptationresidualerror2">
<img alt="../_images/StaticProblems_AdaptationResidualError2.png" src="../_images/StaticProblems_AdaptationResidualError2.png" />
<p class="caption"><span class="caption-number">Fig. 191 </span><span class="caption-text">The mesh and isovalue of the solution</span></p>
</div>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>