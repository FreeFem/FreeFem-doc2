<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Evolution problems</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">Evolution problems</a><ul>
<li><a class="reference internal" href="#mathematical-theory-on-time-difference-approximations">Mathematical Theory on Time Difference Approximations.</a></li>
<li><a class="reference internal" href="#convection">Convection</a></li>
<li><a class="reference internal" href="#d-black-scholes-equation-for-an-european-put-option">2D Black-Scholes equation for an European Put option</a></li>
</ul>
</li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="math notranslate nohighlight">
\[\def\p{{\partial}}
\def\R{{\mathbb{R}}}\]</div>
<div class="section" id="evolution-problems">
<h1>Evolution problems<a class="headerlink" href="#evolution-problems" title="Permalink to this headline">¶</a></h1>
<p><strong>FreeFem++</strong> also solves evolution problems such as the heat equation:</p>
<div class="math notranslate nohighlight" id="equation-eqn-heatequation">
<span class="eqno">(50)<a class="headerlink" href="#equation-eqn-heatequation" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{array}{rcll}
    \frac{\p u}{\p t}-\mu\Delta u &amp;=&amp; f &amp; \textrm{ in }\Omega\times ]0,T[\\
    u(\mathbf{x},0) &amp;=&amp; u_0(\mathbf{x}) &amp; \textrm{ in }\Omega\\
    \left(\p u/\p n\right)(\mathbf{x},t) &amp;=&amp; 0 &amp; \textrm{ on }\p\Omega\times ]0,T[
\end{array}\end{split}\]</div>
<p>with a positive viscosity coefficient <span class="math notranslate nohighlight">\(\mu\)</span> and homogeneous Neumann boundary conditions.</p>
<p>We solve <a class="reference internal" href="#equation-eqn-heatequation">(50)</a> by FEM in space and finite differences in time.</p>
<p>We use the definition of the partial derivative of the solution in the time derivative:</p>
<div class="math notranslate nohighlight">
\[\frac{\p u}{\p t}(x,y,t) = \lim_{\tau \to 0}\frac{u(x,y,t)-u(x,y,t-\tau )}{\tau }\]</div>
<p>which indicates that <span class="math notranslate nohighlight">\(u^m(x,y)=u(x,y,m\tau )\)</span> will satisfy approximatively:</p>
<div class="math notranslate nohighlight">
\[\frac{\p u}{\p t}(x,y,m\tau )\simeq \frac{u^m(x,y)-u^{m-1}(x,y)}{\tau }\]</div>
<p>The time discretization of heat equation <a class="reference internal" href="#equation-eqn-heatequation">(50)</a> is as follows, <span class="math notranslate nohighlight">\(\forall m=0,\cdots,[T/\tau ]\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcll}
    \frac{u^{m+1}-u^{m}}{\tau }-\mu\Delta u^{m+1} &amp;=&amp; f^{m+1} &amp; \textrm{ in }\Omega\\
    u^0(\mathbf{x}) &amp;=&amp; u_0(\mathbf{x}) &amp; \textrm{ in }\Omega\\
    \p u^{m+1}/\p n(\mathbf{x}) &amp;=&amp; 0 &amp; \textrm{ on }\p\Omega
\end{array}\end{split}\]</div>
<p>which is so-called <em>backward Euler method</em> for <a class="reference internal" href="#equation-eqn-heatequation">(50)</a>.</p>
<p>To obtain the variational formulation, multiply with the test function <span class="math notranslate nohighlight">\(v\)</span> both sides of the equation:</p>
<div class="math notranslate nohighlight">
\[\int_{\Omega}\{u^{m+1}v-\tau \Delta u^{m+1}v\}=\int_{\Omega}\{u^m+\tau f^{m+1}\}v\]</div>
<p>By the divergence theorem, we have:</p>
<div class="math notranslate nohighlight">
\[\int_{\Omega}\{u^{m+1}v+\tau\nabla u^{m+1}\cdot \nabla v\}
-\int_{\p\Omega} \tau \left( \p u^{m+1}/\p n\right) v
=\int_{\Omega }\{u^mv+\tau f^{m+1}v\}\]</div>
<p>By the boundary condition <span class="math notranslate nohighlight">\(\p u^{m+1}/\p n=0\)</span>, it follows that:</p>
<div class="math notranslate nohighlight" id="equation-eqn-heatequationbwe">
<span class="eqno">(51)<a class="headerlink" href="#equation-eqn-heatequationbwe" title="Permalink to this equation">¶</a></span>\[\int_{\Omega} \{u^{m+1}v+\tau \nabla u^{m+1}\cdot \nabla v\}
-\int_{\Omega }\{u^mv+\tau f^{m+1}v\}
=0\]</div>
<p>Using the identity just above, we can calculate the finite element approximation <span class="math notranslate nohighlight">\(u_h^m\)</span> of <span class="math notranslate nohighlight">\(u^m\)</span> in a step-by-step manner with respect to <span class="math notranslate nohighlight">\(t\)</span>.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Example</p>
<p>We now solve the following example with the exact solution <span class="math notranslate nohighlight">\(u(x,y,t)=tx^4\)</span>, <span class="math notranslate nohighlight">\(\Omega = ]0,1[^2\)</span>.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcll}
    \frac{{\p u}}{{\p t}} - \mu \Delta u &amp;=&amp; x^4 - \mu 12tx^2 &amp; \textrm{ in }\Omega\times ]0,3[\\
    u(x,y,0) &amp;=&amp; 0 &amp; \textrm{ on }\Omega\\
    \left. u \right|_{\p\Omega} &amp;=&amp; t*x^4
\end{array}\end{split}\]</div>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">real</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="nf">dHeat</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">u</span><span class="o">*</span><span class="n">v</span>
        <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">uu</span><span class="o">*</span><span class="n">v</span>
        <span class="o">-</span> <span class="n">dt</span><span class="o">*</span><span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Time loop</span>
<span class="kt">real</span> <span class="kp">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">uu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="kr">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">m</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="o">/</span><span class="n">dt</span><span class="p">;</span> <span class="kr">m</span><span class="o">++</span><span class="p">){</span>
    <span class="c1">// Update</span>
    <span class="kp">t</span> <span class="o">=</span> <span class="kp">t</span><span class="o">+</span><span class="n">dt</span><span class="p">;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="kr">x</span><span class="o">^</span><span class="mi">4</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="kp">t</span><span class="o">*</span><span class="mi">12</span><span class="o">*</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>
    <span class="n">g</span> <span class="o">=</span> <span class="kp">t</span><span class="o">*</span><span class="kr">x</span><span class="o">^</span><span class="mi">4</span><span class="p">;</span>
    <span class="n">uu</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

    <span class="c1">// Solve</span>
    <span class="n">dHeat</span><span class="p">;</span>

    <span class="c1">// Plot</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;t=&quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">t</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - L^2-Error=&quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">sqrt</span><span class="p">(</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)((</span><span class="n">u</span><span class="o">-</span><span class="kp">t</span><span class="o">*</span><span class="kr">x</span><span class="o">^</span><span class="mi">4</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the last statement, the <span class="math notranslate nohighlight">\(L^2\)</span>-error <span class="math notranslate nohighlight">\(\left(\int_{\Omega}\left| u-tx^4\right|^2\right)^{1/2}\)</span> is calculated at <span class="math notranslate nohighlight">\(t=m\tau, \tau =0.1\)</span>. At <span class="math notranslate nohighlight">\(t=0.1\)</span>, the error is 0.000213269. The errors increase with <span class="math notranslate nohighlight">\(m\)</span> and 0.00628589 at <span class="math notranslate nohighlight">\(t=3\)</span>.</p>
<p>The iteration of the backward Euler <a class="reference internal" href="#equation-eqn-heatequationbwe">(51)</a> is made by <a class="reference internal" href="../reference/loops.html#loopfor"><span class="std std-ref">for loop</span></a>.</p>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The stiffness matrix in the loop is used over and over again.
<strong>FreeFem++</strong> support reuses of stiffness matrix.</p>
</div>
</div>
<div class="section" id="mathematical-theory-on-time-difference-approximations">
<h2>Mathematical Theory on Time Difference Approximations.<a class="headerlink" href="#mathematical-theory-on-time-difference-approximations" title="Permalink to this headline">¶</a></h2>
<p>In this section, we show the advantage of implicit schemes.
Let <span class="math notranslate nohighlight">\(V, H\)</span> be separable Hilbert space and <span class="math notranslate nohighlight">\(V\)</span> is dense in <span class="math notranslate nohighlight">\(H\)</span>.
Let <span class="math notranslate nohighlight">\(a\)</span> be a continuous bilinear form over <span class="math notranslate nohighlight">\(V \times V\)</span> with coercivity and symmetry.</p>
<p>Then <span class="math notranslate nohighlight">\(\sqrt{a(v,v)}\)</span> become equivalent to the norm <span class="math notranslate nohighlight">\(\| v\|\)</span> of <span class="math notranslate nohighlight">\(V\)</span>.</p>
<p><strong>Problem Ev(f,Omega)</strong>: For a given <span class="math notranslate nohighlight">\(f\in L^2(0,T;V'),\, u^0\in H\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    \frac{d}{dt}(u(t),v)+a(u(t),v)&amp;=&amp;( f(t),v)\qquad \forall v\in V,\quad a.e. \, t\in [0,T]\\
    u(0)&amp;=&amp;u^0\nonumber
\end{array}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(V'\)</span> is the dual space of <span class="math notranslate nohighlight">\(V\)</span>.</p>
<p>Then, there is an unique solution <span class="math notranslate nohighlight">\(u\in L^{\infty}(0,T;H)\cap L^2(0,T;V)\)</span>.</p>
<p>Let us denote the time step by <span class="math notranslate nohighlight">\(\tau&gt;0\)</span>, <span class="math notranslate nohighlight">\(N_T=[T/\tau]\)</span>.
For the discretization, we put <span class="math notranslate nohighlight">\(u^n = u(n\tau)\)</span> and consider the time difference for each <span class="math notranslate nohighlight">\(\theta\in [0,1]\)</span></p>
<div class="math notranslate nohighlight" id="equation-eqn-t-method">
<span class="eqno">(52)<a class="headerlink" href="#equation-eqn-t-method" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{array}{rcl}
    \frac{1}{\tau}\left( u_h^{n+1}-u_h^n,\phi_i\right) +a\left( u_h^{n+\theta},\phi_i\right)&amp;=&amp;\langle f^{n+\theta},\phi_i\rangle\\
    i=1,&amp;\cdots&amp;, m,\quad n=0,\cdots, N_T\nonumber\\
    u_h^{n+\theta}&amp;=&amp;\theta u_h^{n+1}+(1-\theta)u_h^n,\\
    f^{n+\theta}&amp;=&amp;\theta f^{n+1}+(1-\theta)f^n\nonumber
\end{array}\end{split}\]</div>
<p>Formula <a class="reference internal" href="#equation-eqn-t-method">(52)</a> is the <em>forward Euler scheme</em> if <span class="math notranslate nohighlight">\(\theta=0\)</span>, <em>Crank-Nicolson scheme</em> if <span class="math notranslate nohighlight">\(\theta=1/2\)</span>, the <em>backward Euler scheme</em> if <span class="math notranslate nohighlight">\(\theta=1\)</span>.</p>
<p>Unknown vectors <span class="math notranslate nohighlight">\(u^n=(u_h^1,\cdots,u_h^M)^T\)</span> in</p>
<div class="math notranslate nohighlight">
\[u_h^n(x)=u^n_1\phi_1(x)+\cdots+u^n_m\phi_m(x),\quad u^n_1,\cdots,u^n_m\in \R\]</div>
<p>are obtained from solving the matrix</p>
<div class="math notranslate nohighlight" id="equation-eqn-evolution-1">
<span class="eqno">(53)<a class="headerlink" href="#equation-eqn-evolution-1" title="Permalink to this equation">¶</a></span>\[\begin{split}(M+\theta\tau A)u^{n+1}=\{M-(1-\theta)\tau A\}u^n
+\tau\left\{\theta f^{n+1}+(1-\theta)f^n\right\}\\
M=(m_{ij}),\quad m_{ij}=(\phi_j,\phi_i),\qquad
A=(a_{ij}),\quad a_{ij}=a(\phi_j,\phi_i)\nonumber\end{split}\]</div>
<p>Refer <a class="reference internal" href="../reference.html#tabata1994" id="id1">[TABATA1994]</a>, pp.70–75 for solvability of <a class="reference internal" href="#equation-eqn-evolution-1">(53)</a>. The stability of <a class="reference internal" href="#equation-eqn-evolution-1">(53)</a> is in <a class="reference internal" href="../reference.html#tabata1994" id="id2">[TABATA1994]</a>, Theorem 2.13:</p>
<p>Let <span class="math notranslate nohighlight">\(\{\mathcal{T}_h\}_{h\downarrow 0}\)</span> be regular triangulations (see <a class="reference internal" href="../documentation/meshGeneration.html#meshregulartriangulation"><span class="std std-ref">Regular Triangulation</span></a>).
Then there is a number <span class="math notranslate nohighlight">\(c_0&gt;0\)</span> independent of <span class="math notranslate nohighlight">\(h\)</span> such that,</p>
<div class="math notranslate nohighlight">
\[\begin{split}|u_h^n|^2\le
\left\{
\begin{array}{lr}
\frac{1}{\delta}\left\{
|u^0_h|^2+\tau \sum_{k=0}^{n-1}\|f^{k+\theta}\|^2_{V_h'}
\right\}&amp;\theta\in [0,1/2)\\
|u^0_h|^2+\tau \sum_{k=0}^{n-1}\|f^{k+\theta}\|^2_{V_h'}&amp;\theta\in [1/2,1]
\end{array}
\right.\end{split}\]</div>
<p>if the following are satisfied:</p>
<ol class="arabic">
<li><p class="first">When <span class="math notranslate nohighlight">\(\theta\in [0,1/2)\)</span>, then we can take a time step <span class="math notranslate nohighlight">\(\tau\)</span> in such a way that</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\tau &lt;\frac{2(1-\delta)}{(1-2\theta)c_0^2}h^2\]</div>
<p>for arbitrary <span class="math notranslate nohighlight">\(\delta\in (0,1)\)</span>.</p>
</div></blockquote>
</li>
<li><p class="first">When <span class="math notranslate nohighlight">\(1/2\leq \theta\leq 1\)</span>, we can take <span class="math notranslate nohighlight">\(\tau\)</span> arbitrary.</p>
</li>
</ol>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Example</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">real</span> <span class="n">tau</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="kt">real</span>
<span class="n">theta</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">oldU</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f0</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Ph</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>
<span class="n">Ph</span> <span class="n">h</span> <span class="o">=</span> <span class="kr">hTriangle</span><span class="p">;</span> <span class="c1">// mesh sizes for each triangle</span>

<span class="c1">// Function</span>
<span class="kt">func</span> <span class="kt">real</span> <span class="nf">f</span> <span class="p">(</span><span class="kt">real</span> <span class="kp">t</span><span class="p">){</span>
    <span class="k">return</span> <span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kr">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="kp">t</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">12</span><span class="o">*</span><span class="kr">x</span> <span class="o">-</span> <span class="mi">11</span><span class="o">*</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="kr">x</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="kr">x</span><span class="o">^</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// File</span>
<span class="kt">ofstream</span> <span class="nf">out</span><span class="p">(</span><span class="s">&quot;err02.csv&quot;</span><span class="p">);</span> <span class="c1">//file to store calculations</span>
<span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;mesh size = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">h</span><span class="p">[].</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, time step = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tau</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">n</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">/</span><span class="n">tau</span><span class="p">;</span> <span class="kr">n</span><span class="o">++</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="kr">n</span><span class="o">*</span><span class="n">tau</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
<span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="nf">aTau</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">u</span><span class="o">*</span><span class="n">v</span>
        <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">oldU</span><span class="o">*</span><span class="n">v</span>
        <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">oldU</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">oldU</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="n">oldU</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">tau</span><span class="o">*</span><span class="p">(</span><span class="n">theta</span><span class="o">*</span><span class="n">f1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">f0</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Theta loop</span>
<span class="k">while</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">){</span>
    <span class="kt">real</span> <span class="kp">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">real</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">oldU</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">theta</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">n</span> <span class="o">&lt;</span> <span class="n">T</span><span class="o">/</span><span class="n">tau</span><span class="p">;</span> <span class="kr">n</span><span class="o">++</span><span class="p">){</span>
        <span class="c1">// Update</span>
        <span class="kp">t</span> <span class="o">=</span> <span class="kp">t</span> <span class="o">+</span> <span class="n">tau</span><span class="p">;</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="kr">n</span><span class="o">*</span><span class="n">tau</span><span class="p">);</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">f</span><span class="p">((</span><span class="kr">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">tau</span><span class="p">);</span>

        <span class="c1">// Solve</span>
        <span class="n">aTau</span><span class="p">;</span>
        <span class="n">oldU</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

        <span class="c1">// Plot</span>
        <span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>

        <span class="c1">// Error</span>
        <span class="n">Vh</span> <span class="n">uex</span> <span class="o">=</span> <span class="kp">t</span><span class="o">*</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="kr">x</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span> <span class="c1">//exact solution = tx^2(1-x)^2</span>
        <span class="n">Vh</span> <span class="kp">err</span> <span class="o">=</span> <span class="n">u</span> <span class="o">-</span> <span class="n">uex</span><span class="p">;</span> <span class="c1">// err = FE-sol - exact</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="nf">abs</span><span class="p">(</span><span class="kp">err</span><span class="p">[].</span><span class="kr">max</span><span class="p">)</span><span class="o">/</span><span class="nf">abs</span><span class="p">(</span><span class="n">uex</span><span class="p">[].</span><span class="kr">max</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="figure" id="figevolutiontimediff">
<img alt="../_images/EvolutionProblems_TimeDifference.png" src="../_images/EvolutionProblems_TimeDifference.png" />
<p class="caption"><span class="caption-number">Fig. 203 </span><span class="caption-text"><span class="math notranslate nohighlight">\(\max_{x\in\Omega}\vert u_h^n(\theta)-u_{ex}(n\tau)\vert\max_{x\in\Omega}\vert u_{ex}(n\tau)\vert at n=0,1,\cdots,29\)</span></span></p>
</div>
<p class="last">We can see in <a class="reference internal" href="#figevolutiontimediff"><span class="std std-numref">Fig. 203</span></a> that <span class="math notranslate nohighlight">\(u_h^n(\theta)\)</span> become unstable at <span class="math notranslate nohighlight">\(\theta=0.4\)</span>, and figures are omitted in the case <span class="math notranslate nohighlight">\(\theta&lt;0.4\)</span>.</p>
</div>
</div>
<div class="section" id="convection">
<h2>Convection<a class="headerlink" href="#convection" title="Permalink to this headline">¶</a></h2>
<p>The hyperbolic equation</p>
<div class="math notranslate nohighlight" id="equation-eqn-conv">
<span class="eqno">(54)<a class="headerlink" href="#equation-eqn-conv" title="Permalink to this equation">¶</a></span>\[\p_t u +\mathbf{\alpha} \cdot \nabla u=f;\ \textrm{ for a vector-valued function }\mathbf{\alpha}\]</div>
<p>appears frequently in scientific problems, for example in the Navier-Stokes equations, in the Convection-Diffusion equation, etc.</p>
<p>In the case of 1-dimensional space, we can easily find the general solution <span class="math notranslate nohighlight">\((x,t)\mapsto u(x,t)=u^0(x-\alpha t)\)</span> of the following equation, if <span class="math notranslate nohighlight">\(\alpha\)</span> is constant,</p>
<div class="math notranslate nohighlight" id="equation-eqn-conv0">
<span class="eqno">(55)<a class="headerlink" href="#equation-eqn-conv0" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{array}{rcl}
    \p_t u +\alpha\p_x u &amp;=&amp; 0\\
    u(x,0) &amp;=&amp; u^0(x),
\end{array}\end{split}\]</div>
<p>because <span class="math notranslate nohighlight">\(\p_t u +\alpha\p_x u=-\alpha\dot{u}^0+a\dot{u}^0=0\)</span>, where <span class="math notranslate nohighlight">\(\dot{u}^0=du^0(x)/dx\)</span>.</p>
<p>Even if <span class="math notranslate nohighlight">\(\alpha\)</span> is not constant, the construction works on similar principles.
One begins with the ordinary differential equation (with the convention that <span class="math notranslate nohighlight">\(\alpha\)</span> is prolonged by zero apart from <span class="math notranslate nohighlight">\((0,L)\times (0,T)\)</span>):</p>
<div class="math notranslate nohighlight">
\[\dot{X}(\tau )=+\alpha(X(\tau ),\tau ),\ \tau \in (0,t)\quad X(t)=x\]</div>
<p>In this equation <span class="math notranslate nohighlight">\(\tau\)</span> is the variable and <span class="math notranslate nohighlight">\(x,t\)</span> are parameters, and we denote the solution by <span class="math notranslate nohighlight">\(X_{x,t}(\tau )\)</span>.
Then it is noticed that <span class="math notranslate nohighlight">\((x,t)\rightarrow v(X(\tau),\tau)\)</span> in <span class="math notranslate nohighlight">\(\tau=t\)</span> satisfies the equation</p>
<div class="math notranslate nohighlight">
\[\p _{t}v+\alpha\p _{x}v=\p _{t}X\dot{v}+a\p _{x}X\dot{v}%
=0\]</div>
<p>and by the definition <span class="math notranslate nohighlight">\(\p _{t}X=\dot{X}=+\alpha\)</span> and <span class="math notranslate nohighlight">\(\p_{x}X=\p _{x}x\)</span> in <span class="math notranslate nohighlight">\(\tau=t\)</span>, because if <span class="math notranslate nohighlight">\(\tau =t\)</span> we have <span class="math notranslate nohighlight">\(X(\tau )=x\)</span>.</p>
<p>The general solution of <a class="reference internal" href="#equation-eqn-conv0">(55)</a> is thus the value of the boundary condition in <span class="math notranslate nohighlight">\(X_{x, t}(0)\)</span>, that is to say <span class="math notranslate nohighlight">\(u(x,t)=u^{0}(X_{x,t}(0))\)</span> where <span class="math notranslate nohighlight">\(X_{x,t}(0)\)</span> is on the <span class="math notranslate nohighlight">\(x\)</span> axis, <span class="math notranslate nohighlight">\(u(x,t)=u^{0}(X_{x,t}(0))\)</span> if <span class="math notranslate nohighlight">\(X_{x,t}(0)\)</span> is on the axis of <span class="math notranslate nohighlight">\(t\)</span>.</p>
<p>In higher dimension <span class="math notranslate nohighlight">\(\Omega \subset R^{d},~d=2,3\)</span>, the equation for the convection is written</p>
<div class="math notranslate nohighlight">
\[\p _{t}u+\mathbf{\alpha}\cdot \nabla u=0\hbox{ in }\Omega \times (0,T)\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{a}(x,t)\in \R^{d}\)</span>.</p>
<p><strong>FreeFem++</strong> implements the Characteristic-Galerkin method for convection operators.
Recall that the equation <a class="reference internal" href="#equation-eqn-conv">(54)</a> can be discretized as</p>
<div class="math notranslate nohighlight">
\[\frac{Du}{Dt} = f\;\;\textrm{i.e. }\frac{du}{dt}\left( {X(t),t} \right) = f\left(X( t ),t \right)\textrm{ where }\frac{dX}{dt}( t ) = \mathbf{\alpha}( {X(t),t})\]</div>
<p>where <span class="math notranslate nohighlight">\(D\)</span> is the total derivative operator.
So a good scheme is one step of backward convection by the method of Characteristics-Galerkin</p>
<div class="math notranslate nohighlight" id="equation-eqn-charac">
<span class="eqno">(56)<a class="headerlink" href="#equation-eqn-charac" title="Permalink to this equation">¶</a></span>\[\frac{1}{{\tau }}\left(u^{m + 1}(x) - u^m(X^m(x))\right) = f^m (x)\]</div>
<p>where <span class="math notranslate nohighlight">\(X^m (x)\)</span> is an approximation of the solution at <span class="math notranslate nohighlight">\(t = m\tau\)</span> of the ordinary differential equation</p>
<div class="math notranslate nohighlight">
\[\frac{d\mathbf{X}}{dt}(t) = \mathbf{\alpha}^m(\mathbf{X}(t)), \mathbf{X}((m + 1)\tau) = x.\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{\alpha}^m(x)=(\alpha_1(x,m\tau ),\alpha_2(x,m\tau))\)</span>.
Because, by Taylor’s expansion, we have</p>
<div class="math notranslate nohighlight" id="equation-eqn-conv1">
<span class="eqno">(57)<a class="headerlink" href="#equation-eqn-conv1" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{array}{rcl}
    u^m(\mathbf{X}(m\tau ))&amp;=&amp;
    u^m(\mathbf{X}((m+1)\tau )) -
    \tau \sum_{i=1}^d \frac{\p u^m}{\p x_i}(\mathbf{X}((m+1)\tau ))
    \frac{\p X_i}{\p t}((m+1)\tau )
    +o(\tau )\nonumber\\
    &amp;=&amp;u^m(x)-\tau \mathbf{\alpha}^m(x)\cdot \nabla u^m(x)+o(\tau )
\end{array}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(X_i(t)\)</span> are the i-th component of <span class="math notranslate nohighlight">\(\mathbf{X}(t)\)</span>, <span class="math notranslate nohighlight">\(u^m(x)=u(x,m\tau )\)</span> and we used the chain rule and <span class="math notranslate nohighlight">\(x=\mathbf{X}((m+1)\tau )\)</span>.
From <a class="reference internal" href="#equation-eqn-conv1">(57)</a>, it follows that</p>
<div class="math notranslate nohighlight">
\[u^m(X^m(x))=u^m(x)-\tau \mathbf{\alpha}^m(x)\cdot \nabla u^m(x)+o(\tau )\]</div>
<p>Also we apply Taylor’s expansion for <span class="math notranslate nohighlight">\(t \rightarrow u^m(x-\mathbf{\alpha}^m(x)t),0\le t\le \tau\)</span>, then</p>
<div class="math notranslate nohighlight">
\[u^m(x-\mathbf{\alpha}\tau )=u^m(x)-\tau \mathbf{\alpha}^m(x)\cdot \nabla u^m(x)+o(\tau ).\]</div>
<p>Putting</p>
<p><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">convect</span></code><span class="math notranslate nohighlight">\(\left( {\mathbf{\alpha},-\tau ,u^m } \right)\approx u^m \left(x - \mathbf{\alpha}^m\tau \right)\)</span></p>
<p>we can get the approximation</p>
<p><span class="math notranslate nohighlight">\(u^m \left( {X^m( x )} \right) \approx\)</span> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">convect</span></code> <span class="math notranslate nohighlight">\(\left( {[a_1^m ,a_2^m],-\tau ,u^m } \right)\)</span> by <span class="math notranslate nohighlight">\(X^m \approx x \mapsto x- \tau [a_1^m(x) ,a_2^m(x)]\)</span></p>
<p>A classical convection problem is that of the “rotating bell” (quoted from <a class="reference internal" href="../reference.html#lucquin1998" id="id3">[LUCQUIN1998]</a>, p.16).</p>
<p>Let <span class="math notranslate nohighlight">\(\Omega\)</span> be the unit disk centered at 0, with its center rotating with speed <span class="math notranslate nohighlight">\(\alpha_1 = y,\, \alpha_2 = -x\)</span>.
We consider the problem <a class="reference internal" href="#equation-eqn-conv">(54)</a> with <span class="math notranslate nohighlight">\(f=0\)</span> and the initial condition <span class="math notranslate nohighlight">\(u(x,0)=u^0(x)\)</span>, that is, from <a class="reference internal" href="#equation-eqn-charac">(56)</a></p>
<p><span class="math notranslate nohighlight">\(u^{m + 1}(x) = u^m(X^m(x))\approx\)</span> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">convect</span></code><span class="math notranslate nohighlight">\((\mathbf{\alpha},-\tau ,u^m)\)</span></p>
<p>The exact solution is <span class="math notranslate nohighlight">\(u(x, t) = u(\mathbf{X}(t))\)</span> where <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> equals <span class="math notranslate nohighlight">\(x\)</span> rotated around the origin by an angle <span class="math notranslate nohighlight">\(\theta = -t\)</span> (rotate in clockwise).
So, if <span class="math notranslate nohighlight">\(u^0\)</span> in a 3D perspective looks like a bell, then <span class="math notranslate nohighlight">\(u\)</span> will have exactly the same shape, but rotated by the same amount.
The program consists in solving the equation until <span class="math notranslate nohighlight">\(T = 2\pi\)</span>, that is for a full revolution and to compare the final solution with the initial one; they should be equal.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Convect</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">real</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.17</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">C</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);}</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="mi">70</span><span class="p">));</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u0</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">a1</span> <span class="o">=</span> <span class="o">-</span><span class="kr">y</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="kr">x</span><span class="p">;</span> <span class="c1">//rotation velocity</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">;</span>

<span class="c1">// Initialization</span>
<span class="n">u</span> <span class="o">=</span> <span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="o">*</span><span class="p">((</span><span class="kr">x</span><span class="o">-</span><span class="mf">0.3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span><span class="p">(</span><span class="kr">y</span><span class="o">-</span><span class="mf">0.3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">));</span>

<span class="c1">// Time loop</span>
<span class="kt">real</span> <span class="kp">t</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="kr">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">m</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">/</span><span class="n">dt</span><span class="p">;</span> <span class="kr">m</span><span class="o">++</span><span class="p">){</span>
    <span class="c1">// Update</span>
    <span class="kp">t</span> <span class="o">+=</span> <span class="n">dt</span><span class="p">;</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

    <span class="c1">// Convect</span>
    <span class="n">u</span> <span class="o">=</span> <span class="nf">convect</span><span class="p">([</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">],</span> <span class="o">-</span><span class="n">dt</span><span class="p">,</span> <span class="n">u0</span><span class="p">);</span> <span class="c1">//u^{m+1}=u^m(X^m(x))</span>

    <span class="c1">// Plot</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot; t=&quot;</span><span class="o">+</span><span class="kp">t</span><span class="o">+</span><span class="s">&quot;, min=&quot;</span><span class="o">+</span><span class="n">u</span><span class="p">[].</span><span class="kr">min</span><span class="o">+</span><span class="s">&quot;, max=&quot;</span><span class="o">+</span><span class="n">u</span><span class="p">[].</span><span class="kr">max</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The scheme <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">convect</span></code> is unconditionally stable, then the bell become lower and lower (the maximum of <span class="math notranslate nohighlight">\(u^{37}\)</span> is <span class="math notranslate nohighlight">\(0.406\)</span> as shown in <a class="reference internal" href="#figevolutionconvect"><span class="std std-numref">Fig. 205</span></a>.</p>
</div>
<div class="inline2 figure" id="id6">
<img alt="../_images/EvolutionProblem_Convect.png" src="../_images/EvolutionProblem_Convect.png" />
<p class="caption"><span class="caption-number">Fig. 204 </span><span class="caption-text"><span class="math notranslate nohighlight">\(u^0=e^{-10((x-0.3)^2 +(y-0.3)^2)}\)</span></span></p>
</div>
<div class="inline2 last figure" id="figevolutionconvect">
<img alt="../_images/EvolutionProblem_Convect2.png" src="../_images/EvolutionProblem_Convect2.png" />
<p class="caption"><span class="caption-number">Fig. 205 </span><span class="caption-text">The bell at <span class="math notranslate nohighlight">\(t=6.29\)</span></span></p>
</div>
</div>
</div>
<div class="section" id="d-black-scholes-equation-for-an-european-put-option">
<h2>2D Black-Scholes equation for an European Put option<a class="headerlink" href="#d-black-scholes-equation-for-an-european-put-option" title="Permalink to this headline">¶</a></h2>
<p>In mathematical finance, an option on two assets is modeled by a Black-Scholes equations in two space variables, (see for example <a class="reference internal" href="../reference.html#wilmott1995" id="id4">[WILMOTT1995]</a> or <a class="reference internal" href="../reference.html#achdou2005" id="id5">[ACHDOU2005]</a>).</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    \p _t u &amp;+&amp; \frac{{\left( {\sigma _1 x } \right)^2 }}{2}\frac{{\p ^2 u}}{{\p x^2 }} + \frac{{\left( {\sigma _2 y } \right)^2 }}{2}\frac{{\p ^2 u}}{{\p y^2 }} \\
    &amp;&amp;{\rm{ }} + \rho x y \frac{{\p ^2 u}}{{\p x \p y }} + rS_1 \frac{{\p u}}{{\p x }} + rS_2 \frac{{\p u}}{{\p y }} - rP = 0 \nonumber
\end{array}\end{split}\]</div>
<p>which is to be integrated in <span class="math notranslate nohighlight">\(\left( {0,T} \right) \times \R^ + \times \R^ +\)</span> subject to, in the case of a put</p>
<div class="math notranslate nohighlight">
\[u\left( {x , y ,T} \right) = \left( {K - \max \left( {x ,y } \right)} \right)^+\]</div>
<p>Boundary conditions for this problem may not be so easy to device.
As in the one dimensional case the PDE contains boundary conditions on the axis <span class="math notranslate nohighlight">\(x_1 = 0\)</span> and on the axis <span class="math notranslate nohighlight">\(x_2 = 0\)</span>, namely two one dimensional Black-Scholes equations driven respectively by the data <span class="math notranslate nohighlight">\(u\left( {0, + \infty ,T} \right)\)</span> and <span class="math notranslate nohighlight">\(u\left( { + \infty ,0,T} \right)\)</span>.
These will be automatically accounted for because they are embedded in the PDE.
So if we do nothing in the variational form (i.e.&nbsp;if we take a Neumann boundary condition at these two axis in the strong form) there will be no disturbance to these.
At infinity in one of the variable, as in 1D, it makes sense to impose <span class="math notranslate nohighlight">\(u=0\)</span>.
We take</p>
<div class="math notranslate nohighlight">
\[\sigma _1  = 0.3,\;\;\sigma _2  = 0.3,\;\;\rho  = 0.3,\;\;r = 0.05,\;\;K = 40,\;\;T = 0.5\]</div>
<p>An implicit Euler scheme is used and a mesh adaptation is done every 10 time steps.
To have an unconditionally stable scheme, the first order terms are treated by the Characteristic Galerkin method, which, roughly, approximates</p>
<div class="math notranslate nohighlight">
\[\frac{{\p u}}{{\p t}} + a_1 \frac{{\p u}}{{\p x}} + a_2 \frac{{\p u}}{{\p y}} \approx \frac{1}{{\tau }}\left( {u^{n + 1} \left( x \right) - u^n \left( {x - \mathbf{\alpha}\tau } \right)} \right)\]</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Black-Scholes</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="kr">m</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span> <span class="kt">int</span> <span class="n">L</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span> <span class="kt">int</span> <span class="n">LL</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="kt">real</span> <span class="n">sigx</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span> <span class="kt">real</span> <span class="n">sigy</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span> <span class="kt">real</span> <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span> <span class="kt">real</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">;</span> <span class="kt">real</span> <span class="n">K</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span> <span class="kt">real</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="kr">m</span><span class="p">,</span> <span class="kr">m</span><span class="p">,</span> <span class="p">[</span><span class="n">L</span><span class="o">*</span><span class="kr">x</span><span class="p">,</span> <span class="n">LL</span><span class="o">*</span><span class="kr">y</span><span class="p">]);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u</span> <span class="o">=</span> <span class="kr">max</span><span class="p">(</span><span class="n">K</span><span class="o">-</span><span class="kr">max</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span><span class="kr">y</span><span class="p">),</span><span class="mf">0.</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">xveloc</span><span class="p">,</span> <span class="n">yveloc</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">uold</span><span class="p">;</span>

<span class="c1">// Time loop</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">n</span><span class="o">*</span><span class="n">dt</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">;</span> <span class="kr">n</span><span class="o">++</span><span class="p">){</span>
    <span class="c1">// Mesh adaptation</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">){</span>
        <span class="n">th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">abserror</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">nbjacoby</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="kp">err</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="kp">nbvx</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="kp">omega</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="kp">ratio</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="kp">nbsmooth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="kp">splitpbedge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">maxsubdiv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="kp">rescaling</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">xveloc</span> <span class="o">=</span> <span class="o">-</span><span class="kr">x</span><span class="o">*</span><span class="n">r</span> <span class="o">+</span> <span class="kr">x</span><span class="o">*</span><span class="n">sigx</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="kr">x</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">sigx</span><span class="o">*</span><span class="n">sigy</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
        <span class="n">yveloc</span> <span class="o">=</span> <span class="o">-</span><span class="kr">y</span><span class="o">*</span><span class="n">r</span> <span class="o">+</span> <span class="kr">y</span><span class="o">*</span><span class="n">sigy</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="kr">y</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">sigx</span><span class="o">*</span><span class="n">sigy</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Update</span>
    <span class="n">uold</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

    <span class="c1">// Solve</span>
    <span class="kt">solve</span> <span class="nf">eq1</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="kp">init</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">LU</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)(</span>
              <span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>
            <span class="o">+</span> <span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kr">x</span><span class="o">*</span><span class="n">sigx</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
            <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kr">y</span><span class="o">*</span><span class="n">sigy</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
            <span class="o">+</span> <span class="p">(</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">sigx</span><span class="o">*</span><span class="n">sigy</span><span class="o">*</span><span class="kr">x</span><span class="o">*</span><span class="kr">y</span><span class="o">/</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)(</span>
              <span class="n">v</span><span class="o">*</span><span class="nf">convect</span><span class="p">([</span><span class="n">xveloc</span><span class="p">,</span> <span class="n">yveloc</span><span class="p">],</span> <span class="n">dt</span><span class="p">,</span> <span class="n">uold</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="c1">// Update</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
</pre></div>
</div>
<p>Results are shown on <a class="reference internal" href="#figevolutionblacksholes1"><span class="std std-numref">Fig. 206</span></a> and <a class="reference internal" href="#figevolutionblacksholes2"><span class="std std-numref">Fig. 207</span></a>.</p>
<div class="inline2 figure" id="figevolutionblacksholes1">
<img alt="../_images/EvolutionProblems_BlackSholes.png" src="../_images/EvolutionProblems_BlackSholes.png" />
<p class="caption"><span class="caption-number">Fig. 206 </span><span class="caption-text">The adapted triangulation</span></p>
</div>
<div class="inline2 last figure" id="figevolutionblacksholes2">
<img alt="../_images/EvolutionProblems_BlackSholes2.png" src="../_images/EvolutionProblems_BlackSholes2.png" />
<p class="caption"><span class="caption-number">Fig. 207 </span><span class="caption-text">The level line of the European basquet put option</span></p>
</div>
</div>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>