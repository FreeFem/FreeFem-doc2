<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Compressible Neo-Hookean materials</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">Compressible Neo-Hookean materials</a><ul>
<li><a class="reference internal" href="#notation">Notation</a></li>
<li><a class="reference internal" href="#recommended-references">Recommended References</a></li>
<li><a class="reference internal" href="#a-neo-hookean-compressible-material">A Neo-Hookean Compressible Material</a></li>
<li><a class="reference internal" href="#an-approach-to-implementation-in-freefem">An Approach to Implementation in FreeFem++</a></li>
</ul>
</li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="section" id="compressible-neo-hookean-materials">
<h1>Compressible Neo-Hookean materials<a class="headerlink" href="#compressible-neo-hookean-materials" title="Permalink to this headline">¶</a></h1>
<p>Author: <em>Alex Sadovsky</em></p>
<div class="math notranslate nohighlight">
\[\begin{split}\def\bR{{\bf R}}
\def\bP{{\bf P}}
\def\bZ{{\bf Z}}
\def\bC{{\bf C}}
\def\VS{\bR^2}
\def\SVS{\underline V}
\def\SO{{\bf SO}}
\def\Sym{{\bf Sym}}
\def\qi{{\bf i}}
\def\qj{{\bf j}}
\def\qk{{\bf k}}
\def\ec{\hat{\bf e}}
\def\xc{\hat{\bf x}}
\def\bdr{\partial}
\def\PD{\partial_}
\def\strain{\underline \epsilon}
\def\stress{\underline \sigma}
\def\strainrate{\underline \epsilon^.}
\def\stressrate{\underline \sigma^.}
\def\stiff{\; \underline{\underline C}\;}
\def\comply{\underline{\underline \kappa}\;}
\def\Id{{\bf I}}
\def\Div{\nabla \cdot}
\def\Grad{\mathbf{\nabla}}
\def\rot{\nabla \times}
\def\lap{\triangle}
\def\tr{{\bf tr}\;}
\def\udH{\underline H}
\def\refX{\mathbf X}
\def\Jac{\overline{J}}
\def\spatx{\mathbf x}
\def\ani{\overline a}
\def\mat{\left[\begin{array}}
\def\tam{\end{array}\right]}
\def\arr{\left.\begin{array}}
\def\rra{\end{array}\right\}}
\def\arl{\left\{\begin{array}}
\def\lra{\end{array}\right.}
\def\ar{\begin{array}}
\def\ra{\end{array}}
\def\const{\mbox{ const.}}
\def\eps{\; \epsilon}
\def\sig{\; \sigma}
\def\th{\theta}
\def\sgn{\mbox{sgn}}
\def\qed{\; Q.E.D.\\}
\def\ranqe{\end{eqnarray}}
\def\ol{\overline}
\def\ul{\underline}
\def\bB{{\bf B}}
\def\bC{{\bf C}}
\def\bD{{\bf D}}
\def\bE{{\bf E}}
\def\bF{{\bf F}}
\def\bK{{\bf K}}
\def\bP{{\bf P}}
\def\bS{{\bf S}}
\def\bT{{\bf T}}
\def\bsig{{\bf \sigma}}\end{split}\]</div>
<div class="section" id="notation">
<h2>Notation<a class="headerlink" href="#notation" title="Permalink to this headline">¶</a></h2>
<p>In what follows, the symbols <span class="math notranslate nohighlight">\(\mathbf{u}, \bF, \bB, \bC, \stress\)</span> denote, respectively, the displacement field, the deformation gradient, the left Cauchy-Green strain tensor <span class="math notranslate nohighlight">\(\bB = \bF \bF^T\)</span>, the right Cauchy-Green strain tensor <span class="math notranslate nohighlight">\(\bC =\bF^T \bF\)</span>, and the Cauchy stress tensor.</p>
<p>We also introduce the symbols <span class="math notranslate nohighlight">\(I_1 := \tr \bC\)</span> and <span class="math notranslate nohighlight">\(J := \det\bF\)</span>.
Use will be made of the identity:</p>
<div class="math notranslate nohighlight">
\[{\PD{}J \over \PD{}\bC} = J \bC^{-1}\]</div>
<p>The symbol <span class="math notranslate nohighlight">\(\Id\)</span> denotes the identity tensor.
The symbol <span class="math notranslate nohighlight">\(\Omega_{0}\)</span> denotes the reference configuration of the body to be deformed.
The unit volume in the reference (resp., deformed) configuration is denoted <span class="math notranslate nohighlight">\(dV\)</span> (resp., <span class="math notranslate nohighlight">\(dV_{0}\)</span>); these two are related by:</p>
<div class="math notranslate nohighlight">
\[dV = J dV_{0},\]</div>
<p>which allows an integral over <span class="math notranslate nohighlight">\(\Omega\)</span> involving the Cauchy stress <span class="math notranslate nohighlight">\(\bT\)</span> to be rewritten as an integral of the Kirchhoff stress <span class="math notranslate nohighlight">\(\kappa = J \bT\)</span> over <span class="math notranslate nohighlight">\(\Omega_{0}\)</span>.</p>
</div>
<div class="section" id="recommended-references">
<h2>Recommended References<a class="headerlink" href="#recommended-references" title="Permalink to this headline">¶</a></h2>
<p>For an exposition of nonlinear elasticity and of the underlying linear and tensor algebra, see <a class="reference internal" href="../reference.html#ogden1984" id="id1">[OGDEN1984]</a>.
For an advanced mathematical analysis of the Finite Element Method, see <a class="reference internal" href="../reference.html#raviart1998" id="id2">[RAVIART1998]</a>.</p>
</div>
<div class="section" id="a-neo-hookean-compressible-material">
<h2>A Neo-Hookean Compressible Material<a class="headerlink" href="#a-neo-hookean-compressible-material" title="Permalink to this headline">¶</a></h2>
<p><em>Constitutive Theory and Tangent Stress Measures</em></p>
<p>The strain energy density function is given by:</p>
<div class="math notranslate nohighlight">
\[W = {\mu \over 2}(I_1 - \tr \Id - 2 \ln J)\]</div>
<p>(see <a class="reference internal" href="../reference.html#horgan2004" id="id3">[HORGAN2004]</a>, formula (12)).</p>
<p>The corresponding 2nd Piola-Kirchoff stress tensor is given by:</p>
<div class="math notranslate nohighlight">
\[\bS_{n} := {\PD{} W \over \PD{}\bE} (\bF_{n})
=
\mu (\Id - \bC^{-1})\]</div>
<p>The Kirchhoff stress, then, is:</p>
<div class="math notranslate nohighlight">
\[\kappa
= \bF \bS \bF^{T}
= \mu (\bB - \Id)\]</div>
<p>The tangent Kirchhoff stress tensor at <span class="math notranslate nohighlight">\(\bF_{n}\)</span> acting on <span class="math notranslate nohighlight">\(\delta \bF_{n+1}\)</span> is, consequently:</p>
<div class="math notranslate nohighlight">
\[{\PD{} \kappa \over \PD{} \bF} (\bF_{n}) \delta \bF_{n+1}
=
\mu
\left[
\bF_{n} (\delta \bF_{n+1})^T
+
\delta \bF_{n+1} (\bF_{n})^T
\right]\]</div>
<p><em>The Weak Form of the BVP in the Absence of Body (External) Forces</em></p>
<p>The <span class="math notranslate nohighlight">\(\Omega_0\)</span> we are considering is an elliptical annulus, whose boundary consists of two concentric ellipses (each allowed to be a circle as a special case), with the major axes parallel.
Let <span class="math notranslate nohighlight">\(P\)</span> denote the dead stress load (traction) on a portion <span class="math notranslate nohighlight">\(\partial \Omega_0^{t}\)</span> (= the inner ellipse) of the boundary <span class="math notranslate nohighlight">\(\partial \Omega_0\)</span>.
On the rest of the boundary, we prescribe zero displacement.</p>
<p>The weak formulation of the boundary value problem is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\arr{lll}
0
&amp; = &amp;
\int_{\Omega_0}
\kappa[\bF]
\:
:
\:
\left\{
(\Grad \otimes \mathbf{w}) (\bF)^{-1}
\right\}\\
&amp; - &amp; \int_{\PD{} \Omega_0^{t}} P \cdot \hat{N}_0\\
\rra\end{split}\]</div>
<p>For brevity, in the rest of this section we assume <span class="math notranslate nohighlight">\(P = 0\)</span>.
The provided FreeFem++ code, however, does not rely on this assumption and allows for a general value and direction of <span class="math notranslate nohighlight">\(P\)</span>.</p>
<p>Given a Newton approximation <span class="math notranslate nohighlight">\(\mathbf{u}_n\)</span> of the displacement field <span class="math notranslate nohighlight">\(\mathbf{u}\)</span> satisfying the BVP, we seek the correction <span class="math notranslate nohighlight">\(\delta \mathbf{u}_{n+1}\)</span> to obtain a better approximation:</p>
<div class="math notranslate nohighlight">
\[\mathbf{u}_{n+1} = \mathbf{u}_{n} + \delta \mathbf{u}_{n+1}\]</div>
<p>by solving the weak formulation:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\arr{lll}
    0 &amp;=&amp; \int_{\Omega_0}\kappa[\bF_{n} + \delta \bF_{n+1}]\: :\: \left\{(\Grad \otimes \mathbf{w}) (\bF_{n} + \delta\bF_{n+1})^{-1}\right\}- \int_{\PD{} \Omega_0} P \cdot \hat{N}_0\\
    &amp;=&amp; \int_{\Omega_0}\left\{\kappa[\bF_{n}] + {\PD{} \kappa \over \PD{} \bF}[\bF_{n}]\delta \bF_{n+1}\right\}\: :\: \left\{(\Grad \otimes \mathbf{w})(\bF_{n} + \delta \bF_{n+1})^{-1}\right\}\\
    &amp;=&amp; \int_{\Omega_0}\left\{\kappa[\bF_{n}] + {\PD{} \kappa \over \PD{} \bF}[\bF_{n}]\delta \bF_{n+1}\right\}\: :\: \left\{(\Grad \otimes \mathbf{w}) (\bF_{n}^{-1} + \bF_{n}^{-2} \delta \bF_{n+1})\right\}\\
    \\
    &amp;=&amp; \int_{\Omega_0}\kappa[\bF_{n}]\: :\: \left\{(\Grad \otimes \mathbf{w})\bF_{n}^{-1}\right\}\\
    &amp;-&amp; \int_{\Omega_0}\kappa[\bF_{n}]\: :\: \left\{(\Grad \otimes \mathbf{w})(\bF_{n}^{-2} \delta \bF_{n+1})\right\}\\
    &amp;+&amp; \int_{\Omega_0}\left\{{\PD{} \kappa \over \PD{} \bF}[\bF_{n}]\delta \bF_{n+1}\right\}\: :\: \left\{(\Grad \otimes \mathbf{w})
\bF_{n}^{-1}
\right\}
\\
\rra
\quad
\mbox{for all test functions} \mathbf{w},\end{split}\]</div>
<p>where we have taken:</p>
<div class="math notranslate nohighlight">
\[\delta \bF_{n+1} = \Grad \otimes \delta \mathbf{u}_{n+1}\]</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Contrary to standard notational use, the symbol <span class="math notranslate nohighlight">\(\delta\)</span> here bears no variational context.
By <span class="math notranslate nohighlight">\(\delta\)</span> we mean simply an increment in the sense of Newton’s Method.
The role of a variational virtual displacement here is played by <span class="math notranslate nohighlight">\(\mathbf{w}\)</span>.</p>
</div>
</div>
<div class="section" id="an-approach-to-implementation-in-freefem">
<h2>An Approach to Implementation in FreeFem++<a class="headerlink" href="#an-approach-to-implementation-in-freefem" title="Permalink to this headline">¶</a></h2>
<p>Introducing the code-like notation, where a string in <span class="math notranslate nohighlight">\(&lt; &gt;\)</span>’s is to be read as one symbol, the individual components of the tensor:</p>
<div class="math notranslate nohighlight">
\[&lt;TanK&gt;
 :=
{\PD{} \kappa \over \PD{} \bF}[\bF_{n}]
\delta \bF_{n+1}\]</div>
<p>will be implemented as the macros <span class="math notranslate nohighlight">\(&lt;TanK11&gt;\)</span>, <span class="math notranslate nohighlight">\(&lt;TanK12&gt;\)</span>, …</p>
<p>The individual components of the tensor quantities:</p>
<div class="math notranslate nohighlight">
\[\bD_{1} :=
\bF_{n} (\delta \bF_{n+1})^T
+
\delta \bF_{n+1} (\bF_{n})^T,\]</div>
<div class="math notranslate nohighlight">
\[\bD_{2} :=
\bF_{n}^{-T} \delta \bF_{n+1},\]</div>
<div class="math notranslate nohighlight">
\[\bD_{3} :=
(\Grad \otimes \mathbf{w})
\bF_{n}^{-2} \delta \bF_{n+1},\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[\bD_{4} :=
(\Grad \otimes \mathbf{w})
\bF_{n}^{-1},\]</div>
<p>will be implemented as the macros:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\arr{l}
&lt;d1Aux11&gt;, &lt;d1Aux12&gt;, \quad \ldots \quad, &lt;d1Aux22&gt;,\\
&lt;d2Aux11&gt;, &lt;d2Aux12&gt;, \quad \ldots \quad, &lt;d2Aux22&gt;\\
&lt;d3Aux11&gt;, &lt;d3Aux12&gt;, \quad \ldots \quad, &lt;d3Aux22&gt;\\
&lt;d4Aux11&gt;, &lt;d4Aux12&gt;, \quad \ldots \quad, &lt;d4Aux22&gt;\\
\rra,\end{split}\]</div>
<p>respectively.</p>
<p>In the above notation, the tangent Kirchhoff stress term becomes</p>
<div class="math notranslate nohighlight">
\[{\PD{} \kappa \over \PD{} \bF} (\bF_{n})
\: \delta \bF_{n+1}
=
\mu
\: \bD_{1}\]</div>
<p>while the weak BVP formulation acquires the form:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\arr{lll}
0 &amp; = &amp;
\int_{\Omega_0}
\kappa[\bF_{n}]
\:
:
\:
\bD_{4}
\\
&amp;-&amp;
\int_{\Omega_0}
\kappa[\bF_{n}]
\:
:
\:
\bD_{3}
\\
&amp;+&amp;
\int_{\Omega_0}
\left\{
{\PD{} \kappa \over \PD{} \bF}[\bF_{n}]
\delta \bF_{n+1}
\right\}
\:
:
\:
\bD_{4}
\\
\rra
\quad
\mbox{for all test functions} \mathbf{w}\end{split}\]</div>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Macro</span>
<span class="c1">//Macros for the gradient of a vector field (u1, u2)</span>
<span class="kt">macro</span> <span class="nf">grad11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u1</span><span class="p">))</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">grad21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="nf">dy</span><span class="p">(</span><span class="n">u1</span><span class="p">))</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">grad12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u2</span><span class="p">))</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">grad22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="nf">dy</span><span class="p">(</span><span class="n">u2</span><span class="p">))</span> <span class="c1">//</span>

<span class="c1">//Macros for the deformation gradient</span>
<span class="kt">macro</span> <span class="n">F11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">grad11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">))</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">F12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">+</span> <span class="n">grad12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">))</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">F21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">+</span> <span class="n">grad21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">))</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">F22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">grad22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">))</span> <span class="c1">//</span>

<span class="c1">//Macros for the incremental deformation gradient</span>
<span class="kt">macro</span> <span class="n">dF11</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span><span class="n">grad11</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">))</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">dF12</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span><span class="n">grad12</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">))</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">dF21</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span><span class="n">grad21</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">))</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">dF22</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span><span class="n">grad22</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">))</span> <span class="c1">//</span>

<span class="c1">//Macro for the determinant of the deformation gradient</span>
<span class="kt">macro</span> <span class="n">J</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">F11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">F22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">-</span> <span class="n">F12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">F21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span> <span class="c1">//</span>

<span class="c1">//Macros for the inverse of the deformation gradient</span>
<span class="kt">macro</span> <span class="n">Finv11</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">F22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">/</span> <span class="n">J</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">Finv22</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">F11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">/</span> <span class="n">J</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">Finv12</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
    <span class="o">-</span> <span class="n">F12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">/</span> <span class="n">J</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">Finv21</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
    <span class="o">-</span> <span class="n">F21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">/</span> <span class="n">J</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span> <span class="c1">//</span>

<span class="c1">//Macros for the square of the inverse of the deformation gradient</span>
<span class="kt">macro</span> <span class="n">FFinv11</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">Finv11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>
    <span class="o">+</span> <span class="n">Finv12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">Finv21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span> <span class="c1">//</span>

<span class="kt">macro</span> <span class="n">FFinv12</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">Finv12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Finv11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">Finv22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">))</span>
<span class="p">)</span> <span class="c1">//</span>

<span class="kt">macro</span> <span class="n">FFinv21</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">Finv21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Finv11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">Finv22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">))</span>
<span class="p">)</span> <span class="c1">//</span>

<span class="kt">macro</span> <span class="n">FFinv22</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">Finv12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">Finv21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">Finv22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>
<span class="p">)</span> <span class="c1">//</span>

<span class="c1">//Macros for the inverse of the transpose of the deformation gradient</span>
<span class="kt">macro</span> <span class="n">FinvT11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="n">Finv11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">))</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">FinvT12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="n">Finv21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">))</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">FinvT21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="n">Finv12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">))</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">FinvT22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="n">Finv22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">))</span> <span class="c1">//</span>

<span class="c1">//The left Cauchy-Green strain tensor</span>
<span class="kt">macro</span> <span class="n">B11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">F11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">F12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">B12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">F11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">F21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">F12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">F22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">B21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">F11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">F21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">F12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">F22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">B22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)(</span>
      <span class="n">F21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">F22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>
<span class="p">)</span><span class="c1">//</span>

<span class="c1">//The macros for the auxiliary tensors (D0, D1, D2, ...): Begin</span>
<span class="o">//</span><span class="n">The</span> <span class="n">tensor</span> <span class="n">quantity</span> <span class="n">D0</span> <span class="o">=</span> <span class="n">F</span><span class="p">{</span><span class="kr">n</span><span class="p">}</span> <span class="p">(</span><span class="n">delta</span> <span class="n">F</span><span class="p">{</span><span class="kr">n</span><span class="o">+</span><span class="mi">1</span><span class="p">})</span><span class="o">^</span><span class="n">T</span>
<span class="kt">macro</span> <span class="n">d0Aux11</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">dF11</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">F11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF12</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">F12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d0Aux12</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">dF21</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">F11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF22</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">F12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d0Aux21</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">dF11</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">F21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF12</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">F22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d0Aux22</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">dF21</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">F21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF22</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">F22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="c1">///The tensor quantity D1 = D0 + D0^T</span>
<span class="kt">macro</span> <span class="n">d1Aux11</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="mf">2.0</span> <span class="o">*</span> <span class="n">d0Aux11</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d1Aux12</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">d0Aux12</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">d0Aux21</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d1Aux21</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">d1Aux12</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d1Aux22</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)(</span>
      <span class="mf">2.0</span> <span class="o">*</span> <span class="n">d0Aux22</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="c1">///The tensor quantity D2 = F^{-T}_{n} dF_{n+1}</span>
<span class="kt">macro</span> <span class="n">d2Aux11</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">dF11</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FinvT11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF21</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FinvT12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d2Aux12</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">dF12</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FinvT11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF22</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FinvT12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d2Aux21</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">dF11</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FinvT21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF21</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FinvT22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d2Aux22</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">dF12</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FinvT21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF22</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FinvT22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="c1">///The tensor quantity D3 = F^{-2}_{n} dF_{n+1}</span>
<span class="kt">macro</span> <span class="n">d3Aux11</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">dF11</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad11</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF21</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad11</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF11</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad12</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF21</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad12</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d3Aux12</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">dF12</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad11</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF22</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad11</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF12</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad12</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF22</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad12</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d3Aux21</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">dF11</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad21</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF21</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad21</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF11</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad22</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF21</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad22</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d3Aux22</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">dF12</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad21</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF22</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad21</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF12</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad22</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">dF22</span><span class="p">(</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">FFinv22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad22</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="c1">///The tensor quantity D4 = (grad w) * Finv</span>
<span class="kt">macro</span> <span class="n">d4Aux11</span> <span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">Finv11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">grad11</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">Finv21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">grad12</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d4Aux12</span> <span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">Finv12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">grad11</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">Finv22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">grad12</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d4Aux21</span> <span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">Finv11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">grad21</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">Finv21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">grad22</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">d4Aux22</span> <span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">Finv12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">grad21</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">Finv22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">grad22</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>
<span class="c1">//The macros for the auxiliary tensors (D0, D1, D2, ...): End</span>

<span class="c1">//The macros for the various stress measures: BEGIN</span>
<span class="c1">//The Kirchhoff stress tensor</span>
<span class="kt">macro</span> <span class="n">StressK11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">B11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="c1">//The Kirchhoff stress tensor</span>
<span class="kt">macro</span> <span class="n">StressK12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">mu</span> <span class="o">*</span> <span class="n">B12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="c1">//The Kirchhoff stress tensor</span>
<span class="kt">macro</span> <span class="n">StressK21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">mu</span> <span class="o">*</span> <span class="n">B21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="c1">//The Kirchhoff stress tensor</span>
<span class="kt">macro</span> <span class="n">StressK22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">B22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="c1">//The tangent Kirchhoff stress tensor</span>
<span class="kt">macro</span> <span class="n">TanK11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">mu</span> <span class="o">*</span> <span class="n">d1Aux11</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">TanK12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">mu</span> <span class="o">*</span> <span class="n">d1Aux12</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">TanK21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">mu</span> <span class="o">*</span> <span class="n">d1Aux21</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>

<span class="kt">macro</span> <span class="n">TanK22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">mu</span> <span class="o">*</span> <span class="n">d1Aux22</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span>
<span class="p">)</span><span class="c1">//</span>
<span class="c1">//The macros for the stress tensor components: END</span>

<span class="c1">// Parameters</span>
<span class="kt">real</span> <span class="n">mu</span> <span class="o">=</span> <span class="mf">5.e2</span><span class="p">;</span> <span class="c1">//Elastic coefficients (kg/cm^2)</span>
<span class="kt">real</span> <span class="n">D</span> <span class="o">=</span> <span class="mf">1.e3</span><span class="p">;</span> <span class="c1">//(1 / compressibility)</span>
<span class="kt">real</span> <span class="n">Pa</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.e2</span><span class="p">;</span> <span class="c1">//Stress loads</span>

<span class="kt">real</span> <span class="n">InnerRadius</span> <span class="o">=</span> <span class="mf">1.e0</span><span class="p">;</span> <span class="c1">//The wound radius</span>
<span class="kt">real</span> <span class="n">OuterRadius</span> <span class="o">=</span> <span class="mf">4.e0</span><span class="p">;</span> <span class="c1">//The outer (truncated) radius</span>
<span class="kt">real</span> <span class="kp">tol</span> <span class="o">=</span> <span class="mf">1.e-4</span><span class="p">;</span> <span class="c1">//Tolerance (L^2)</span>
<span class="kt">real</span> <span class="n">InnerEllipseExtension</span> <span class="o">=</span> <span class="mf">1.e0</span><span class="p">;</span> <span class="c1">//Extension of the inner ellipse ((major axis) - (minor axis))</span>

<span class="kt">int</span> <span class="kr">m</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">InnerEdge</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">InnerEllipseExtension</span><span class="p">)</span><span class="o">*</span><span class="n">InnerRadius</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="n">InnerRadius</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">OuterEdge</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">InnerEllipseExtension</span><span class="p">)</span><span class="o">*</span><span class="n">OuterRadius</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="n">OuterRadius</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;}</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">InnerEdge</span><span class="p">(</span><span class="o">-</span><span class="kr">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">OuterEdge</span><span class="p">(</span><span class="kr">n</span><span class="p">));</span>
<span class="kt">int</span> <span class="n">bottom</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Wh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1dc</span><span class="p">);</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="p">[</span><span class="nc">P1</span><span class="p">,</span> <span class="nc">P1</span><span class="p">]);</span>
<span class="n">Vh</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">],</span> <span class="p">[</span><span class="n">u1n</span><span class="p">,</span><span class="n">u2n</span><span class="p">],</span> <span class="p">[</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">];</span>
<span class="n">Vh</span> <span class="p">[</span><span class="n">ehat1x</span><span class="p">,</span> <span class="n">ehat1y</span><span class="p">],</span> <span class="p">[</span><span class="n">ehat2x</span><span class="p">,</span> <span class="n">ehat2y</span><span class="p">];</span>
<span class="n">Vh</span> <span class="p">[</span><span class="n">auxVec1</span><span class="p">,</span> <span class="n">auxVec2</span><span class="p">];</span> <span class="c1">//The individual elements of the total 1st Piola-Kirchoff stress</span>
<span class="n">Vh</span> <span class="p">[</span><span class="n">ef1</span><span class="p">,</span> <span class="n">ef2</span><span class="p">];</span>

<span class="kt">fespace</span> <span class="nf">Sh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Sh</span> <span class="n">p</span><span class="p">,</span> <span class="n">ppp</span><span class="p">;</span>
<span class="n">Sh</span> <span class="n">StrK11</span><span class="p">,</span> <span class="n">StrK12</span><span class="p">,</span> <span class="n">StrK21</span><span class="p">,</span> <span class="n">StrK22</span><span class="p">;</span>
<span class="n">Sh</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">varf</span> <span class="nf">vfMass1D</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="n">Mass1D</span> <span class="o">=</span> <span class="n">vfMass1D</span><span class="p">(</span><span class="n">Sh</span><span class="p">,</span> <span class="n">Sh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">);</span>

<span class="n">p</span><span class="p">[]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">ppp</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Mass1D</span> <span class="o">*</span> <span class="n">p</span><span class="p">[];</span>

<span class="kt">real</span> <span class="n">DomainMass</span> <span class="o">=</span> <span class="n">ppp</span><span class="p">[].</span><span class="kr">sum</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;DomainMass = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">DomainMass</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">varf</span> <span class="nf">vmass</span> <span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">],</span> <span class="p">[</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">],</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span> <span class="p">(</span><span class="n">u1</span><span class="o">*</span><span class="n">v1</span> <span class="o">+</span> <span class="n">u2</span><span class="o">*</span><span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="n">DomainMass</span> <span class="p">);</span>

<span class="kt">matrix</span> <span class="n">Mass</span> <span class="o">=</span> <span class="n">vmass</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>

<span class="kt">matrix</span> <span class="n">Id</span> <span class="o">=</span> <span class="n">vmass</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>

<span class="c1">//Define the standard Euclidean basis functions</span>
<span class="p">[</span><span class="n">ehat1x</span><span class="p">,</span> <span class="n">ehat1y</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">];</span>
<span class="p">[</span><span class="n">ehat2x</span><span class="p">,</span> <span class="n">ehat2y</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">];</span>

<span class="kt">real</span> <span class="n">ContParam</span><span class="p">,</span> <span class="n">dContParam</span><span class="p">;</span>

<span class="kt">problem</span> <span class="nf">neoHookeanInc</span> <span class="p">([</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">],</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">],</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">LU</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qforder</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span>
        <span class="o">-</span> <span class="p">(</span>
              <span class="n">StressK11</span> <span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span> <span class="o">*</span> <span class="n">d3Aux11</span><span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">StressK12</span> <span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span> <span class="o">*</span> <span class="n">d3Aux12</span><span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">StressK21</span> <span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span> <span class="o">*</span> <span class="n">d3Aux21</span><span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">StressK22</span> <span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span> <span class="o">*</span> <span class="n">d3Aux22</span><span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">TanK11</span> <span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">d4Aux11</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">TanK12</span> <span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">d4Aux12</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">TanK21</span> <span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">d4Aux21</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">TanK22</span> <span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">,</span> <span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">)</span> <span class="o">*</span> <span class="n">d4Aux22</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qforder</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span>
          <span class="n">StressK11</span> <span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span> <span class="o">*</span> <span class="n">d4Aux11</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">StressK12</span> <span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span> <span class="o">*</span> <span class="n">d4Aux12</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">StressK21</span> <span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span> <span class="o">*</span> <span class="n">d4Aux21</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">StressK22</span> <span class="p">(</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span> <span class="o">*</span> <span class="n">d4Aux22</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1">//Choose one of the following two boundary conditions involving Pa:</span>
    <span class="c1">// Load vectors normal to the boundary:</span>
    <span class="o">-</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span>
          <span class="n">Pa</span> <span class="o">*</span> <span class="p">(</span><span class="n">w1</span><span class="o">*</span><span class="kr">N</span><span class="p">.</span><span class="kr">x</span> <span class="o">+</span> <span class="n">w2</span><span class="o">*</span><span class="kr">N</span><span class="p">.</span><span class="kr">y</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1">//Load vectors tangential to the boundary:</span>
    <span class="c1">//- int1d(Th, 1)(</span>
    <span class="c1">//    Pa * (w1*N.y - w2*N.x)</span>
    <span class="c1">//)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">varu1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">varu2</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="c1">//Auxiliary variables</span>
<span class="kt">matrix</span> <span class="n">auxMat</span><span class="p">;</span>

<span class="c1">// Newton&#39;s method</span>
<span class="n">ContParam</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
<span class="n">dContParam</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>

<span class="c1">//Initialization:</span>
<span class="p">[</span><span class="n">varu1</span><span class="p">,</span> <span class="n">varu2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">];</span>
<span class="p">[</span><span class="n">u1n</span><span class="p">,</span> <span class="n">u2n</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">];</span>
<span class="kt">real</span> <span class="n">res</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="kp">tol</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">eforceres</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">loopcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">loopmax</span> <span class="o">=</span> <span class="mi">45</span><span class="p">;</span>

<span class="c1">// Iterations</span>
<span class="k">while</span> <span class="p">(</span><span class="n">loopcount</span> <span class="o">&lt;=</span> <span class="n">loopmax</span> <span class="o">&amp;&amp;</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="kp">tol</span><span class="p">){</span>
    <span class="n">loopcount</span> <span class="o">++</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Loop &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">loopcount</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="c1">// Solve</span>
    <span class="n">neoHookeanInc</span><span class="p">;</span>

    <span class="c1">// Update</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">varu1</span><span class="p">;</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">varu2</span><span class="p">;</span>

    <span class="c1">// Residual</span>
    <span class="n">w1</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Mass</span><span class="o">*</span><span class="n">varu1</span><span class="p">[];</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">w1</span><span class="p">[]</span><span class="o">&#39;</span> <span class="o">*</span> <span class="n">varu1</span><span class="p">[]);</span> <span class="c1">//L^2 norm of [varu1, varu2]</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; L^2 residual = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">res</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="c1">// Newton</span>
    <span class="n">u1n</span><span class="p">[]</span> <span class="o">+=</span> <span class="n">varu1</span><span class="p">[];</span>

    <span class="c1">// Plot</span>
    <span class="nf">plot</span><span class="p">([</span><span class="n">u1n</span><span class="p">,</span><span class="n">u2n</span><span class="p">],</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;</span><span class="kp">displacement</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="c1">// Movemesh</span>
<span class="kt">mesh</span> <span class="n">Th1</span> <span class="o">=</span> <span class="nf">movemesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="p">[</span><span class="kr">x</span><span class="o">+</span><span class="n">u1n</span><span class="p">,</span> <span class="kr">y</span><span class="o">+</span><span class="n">u2n</span><span class="p">]);</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th1</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
<span class="nf">plot</span><span class="p">([</span><span class="n">u1n</span><span class="p">,</span><span class="n">u2n</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>