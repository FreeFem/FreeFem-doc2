<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Whispering gallery modes</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">Whispering gallery modes</a><ul>
<li><a class="reference internal" href="#wave-equation-for-the-wgms">Wave equation for the WGMs</a></li>
<li><a class="reference internal" href="#weak-formulation">Weak formulation</a></li>
<li><a class="reference internal" href="#a-dielectric-sphere-example-with-freefem">A dielectric sphere example with FreeFem++</a></li>
</ul>
</li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="section" id="whispering-gallery-modes">
<h1>Whispering gallery modes<a class="headerlink" href="#whispering-gallery-modes" title="Permalink to this headline">¶</a></h1>
<p>Author: <a class="reference external" href="http://linkeding.com/in/grudinin">I. S. Grudinin</a></p>
<p>In whispering gallery mode (WGM) resonators, which are typically spheres or disks, electromagnetic field is trapped by total internal reflections from the boundary.
Modes of such resonators are distinguished by compact volume and record high quality factors (Q) in a broad range of frequencies.</p>
<p>Modern applications of such resonators include microwave and optical cavities for atomic clocks, cavity optomechanics, nonlinear and quantum optics.
Analytical solutions for WG modes are only available for a limited number of idealized geometries, such as sphere or ellipsoid.
Since resonator dimensions are typically much larger than optical wavelength, direct application of numerical 3D finite difference time domain (FDTD) or finite element methods (FEM) is not practical.
It’s possible to solve the vectorial wave equation by reducing it to a two dimensional case by taking axial symmetry into account.</p>
<p>Such reduction leads to a system of 3 equations to be solved in a 2D “<span class="math notranslate nohighlight">\(\rho-z\)</span>” section of a resonator.
Please refer to <a class="reference internal" href="../reference.html#oxborrow2007" id="id1">[OXBORROW2007]</a> for a detailed derivation and to <a class="reference internal" href="../reference.html#grudinin2012" id="id2">[GRUDININ2012]</a> for an example of using FreeFem++ to compute WGMs.</p>
<div class="section" id="wave-equation-for-the-wgms">
<h2>Wave equation for the WGMs<a class="headerlink" href="#wave-equation-for-the-wgms" title="Permalink to this headline">¶</a></h2>
<p>Since electric field is discontinuous on the surface of a dielectric and magnetic field is typically not, we derive our equations for the magnetic field.
The electric field can be easily derived at a later stage from <span class="math notranslate nohighlight">\(\vec{E}=\frac{i}{\omega\epsilon_0}\hat{\epsilon}^{-1}\nabla\times\vec{H}\)</span>.
Following a standard procedure starting with Maxwell equations we derive a wave equation in a single-axis anisotropic medium such as an optical crystal:</p>
<div class="math notranslate nohighlight" id="equation-eqn-wave">
<span class="eqno">(63)<a class="headerlink" href="#equation-eqn-wave" title="Permalink to this equation">¶</a></span>\[\nabla\times\left(\hat{\epsilon}^{-1}\nabla\times\vec{H}\right)-k_0^2\vec{H}-\alpha\nabla\left(\nabla\cdot\vec{H}\right)=0\]</div>
<p>Here <span class="math notranslate nohighlight">\(k_0=\omega/c\)</span> is the wavenumber, <span class="math notranslate nohighlight">\(\alpha\)</span> is the penalty term added to fight spurious FEM solutions.
For anisotropic single-axis medium with <span class="math notranslate nohighlight">\(\partial\hat{\epsilon}/\partial\phi=0\)</span> in cylindrical system of coordinates we have:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\hat{\epsilon}=\begin{pmatrix} \epsilon_{\rho} &amp; 0 &amp; 0 \\ 0 &amp; \epsilon_{\rho} &amp; 0 \\ 0 &amp; 0 &amp; \epsilon_z \end{pmatrix}. \nonumber\end{split}\]</div>
<p>We now assume axial symmetry of our electromagnetic fields and insert an imaginary unity in front of the <span class="math notranslate nohighlight">\(H_{\phi}\)</span> to allow all field components to be real numbers and also to account for the phase shift of this component <span class="math notranslate nohighlight">\(\vec{H}(\rho,\phi,z)=\left\{H_{\rho}(\rho,z),iH_{\phi}(\rho,z),H_z(\rho,z)\right\}\times e^{im\phi}\)</span>.</p>
<p>We write the wave equation <a class="reference internal" href="#equation-eqn-wave">(63)</a> explicitly in cylindrical coordinates, thus obtaining a set of three differential equations for the domain <span class="math notranslate nohighlight">\(\Omega\)</span> given by the resonator’s cross section and some space outside:</p>
<div class="math notranslate nohighlight" id="equation-eqn-system">
<span class="eqno">(64)<a class="headerlink" href="#equation-eqn-system" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{array}{rcl}
    A_1\{{H}_{\rho}^t,{H}_{\phi}^t,{H}_{z}^t\}&amp;=&amp;0\\ \nonumber
    A_2\{{H}_{\rho}^t,{H}_{\phi}^t,{H}_{z}^t\}&amp;=&amp;0\\ \nonumber
    A_3\{{H}_{\rho}^t,{H}_{\phi}^t,{H}_{z}^t\}&amp;=&amp;0
\end{array}\end{split}\]</div>
<p>The numerical solutions of these equations and boundary conditions can be found with FreeFem++ if we write the system in the weak, or integral form.</p>
</div>
<div class="section" id="weak-formulation">
<h2>Weak formulation<a class="headerlink" href="#weak-formulation" title="Permalink to this headline">¶</a></h2>
<p>In general, to obtain the integral or “weak” statements equivalent to system <a class="reference internal" href="#equation-eqn-system">(64)</a> and boundary conditions we form a scalar dot product between an arbitrary magnetic field test function <span class="math notranslate nohighlight">\(\mathbf{H}^t=\{{H}_{\rho}^t,{H}_{\phi}^t,{H}_{z}^t\}\)</span> and the components of our vectorial equation <span class="math notranslate nohighlight">\(A_1,A_2,A_3\)</span>, and integrate over the resonator’s cross section domain <span class="math notranslate nohighlight">\(\Omega\)</span> (and its boundary for the boundary conditions):</p>
<div class="math notranslate nohighlight">
\[\int\limits_{\Omega}(H^t_{\rho}A_1+H^t_{\phi}A_2+H^t_{z}A_3)d\Omega\]</div>
<p>We can reduce the order of partial derivatives in this integral by using the Green’s formula for integration by parts.
For example:</p>
<div class="math notranslate nohighlight">
\[\int\limits_{\Omega}H_z^t \frac{\partial^2 H_z}{\partial \rho^2 }d\Omega=
-\int\limits_{\Omega}\frac{\partial H_z^t}{\partial \rho}\frac{\partial H_z}{\partial \rho }d\Omega+\oint H_z^t\frac{\partial H_z}{\partial \rho}n_{\rho}d\Gamma\]</div>
<p>Thus converting equations <a class="reference internal" href="#equation-eqn-system">(64)</a> we obtain a large expression for the weak form.</p>
</div>
<div class="section" id="a-dielectric-sphere-example-with-freefem">
<h2>A dielectric sphere example with FreeFem++<a class="headerlink" href="#a-dielectric-sphere-example-with-freefem" title="Permalink to this headline">¶</a></h2>
<p>We now compute the fundamental mode frequency for a fused silica sphere.
The sphere is 36 micrometer in diameter, the refractive index is 1.46, the boundary condition is the magnetic wall (which can actually be omitted as it holds automatically).</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">real</span> <span class="n">radius</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span> <span class="c1">//approximate radius of the cavity</span>
<span class="kt">real</span> <span class="n">yb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="o">-</span><span class="n">yb</span><span class="p">;</span> <span class="c1">//window yb=bottom and yt=top coordinates</span>
<span class="kt">real</span> <span class="n">xl</span> <span class="o">=</span> <span class="n">radius</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="n">xr</span> <span class="o">=</span> <span class="n">radius</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span> <span class="c1">//window xl=left and xr=right coordinates</span>
<span class="kt">real</span> <span class="n">angle</span> <span class="o">=</span> <span class="nf">asin</span><span class="p">((</span><span class="n">yt</span><span class="p">)</span><span class="o">/</span><span class="n">radius</span><span class="p">);</span> <span class="c1">//angle of the sphere segment to model in radians</span>
<span class="kt">int</span> <span class="n">Nm</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span> <span class="c1">//number of mesh vertices per border</span>
<span class="kt">real</span> <span class="n">ne</span> <span class="o">=</span> <span class="mf">1.46</span><span class="p">;</span> <span class="c1">//n_e-extraordinary refractive index (root of permittivity parallel to z-axis, epara)</span>
<span class="kt">real</span> <span class="n">no</span> <span class="o">=</span> <span class="mf">1.46</span><span class="p">;</span> <span class="c1">//n_o-ordinary refractive index (root of permittivity orthogonal to z-axis, eorto)</span>
<span class="kt">real</span> <span class="n">nm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//refractive index of surrounding medium (air)</span>

<span class="kt">int</span> <span class="kp">nev</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// number of eigen values to find</span>

<span class="kt">int</span> <span class="n">M</span> <span class="o">=</span> <span class="mi">213</span><span class="p">;</span> <span class="c1">//azimuthal mode order ~ 2Pi*n*R/lambda</span>
<span class="kt">real</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//penalty term</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">W1l</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">xl</span><span class="o">+</span><span class="p">(</span><span class="n">radius</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="o">-</span><span class="n">xl</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="n">yt</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">W1r</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">xr</span><span class="o">-</span><span class="p">(</span><span class="n">xr</span><span class="o">-</span><span class="n">radius</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="n">yt</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">W2</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">xr</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">yb</span><span class="o">+</span><span class="p">(</span><span class="n">yt</span><span class="o">-</span><span class="n">yb</span><span class="p">)</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">W3l</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">xl</span><span class="o">+</span><span class="p">(</span><span class="n">radius</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="o">-</span><span class="n">xl</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="n">yb</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">W3r</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">xr</span><span class="o">-</span><span class="p">(</span><span class="n">xr</span><span class="o">-</span><span class="n">radius</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="n">yb</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">W4</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">xl</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">yt</span><span class="o">-</span><span class="p">(</span><span class="n">yt</span><span class="o">-</span><span class="n">yb</span><span class="p">)</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">S</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">radius</span><span class="o">*</span><span class="nf">cos</span><span class="p">((</span><span class="kp">t</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">angle</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="n">radius</span><span class="o">*</span><span class="nf">sin</span><span class="p">((</span><span class="kp">t</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">angle</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;}</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">W1r</span><span class="p">(</span><span class="n">Nm</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">W1l</span><span class="p">(</span><span class="n">Nm</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">W4</span><span class="p">(</span><span class="n">Nm</span><span class="p">)</span> <span class="o">+</span> <span class="n">W3l</span><span class="p">(</span><span class="n">Nm</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">W3r</span><span class="p">(</span><span class="n">Nm</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">W2</span><span class="p">(</span><span class="n">Nm</span><span class="p">)</span> <span class="o">+</span> <span class="n">S</span><span class="p">(</span><span class="n">Nm</span><span class="p">));</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">WindowIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Ph</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>
<span class="n">Ph</span> <span class="n">reg</span> <span class="o">=</span> <span class="kr">region</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">ncav</span> <span class="o">=</span> <span class="n">reg</span><span class="p">(</span><span class="n">xl</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// cavity</span>
<span class="kt">int</span> <span class="n">nair</span> <span class="o">=</span> <span class="n">reg</span><span class="p">(</span><span class="n">xr</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//air</span>
<span class="n">Ph</span> <span class="n">eorto</span> <span class="o">=</span> <span class="n">no</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kr">region</span><span class="o">==</span><span class="n">ncav</span><span class="p">)</span> <span class="o">+</span> <span class="n">nm</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kr">region</span><span class="o">==</span><span class="n">nair</span><span class="p">);</span> <span class="c1">//subdomains for epsilon values inside and outside the resonators</span>
<span class="n">Ph</span> <span class="n">epara</span> <span class="o">=</span> <span class="n">ne</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kr">region</span><span class="o">==</span><span class="n">ncav</span><span class="p">)</span> <span class="o">+</span> <span class="n">nm</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kr">region</span><span class="o">==</span><span class="n">nair</span><span class="p">);</span> <span class="c1">//subdomains for epsilon values inside and outside the resonators</span>

<span class="c1">//supplementary variables to store eigenvectors, defined on mesh Th with P2 elements - Largange quadratic.</span>
<span class="kt">fespace</span> <span class="nf">Supp</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span>
<span class="n">Supp</span> <span class="n">eHsqr</span><span class="p">;</span>

<span class="c1">//3d vector FE space</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="p">[</span><span class="nc">P2</span><span class="p">,</span> <span class="nc">P2</span><span class="p">,</span> <span class="nc">P2</span><span class="p">]);</span>
<span class="n">Vh</span> <span class="p">[</span><span class="n">Hr</span><span class="p">,</span> <span class="n">Hphi</span><span class="p">,</span> <span class="n">Hz</span><span class="p">],</span> <span class="p">[</span><span class="n">vHr</span><span class="p">,</span> <span class="n">vHphi</span><span class="p">,</span> <span class="n">vHz</span><span class="p">];</span> <span class="c1">//magnetic field components on Vh space and test functions vH</span>

<span class="c1">// Macro</span>
<span class="c1">//boundary condition macros</span>
<span class="kt">macro</span> <span class="nf">EWall</span><span class="p">(</span><span class="n">Hr</span><span class="p">,</span> <span class="n">Hphi</span><span class="p">,</span> <span class="n">Hz</span><span class="p">)</span> <span class="p">(</span>
      <span class="nf">dy</span><span class="p">(</span><span class="n">Hr</span><span class="p">)</span> <span class="o">-</span> <span class="nf">dx</span><span class="p">(</span><span class="n">Hz</span><span class="p">)</span> <span class="o">+</span> <span class="n">Hr</span><span class="o">*</span><span class="kr">N</span><span class="p">.</span><span class="kr">x</span> <span class="o">+</span> <span class="n">Hz</span><span class="o">*</span><span class="kr">N</span><span class="p">.</span><span class="kr">y</span>
    <span class="o">-</span> <span class="n">epara</span><span class="o">*</span><span class="p">(</span><span class="n">Hz</span><span class="o">*</span><span class="n">M</span> <span class="o">-</span> <span class="nf">dy</span><span class="p">(</span><span class="n">Hphi</span><span class="p">)</span><span class="o">*</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="kr">N</span><span class="p">.</span><span class="kr">y</span>
    <span class="o">+</span> <span class="n">eorto</span><span class="o">*</span><span class="p">(</span><span class="n">Hphi</span> <span class="o">-</span> <span class="n">Hr</span><span class="o">*</span><span class="n">M</span><span class="o">+</span><span class="nf">dx</span><span class="p">(</span><span class="n">Hphi</span><span class="p">)</span><span class="o">*</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="kr">N</span><span class="p">.</span><span class="kr">x</span><span class="p">)</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">MWall</span><span class="p">(</span><span class="n">Hr</span><span class="p">,</span> <span class="n">Hphi</span><span class="p">,</span> <span class="n">Hz</span><span class="p">)</span> <span class="p">(</span>
      <span class="n">Hphi</span> <span class="o">+</span> <span class="n">Hz</span><span class="o">*</span><span class="kr">N</span><span class="p">.</span><span class="kr">x</span> <span class="o">-</span> <span class="n">Hr</span><span class="o">*</span><span class="kr">N</span><span class="p">.</span><span class="kr">y</span>
    <span class="o">+</span> <span class="n">epara</span><span class="o">*</span><span class="p">(</span><span class="n">Hz</span><span class="o">*</span><span class="n">M</span> <span class="o">-</span> <span class="nf">dy</span><span class="p">(</span><span class="n">Hphi</span><span class="p">)</span><span class="o">*</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="kr">N</span><span class="p">.</span><span class="kr">x</span>
    <span class="o">+</span> <span class="n">eorto</span><span class="o">*</span><span class="p">(</span><span class="n">Hphi</span> <span class="o">-</span> <span class="n">Hr</span><span class="o">*</span><span class="n">M</span><span class="o">+</span><span class="nf">dx</span><span class="p">(</span><span class="n">Hphi</span><span class="p">)</span><span class="o">*</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="kr">N</span><span class="p">.</span><span class="kr">y</span> <span class="p">)</span> <span class="c1">//</span>

<span class="c1">// Problem</span>
<span class="kt">real</span> <span class="kp">sigma</span> <span class="o">=</span><span class="p">(</span><span class="n">M</span><span class="o">/</span><span class="p">(</span><span class="n">ne</span><span class="o">*</span><span class="n">radius</span><span class="p">))</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span> <span class="c1">// value of the shift (k^2), where the modes will be found</span>
<span class="kt">varf</span> <span class="nf">b</span> <span class="p">([</span><span class="n">Hr</span><span class="p">,</span> <span class="n">Hphi</span><span class="p">,</span> <span class="n">Hz</span><span class="p">],</span> <span class="p">[</span><span class="n">vHr</span><span class="p">,</span> <span class="n">vHphi</span><span class="p">,</span> <span class="n">vHz</span><span class="p">])</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="kr">x</span><span class="o">*</span><span class="p">(</span><span class="n">Hr</span><span class="o">*</span><span class="n">vHr</span><span class="o">+</span><span class="n">Hphi</span><span class="o">*</span><span class="n">vHphi</span><span class="o">+</span><span class="n">Hz</span><span class="o">*</span><span class="n">vHz</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="p">;</span>
<span class="c1">// OP = A - sigma B ; // the shifted matrix</span>
<span class="kt">varf</span> <span class="kp">op</span> <span class="p">([</span><span class="n">Hr</span><span class="p">,</span> <span class="n">Hphi</span><span class="p">,</span> <span class="n">Hz</span><span class="p">],</span> <span class="p">[</span><span class="n">vHr</span><span class="p">,</span> <span class="n">vHphi</span><span class="p">,</span> <span class="n">vHz</span><span class="p">])</span><span class="o">=</span>
    <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="p">(</span>
              <span class="p">(</span><span class="n">eorto</span><span class="o">*</span><span class="p">(</span><span class="n">vHphi</span><span class="o">*</span><span class="n">Hphi</span> <span class="o">-</span> <span class="n">M</span><span class="o">*</span><span class="p">(</span><span class="n">vHphi</span><span class="o">*</span><span class="n">Hr</span> <span class="o">+</span> <span class="n">Hphi</span><span class="o">*</span><span class="n">vHr</span><span class="p">)</span> <span class="o">+</span> <span class="n">M</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="n">vHr</span><span class="o">*</span><span class="n">Hr</span><span class="p">)</span> <span class="o">+</span> <span class="n">epara</span><span class="o">*</span><span class="n">M</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="n">vHz</span><span class="o">*</span><span class="n">Hz</span><span class="p">)</span><span class="o">/</span><span class="kr">x</span> <span class="c1">//A/r</span>
            <span class="o">+</span> <span class="n">eorto</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">vHphi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Hphi</span> <span class="o">-</span> <span class="n">M</span><span class="o">*</span><span class="n">Hr</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dx</span><span class="p">(</span><span class="n">Hphi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">vHphi</span> <span class="o">-</span> <span class="n">M</span><span class="o">*</span><span class="n">vHr</span><span class="p">))</span> <span class="o">-</span> <span class="n">epara</span><span class="o">*</span><span class="n">M</span><span class="o">*</span><span class="p">(</span><span class="n">vHz</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">Hphi</span><span class="p">)</span> <span class="o">+</span> <span class="n">Hz</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vHphi</span><span class="p">))</span> <span class="c1">//B</span>
            <span class="o">+</span> <span class="kr">x</span><span class="o">*</span><span class="p">(</span><span class="n">eorto</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vHphi</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">Hphi</span><span class="p">)</span> <span class="o">+</span> <span class="n">epara</span><span class="o">*</span><span class="p">((</span><span class="nf">dx</span><span class="p">(</span><span class="n">vHz</span><span class="p">)</span> <span class="o">-</span> <span class="nf">dy</span><span class="p">(</span><span class="n">vHr</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">Hz</span><span class="p">)</span> <span class="o">-</span> <span class="nf">dy</span><span class="p">(</span><span class="n">Hr</span><span class="p">))</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">vHphi</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">Hphi</span><span class="p">)))</span> <span class="c1">//C</span>
        <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">eorto</span><span class="o">*</span><span class="n">epara</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span>
              <span class="p">(</span><span class="n">vHr</span><span class="o">*</span><span class="n">Hr</span> <span class="o">-</span> <span class="n">M</span><span class="o">*</span><span class="p">(</span><span class="n">vHphi</span><span class="o">*</span><span class="n">Hr</span> <span class="o">+</span> <span class="n">Hphi</span><span class="o">*</span><span class="n">vHr</span><span class="p">)</span> <span class="o">+</span> <span class="n">M</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="n">vHphi</span><span class="o">*</span><span class="n">Hphi</span><span class="p">)</span><span class="o">/</span><span class="kr">x</span> <span class="c1">//D/r</span>
            <span class="o">+</span> <span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">vHr</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">vHz</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">Hr</span> <span class="o">-</span> <span class="n">M</span><span class="o">*</span><span class="n">Hphi</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">vHr</span> <span class="o">-</span> <span class="n">M</span><span class="o">*</span><span class="n">vHphi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">Hr</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">Hz</span><span class="p">))</span> <span class="c1">//E</span>
            <span class="o">+</span> <span class="kr">x</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">vHr</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">vHz</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">Hr</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">Hz</span><span class="p">))</span> <span class="c1">//F</span>
        <span class="p">)</span>
        <span class="o">-</span><span class="kp">sigma</span><span class="o">*</span><span class="kr">x</span><span class="o">*</span><span class="p">(</span><span class="n">vHr</span><span class="o">*</span><span class="n">Hr</span> <span class="o">+</span> <span class="n">vHphi</span><span class="o">*</span><span class="n">Hphi</span> <span class="o">+</span> <span class="n">vHz</span><span class="o">*</span><span class="n">Hz</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1">//electric wall boundary condition on the boundary of computation domain</span>
    <span class="o">+</span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span>
          <span class="n">EWall</span><span class="p">(</span><span class="n">Hr</span><span class="p">,</span> <span class="n">Hphi</span><span class="p">,</span> <span class="n">Hz</span><span class="p">)</span><span class="o">*</span><span class="n">EWall</span><span class="p">(</span><span class="n">vHr</span><span class="p">,</span> <span class="n">vHphi</span><span class="p">,</span> <span class="n">vHz</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="p">;</span>
<span class="c1">//setting sparce matrices and assigning the solver UMFPACK to solve eigenvalue problem</span>
<span class="kt">matrix</span> <span class="kp">B</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">UMFPACK</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="n">OP</span> <span class="o">=</span> <span class="kp">op</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">UMFPACK</span><span class="p">);</span>

<span class="c1">// Solve</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">ev</span><span class="p">(</span><span class="kp">nev</span><span class="p">);</span> <span class="c1">//to store the nev eigenvalue</span>
<span class="n">Vh</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="p">[</span><span class="n">eHr</span><span class="p">,</span> <span class="n">eHphi</span><span class="p">,</span> <span class="n">eHz</span><span class="p">](</span><span class="kp">nev</span><span class="p">);</span> <span class="c1">//to store the nev eigenvector</span>
<span class="c1">//calling ARPACK on sparce matrices with the assigned solver UMFPACK:</span>
<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="nf">EigenValue</span><span class="p">(</span><span class="n">OP</span><span class="p">,</span> <span class="kp">B</span><span class="p">,</span> <span class="kp">sym</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">sigma</span><span class="o">=</span><span class="kp">sigma</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="n">ev</span><span class="p">,</span> <span class="kp">vector</span><span class="o">=</span><span class="n">eHr</span><span class="p">,</span> <span class="kp">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="kp">maxit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="kp">ncv</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>

<span class="n">k</span> <span class="o">=</span> <span class="kr">min</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kp">nev</span><span class="p">);</span> <span class="c1">//sometimes the number of converged eigen values</span>
                 <span class="c1">//can be greater than nev</span>

<span class="c1">//file to output mode values</span>
<span class="kt">ofstream</span> <span class="nf">f</span><span class="p">(</span><span class="s">&quot;modes.txt&quot;</span><span class="p">);</span>
<span class="c1">//setting number of digits in the file output</span>
<span class="kt">int</span> <span class="n">nold</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="kr">precision</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>

<span class="c1">// Plot &amp; Save</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="kt">real</span> <span class="n">lambda</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">/</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">ev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">eHsqr</span> <span class="o">=</span> <span class="p">(</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">eHr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">eHphi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">eHz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span><span class="p">));</span> <span class="c1">//intensity from magnetic field components</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">eHsqr</span><span class="p">,</span> <span class="kp">WindowIndex</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">nbiso</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">LabelColors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">aspectratio</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;Mode &quot;</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="s">&quot;, lambda=&quot;</span><span class="o">+</span><span class="n">lambda</span><span class="o">+</span><span class="s">&quot;, F=&quot;</span><span class="o">+</span><span class="p">(</span><span class="mf">299792.458</span><span class="o">/</span><span class="n">lambda</span><span class="p">));</span>
    <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Mode &quot;</span><span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, ka=&quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">ev</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">radius</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>