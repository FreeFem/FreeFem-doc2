<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Domain decomposition</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">Domain decomposition</a><ul>
<li><a class="reference internal" href="#schwarz-overlapping">Schwarz overlapping</a></li>
<li><a class="reference internal" href="#schwarz-non-overlapping-scheme">Schwarz non overlapping Scheme</a></li>
<li><a class="reference internal" href="#schwarz-conjuguate-gradient">Schwarz conjuguate gradient</a></li>
</ul>
</li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="section" id="domain-decomposition">
<h1>Domain decomposition<a class="headerlink" href="#domain-decomposition" title="Permalink to this headline">¶</a></h1>
<p>We present three classic examples of domain decomposition technique: first, Schwarz algorithm with overlapping, second Schwarz algorithm without overlapping (also call Shur complement), and last we show to use the conjugate gradient to solve the boundary problem of the Shur complement.</p>
<div class="section" id="schwarz-overlapping">
<span id="domaindecompositionschwarzoverlapping"></span><h2>Schwarz overlapping<a class="headerlink" href="#schwarz-overlapping" title="Permalink to this headline">¶</a></h2>
<p>To solve:</p>
<div class="math notranslate nohighlight">
\[-\Delta u =f,\;\mbox{in}\;\Omega=\Omega_1\cup\Omega_2\quad u|_\Gamma=0\]</div>
<p>the Schwarz algorithm runs like this:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    -\Delta u^{n+1}_1&amp;=&amp;f\;\mbox{in}\;\Omega_1\quad
    u^{n+1}_1|_{\Gamma_1}=u^n_2\\
    -\Delta u^{n+1}_2&amp;=&amp;f\;\mbox{in}\;\Omega_2\quad
    u^{n+1}_2|_{\Gamma_2}=u^n_1
\end{array}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\Gamma_i\)</span> is the boundary of <span class="math notranslate nohighlight">\(\Omega_i\)</span> and on the condition that <span class="math notranslate nohighlight">\(\Omega_1\cap\Omega_2\neq\emptyset\)</span> and that <span class="math notranslate nohighlight">\(u_i\)</span> are zero at iteration 1.</p>
<p>Here we take <span class="math notranslate nohighlight">\(\Omega_1\)</span> to be a quadrangle, <span class="math notranslate nohighlight">\(\Omega_2\)</span> a disk and we apply the algorithm starting from zero.</p>
<div class="figure" id="figdomain1">
<img alt="../_images/DomainDecomposition_Schwarz1.png" src="../_images/DomainDecomposition_Schwarz1.png" />
<p class="caption"><span class="caption-number">Fig. 209 </span><span class="caption-text">The 2 overlapping mesh <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">TH</span></code> and <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">th</span></code></span></p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Schwarz overlapping</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="kp">inside</span> <span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="c1">//inside boundary</span>
<span class="kt">int</span> <span class="n">outside</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//outside boundary</span>
<span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">a</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">outside</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">b</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">outside</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">c</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">outside</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">d</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="kp">inside</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">e</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="kr">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="kp">inside</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">e1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="kr">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="n">outside</span><span class="p">;}</span>
<span class="kt">mesh</span> <span class="n">th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="nf">d</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">));</span>
<span class="kt">mesh</span> <span class="n">TH</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">e</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">e1</span><span class="p">(</span><span class="mi">25</span><span class="o">*</span><span class="kr">n</span><span class="p">));</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="n">TH</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span> <span class="c1">//to see the 2 meshes</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">vh</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">vh</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">VH</span><span class="p">(</span><span class="n">TH</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">VH</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">problem</span> <span class="nf">PB</span> <span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="kp">init</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Cholesky</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">TH</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">TH</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">V</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="kp">inside</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">outside</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">problem</span> <span class="nf">pb</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="kp">init</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Cholesky</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="kp">inside</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">U</span><span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">outside</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Calculation loop</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="c1">// Solve</span>
    <span class="n">PB</span><span class="p">;</span>
    <span class="n">pb</span><span class="p">;</span>

    <span class="c1">// Plot</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="inline2 figure" id="figdomainiter0">
<img alt="../_images/DomainDecomposition_Schwarz2.png" src="../_images/DomainDecomposition_Schwarz2.png" />
<p class="caption"><span class="caption-number">Fig. 210 </span><span class="caption-text">Isovalues of the solution at iteration 0</span></p>
</div>
<div class="inline2 last figure" id="figdomainiter9">
<img alt="../_images/DomainDecomposition_Schwarz3.png" src="../_images/DomainDecomposition_Schwarz3.png" />
<p class="caption"><span class="caption-number">Fig. 211 </span><span class="caption-text">Isovalues of the solution at iteration 0</span></p>
</div>
</div>
</div>
<div class="section" id="schwarz-non-overlapping-scheme">
<h2>Schwarz non overlapping Scheme<a class="headerlink" href="#schwarz-non-overlapping-scheme" title="Permalink to this headline">¶</a></h2>
<p>To solve:</p>
<div class="math notranslate nohighlight">
\[-\Delta u =f\;\mbox{in}\;\Omega=\Omega_1\cup\Omega_2\quad u|_\Gamma=0\]</div>
<p>the Schwarz algorithm for domain decomposition without overlapping runs like this</p>
<div class="figure" id="figdomain4">
<img alt="../_images/DomainDecomposition_Schwarz4.png" src="../_images/DomainDecomposition_Schwarz4.png" />
<p class="caption"><span class="caption-number">Fig. 212 </span><span class="caption-text">The two none overlapping mesh <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">TH</span></code> and <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">th</span></code></span></p>
</div>
<p>Let introduce <span class="math notranslate nohighlight">\(\Gamma_i\)</span> is common the boundary of <span class="math notranslate nohighlight">\(\Omega_1\)</span> and <span class="math notranslate nohighlight">\(\Omega_2\)</span> and <span class="math notranslate nohighlight">\(\Gamma_e^i= \partial \Omega_i \setminus \Gamma_i\)</span>.</p>
<p>The problem find <span class="math notranslate nohighlight">\(\lambda\)</span> such that <span class="math notranslate nohighlight">\((u_1|_{\Gamma_i}=u_2|_{\Gamma_i})\)</span> where <span class="math notranslate nohighlight">\(u_i\)</span> is solution of the following Laplace problem:</p>
<div class="math notranslate nohighlight">
\[-\Delta u_i=f\;\mbox{in}\;\Omega_i\quad
u_i|_{\Gamma_i}=\lambda \quad
u_i|_{\Gamma_e^i} = 0\]</div>
<p>To solve this problem we just make a loop with upgrading <span class="math notranslate nohighlight">\(\lambda\)</span> with</p>
<div class="math notranslate nohighlight">
\[\lambda = \lambda {\pm} \frac{(u_1-u_2)}{2}\]</div>
<p>where the sign <span class="math notranslate nohighlight">\(+\)</span> or <span class="math notranslate nohighlight">\(-\)</span> of <span class="math notranslate nohighlight">\({\pm}\)</span> is choose to have convergence.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Schwarz non-overlapping</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="kp">inside</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="kt">int</span> <span class="n">outside</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">a</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">outside</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">b</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">outside</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">c</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">outside</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">d</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="kp">inside</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">e</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="kp">inside</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">e1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="kr">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="n">outside</span><span class="p">;};</span>
<span class="kt">mesh</span> <span class="n">th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="nf">d</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">));</span>
<span class="kt">mesh</span> <span class="n">TH</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">e</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">e1</span><span class="p">(</span><span class="mi">25</span><span class="o">*</span><span class="kr">n</span><span class="p">));</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="n">TH</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">vh</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">vh</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
<span class="n">vh</span> <span class="n">lambda</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">VH</span><span class="p">(</span><span class="n">TH</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">VH</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">problem</span> <span class="nf">PB</span> <span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="kp">init</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Cholesky</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">TH</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">TH</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">V</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">TH</span><span class="p">,</span> <span class="kp">inside</span><span class="p">)(</span>
          <span class="n">lambda</span><span class="o">*</span><span class="n">V</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">outside</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">;</span>

<span class="kt">problem</span> <span class="nf">pb</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="kp">init</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Cholesky</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="kp">inside</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">lambda</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">outside</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="c1">// Solve</span>
    <span class="n">PB</span><span class="p">;</span>
    <span class="n">pb</span><span class="p">;</span>
    <span class="n">lambda</span> <span class="o">=</span> <span class="n">lambda</span> <span class="o">-</span> <span class="p">(</span><span class="n">u</span><span class="o">-</span><span class="n">U</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

    <span class="c1">// Plot</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>
</pre></div>
</div>
<div class="inline2 figure" id="id1">
<img alt="../_images/DomainDecomposition_Schwarz5.png" src="../_images/DomainDecomposition_Schwarz5.png" />
<p class="caption"><span class="caption-number">Fig. 213 </span><span class="caption-text">Isovalues of the solution at iteration 0 without overlapping</span></p>
</div>
<div class="inline2 last figure" id="id2">
<img alt="../_images/DomainDecomposition_Schwarz6.png" src="../_images/DomainDecomposition_Schwarz6.png" />
<p class="caption"><span class="caption-number">Fig. 214 </span><span class="caption-text">Isovalues of the solution at iteration 9 without overlapping</span></p>
</div>
</div>
</div>
<div class="section" id="schwarz-conjuguate-gradient">
<h2>Schwarz conjuguate gradient<a class="headerlink" href="#schwarz-conjuguate-gradient" title="Permalink to this headline">¶</a></h2>
<p>To solve <span class="math notranslate nohighlight">\(-\Delta u =f \;\mbox{in}\;\Omega=\Omega_1\cup\Omega_2\quad u|_\Gamma=0\)</span> the Schwarz algorithm for domain decomposition without overlapping runs like this</p>
<p>Let introduce <span class="math notranslate nohighlight">\(\Gamma_i\)</span> is common the boundary of <span class="math notranslate nohighlight">\(\Omega_1\)</span> and <span class="math notranslate nohighlight">\(\Omega_2\)</span> and <span class="math notranslate nohighlight">\(\Gamma_e^i= \partial \Omega_i \setminus \Gamma_i\)</span>.</p>
<p>The problem find <span class="math notranslate nohighlight">\(\lambda\)</span> such that <span class="math notranslate nohighlight">\((u_1|_{\Gamma_i}=u_2|_{\Gamma_i})\)</span> where <span class="math notranslate nohighlight">\(u_i\)</span> is solution of the following Laplace problem:</p>
<div class="math notranslate nohighlight">
\[-\Delta u_i=f\;\mbox{in}\;\Omega_i\quad
u_i|_{\Gamma_i}=\lambda \quad
u_i|_{\Gamma_e^i} = 0\]</div>
<p>The version of this example uses the Shur complement.
The problem on the border is solved by a conjugate gradient method.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Schwarz conjugate gradient</p>
<p>First, we construct the two domains:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="kp">inside</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="kt">int</span> <span class="n">outside</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">Gamma1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">outside</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">Gamma2</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">outside</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">Gamma3</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">outside</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">GammaInside</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="kp">inside</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">GammaArc</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="kr">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="n">outside</span><span class="p">;}</span>
<span class="kt">mesh</span> <span class="n">Th1</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">Gamma1</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Gamma2</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">GammaInside</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Gamma3</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">));</span>
<span class="kt">mesh</span> <span class="n">Th2</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">GammaInside</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="o">*</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">GammaArc</span><span class="p">(</span><span class="mi">25</span><span class="o">*</span><span class="kr">n</span><span class="p">));</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th1</span><span class="p">,</span> <span class="n">Th2</span><span class="p">);</span>
</pre></div>
</div>
<p>Now, define the finite element spaces:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh1</span><span class="p">(</span><span class="n">Th1</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh1</span> <span class="n">u1</span><span class="p">,</span> <span class="n">v1</span><span class="p">;</span>
<span class="n">Vh1</span> <span class="n">lambda</span><span class="p">;</span>
<span class="n">Vh1</span> <span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Vh2</span><span class="p">(</span><span class="n">Th2</span><span class="p">,</span><span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh2</span> <span class="n">u2</span><span class="p">,</span> <span class="n">v2</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>It is impossible to define a function just on a part of boundary, so the <span class="math notranslate nohighlight">\(\lambda\)</span> function must be defined on the all domain <span class="math notranslate nohighlight">\(\Omega_1\)</span> such as:</p>
<div class="last highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="n">Vh1</span> <span class="n">lambda</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>The two Poisson’s problems:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">problem</span> <span class="nf">Pb1</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="kp">init</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Cholesky</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th1</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th1</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">v1</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th1</span><span class="p">,</span> <span class="kp">inside</span><span class="p">)(</span>
          <span class="n">lambda</span><span class="o">*</span><span class="n">v1</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">outside</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">problem</span> <span class="nf">Pb2</span> <span class="p">(</span><span class="n">u2</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="kp">init</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Cholesky</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th2</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th2</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">v2</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th2</span><span class="p">,</span> <span class="kp">inside</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">lambda</span><span class="o">*</span><span class="n">v2</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">outside</span><span class="p">,</span> <span class="n">u2</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>
</pre></div>
</div>
<p>And, we define a border matrix, because the <span class="math notranslate nohighlight">\(\lambda\)</span> function is none zero inside the domain <span class="math notranslate nohighlight">\(\Omega_1\)</span>:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">varf</span> <span class="nf">b</span><span class="p">(</span><span class="n">u2</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th1</span><span class="p">,</span> <span class="kp">inside</span><span class="p">)(</span><span class="n">u2</span><span class="o">*</span><span class="n">v2</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="kp">B</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">Vh1</span><span class="p">,</span> <span class="n">Vh1</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">);</span>
</pre></div>
</div>
<p>The boundary problem function,</p>
<div class="math notranslate nohighlight">
\[\lambda \longrightarrow \int_{\Gamma_i }(u_1-u_2) v_{1}\]</div>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Boundary problem function</span>
<span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">BoundaryProblem</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">){</span>
   <span class="n">lambda</span><span class="p">[]</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span> <span class="c1">//make FE function form l</span>
   <span class="n">Pb1</span><span class="p">;</span>
   <span class="n">Pb2</span><span class="p">;</span>
   <span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="c1">//no refactorization i != 0</span>
   <span class="n">v1</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">u1</span><span class="o">-</span><span class="n">u2</span><span class="p">);</span>
   <span class="n">lambda</span><span class="p">[]</span> <span class="o">=</span> <span class="kp">B</span><span class="o">*</span><span class="n">v1</span><span class="p">[];</span>
   <span class="k">return</span> <span class="n">lambda</span><span class="p">[];</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The difference between the two notations <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">v1</span></code> and <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">v1</span><span class="p">[]</span></code> is: <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">v1</span></code> is the finite element function and <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">v1</span><span class="p">[]</span></code> is the vector in the canonical basis of the finite element function <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">v1</span></code>.</p>
</div>
<div class="last highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Solve</span>
<span class="kt">real</span> <span class="n">cpu</span><span class="o">=</span><span class="nf">clock</span><span class="p">();</span>
<span class="nf">LinearCG</span><span class="p">(</span><span class="n">BoundaryProblem</span><span class="p">,</span> <span class="n">p</span><span class="p">[],</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">100</span><span class="p">);</span>
<span class="c1">//compute the final solution, because CG works with increment</span>
<span class="n">BoundaryProblem</span><span class="p">(</span><span class="n">p</span><span class="p">[]);</span> <span class="c1">//solve again to have right u1, u2</span>

<span class="c1">// Display &amp; Plot</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; -- CPU time schwarz-gc:&quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">clock</span><span class="p">()</span><span class="o">-</span><span class="n">cpu</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>