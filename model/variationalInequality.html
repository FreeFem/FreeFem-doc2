<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Variational Inequality</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">Variational Inequality</a></li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="section" id="variational-inequality">
<h1>Variational Inequality<a class="headerlink" href="#variational-inequality" title="Permalink to this headline">Â¶</a></h1>
<p>We present, a classical example of variational inequality.</p>
<p>Let us denote <span class="math notranslate nohighlight">\(\mathcal{C} = \{ u\in H^1_0(\Omega), u \le g \}\)</span></p>
<p>The problem is:</p>
<div class="math notranslate nohighlight">
\[u = arg \min_{u\in \mathcal{C}} J(u) = \frac{1}{2} \int_\Omega \nabla u . \nabla u - \int_\Omega f u\]</div>
<p>where <span class="math notranslate nohighlight">\(f\)</span> and <span class="math notranslate nohighlight">\(g\)</span> are given function.</p>
<p>The solution is a projection on the convex <span class="math notranslate nohighlight">\(\mathcal{C}\)</span> of <span class="math notranslate nohighlight">\(f^\star\)</span> for the scalar product <span class="math notranslate nohighlight">\(((v,w)) = \int_\Omega \nabla v . \nabla w\)</span> of <span class="math notranslate nohighlight">\(H^1_0(\Omega)\)</span> where <span class="math notranslate nohighlight">\(f^\star\)</span> is solution of:</p>
<div class="math notranslate nohighlight">
\[(f^\star, v ) = \int_{\Omega}{f v}, \forall v \in H^1_0(`\Omega)\]</div>
<p>The projection on a convex satisfy clearly <span class="math notranslate nohighlight">\(\forall v \in \mathcal{C}, \quad (( u -v , u - \tilde{f} )) \leq 0\)</span>, and after expanding, we get the classical inequality:</p>
<div class="math notranslate nohighlight">
\[\forall v \in \mathcal{C}, \quad \int_\Omega \nabla(u -v) \nabla u \leq \int_\Omega (u-v) f\]</div>
<p>We can also rewrite the problem as a saddle point problem:</p>
<p>Find <span class="math notranslate nohighlight">\(\lambda, u\)</span> such that:</p>
<div class="math notranslate nohighlight">
\[\max_{\lambda\in L^2(\Omega), \lambda\geq 0} \min_{u\in H^1_0(\Omega)} \mathcal{L}(u,\lambda) = \frac{1}{2} \int_\Omega \nabla u . \nabla u - \int_\Omega f u + \int_{\Omega} \lambda (u-g)^+\]</div>
<p>where <span class="math notranslate nohighlight">\(((u-g)^+ = max(0,u-g)\)</span>.</p>
<p>This saddle point problem is equivalent to find <span class="math notranslate nohighlight">\(u, \lambda\)</span> such that:</p>
<div class="math notranslate nohighlight">
\[\left\{
\begin{array}{cc}
    \displaystyle \int_\Omega \nabla u . \nabla v + \lambda v^+ \,d\omega= \int_\Omega f u , &amp;\forall v \in H^1_0(\Omega) \cr
    \displaystyle \int_\Omega \mu (u-g)^+ = 0 , &amp; \forall \mu \in L^2(\Omega) , \mu \geq 0, \lambda \geq 0,
\end{array}\right.\]</div>
<p>An algorithm to solve the previous problem is:</p>
<ol class="arabic">
<li><p class="first">k=0, and choose <span class="math notranslate nohighlight">\(\lambda_0\)</span> belong <span class="math notranslate nohighlight">\(H^{-1}(\Omega)\)</span></p>
</li>
<li><p class="first">Loop on <span class="math notranslate nohighlight">\(k = 0, .....\)</span></p>
<ul>
<li><p class="first">set <span class="math notranslate nohighlight">\(\mathcal{I}_{k} = \{ x \in \Omega / \lambda_{k} + c * ( u_{k+1} - g) \leq 0 \}\)</span></p>
</li>
<li><p class="first"><span class="math notranslate nohighlight">\(V_{g,k+1} = \{ v\in H^1_0(\Omega) / v = g\)</span> on <span class="math notranslate nohighlight">\({I}_{k} \}\)</span>,</p>
</li>
<li><p class="first"><span class="math notranslate nohighlight">\(V_{0,k+1} = \{ v\in H^1_0(\Omega) / v = 0\)</span> on <span class="math notranslate nohighlight">\({I}_{k} \}\)</span>,</p>
</li>
<li><p class="first">Find <span class="math notranslate nohighlight">\(u_{k+1} \in V_{g,k+1}\)</span> and <span class="math notranslate nohighlight">\(\lambda_{k+1} \in H^{-1}(\Omega)\)</span> such that</p>
<div class="math notranslate nohighlight">
\[\left\{\begin{array}{cc}
   \displaystyle \int_\Omega \nabla u_{k+1}. \nabla v_{k+1} \,d\omega = \int_\Omega f v_{k+1} , &amp;\forall v_{k+1} \in V_{0,k+1} \cr
   \displaystyle &lt;\lambda_{k+1},v&gt; = \int_\Omega \nabla u_{k+1}. \nabla v - f v \,d\omega &amp;
\end{array}\right.\]</div>
<p>where <span class="math notranslate nohighlight">\(&lt;,&gt;\)</span> is the duality bracket between <span class="math notranslate nohighlight">\(H^{1}_0(\Omega)\)</span> and <span class="math notranslate nohighlight">\(H^{-1}(\Omega)\)</span>, and <span class="math notranslate nohighlight">\(c\)</span> is a penalty constant (large enough).</p>
</li>
</ul>
</li>
</ol>
<p>You can find all the mathematics about this algorithm in <a class="reference internal" href="../reference.html#ito2003" id="id1">[ITO2003]</a>.</p>
<p>Now how to do that in FreeFem++? The full example is:</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Variational inequality</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;</span><span class="nf">medit</span><span class="s">&quot;</span>

<span class="c1">// Parameters</span>
<span class="kt">real</span> <span class="kp">eps</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="c1">//penalty parameter of the algoritm</span>
<span class="kt">real</span> <span class="kp">tgv</span> <span class="o">=</span> <span class="mf">1e30</span><span class="p">;</span> <span class="c1">//a huge value for exact penalization</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//right hand side function</span>
<span class="kt">func</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//Dirichlet boundary condition function</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">;</span> <span class="c1">//number of degree of freedom</span>
<span class="n">Vh</span> <span class="n">uh</span><span class="p">,</span> <span class="n">uhp</span><span class="p">;</span> <span class="c1">//u^n+1 and u^n</span>
<span class="n">Vh</span> <span class="n">Ik</span><span class="p">;</span> <span class="c1">//to define the set where the containt is reached.</span>
<span class="n">Vh</span> <span class="n">g</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">;</span> <span class="c1">//discret function g</span>
<span class="n">Vh</span> <span class="n">lambda</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">varf</span> <span class="nf">a</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">f</span><span class="o">*</span><span class="n">vh</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">uh</span><span class="o">=</span><span class="n">fd</span><span class="p">)</span>
    <span class="p">;</span>

<span class="c1">//the mass Matrix construction</span>
<span class="kt">varf</span> <span class="nf">vM</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">uh</span><span class="o">*</span><span class="n">vh</span><span class="p">);</span>

<span class="c1">//two versions of the matrix of the problem</span>
<span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">tgv</span><span class="o">=</span><span class="kp">tgv</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">);</span> <span class="c1">//one changing</span>
<span class="kt">matrix</span> <span class="n">AA</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">);</span> <span class="c1">//one for computing residual</span>

<span class="kt">matrix</span> <span class="n">M</span> <span class="o">=</span> <span class="n">vM</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span> <span class="c1">//to do a fast computing of L^2 norm : sqrt(u&#39;*(w=M*u))</span>

<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Aiin</span><span class="p">(</span><span class="kr">n</span><span class="p">);</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Aii</span> <span class="o">=</span> <span class="kp">A</span><span class="p">.</span><span class="kr">diag</span><span class="p">;</span> <span class="c1">//get the diagonal of the matrix</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">tgv</span><span class="o">=</span><span class="kp">tgv</span><span class="p">);</span>

<span class="c1">// Initialization</span>
<span class="n">Ik</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">uhp</span> <span class="o">=</span> <span class="o">-</span><span class="kp">tgv</span><span class="p">;</span>

<span class="c1">// Loop</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">iter</span><span class="p">){</span>
    <span class="c1">// Update</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">;</span> <span class="c1">//get a copy of the Right hand side</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Ak</span><span class="p">(</span><span class="kr">n</span><span class="p">);</span> <span class="c1">//the complementary of Ik ( !Ik = (Ik-1))</span>
    <span class="n">Ak</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span> <span class="n">Ak</span> <span class="o">-=</span> <span class="n">Ik</span><span class="p">[];</span>
    <span class="c1">//adding new locking condition on b and on the diagonal if (Ik ==1 )</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Ik</span><span class="p">[]</span> <span class="p">.</span><span class="o">*</span> <span class="n">g</span><span class="p">[];</span> <span class="n">b</span> <span class="o">*=</span> <span class="kp">tgv</span><span class="p">;</span> <span class="n">b</span> <span class="o">-=</span> <span class="n">Ak</span> <span class="p">.</span><span class="o">*</span> <span class="n">rhs</span><span class="p">;</span>
    <span class="n">Aiin</span> <span class="o">=</span> <span class="n">Ik</span><span class="p">[]</span> <span class="o">*</span> <span class="kp">tgv</span><span class="p">;</span> <span class="n">Aiin</span> <span class="o">+=</span> <span class="n">Ak</span> <span class="p">.</span><span class="o">*</span> <span class="n">Aii</span><span class="p">;</span> <span class="c1">//set Aii= tgv i in Ik</span>
    <span class="kp">A</span><span class="p">.</span><span class="kr">diag</span> <span class="o">=</span> <span class="n">Aiin</span><span class="p">;</span> <span class="c1">//set the matrix diagonal</span>
    <span class="nf">set</span><span class="p">(</span><span class="kp">A</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">);</span> <span class="c1">//important to change preconditioning for solving</span>

    <span class="c1">// Solve</span>
    <span class="n">uh</span><span class="p">[]</span> <span class="o">=</span> <span class="kp">A</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span> <span class="n">b</span><span class="p">;</span> <span class="c1">//solve the problem with more locking condition</span>

    <span class="c1">// Residual</span>
    <span class="n">lambda</span><span class="p">[]</span> <span class="o">=</span> <span class="n">AA</span> <span class="o">*</span> <span class="n">uh</span><span class="p">[];</span> <span class="c1">//compute the residual (fast with matrix)</span>
    <span class="n">lambda</span><span class="p">[]</span> <span class="o">+=</span> <span class="n">rhs</span><span class="p">;</span> <span class="c1">//remark rhs = -\int f v</span>

    <span class="n">Ik</span> <span class="o">=</span> <span class="p">(</span><span class="n">lambda</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span> <span class="n">g</span><span class="o">-</span> <span class="n">uh</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">;</span> <span class="c1">//the new locking value</span>

    <span class="c1">// Plot</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">Ik</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot; lock set &quot;</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;uh&quot;</span><span class="p">);</span>

    <span class="c1">// Error</span>
    <span class="c1">//trick to compute L^2 norm of the variation (fast method)</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">diff</span><span class="p">(</span><span class="kr">n</span><span class="p">),</span> <span class="n">Mdiff</span><span class="p">(</span><span class="kr">n</span><span class="p">);</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">uh</span><span class="p">[]</span> <span class="o">-</span> <span class="n">uhp</span><span class="p">[];</span>
    <span class="n">Mdiff</span> <span class="o">=</span> <span class="n">M</span><span class="o">*</span><span class="n">diff</span><span class="p">;</span>
    <span class="kt">real</span> <span class="kp">err</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">Mdiff</span><span class="o">&#39;*</span><span class="n">diff</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;|| u_{k=1} - u_{k} ||_2 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">err</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="c1">// Stop test</span>
    <span class="k">if</span><span class="p">(</span><span class="kp">err</span> <span class="o">&lt;</span> <span class="kp">eps</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

    <span class="c1">// Update</span>
    <span class="n">uhp</span><span class="p">[]</span> <span class="o">=</span> <span class="n">uh</span><span class="p">[];</span>
<span class="p">}</span>

<span class="c1">// Plot</span>
<span class="nf">medit</span><span class="p">(</span><span class="s">&quot;uh&quot;</span><span class="p">,</span> <span class="n">Th</span><span class="p">,</span> <span class="n">uh</span><span class="p">);</span>
</pre></div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As you can see on this example, some vector, or matrix operator are not implemented so a way is to skip the expression and we use operator <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="o">+=</span></code>,  <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="o">-=</span></code> to merge the result.</p>
</div>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>