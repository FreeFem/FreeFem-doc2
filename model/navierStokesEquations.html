<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Navier-Stokes equations</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">Navier-Stokes equations</a><ul>
<li><a class="reference internal" href="#uzawa-algorithm-and-conjugate-gradients">Uzawa Algorithm and Conjugate Gradients</a></li>
<li><a class="reference internal" href="#nsuzawacahouetchabart-edp">NSUzawaCahouetChabart.edp</a></li>
</ul>
</li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="math notranslate nohighlight">
\[\def\p{{\partial}}\]</div>
<div class="section" id="navier-stokes-equations">
<h1>Navier-Stokes equations<a class="headerlink" href="#navier-stokes-equations" title="Permalink to this headline">¶</a></h1>
<p>The Stokes equations are: for a given <span class="math notranslate nohighlight">\(\mathbf{f}\in L^2(\Omega)^2\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-eqn-stokes">
<span class="eqno">(58)<a class="headerlink" href="#equation-eqn-stokes" title="Permalink to this equation">¶</a></span>\[\begin{split}\left.\begin{array}{cl}
    -\Delta \mathbf{u}+\nabla p &amp; =\mathbf{f} \\
    \nabla\cdot \mathbf{u} &amp;=0
\end{array}\right\}\quad \hbox{ in }\Omega\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{u}=(u_1,u_2)\)</span> is the velocity vector and <span class="math notranslate nohighlight">\(p\)</span> the pressure.
For simplicity, let us choose Dirichlet boundary conditions on the velocity, <span class="math notranslate nohighlight">\(\mathbf{u}=\mathbf{u}_{\Gamma}\)</span> on <span class="math notranslate nohighlight">\(\Gamma\)</span>.</p>
<p>In <a class="reference internal" href="../reference.html#temam1977" id="id1">[TEMAM1977]</a>, Theorem 2.2, there is a weak form of <a class="reference internal" href="#equation-eqn-stokes">(58)</a>:</p>
<p>Find <span class="math notranslate nohighlight">\(\mathbf{v}=(v_1,v_2)\in \mathbf{V}(\Omega)\)</span>:</p>
<div class="math notranslate nohighlight">
\[\mathbf{V}(\Omega)=\{\mathbf{w}\in H^1_0(\Omega)^2|\; \textrm{div}\mathbf{w}=0\}\]</div>
<p>which satisfy:</p>
<div class="math notranslate nohighlight">
\[\sum_{i=1}^2\int_{\Omega}\nabla u_i\cdot \nabla v_i=\int_{\Omega}\mathbf{f}\cdot \mathbf{w}
\quad \textrm{for all }v\in V\]</div>
<p>Here it is used the existence <span class="math notranslate nohighlight">\(p\in H^1(\Omega)\)</span> such that <span class="math notranslate nohighlight">\(\mathbf{u}=\nabla p\)</span>, if:</p>
<div class="math notranslate nohighlight">
\[\int_{\Omega}\mathbf{u}\cdot \mathbf{v}=0\quad \textrm{for all }\mathbf{v}\in V\]</div>
<p>Another weak form is derived as follows: We put:</p>
<div class="math notranslate nohighlight">
\[\mathbf{V}=H^1_0(\Omega)^2;\quad
W=\left\{q\in L^2(\Omega)\left|\; \int_{\Omega}q=0\right.\right\}\]</div>
<p>By multiplying the first equation in <a class="reference internal" href="#equation-eqn-stokes">(58)</a> with <span class="math notranslate nohighlight">\(v\in V\)</span> and the second with <span class="math notranslate nohighlight">\(q\in W\)</span>, subsequent integration over <span class="math notranslate nohighlight">\(\Omega\)</span>, and an application of Green’s formula, we have:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    \int_{\Omega}\nabla\mathbf{u}\cdot \nabla\mathbf{v}-\int_{\Omega}\textrm{div}\mathbf{v}\, p
    &amp;=&amp;\int_{\Omega}\mathbf{f}\cdot\mathbf{v}\\
    \int_{\Omega}\textrm{div}\mathbf{u}\, q&amp;=&amp;0
\end{array}\end{split}\]</div>
<p>This yields the weak form of <a class="reference internal" href="#equation-eqn-stokes">(58)</a>:</p>
<p>Find <span class="math notranslate nohighlight">\((\mathbf{u},p)\in \mathbf{V}\times W\)</span> such that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    a(\mathbf{u},\mathbf{v})+b(\mathbf{v},p)&amp;=&amp;(\mathbf{f},\mathbf{v})\\
    b(\mathbf{u},q)&amp;=&amp;0
\end{array}\end{split}\]</div>
<p>for all <span class="math notranslate nohighlight">\((\mathbf{v},q)\in V\times W\)</span>, where:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    a(\mathbf{u},\mathbf{v})&amp;=&amp;\int_{\Omega}\nabla \mathbf{u}\cdot \nabla\mathbf{v}
    =\sum_{i=1}^2\int_{\Omega}\nabla u_i\cdot \nabla v_i\\
    b(\mathbf{u},q)&amp;=&amp;-\int_{\Omega}\textrm{div}\mathbf{u}\, q
\end{array}\end{split}\]</div>
<p>Now, we consider finite element spaces <span class="math notranslate nohighlight">\(\mathbf{V}_h\subset \mathbf{V}\)</span> and <span class="math notranslate nohighlight">\(W_h\subset W\)</span>, and we assume the following basis functions:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    &amp;&amp;\mathbf{V}_h=V_h\times V_h,\quad
    V_h=\{v_h|\; v_h=v_1\phi_1+\cdots +v_{M_V}\phi_{M_V}\},\\
    &amp;&amp;W_h=\{q_h|\; q_h=q_1\varphi_1+\cdots +q_{M_W}\varphi_{M_W}\}
\end{array}\end{split}\]</div>
<p>The discrete weak form is: Find <span class="math notranslate nohighlight">\((\mathbf{u}_{h},p_{h}) \in \mathbf{V}_{h} \times W_{h}\)</span> such that:</p>
<div class="math notranslate nohighlight" id="equation-eqn-vfstokes">
<span class="eqno">(59)<a class="headerlink" href="#equation-eqn-vfstokes" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{array}{cll}
    a(\mathbf{u}_h,\mathbf{v}_h)+b(\mathbf{v}_h,p) &amp;= (\mathbf{f},\mathbf{v}_h) ,
    &amp;\forall \mathbf{v}_{h} \in \mathbf{V}_{h} \\
    b(\mathbf{u}_h,q_h)&amp;= 0,
    &amp;\forall q_{h} \in W_{h}
\end{array}\end{split}\]</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Assume that:</p>
<ol class="last arabic">
<li><p class="first">There is a constant <span class="math notranslate nohighlight">\(\alpha_h&gt;0\)</span> such that:</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[a(\mathbf{v}_h,\mathbf{v}_h)\ge \alpha\| \mathbf{v}_h\|_{1,\Omega}^2\quad \textrm{for all }\mathbf{v}_h\in Z_h\]</div>
<p>where:</p>
<div class="math notranslate nohighlight">
\[Z_h=\{\mathbf{v}_h\in \mathbf{V}_h|\; b(\mathbf{w}_h,q_h)=0\quad \textrm{for all }q_h\in W_h\}\]</div>
</div></blockquote>
</li>
<li><p class="first">There is a constant <span class="math notranslate nohighlight">\(\beta_h&gt;0\)</span> such that:</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\sup_{\mathbf{v}_h\in \mathbf{V}_h}\frac{b(\mathbf{v}_h,q_h)}{\| \mathbf{v}_h\|_{1,\Omega}}
\ge \beta_h\| q_h\|_{0,\Omega}\quad \textrm{for all }q_h\in W_h\]</div>
<p>Then we have an unique solution <span class="math notranslate nohighlight">\((\mathbf{u}_h,p_h)\)</span> of <a class="reference internal" href="#equation-eqn-vfstokes">(59)</a> satisfying:</p>
<div class="math notranslate nohighlight">
\[\| \mathbf{u}-\mathbf{u}_h\|_{1,\Omega}+\| p-p_h\|_{0,\Omega}
\le C\left(
\inf_{\mathbf{v}_h\in \mathbf{V}_h}\| u-v_h\|_{1,\Omega}
+\inf_{q_h\in W_h}\| p-q_h\|_{0,\Omega}\right)\]</div>
<p>with a constant <span class="math notranslate nohighlight">\(C&gt;0\)</span> (see e.g. <a class="reference internal" href="../reference.html#roberts1993" id="id2">[ROBERTS1993]</a>, Theorem 10.4).</p>
</div></blockquote>
</li>
</ol>
</div>
<p>Let us denote that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    A&amp;=&amp;(A_{ij}),\, A_{ij}=\int_{\Omega}\nabla \phi_j\cdot \nabla \phi_i\qquad
    i,j=1,\cdots,M_{\mathbf{V}}\\
    \mathbf{B}&amp;=&amp;(Bx_{ij},By_{ij}),\,
    Bx_{ij}=-\int_{\Omega}\p \phi_j/\p x\, \varphi_i\qquad
    By_{ij}=-\int_{\Omega}\p \phi_j/\p y\, \varphi_i\nonumber\\
    &amp;&amp;\qquad i=1,\cdots,M_W;j=1,\cdots,M_V\nonumber
\end{array}\end{split}\]</div>
<p>then <a class="reference internal" href="#equation-eqn-vfstokes">(59)</a> is written by:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\left(
\begin{array}{cc}
    \mathbf{A}&amp;\mathbf{\mathbf{B}}^*\\
    \mathbf{B}&amp;0
\end{array}
\right)
\left(
\begin{array}{cc}
    \mathbf{U}_h\\
    \{p_h\}
\end{array}
\right)
=
\left(
\begin{array}{cc}
    \mathbf{F}_h\\
    0
\end{array}
\right)\end{split}\]</div>
<p>where:</p>
<div class="math notranslate nohighlight">
\[\begin{split}&amp;\mathbf{A}=\left(
\begin{array}{cc}
A&amp;0\\
0&amp;A
\end{array}
\right)
\qquad
\mathbf{B}^*=\left\{
\begin{array}{c}
Bx^T\\
By^T
\end{array}
\right\}
\qquad
\mathbf{U}_h=\left\{
\begin{array}{c}
\{u_{1,h}\}\\
\{u_{2,h}\}
\end{array}
\right\}
\qquad
\mathbf{F}_h=\left\{
\begin{array}{c}
\{\textstyle{\int_{\Omega}f_1\phi_i}\}\\
\{\textstyle{\int_{\Omega}f_2\phi_i}\}
\end{array}
\right\}\end{split}\]</div>
<p><strong>Penalty method:</strong> This method consists of replacing <a class="reference internal" href="#equation-eqn-vfstokes">(59)</a> by a more regular problem:</p>
<p>Find <span class="math notranslate nohighlight">\((\mathbf{v}_h^{\epsilon},p_h^{\epsilon})\in \mathbf{V}_h\times \tilde{W}_{h}\)</span> satisfying:</p>
<div class="math notranslate nohighlight" id="equation-eqn-pvfstokes">
<span class="eqno">(60)<a class="headerlink" href="#equation-eqn-pvfstokes" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{array}{cll}
    a(\mathbf{u}_h^\epsilon,\mathbf{v}_h)+b(\mathbf{v}_h,p_h^{\epsilon}) &amp;= (\mathbf{f},\mathbf{v}_h) ,
    &amp;\forall \mathbf{v}_{h} \in \mathbf{V}_{h} \\
    b(\mathbf{u}_h^{\epsilon},q_h)-\epsilon(p_h^{\epsilon},q_h)&amp;= 0,
    &amp;\forall q_{h} \in \tilde{W}_{h}
\end{array}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\tilde{W}_h\subset L^2(\Omega)\)</span>.
Formally, we have:</p>
<div class="math notranslate nohighlight">
\[\textrm{div}\mathbf{u}_h^{\epsilon}=\epsilon p_h^{\epsilon}\]</div>
<p>and the corresponding algebraic problem:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\left(
\begin{array}{cc}
\mathbf{A}&amp;B^*\\
B&amp;-\epsilon I
\end{array}
\right)
\left(
\begin{array}{cc}
\mathbf{U}_h^{\epsilon}\\
\{p_h^{\epsilon}\}
\end{array}
\right)
=
\left(
\begin{array}{cc}
\mathbf{F}_h\\
0
\end{array}
\right)\end{split}\]</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>We can eliminate <span class="math notranslate nohighlight">\(p_h^\epsilon=(1/\epsilon)BU_h^{\epsilon}\)</span> to obtain:</p>
<div class="math notranslate nohighlight" id="equation-eqn-stiffpvfstokes">
<span class="eqno">(61)<a class="headerlink" href="#equation-eqn-stiffpvfstokes" title="Permalink to this equation">¶</a></span>\[(A+(1/\epsilon)B^*B)\mathbf{U}_h^{\epsilon}=\mathbf{F}_h^{\epsilon}\]</div>
<p>Since the matrix <span class="math notranslate nohighlight">\(A+(1/\epsilon)B^*B\)</span> is symmetric, positive-definite, and sparse, <a class="reference internal" href="#equation-eqn-stiffpvfstokes">(61)</a> can be solved by known technique.
There is a constant <span class="math notranslate nohighlight">\(C&gt;0\)</span> independent of <span class="math notranslate nohighlight">\(\epsilon\)</span> such that:</p>
<div class="math notranslate nohighlight">
\[\|\mathbf{u}_h-\mathbf{u}_h^\epsilon\|_{1,\Omega}+
\|p_h-p_h^{\epsilon}\|_{0,\Omega}\le C\epsilon\]</div>
<p class="last">(see e.g. <a class="reference internal" href="../reference.html#roberts1993" id="id3">[ROBERTS1993]</a>, 17.2)</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Cavity</p>
<p>The driven cavity flow problem is solved first at zero Reynolds number (Stokes flow) and then at Reynolds 100.
The velocity pressure formulation is used first and then the calculation is repeated with the stream function vorticity formulation.</p>
<p>We solve the driven cavity problem by the penalty method <a class="reference internal" href="#equation-eqn-pvfstokes">(60)</a> where <span class="math notranslate nohighlight">\(\mathbf{u}_{\Gamma}\cdot \mathbf{n}=0\)</span> and <span class="math notranslate nohighlight">\(\mathbf{u}_{\Gamma}\cdot \mathbf{s}=1\)</span> on the top boundary and zero elsewhere (<span class="math notranslate nohighlight">\(\mathbf{n}\)</span> is the unit normal to <span class="math notranslate nohighlight">\(\Gamma\)</span>, and <span class="math notranslate nohighlight">\(\mathbf{s}\)</span> the unit tangent to <span class="math notranslate nohighlight">\(\Gamma\)</span>).</p>
<p>The mesh is constructed by:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</pre></div>
</div>
<p>We use a classical Taylor-Hood element technique to solve the problem:</p>
<p>The velocity is approximated with the <span class="math notranslate nohighlight">\(P_{2}\)</span> FE (<span class="math notranslate nohighlight">\(X_{h}\)</span> space), and the pressure is approximated with the <span class="math notranslate nohighlight">\(P_{1}\)</span> FE (<span class="math notranslate nohighlight">\(M_{h}\)</span> space), where:</p>
<div class="math notranslate nohighlight">
\[X_{h} = \left\{ \mathbf{v} \in H^{1}(]0,1[^2) \left|\; \forall K \in \mathcal{T}_{h}\quad v_{|K} \in P_{2}\right.\right\}\]</div>
<p>and:</p>
<div class="math notranslate nohighlight">
\[M_{h} = \left\{ v \in H^{1}(]0,1[^2) \left|\; \forall K \in \mathcal{T}_{h}\quad v_{|K} \in P_{1} \right.\right\}\]</div>
<p>The FE spaces and functions are constructed by:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">fespace</span> <span class="nf">Xh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span> <span class="c1">//definition of the velocity component space</span>
<span class="kt">fespace</span> <span class="nf">Mh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span> <span class="c1">//definition of the pressure space</span>
<span class="n">Xh</span> <span class="n">u2</span><span class="p">,</span> <span class="n">v2</span><span class="p">;</span>
<span class="n">Xh</span> <span class="n">u1</span><span class="p">,</span> <span class="n">v1</span><span class="p">;</span>
<span class="n">Mh</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">;</span>
</pre></div>
</div>
<p>The Stokes operator is implemented as a system-solve for the velocity <span class="math notranslate nohighlight">\((u1,u2)\)</span> and the pressure <span class="math notranslate nohighlight">\(p\)</span>.
The test function for the velocity is <span class="math notranslate nohighlight">\((v1,v2)\)</span> and <span class="math notranslate nohighlight">\(q\)</span> for the pressure, so the variational form <a class="reference internal" href="#equation-eqn-vfstokes">(59)</a> in freefem language is:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">solve</span> <span class="nf">Stokes</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Crout</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="p">(</span>
            <span class="nf">dx</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
            <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
            <span class="o">+</span> <span class="nf">dx</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
            <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mf">0.000001</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
        <span class="o">-</span> <span class="nf">dx</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span> <span class="o">-</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">u2</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">u2</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>
</pre></div>
</div>
<p>Each unknown has its own boundary conditions.</p>
<p>If the streamlines are required, they can be computed by finding <span class="math notranslate nohighlight">\(\psi\)</span> such that <span class="math notranslate nohighlight">\(rot\psi=u\)</span> or better:</p>
<div class="math notranslate nohighlight">
\[-\Delta\psi=\nabla\times u\]</div>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="n">Xh</span> <span class="n">psi</span><span class="p">,</span> <span class="n">phi</span><span class="p">;</span>

<span class="kt">solve</span> <span class="nf">streamlines</span> <span class="p">(</span><span class="n">psi</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">phi</span><span class="o">*</span><span class="p">(</span><span class="nf">dy</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span> <span class="o">-</span> <span class="nf">dx</span><span class="p">(</span><span class="n">u2</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">psi</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>
</pre></div>
</div>
<p>Now the Navier-Stokes equations are solved:</p>
<div class="math notranslate nohighlight">
\[{\p {u}\over\p t} +u\cdot\nabla u-\nu \Delta u+\nabla p=0, \nabla\cdot u=0\]</div>
<p>with the same boundary conditions and with initial conditions <span class="math notranslate nohighlight">\(u=0\)</span>.</p>
<p>This is implemented by using the convection operator <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">convect</span></code> for the term <span class="math notranslate nohighlight">\({\p u\over\p t} +u\cdot\nabla u\)</span>, giving a discretization in time</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{cl}
    \frac{1}{\tau } (u^{n+1}-u^n\circ X^n) -\nu\Delta u^{n+1} + \nabla p^{n+1} &amp;=0,\\
    \nabla\cdot u^{n+1} &amp;= 0
\end{array}\end{split}\]</div>
<p>The term <span class="math notranslate nohighlight">\(u^n\circ X^n(x)\approx u^n(x-u^n(x)\tau )\)</span> will be computed by the operator <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">convect</span></code>, so we obtain:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">dt</span><span class="p">;</span>
<span class="kt">problem</span> <span class="nf">NS</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Crout</span><span class="p">,</span> <span class="kp">init</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">u1</span><span class="o">*</span><span class="n">v1</span> <span class="o">+</span> <span class="n">u2</span><span class="o">*</span><span class="n">v2</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">nu</span> <span class="o">*</span> <span class="p">(</span>
              <span class="nf">dx</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
            <span class="o">+</span> <span class="nf">dx</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mf">0.000001</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
        <span class="o">-</span> <span class="nf">dx</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span> <span class="o">-</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">alpha</span><span class="o">*</span><span class="nf">convect</span><span class="p">([</span><span class="n">up1</span><span class="p">,</span><span class="n">up2</span><span class="p">],</span><span class="o">-</span><span class="n">dt</span><span class="p">,</span><span class="n">up1</span><span class="p">)</span><span class="o">*</span><span class="n">v1</span>
        <span class="o">-</span> <span class="n">alpha</span><span class="o">*</span><span class="nf">convect</span><span class="p">([</span><span class="n">up1</span><span class="p">,</span><span class="n">up2</span><span class="p">],</span><span class="o">-</span><span class="n">dt</span><span class="p">,</span><span class="n">up2</span><span class="p">)</span><span class="o">*</span><span class="n">v2</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">u2</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="n">u1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">u2</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Time loop</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="c1">// Update</span>
    <span class="n">up1</span> <span class="o">=</span> <span class="n">u1</span><span class="p">;</span>
    <span class="n">up2</span> <span class="o">=</span> <span class="n">u2</span><span class="p">;</span>

    <span class="c1">// Solve</span>
    <span class="n">NS</span><span class="p">;</span>

    <span class="c1">// Plot</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span><span class="p">))</span>
    <span class="nf">plot</span><span class="p">(</span><span class="kp">coef</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;[u1,u2] and p&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="p">[</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Notice that the stiffness matrices are reused (keyword <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">init</span><span class="o">=</span><span class="n">i</span></code>)</p>
<p class="last">The complete script is available in <a class="reference internal" href="../example/index.html#examplecavity"><span class="std std-ref">cavity example</span></a>.</p>
</div>
<div class="section" id="uzawa-algorithm-and-conjugate-gradients">
<span id="navierstokesuzawaconjugategradients"></span><h2>Uzawa Algorithm and Conjugate Gradients<a class="headerlink" href="#uzawa-algorithm-and-conjugate-gradients" title="Permalink to this headline">¶</a></h2>
<p>We solve Stokes problem without penalty.
The classical iterative method of Uzawa is described by the algorithm (see e.g. <a class="reference internal" href="../reference.html#roberts1993" id="id4">[ROBERTS1993]</a>, 17.3, <a class="reference internal" href="../reference.html#glowinski1979" id="id5">[GLOWINSKI1979]</a>, 13 or <a class="reference internal" href="../reference.html#glowinski1985" id="id6">[GLOWINSKI1985]</a>, 13):</p>
<ul>
<li><p class="first"><strong>Initialize:</strong> Let <span class="math notranslate nohighlight">\(p_h^0\)</span> be an arbitrary chosen element of <span class="math notranslate nohighlight">\(L^2(\Omega)\)</span>.</p>
</li>
<li><p class="first"><strong>Calculate :math:`mathbf{u}_h`:</strong> Once <span class="math notranslate nohighlight">\(p_h^n\)</span> is known, <span class="math notranslate nohighlight">\(\mathbf{v}_h^n\)</span> is the solution of:</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\mathbf{u}_h^n = A^{-1}(\mathbf{f}_h-\mathbf{B}^*p_h^n)\]</div>
</div></blockquote>
</li>
<li><p class="first"><strong>Advance :math:`p_h`:</strong> Let <span class="math notranslate nohighlight">\(p_h^{n+1}\)</span> be defined by;</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[p_h^{n+1}=p_h^n+\rho_n\mathbf{B}\mathbf{u}_h^n\]</div>
</div></blockquote>
</li>
</ul>
<p>There is a constant <span class="math notranslate nohighlight">\(\alpha&gt;0\)</span> such that <span class="math notranslate nohighlight">\(\alpha\le \rho_n\le 2\)</span> for each <span class="math notranslate nohighlight">\(n\)</span>, then <span class="math notranslate nohighlight">\(\mathbf{u}_h^n\)</span> converges to the solution <span class="math notranslate nohighlight">\(\mathbf{u}_h\)</span>, and then <span class="math notranslate nohighlight">\(B\mathbf{v}_h^n\to 0\)</span> as <span class="math notranslate nohighlight">\(n\to \infty\)</span> from the <em>Advance</em> <span class="math notranslate nohighlight">\(p_h\)</span>. This method in general converges quite slowly.</p>
<p>First we define mesh, and the Taylor-Hood approximation.
So <span class="math notranslate nohighlight">\(X_{h}\)</span> is the velocity space, and <span class="math notranslate nohighlight">\(M_{h}\)</span> is the pressure space.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Stokes Uzawa</p>
<div class="last highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Xh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span>
<span class="n">Xh</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">;</span>
<span class="n">Xh</span> <span class="n">bc1</span><span class="p">,</span> <span class="n">bc2</span><span class="p">;</span>
<span class="n">Xh</span> <span class="n">b</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Mh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Mh</span> <span class="n">p</span><span class="p">;</span>
<span class="n">Mh</span> <span class="n">ppp</span><span class="p">;</span> <span class="c1">//ppp is a working pressure</span>

<span class="c1">// Problem</span>
<span class="kt">varf</span> <span class="nf">bx</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="o">-</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">));</span>
<span class="kt">varf</span> <span class="nf">by</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="o">-</span><span class="p">(</span><span class="nf">dy</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">));</span>
<span class="kt">varf</span> <span class="nf">a</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
<span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
<span class="c1">//remark: put the on(3,u1=1) before on(1,2,4,u1=0)</span>
<span class="c1">//because we want zero on intersection</span>

<span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">Xh</span><span class="p">,</span> <span class="n">Xh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="n">Bx</span> <span class="o">=</span> <span class="n">bx</span><span class="p">(</span><span class="n">Xh</span><span class="p">,</span> <span class="n">Mh</span><span class="p">);</span> <span class="c1">//B=(Bx, By)</span>
<span class="kt">matrix</span> <span class="n">By</span> <span class="o">=</span> <span class="n">by</span><span class="p">(</span><span class="n">Xh</span><span class="p">,</span> <span class="n">Mh</span><span class="p">);</span>

<span class="n">bc1</span><span class="p">[]</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Xh</span><span class="p">);</span> <span class="c1">//boundary condition contribution on u1</span>
<span class="n">bc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//no boundary condition contribution on u2</span>

<span class="c1">//p_h^n -&gt; B A^-1 - B^* p_h^n = -div u_h</span>
<span class="c1">//is realized as the function divup</span>
<span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">divup</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">pp</span><span class="p">){</span>
    <span class="c1">//compute u1(pp)</span>
    <span class="n">b</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Bx</span><span class="o">&#39;*</span><span class="n">pp</span><span class="p">;</span>
    <span class="n">b</span><span class="p">[]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">b</span><span class="p">[]</span> <span class="o">+=</span> <span class="n">bc1</span><span class="p">[];</span>
    <span class="n">u1</span><span class="p">[]</span> <span class="o">=</span> <span class="kp">A</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">[];</span>
    <span class="c1">//compute u2(pp)</span>
    <span class="n">b</span><span class="p">[]</span> <span class="o">=</span> <span class="n">By</span><span class="o">&#39;*</span><span class="n">pp</span><span class="p">;</span>
    <span class="n">b</span><span class="p">[]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">b</span><span class="p">[]</span> <span class="o">+=</span> <span class="n">bc2</span><span class="p">[];</span>
    <span class="n">u2</span><span class="p">[]</span> <span class="o">=</span> <span class="kp">A</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">[];</span>
    <span class="c1">//u^n = (A^-1 Bx^T p^n, By^T p^n)^T</span>
    <span class="n">ppp</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Bx</span><span class="o">*</span><span class="n">u1</span><span class="p">[];</span> <span class="c1">//ppp = Bx u_1</span>
    <span class="n">ppp</span><span class="p">[]</span> <span class="o">+=</span> <span class="n">By</span><span class="o">*</span><span class="n">u2</span><span class="p">[];</span> <span class="c1">//+ By u_2</span>

    <span class="k">return</span> <span class="n">ppp</span><span class="p">[]</span> <span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Initialization</span>
<span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="c1">//p_h^0 = 0</span>
<span class="nf">LinearCG</span><span class="p">(</span><span class="n">divup</span><span class="p">,</span> <span class="n">p</span><span class="p">[],</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">50</span><span class="p">);</span> <span class="c1">//p_h^{n+1} = p_h^n + B u_h^n</span>
<span class="c1">// if n&gt; 50 or |p_h^{n+1} - p_h^n| &lt;= 10^-6, then the loop end</span>
<span class="n">divup</span><span class="p">(</span><span class="n">p</span><span class="p">[]);</span> <span class="c1">//compute the final solution</span>

<span class="nf">plot</span><span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">coef</span><span class="o">=</span><span class="mf">0.1</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="nsuzawacahouetchabart-edp">
<h2>NSUzawaCahouetChabart.edp<a class="headerlink" href="#nsuzawacahouetchabart-edp" title="Permalink to this headline">¶</a></h2>
<p>In this example we solve the Navier-Stokes equation past a cylinder with the Uzawa algorithm preconditioned by the Cahouet-Chabart method (see <a class="reference internal" href="../reference.html#glowinski2003" id="id7">[GLOWINSKI2003]</a> for all the details).</p>
<p>The idea of the preconditioner is that in a periodic domain, all differential operators commute and the Uzawa algorithm comes to solving the linear operator <span class="math notranslate nohighlight">\(\nabla. ( (\alpha Id + \nu \Delta)^{-1} \nabla\)</span>, where <span class="math notranslate nohighlight">\(Id\)</span> is the identity operator.
So the preconditioner suggested is <span class="math notranslate nohighlight">\(\alpha \Delta^{-1} + \nu Id\)</span>.</p>
<p>To implement this, we do:</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>NS Uzawa Cahouet Chabart</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kr">verbosity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">D</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">H</span> <span class="o">=</span> <span class="mf">0.41</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">cx0</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">cy0</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span> <span class="c1">//center of cylinder</span>
<span class="kt">real</span> <span class="n">xa</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">ya</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">xe</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">ye</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">nn</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>

<span class="c1">//TODO</span>
<span class="kt">real</span> <span class="n">Um</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">;</span> <span class="c1">//max velocity (Rey 100)</span>
<span class="kt">real</span> <span class="n">nu</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">;</span>

<span class="kt">func</span> <span class="n">U1</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">Um</span><span class="o">*</span><span class="kr">y</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="kr">y</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">H</span><span class="o">*</span><span class="n">H</span><span class="p">);</span> <span class="c1">//Boundary condition</span>
<span class="kt">func</span> <span class="n">U2</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">T</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">D</span><span class="o">/</span><span class="n">nn</span><span class="o">/</span><span class="n">Um</span><span class="p">;</span> <span class="c1">//CFL = 1</span>
<span class="kt">real</span> <span class="n">epspq</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">;</span>
<span class="kt">real</span> <span class="kp">eps</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">;</span>

<span class="c1">// Variables</span>
<span class="kt">func</span> <span class="n">Ub</span> <span class="o">=</span> <span class="n">Um</span><span class="o">*</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dt</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">Rey</span> <span class="o">=</span> <span class="n">Ub</span><span class="o">*</span><span class="n">D</span><span class="o">/</span><span class="n">nu</span><span class="p">;</span>
<span class="kt">real</span> <span class="kp">t</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">fr1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">fr2</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">2.2</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">fr3</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">2.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">H</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">fr4</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">fr5</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">cx0</span><span class="o">+</span><span class="n">D</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">cy0</span><span class="o">+</span><span class="n">D</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">3</span><span class="p">;}</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">fr1</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">nn</span><span class="p">)</span> <span class="o">+</span> <span class="n">fr2</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span> <span class="o">+</span> <span class="n">fr3</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">nn</span><span class="p">)</span> <span class="o">+</span> <span class="n">fr4</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span> <span class="o">+</span> <span class="n">fr5</span><span class="p">(</span><span class="o">-</span><span class="n">nn</span><span class="o">*</span><span class="mi">3</span><span class="p">));</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Mh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="p">[</span><span class="nc">P1</span><span class="p">]);</span>
<span class="n">Mh</span> <span class="n">p</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Xh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="p">[</span><span class="nc">P2</span><span class="p">]);</span>
<span class="n">Xh</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Wh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="p">[</span><span class="nc">P1dc</span><span class="p">]);</span>
<span class="n">Wh</span> <span class="n">w</span><span class="p">;</span> <span class="c1">//vorticity</span>

<span class="c1">// Macro</span>
<span class="kt">macro</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">div</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u2</span><span class="p">))</span> <span class="c1">//</span>

<span class="c1">// Problem</span>
<span class="kt">varf</span> <span class="n">von1</span> <span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">q</span><span class="p">])</span>
    <span class="o">=</span> <span class="nf">on</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">u2</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="n">U1</span><span class="p">,</span> <span class="n">u2</span><span class="o">=</span><span class="n">U2</span><span class="p">)</span>
    <span class="p">;</span>

<span class="c1">//remark : the value 100 in next varf is manualy fitted, because free outlet.</span>
<span class="kt">varf</span> <span class="nf">vA</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span>
    <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">grad</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">&#39;</span> <span class="o">*</span> <span class="n">grad</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">2</span><span class="p">)(</span>
          <span class="mi">100</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">q</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">vM</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qft</span><span class="o">=</span><span class="kr">qf2pT</span><span class="p">)(</span>
          <span class="n">p</span><span class="o">*</span><span class="n">q</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">vu</span> <span class="p">([</span><span class="n">u1</span><span class="p">],</span> <span class="p">[</span><span class="n">v1</span><span class="p">])</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">u1</span><span class="o">*</span><span class="n">v1</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">nu</span><span class="o">*</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">&#39;</span> <span class="o">*</span> <span class="n">grad</span><span class="p">(</span><span class="n">v1</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">vu1</span> <span class="p">([</span><span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">v1</span><span class="p">])</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">p</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v1</span><span class="p">));</span>
<span class="kt">varf</span> <span class="nf">vu2</span> <span class="p">([</span><span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">v1</span><span class="p">])</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">p</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v1</span><span class="p">));</span>

<span class="kt">varf</span> <span class="nf">vonu1</span> <span class="p">([</span><span class="n">u1</span><span class="p">],</span> <span class="p">[</span><span class="n">v1</span><span class="p">])</span> <span class="o">=</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="n">U1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="kt">varf</span> <span class="nf">vonu2</span> <span class="p">([</span><span class="n">u1</span><span class="p">],</span> <span class="p">[</span><span class="n">v1</span><span class="p">])</span> <span class="o">=</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="n">U2</span><span class="p">)</span> <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>

<span class="kt">matrix</span> <span class="n">pAM</span> <span class="o">=</span> <span class="n">vM</span><span class="p">(</span><span class="n">Mh</span><span class="p">,</span> <span class="n">Mh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">UMFPACK</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="n">pAA</span> <span class="o">=</span> <span class="n">vA</span><span class="p">(</span><span class="n">Mh</span><span class="p">,</span> <span class="n">Mh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">UMFPACK</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="n">AU</span> <span class="o">=</span> <span class="n">vu</span><span class="p">(</span><span class="n">Xh</span><span class="p">,</span> <span class="n">Xh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">UMFPACK</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="kp">B1</span> <span class="o">=</span> <span class="n">vu1</span><span class="p">(</span><span class="n">Mh</span><span class="p">,</span> <span class="n">Xh</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="n">B2</span> <span class="o">=</span> <span class="n">vu2</span><span class="p">(</span><span class="n">Mh</span><span class="p">,</span> <span class="n">Xh</span><span class="p">);</span>

<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">brhs1</span> <span class="o">=</span> <span class="n">vonu1</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Xh</span><span class="p">);</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">brhs2</span> <span class="o">=</span> <span class="n">vonu2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Xh</span><span class="p">);</span>

<span class="kt">varf</span> <span class="nf">vrhs1</span><span class="p">(</span><span class="n">uu</span><span class="p">,</span> <span class="n">vv</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="nf">convect</span><span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">],</span> <span class="o">-</span><span class="n">dt</span><span class="p">,</span> <span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">vv</span><span class="o">*</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">vonu1</span><span class="p">;</span>
<span class="kt">varf</span> <span class="nf">vrhs2</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="nf">convect</span><span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">],</span> <span class="o">-</span><span class="n">dt</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">v1</span><span class="o">*</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">vonu2</span><span class="p">;</span>

<span class="c1">// Uzawa function</span>
<span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">JUzawa</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">pp</span><span class="p">){</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">brhs1</span><span class="p">;</span> <span class="n">b1</span> <span class="o">+=</span> <span class="kp">B1</span><span class="o">*</span><span class="n">pp</span><span class="p">;</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">brhs2</span><span class="p">;</span> <span class="n">b2</span> <span class="o">+=</span> <span class="n">B2</span><span class="o">*</span><span class="n">pp</span><span class="p">;</span>
    <span class="n">u1</span><span class="p">[]</span> <span class="o">=</span> <span class="n">AU</span><span class="o">^-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">b1</span><span class="p">;</span>
    <span class="n">u2</span><span class="p">[]</span> <span class="o">=</span> <span class="n">AU</span><span class="o">^-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">b2</span><span class="p">;</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="kp">B1</span><span class="o">&#39;*</span><span class="n">u1</span><span class="p">[];</span>
    <span class="n">pp</span> <span class="o">+=</span> <span class="n">B2</span><span class="o">&#39;*</span><span class="n">u2</span><span class="p">[];</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">pp</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Preconditioner function</span>
<span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Precon</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">p</span><span class="p">){</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">pAA</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">pAM</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">pa</span> <span class="o">+</span> <span class="n">nu</span><span class="o">*</span><span class="n">pm</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">pp</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Initialization</span>
<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Time loop</span>
<span class="kt">int</span> <span class="n">ndt</span> <span class="o">=</span> <span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ndt</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="c1">// Update</span>
    <span class="n">brhs1</span> <span class="o">=</span> <span class="n">vrhs1</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Xh</span><span class="p">);</span>
    <span class="n">brhs2</span> <span class="o">=</span> <span class="n">vrhs2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Xh</span><span class="p">);</span>

    <span class="c1">// Solve</span>
    <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="nf">LinearCG</span><span class="p">(</span><span class="n">JUzawa</span><span class="p">,</span> <span class="n">p</span><span class="p">[],</span> <span class="kp">precon</span><span class="o">=</span><span class="n">Precon</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="kp">veps</span><span class="o">=</span><span class="kp">eps</span><span class="p">);</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">res</span><span class="o">==</span><span class="mi">1</span><span class="p">);</span>
    <span class="kp">eps</span> <span class="o">=</span> <span class="o">-</span><span class="nf">abs</span><span class="p">(</span><span class="kp">eps</span><span class="p">);</span>

    <span class="c1">// Vorticity</span>
    <span class="n">w</span> <span class="o">=</span> <span class="o">-</span><span class="nf">dy</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dx</span><span class="p">(</span><span class="n">u2</span><span class="p">);</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="kp">nbiso</span><span class="o">=</span><span class="mi">40</span><span class="p">);</span>

    <span class="c1">// Update</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="kr">min</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">T</span><span class="o">-</span><span class="kp">t</span><span class="p">);</span>
    <span class="kp">t</span> <span class="o">+=</span> <span class="n">dt</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dt</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="o">*</span><span class="n">T</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">nbiso</span><span class="o">=</span><span class="mi">40</span><span class="p">);</span>

<span class="c1">// Display</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;u1 max = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u1</span><span class="p">[].</span><span class="kr">linfty</span>
    <span class="o">&lt;&lt;</span> <span class="s">&quot;, u2 max = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u2</span><span class="p">[].</span><span class="kr">linfty</span>
    <span class="o">&lt;&lt;</span> <span class="s">&quot;, p max = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">p</span><span class="p">[].</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Stop test of the conjugate gradient</p>
<p class="last">Because we start from the previous solution and the end the previous solution is close to the final solution, don’t take a relative stop test to the first residual, take an absolute stop test (negative here).</p>
</div>
<div class="last figure" id="navierstokesequations">
<img alt="../_images/NavierStokesEquations.png" src="../_images/NavierStokesEquations.png" />
<p class="caption"><span class="caption-number">Fig. 208 </span><span class="caption-text">The vorticity at Reynolds number 100 a time 2s with the Cahouet-Chabart method.</span></p>
</div>
</div>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>