<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>A projection algorithm for the Navier-Stokes equations</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">A projection algorithm for the Navier-Stokes equations</a></li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="section" id="a-projection-algorithm-for-the-navier-stokes-equations">
<h1>A projection algorithm for the Navier-Stokes equations<a class="headerlink" href="#a-projection-algorithm-for-the-navier-stokes-equations" title="Permalink to this headline">¶</a></h1>
<p><strong>Summary :</strong>
<em>Fluid flows require good algorithms and good triangultions. We show here an example of a complex algorithm and or first example of mesh adaptation.</em></p>
<p>An incompressible viscous fluid satisfies:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    \partial_t \mathbf{u} + \mathbf{u}\cdot\nabla\mathbf{u} + \nabla p - \nu\Delta\mathbf{u} &amp;= 0 &amp;\hbox{ in } \Omega\times ]0,T[\\
    \nabla\cdot\mathbf{u} &amp;= 0 &amp;\hbox{ in } \Omega\times ]0,T[\\
    \mathbf{u}|_{t=0} &amp;= \mathbf{u}^0\\
    \mathbf{u}|_\Gamma &amp;= \mathbf{u}_\Gamma
\end{array}\end{split}\]</div>
<p>A possible algorithm, proposed by Chorin, is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    {1\over \delta t}[\mathbf{u}^{m+1} - \mathbf{u}^mo\mathbf{X}^m] + \nabla p^m -\nu\Delta \mathbf{u}^m &amp;=&amp; 0\\
    \mathbf{u}|_\Gamma &amp;=&amp; \mathbf{u}_\Gamma\\
    \nu \partial_n \mathbf{u}|_{\Gamma_{out}} &amp;=&amp;0
\end{array}\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    -\Delta p^{m+1} &amp;= -\nabla\cdot \mathbf{u}^mo\mathbf{X}^m &amp;\\
    \partial_n p^{m+1} &amp;= 0 &amp;\mbox{ on } \Gamma\\
    p^{m+1} &amp;= 0 &amp;\mbox{ on } \Gamma_{out}
\end{array}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{u}o\mathbf{X}(x) = \mathbf{u}(\mathbf{x}-\mathbf{u}(\mathbf{x})\delta t)\)</span> since <span class="math notranslate nohighlight">\(\partial_t \mathbf{u} + \mathbf{u}\cdot\nabla \mathbf{u}\)</span> is approximated by the method of characteristics, as in the previous section.</p>
<p>We use the Chorin’s algorithm with free boundary condition at outlet (i.e.&nbsp;<span class="math notranslate nohighlight">\(p=0,\nu \partial_n u = 0\)</span>), to compute a correction, q, to the pressure.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    -\Delta q &amp;= \nabla\cdot\mathbf{u}&amp;\\
    q &amp;= 0 \mbox{ on } &amp;\Gamma_{out}
\end{array}\end{split}\]</div>
<p>and define</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    \mathbf{u}^{m+1} &amp;=&amp; \tilde{\mathbf{u}} + P \nabla q\delta t\\
    p^{m+1} &amp;=&amp; p^m-q
\end{array}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\tilde{\mathbf{u}}\)</span> is the <span class="math notranslate nohighlight">\((\mathbf{u}^{m+1}, v^{m+1})\)</span> of Chorin’s algorithm, and where <span class="math notranslate nohighlight">\(P\)</span> is the <span class="math notranslate nohighlight">\(L^2\)</span> projection with mass lumping ( a sparse matrix).</p>
<p><strong>The backward facing step</strong></p>
<p>The geometry is that of a channel with a backward facing step so that the inflow section is smaller than the outflow section.
This geometry produces a fluid recirculation zone that must be captured correctly.</p>
<p>This can only be done if the triangulation is sufficiently fine, or well adapted to the flow.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is a technical difficulty in the example: the output B.C.
Here we put <span class="math notranslate nohighlight">\(p=0\)</span> and <span class="math notranslate nohighlight">\(\nu \partial_n u = 0\)</span>.</p>
</div>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kr">verbosity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">nn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">nu</span> <span class="o">=</span> <span class="mf">0.0025</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">epsv</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">epsu</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">epsp</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">a0</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="mi">2</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">a1</span><span class="p">(</span><span class="kp">t</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">a2</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">a3</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">18</span><span class="o">*</span><span class="kp">t</span><span class="o">^</span><span class="mf">1.2</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">a4</span><span class="p">(</span><span class="kp">t</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">18</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">3</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">a5</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="mi">2</span><span class="o">+</span><span class="mi">20</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">4</span><span class="p">;}</span>

<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">a0</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nn</span><span class="p">)</span> <span class="o">+</span> <span class="n">a1</span><span class="p">(</span><span class="mi">20</span><span class="o">*</span><span class="n">nn</span><span class="p">)</span> <span class="o">+</span> <span class="n">a2</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">nn</span><span class="p">)</span> <span class="o">+</span> <span class="n">a3</span><span class="p">(</span><span class="mi">150</span><span class="o">*</span><span class="n">nn</span><span class="p">)</span> <span class="o">+</span> <span class="n">a4</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">nn</span><span class="p">)</span> <span class="o">+</span> <span class="n">a5</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">nn</span><span class="p">));</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">w</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">q</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="c1">// Definition of Matrix dtMx and dtMy</span>
<span class="kt">matrix</span> <span class="n">dtM1x</span><span class="p">,</span> <span class="n">dtM1y</span><span class="p">;</span>

<span class="c1">// Macro</span>
<span class="kt">macro</span> <span class="nf">BuildMat</span><span class="p">()</span>
<span class="p">{</span>   <span class="cm">/* for memory managenemt */</span>
    <span class="kt">varf</span> <span class="n">vM</span><span class="p">(</span><span class="kr">unused</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">v</span><span class="p">);</span>
    <span class="kt">varf</span> <span class="n">vdx</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">v</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">);</span>
    <span class="kt">varf</span> <span class="n">vdy</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">v</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">);</span>

    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Mlump</span> <span class="o">=</span> <span class="n">vM</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">one</span><span class="p">(</span><span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">);</span> <span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">M1</span> <span class="o">=</span> <span class="n">one</span> <span class="p">.</span><span class="o">/</span> <span class="n">Mlump</span><span class="p">;</span>
    <span class="kt">matrix</span> <span class="n">dM1</span> <span class="o">=</span> <span class="n">M1</span><span class="p">;</span>
    <span class="kt">matrix</span> <span class="n">Mdx</span> <span class="o">=</span> <span class="n">vdx</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="kt">matrix</span> <span class="n">Mdy</span> <span class="o">=</span> <span class="n">vdy</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="n">dtM1x</span> <span class="o">=</span> <span class="n">dM1</span><span class="o">*</span><span class="n">Mdx</span><span class="p">;</span>
    <span class="n">dtM1y</span> <span class="o">=</span> <span class="n">dM1</span><span class="o">*</span><span class="n">Mdy</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">//</span>

<span class="c1">// Build matrices</span>
<span class="n">BuildMat</span>

<span class="c1">// Time iterations</span>
<span class="kt">real</span> <span class="kp">err</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">outflux</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">n</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">;</span> <span class="kr">n</span><span class="o">++</span><span class="p">){</span>
    <span class="c1">// Update</span>
    <span class="n">Vh</span> <span class="n">uold</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">vold</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">pold</span><span class="o">=</span><span class="n">p</span><span class="p">;</span>

    <span class="c1">// Solve</span>
    <span class="kt">solve</span> <span class="nf">pb4u</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="kp">init</span><span class="o">=</span><span class="kr">n</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="n">epsu</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
              <span class="n">u</span><span class="o">*</span><span class="n">w</span><span class="o">/</span><span class="n">dt</span>
            <span class="o">+</span> <span class="n">nu</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="o">-</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
                <span class="nf">convect</span><span class="p">([</span><span class="n">uold</span><span class="p">,</span> <span class="n">vold</span><span class="p">],</span> <span class="o">-</span><span class="n">dt</span><span class="p">,</span> <span class="n">uold</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="o">*</span><span class="n">w</span>
            <span class="o">-</span> <span class="nf">dx</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">w</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">4</span><span class="o">*</span><span class="kr">y</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="kr">y</span><span class="p">))</span>
        <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>

    <span class="kt">solve</span> <span class="nf">pb4v</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="kp">init</span><span class="o">=</span><span class="kr">n</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="n">epsv</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
              <span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="o">/</span><span class="n">dt</span>
            <span class="o">+</span> <span class="n">nu</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="o">-</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
                <span class="nf">convect</span><span class="p">([</span><span class="n">uold</span><span class="p">,</span><span class="n">vold</span><span class="p">],</span><span class="o">-</span><span class="n">dt</span><span class="p">,</span><span class="n">vold</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="o">*</span><span class="n">w</span>
            <span class="o">-</span> <span class="nf">dy</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">w</span>
        <span class="p">)</span>
        <span class="o">+</span><span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="kt">solve</span> <span class="nf">pb4p</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">,</span> <span class="kp">init</span><span class="o">=</span><span class="kr">n</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="n">epsp</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
              <span class="nf">dx</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">+</span><span class="nf">dy</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
              <span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">*</span><span class="n">w</span><span class="o">/</span><span class="n">dt</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="c1">//to have absolute epsilon in CG algorithm.</span>
    <span class="n">epsv</span> <span class="o">=</span> <span class="o">-</span><span class="nf">abs</span><span class="p">(</span><span class="n">epsv</span><span class="p">);</span>
    <span class="n">epsu</span> <span class="o">=</span> <span class="o">-</span><span class="nf">abs</span><span class="p">(</span><span class="n">epsu</span><span class="p">);</span>
    <span class="n">epsp</span> <span class="o">=</span> <span class="o">-</span><span class="nf">abs</span><span class="p">(</span><span class="n">epsp</span><span class="p">);</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">pold</span><span class="o">-</span><span class="n">q</span><span class="p">;</span>
    <span class="n">u</span><span class="p">[]</span> <span class="o">+=</span> <span class="n">dtM1x</span><span class="o">*</span><span class="n">q</span><span class="p">[];</span>
    <span class="n">v</span><span class="p">[]</span> <span class="o">+=</span> <span class="n">dtM1y</span><span class="o">*</span><span class="n">q</span><span class="p">[];</span>

    <span class="c1">// Mesh adaptation</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">n</span><span class="o">%</span><span class="mi">50</span> <span class="o">==</span> <span class="mi">49</span><span class="p">){</span>
        <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">q</span><span class="p">,</span> <span class="kp">err</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="kp">nbvx</span><span class="o">=</span><span class="mi">100000</span><span class="p">);</span>
        <span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
        <span class="n">BuildMat</span> <span class="c1">// Rebuild mat.</span>
    <span class="p">}</span>

    <span class="c1">// Error &amp; Outflux</span>
    <span class="kp">err</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="nf">square</span><span class="p">(</span><span class="n">u</span><span class="o">-</span><span class="n">uold</span><span class="p">)</span><span class="o">+</span><span class="nf">square</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">vold</span><span class="p">))</span><span class="o">/</span><span class="n">Th</span><span class="p">.</span><span class="kr">area</span><span class="p">);</span>
    <span class="n">outflux</span> <span class="o">=</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">)([</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">]</span><span class="o">&#39;*</span><span class="p">[</span><span class="kr">N</span><span class="p">.</span><span class="kr">x</span><span class="p">,</span><span class="kr">N</span><span class="p">.</span><span class="kr">y</span><span class="p">]);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; iter &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">n</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; Err L2 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">err</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; outflux = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">outflux</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="kp">err</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Verification</span>
<span class="nf">assert</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">outflux</span><span class="p">)</span><span class="o">&lt;</span> <span class="mf">2e-3</span><span class="p">);</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">ps</span><span class="o">=</span><span class="s">&quot;NSprojP.eps&quot;</span><span class="p">);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">ps</span><span class="o">=</span><span class="s">&quot;NSprojU.eps&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Rannacher’s projection algorithm: result on an adapted mesh, <a class="reference internal" href="#fignavierprojectionmesh"><span class="std std-numref">Fig. 97</span></a>, showing the pressure, <a class="reference internal" href="#fignavierprojectionp"><span class="std std-numref">Fig. 98</span></a>, and the horizontal velocity <a class="reference internal" href="#fignavierprojectionu"><span class="std std-numref">Fig. 99</span></a> for a Reynolds number of 400 where mesh adaptation is done after 50 iterations on the first mesh.</p>
<div class="figure" id="fignavierprojectionmesh">
<img alt="../_images/navier_stokes_projection_Th.png" src="../_images/navier_stokes_projection_Th.png" />
<p class="caption"><span class="caption-number">Fig. 97 </span><span class="caption-text">Adapted mesh</span></p>
</div>
<div class="figure" id="fignavierprojectionp">
<img alt="../_images/navier_stokes_projection_P.png" src="../_images/navier_stokes_projection_P.png" />
<p class="caption"><span class="caption-number">Fig. 98 </span><span class="caption-text">Pressure</span></p>
</div>
<div class="figure" id="fignavierprojectionu">
<img alt="../_images/navier_stokes_projection_U.png" src="../_images/navier_stokes_projection_U.png" />
<p class="caption"><span class="caption-number">Fig. 99 </span><span class="caption-text">Velocity</span></p>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>