<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Optimal Control</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">Optimal Control</a></li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="section" id="optimal-control">
<h1>Optimal Control<a class="headerlink" href="#optimal-control" title="Permalink to this headline">Â¶</a></h1>
<p>Thanks to the function <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">BFGS</span></code> it is possible to solve complex nonlinear optimization problem within <strong>FreeFem++</strong>.
For example consider the following inverse problem</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    \min_{b, c, d\in R}J &amp;=&amp; \int_E(u-u_d)^2\\
    -\nabla(\kappa(b, c, d)\cdot\nabla u) &amp;=&amp; 0\\
    u|_\Gamma &amp;=&amp; u_\Gamma
\end{array}\end{split}\]</div>
<p>where the desired state <span class="math notranslate nohighlight">\(u_d\)</span>, the boundary data <span class="math notranslate nohighlight">\(u_\Gamma\)</span> and the observation set <span class="math notranslate nohighlight">\(E\subset\Omega\)</span> are all given.
Furthermore let us assume that:</p>
<div class="math notranslate nohighlight">
\[\kappa(x)=1+bI_B(x)+cI_C(x)+dI_D(x)\quad\forall x\in\Omega\]</div>
<p>where <span class="math notranslate nohighlight">\(B,C,D\)</span> are separated subsets of <span class="math notranslate nohighlight">\(\Omega\)</span>.</p>
<p>To solve this problem by the quasi-Newton BFGS method we need the derivatives of <span class="math notranslate nohighlight">\(J\)</span> with respect to <span class="math notranslate nohighlight">\(b,c,d\)</span>.
We self explanatory notations, if <span class="math notranslate nohighlight">\(\delta b,\delta c,\delta d\)</span> are variations of <span class="math notranslate nohighlight">\(b,c,d\)</span> we have:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    \delta J &amp;\approx&amp; 2\int_E(u-u_d)\delta u\\
    -\nabla(\kappa\cdot\nabla\delta u) &amp;\approx&amp; \nabla(\delta\kappa\cdot\nabla u)\\
    \delta u|_\Gamma &amp;=&amp; 0
\end{array}\end{split}\]</div>
<p>Obviously <span class="math notranslate nohighlight">\(J'_b\)</span> is equal to <span class="math notranslate nohighlight">\(\delta J\)</span> when <span class="math notranslate nohighlight">\(\delta b=1,\delta c=0,\delta d=0\)</span>, and so on for <span class="math notranslate nohighlight">\(J'_c\)</span> and <span class="math notranslate nohighlight">\(J'_d\)</span>.</p>
<p>All this is implemented in the following program:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">aa</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);};</span>
<span class="kt">border</span> <span class="kp">bb</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);};</span>
<span class="kt">border</span> <span class="nf">cc</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="mi">3</span><span class="o">+</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);};</span>
<span class="kt">border</span> <span class="nf">dd</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span> <span class="o">=-</span><span class="mi">3</span><span class="o">+</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);};</span>

<span class="kt">mesh</span> <span class="n">th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">aa</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span> <span class="o">+</span> <span class="kp">bb</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span> <span class="o">+</span> <span class="n">cc</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dd</span><span class="p">(</span><span class="mi">35</span><span class="p">));</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">Ib</span><span class="o">=</span><span class="p">((</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="kr">y</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1.0001</span><span class="p">),</span>
   <span class="n">Ic</span><span class="o">=</span><span class="p">(((</span><span class="kr">x</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span> <span class="kr">y</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1.0001</span><span class="p">),</span>
   <span class="n">Id</span><span class="o">=</span><span class="p">((</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="kr">y</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1.0001</span><span class="p">),</span>
   <span class="n">Ie</span><span class="o">=</span><span class="p">(((</span><span class="kr">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span> <span class="kr">y</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">4</span><span class="p">),</span>
   <span class="n">ud</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">uh</span><span class="p">,</span> <span class="n">du</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="kr">z</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="kt">problem</span> <span class="kp">A</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">uh</span><span class="p">)</span>
   <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)(</span>
        <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="kr">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Ib</span><span class="o">+</span><span class="kr">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Ic</span><span class="o">+</span><span class="kr">z</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Id</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">uh</span><span class="p">))</span>
   <span class="p">)</span>
   <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kr">x</span><span class="o">^</span><span class="mi">3</span><span class="o">-</span><span class="kr">y</span><span class="o">^</span><span class="mi">3</span><span class="p">)</span>
   <span class="p">;</span>

<span class="c1">// Solve</span>
<span class="kr">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="kr">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="kr">z</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>
<span class="kp">A</span><span class="p">;</span>
<span class="n">ud</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

<span class="kt">ofstream</span> <span class="nf">f</span><span class="p">(</span><span class="s">&quot;J.txt&quot;</span><span class="p">);</span>
<span class="kt">func</span> <span class="kt">real</span> <span class="nf">J</span><span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">Z</span><span class="p">){</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kr">z</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="kr">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span><span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
   <span class="kp">A</span><span class="p">;</span>
   <span class="kt">real</span> <span class="n">s</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)(</span><span class="n">Ie</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">-</span><span class="n">ud</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">);</span>
   <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Problem BFGS</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="nf">dz</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">dJdz</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="kt">problem</span> <span class="kp">B</span> <span class="p">(</span><span class="n">du</span><span class="p">,</span> <span class="n">uh</span><span class="p">)</span>
   <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)(</span>
        <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="kr">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Ib</span><span class="o">+</span><span class="kr">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Ic</span><span class="o">+</span><span class="kr">z</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Id</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">du</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">du</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">uh</span><span class="p">))</span>
   <span class="p">)</span>
   <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)(</span>
        <span class="p">(</span><span class="nf">dz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Ib</span><span class="o">+</span><span class="nf">dz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Ic</span><span class="o">+</span><span class="nf">dz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Id</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">uh</span><span class="p">))</span>
   <span class="p">)</span>
   <span class="o">+</span><span class="nf">on</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">du</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
   <span class="p">;</span>

<span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">DJ</span><span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">Z</span><span class="p">){</span>
   <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kr">z</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nf">dz</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
         <span class="nf">dz</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nf">dz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="kp">B</span><span class="p">;</span>
      <span class="n">dJdz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)(</span><span class="n">Ie</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">-</span><span class="n">ud</span><span class="p">)</span><span class="o">*</span><span class="n">du</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">dJdz</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Z</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="kr">z</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
   <span class="n">Z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>

<span class="nf">BFGS</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">DJ</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">nbiterline</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;BFGS: J(z) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="kr">z</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
   <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kr">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">ps</span><span class="o">=</span><span class="s">&quot;u.eps&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>In this example the sets <span class="math notranslate nohighlight">\(B,C,D,E\)</span> are circles of boundaries <span class="math notranslate nohighlight">\(bb,cc,dd,ee\)</span> and the domain <span class="math notranslate nohighlight">\(\Omega\)</span> is the circle of boundary <span class="math notranslate nohighlight">\(aa\)</span>.</p>
<p>The desired state <span class="math notranslate nohighlight">\(u_d\)</span> is the solution of the PDE for <span class="math notranslate nohighlight">\(b=2,c=3,d=4\)</span>. The unknowns are packed into array <span class="math notranslate nohighlight">\(z\)</span>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is necessary to recopy <span class="math notranslate nohighlight">\(Z\)</span> into <span class="math notranslate nohighlight">\(z\)</span> because one is a local variable while the other one is global.</p>
</div>
<p>The program found <span class="math notranslate nohighlight">\(b=2.00125,c=3.00109,d=4.00551\)</span>.</p>
<p><a class="reference internal" href="#figoptimalu"><span class="std std-numref">Fig. 115</span></a> and <a class="reference internal" href="#figoptimalj"><span class="std std-numref">Fig. 116</span></a> show <span class="math notranslate nohighlight">\(u\)</span> at convergence and the successive function evaluations of <span class="math notranslate nohighlight">\(J\)</span>.</p>
<div class="inline2 figure" id="figoptimalu">
<img alt="../_images/u-bfgs.png" src="../_images/u-bfgs.png" />
<p class="caption"><span class="caption-number">Fig. 115 </span><span class="caption-text">Level line of <span class="math notranslate nohighlight">\(u\)</span>.</span></p>
</div>
<div class="inline2 figure" id="figoptimalj">
<img alt="../_images/OptimalControl_J.png" src="../_images/OptimalControl_J.png" />
<p class="caption"><span class="caption-number">Fig. 116 </span><span class="caption-text">Successive evaluations of <span class="math notranslate nohighlight">\(J\)</span> by BFGS (5 values above 500 have been removed for readability)</span></p>
</div>
<p>Note that an <em>adjoint state</em> could have been used.
Define <span class="math notranslate nohighlight">\(p\)</span> by:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    -\nabla\cdot(\kappa\nabla p) &amp;=&amp; 2I_E(u-u_d)\\
    p|_\Gamma &amp;=&amp; 0
\end{array}\end{split}\]</div>
<p>Consequently:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    \delta J &amp;=&amp; -\int_{\Omega}(\nabla\cdot(\kappa\nabla p))\delta u\nonumber\\
    &amp;=&amp; \int_\Omega(\kappa\nabla p\cdot\nabla\delta u)\\
    &amp;=&amp;-\int_\Omega(\delta\kappa\nabla p\cdot\nabla u)
\end{array}\end{split}\]</div>
<p>Then the derivatives are found by setting <span class="math notranslate nohighlight">\(\delta b=1, \delta c=\delta d=0\)</span> and so on:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    J'_b&amp;=&amp;-\int_B \nabla p\cdot\nabla u\\
    J'_c&amp;=&amp;-\int_C \nabla p\cdot\nabla u\\
    J'_d&amp;=&amp;-\int_D \nabla p\cdot\nabla u
\end{array}\end{split}\]</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As BFGS stores an <span class="math notranslate nohighlight">\(M\times M\)</span> matrix where <span class="math notranslate nohighlight">\(M\)</span> is the number of unknowns, it is dangerously expensive to use this method when the unknown <span class="math notranslate nohighlight">\(x\)</span> is a Finite Element Function.
One should use another optimizer such as the NonLinear Conjugate Gradient <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">NLCG</span></code> (also a key word of <strong>FreeFem++</strong>).</p>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>