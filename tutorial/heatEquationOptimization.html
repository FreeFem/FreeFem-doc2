<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Time dependent schema optimization for heat equations</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">Time dependent schema optimization for heat equations</a></li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="section" id="time-dependent-schema-optimization-for-heat-equations">
<h1>Time dependent schema optimization for heat equations<a class="headerlink" href="#time-dependent-schema-optimization-for-heat-equations" title="Permalink to this headline">Â¶</a></h1>
<p>First, it is possible to define variational forms, and use this forms to build matrix and vector to make very fast script (4 times faster here).</p>
<p>For example solve the <a class="reference internal" href="thermalConduction.html#thermalconduction"><span class="std std-ref">ThermalConduction</span></a> problem, we must solve the temperature equation in <span class="math notranslate nohighlight">\(\Omega\)</span> in a time interval (0,T).</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcll}
    \partial_t u -\nabla\cdot(\kappa\nabla u) &amp;=&amp; 0 &amp;\hbox{ in } \Omega\times(0,T)\\
    u(x,y,0) &amp;=&amp; u_0 + x u_1\\
    u &amp;=&amp; 30 &amp;\hbox{ on } \Gamma_{24}\times(0,T)\\
    \kappa\frac{\partial u}{\partial n} + \alpha(u-u_e) &amp;=&amp; 0 &amp;\hbox{ on } \Gamma\times(0,T)
\end{array}\end{split}\]</div>
<p>The variational formulation is in <span class="math notranslate nohighlight">\(L^2(0,T;H^1(\Omega))\)</span>; we shall seek <span class="math notranslate nohighlight">\(u^n\)</span> satisfying:</p>
<div class="math notranslate nohighlight">
\[\forall w \in V_{0};\ \int_\Omega \frac{u^n-u^{n-1}}{\delta t} w + \kappa\nabla u^n\nabla w) +\int_\Gamma\alpha(u^n-u_{ue})w=0\]</div>
<p>where <span class="math notranslate nohighlight">\(V_0 = \{w\in H^1(\Omega)/ w_{|\Gamma_{24}}=0\}\)</span>.</p>
<p>So, to code the method with the matrices <span class="math notranslate nohighlight">\(A=(A_{ij})\)</span>, <span class="math notranslate nohighlight">\(M=(M_{ij})\)</span>, and the vectors <span class="math notranslate nohighlight">\(u^n, b^n, b',b&quot;, b_{cl}\)</span> (notation if <span class="math notranslate nohighlight">\(w\)</span> is a vector then <span class="math notranslate nohighlight">\(w_i\)</span> is a component of the vector).</p>
<div class="math notranslate nohighlight">
\[\begin{split}u^n = A^{-1} b^n,
    \quad b' = b_0 + M u^{n-1},
    \quad b&quot;= \frac{1}{\varepsilon} \; b_{cl} ,
    \quad b^n_i = \left\{
        \begin{array}{cl}
            b''_i &amp; \mbox{if }\ i \in \Gamma_{24} \\
            b'_i &amp; \mbox{else }
        \end{array}\right.
    \label{eq tgv}\end{split}\]</div>
<p>Where with <span class="math notranslate nohighlight">\(\frac{1}{\varepsilon} = \mathtt{tgv} = 10^{30}\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    A_{ij} &amp;=&amp;
      \left\{\begin{array}{cl}
      \frac{1}{\varepsilon} &amp; \mbox{if } i \in \Gamma_{24}, \mbox{and}\quad j=i\\
      \displaystyle{\int_{\Omega} w_j w_i / dt + k (\nabla w_j. \nabla w_i ) + \int_{\Gamma_{13}} \alpha w_j w_i} &amp; \mbox{else}
      \end{array}\right.\\
    M_{ij} &amp;=&amp;
      \left\{\begin{array}{cl}
      \frac{1}{\varepsilon} &amp; \mbox{if } i \in \Gamma_{24}, \mbox{and}\quad j=i \\
      \displaystyle n{\int_{\Omega} w_j w_i / dt} &amp; \mbox{else}
      \end{array}\right. \\
    b_{0,i} &amp;=&amp; n{\int_{\Gamma_{13}} \alpha u_{ue} w_i } \\
    b_{cl} &amp;=&amp; u^{0} \quad \mbox{the initial data}
\end{array}\end{split}\]</div>
<p>The Fast version script:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="n">Vh</span> <span class="n">u0</span><span class="o">=</span><span class="n">fu0</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">u0</span><span class="p">;</span>
</pre></div>
</div>
<p>Create three variational formulation, and build the matrices <span class="math notranslate nohighlight">\(A\)</span>,<span class="math notranslate nohighlight">\(M\)</span>.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">varf</span> <span class="nf">vthermic</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="o">/</span><span class="n">dt</span>
        <span class="o">+</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)(</span>
          <span class="n">alpha</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">u</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">vthermic0</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)(</span>
          <span class="n">alpha</span><span class="o">*</span><span class="n">ue</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="p">;</span>
<span class="kt">varf</span> <span class="nf">vMass</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="o">/</span><span class="n">dt</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">real</span> <span class="kp">tgv</span> <span class="o">=</span> <span class="mf">1e30</span><span class="p">;</span>
<span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span> <span class="n">vthermic</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">tgv</span><span class="o">=</span><span class="kp">tgv</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="n">M</span> <span class="o">=</span> <span class="n">vMass</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
</pre></div>
</div>
<p>Now, to build the right hand size; we need 4 vectors.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b0</span> <span class="o">=</span> <span class="n">vthermic0</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Vh</span><span class="p">);</span> <span class="c1">//constant part of RHS</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">bcn</span> <span class="o">=</span> <span class="n">vthermic</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Vh</span><span class="p">);</span> <span class="c1">//tgv on Dirichlet part</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">bcl</span> <span class="o">=</span> <span class="kp">tgv</span><span class="o">*</span><span class="n">u0</span><span class="p">[];</span>   <span class="c1">//the Dirichlet B.C. part</span>

<span class="c1">// The fast loop</span>
<span class="k">for</span><span class="p">(</span><span class="kt">real</span> <span class="kp">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kp">t</span> <span class="o">&lt;</span> <span class="n">T</span><span class="p">;</span> <span class="kp">t</span> <span class="o">+=</span> <span class="n">dt</span><span class="p">){</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b0</span><span class="p">;</span>   <span class="c1">//the RHS</span>
    <span class="n">b</span> <span class="o">+=</span> <span class="n">M</span><span class="o">*</span><span class="n">u</span><span class="p">[];</span> <span class="c1">//add the the time dependent part</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">bcn</span> <span class="o">?</span> <span class="nl">bcl</span> <span class="o">:</span> <span class="n">b</span><span class="p">;</span> <span class="c1">//do $\forall i$: b[i] = bcn[i] ? bcl[i] : b[i];</span>
    <span class="n">u</span><span class="p">[]</span> <span class="o">=</span> <span class="kp">A</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">;</span> <span class="c1">//solve linear problem</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>