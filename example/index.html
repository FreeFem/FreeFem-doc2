<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Examples</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">Examples</a><ul>
<li><a class="reference internal" href="#poisson-s-equation">Poisson’s Equation</a></li>
<li><a class="reference internal" href="#poisson-s-equation-3d">Poisson’s equation 3D</a></li>
<li><a class="reference internal" href="#stokes-equation-on-a-cube">Stokes Equation on a cube</a></li>
<li><a class="reference internal" href="#cavity">Cavity</a></li>
<li><a class="reference internal" href="#mesh-generation">Mesh Generation</a><ul>
<li><a class="reference internal" href="#square-mesh">Square mesh</a></li>
<li><a class="reference internal" href="#mesh-adaptation">Mesh adaptation</a></li>
<li><a class="reference internal" href="#mesh-adaptation-for-the-poisson-s-problem">Mesh adaptation for the Poisson’s problem</a></li>
<li><a class="reference internal" href="#uniform-mesh-adaptation">Uniform mesh adaptation</a></li>
<li><a class="reference internal" href="#borders">Borders</a></li>
<li><a class="reference internal" href="#change">Change</a></li>
<li><a class="reference internal" href="#cube">Cube</a></li>
<li><a class="reference internal" href="#empty-mesh">Empty mesh</a></li>
<li><a class="reference internal" href="#points">3 points</a></li>
<li><a class="reference internal" href="#bezier">Bezier</a></li>
<li><a class="reference internal" href="#build-layer-mesh">Build layer mesh</a></li>
<li><a class="reference internal" href="#sphere">Sphere</a></li>
</ul>
</li>
<li><a class="reference internal" href="#finite-element">Finite Element</a><ul>
<li><a class="reference internal" href="#periodic-3d">Periodic 3D</a></li>
<li><a class="reference internal" href="#lagrange-multipliers">Lagrange multipliers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#visualization">Visualization</a><ul>
<li><a class="reference internal" href="#plot">Plot</a></li>
<li><a class="reference internal" href="#hsv">HSV</a></li>
<li><a class="reference internal" href="#medit">Medit</a></li>
<li><a class="reference internal" href="#paraview">Paraview</a></li>
</ul>
</li>
<li><a class="reference internal" href="#algorithms-optimizations">Algorithms &amp; Optimizations</a><ul>
<li><a class="reference internal" href="#algorithms">Algorithms</a></li>
<li><a class="reference internal" href="#cmaes-variational-inequality">CMAES variational inequality</a></li>
<li><a class="reference internal" href="#ipopt-minimal-surface-volume">IPOPT minimal surface &amp; volume</a></li>
<li><a class="reference internal" href="#cmaes-mpi-variational-inequality">CMAES MPI variational inequality</a></li>
</ul>
</li>
<li><a class="reference internal" href="#parallelization">Parallelization</a><ul>
<li><a class="reference internal" href="#mpi-gmres-2d">MPI-GMRES 2D</a></li>
<li><a class="reference internal" href="#mpi-gmres-3d">MPI-GMRES 3D</a></li>
<li><a class="reference internal" href="#direct-solvers">Direct solvers</a></li>
<li><a class="reference internal" href="#solver-mumps">Solver MUMPS</a></li>
<li><a class="reference internal" href="#solver-superlu-dist">Solver superLU_DIST</a></li>
<li><a class="reference internal" href="#solver-pastix">Solver PaStiX</a></li>
</ul>
</li>
<li><a class="reference internal" href="#developers">Developers</a><ul>
<li><a class="reference internal" href="#fft">FFT</a></li>
<li><a class="reference internal" href="#complex">Complex</a></li>
<li><a class="reference internal" href="#string">String</a></li>
<li><a class="reference internal" href="#elementary-function">Elementary function</a></li>
<li><a class="reference internal" href="#array">Array</a></li>
<li><a class="reference internal" href="#block-matrix">Block matrix</a></li>
<li><a class="reference internal" href="#matrix-operations">Matrix operations</a></li>
<li><a class="reference internal" href="#matrix-inversion">Matrix inversion</a></li>
<li><a class="reference internal" href="#fe-array">FE array</a></li>
<li><a class="reference internal" href="#loop">Loop</a></li>
<li><a class="reference internal" href="#implicit-loop">Implicit loop</a></li>
<li><a class="reference internal" href="#i-o">I/O</a></li>
<li><a class="reference internal" href="#file-stream">File stream</a></li>
<li><a class="reference internal" href="#command-line-arguments">Command line arguments</a></li>
<li><a class="reference internal" href="#macro">Macro</a></li>
<li><a class="reference internal" href="#basic-error-handling">Basic error handling</a></li>
<li><a class="reference internal" href="#error-handling">Error handling</a></li>
</ul>
</li>
</ul>
</li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="section" id="examples">
<span id="id1"></span><h1>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h1>
<div class="section" id="poisson-s-equation">
<span id="examplepoissonequation"></span><h2>Poisson’s Equation<a class="headerlink" href="#poisson-s-equation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">nn</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">L</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">H</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">l</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">h</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>

<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">g</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">NAdapt</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">b1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">b2</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">L</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">b3</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="n">L</span><span class="p">,</span> <span class="n">l</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">h</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">b4</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">H</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">l</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">b5</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">H</span><span class="p">;};</span>
<span class="kt">border</span> <span class="nf">b6</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;};</span>

<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">b1</span><span class="p">(</span><span class="n">nn</span><span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="o">+</span> <span class="n">b2</span><span class="p">(</span><span class="n">nn</span><span class="o">*</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="n">b3</span><span class="p">(</span><span class="n">nn</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">l</span><span class="p">))</span> <span class="o">+</span> <span class="n">b4</span><span class="p">(</span><span class="n">nn</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">h</span><span class="p">))</span> <span class="o">+</span> <span class="n">b5</span><span class="p">(</span><span class="n">nn</span><span class="o">*</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="n">b6</span><span class="p">(</span><span class="n">nn</span><span class="o">*</span><span class="n">H</span><span class="p">));</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span> <span class="c1">// Change P1 to P2 to test P2 finite element</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

<span class="c1">// Macro</span>
<span class="kt">macro</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="c1">//</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="n">Poisson</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=-</span><span class="mf">1.e-6</span><span class="p">)</span>
   <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">&#39;</span> <span class="o">*</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
   <span class="p">)</span>
   <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">f</span> <span class="o">*</span> <span class="n">v</span>
   <span class="p">)</span>
   <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">b6</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
   <span class="p">;</span>

<span class="c1">// Mesh adaptation iterations</span>
<span class="kt">real</span> <span class="n">error</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">real</span> <span class="kp">coef</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">^</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">5.</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NAdapt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
   <span class="c1">// Solve</span>
   <span class="n">Poisson</span><span class="p">;</span>

   <span class="c1">// Plot</span>
   <span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>

   <span class="c1">// Adaptmesh</span>
   <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">inquire</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">err</span><span class="o">=</span><span class="n">error</span><span class="p">);</span>
   <span class="n">error</span> <span class="o">=</span> <span class="n">error</span> <span class="o">*</span> <span class="kp">coef</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="inline2 figure" id="figexamplepoisson">
<img alt="../_images/poisson_associated_mesh.jpg" src="../_images/poisson_associated_mesh.jpg" />
<p class="caption"><span class="caption-number">Fig. 132 </span><span class="caption-text">Adapted mesh</span></p>
</div>
<div class="inline2 figure" id="figexamplepoissonadapt">
<img alt="../_images/poisson_adapted_mesh.jpg" src="../_images/poisson_adapted_mesh.jpg" />
<p class="caption"><span class="caption-number">Fig. 133 </span><span class="caption-text">Solution on adapted mesh</span></p>
</div>
</div>
<div class="section" id="poisson-s-equation-3d">
<span id="examplepoissonequation3d"></span><h2>Poisson’s equation 3D<a class="headerlink" href="#poisson-s-equation-3d" title="Permalink to this headline">¶</a></h2>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;tetgen&quot;</span>

<span class="c1">// Parameters</span>
<span class="kt">real</span> <span class="n">hh</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">ue</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="kr">x</span><span class="o">*</span><span class="kr">x</span> <span class="o">+</span> <span class="mf">3.</span><span class="o">*</span><span class="kr">y</span><span class="o">*</span><span class="kr">y</span> <span class="o">+</span> <span class="mf">4.</span><span class="o">*</span><span class="kr">z</span><span class="o">*</span><span class="kr">z</span> <span class="o">+</span> <span class="mf">5.</span><span class="o">*</span><span class="kr">x</span><span class="o">*</span><span class="kr">y</span> <span class="o">+</span> <span class="mf">6.</span><span class="o">*</span><span class="kr">x</span><span class="o">*</span><span class="kr">z</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f</span><span class="o">=</span> <span class="o">-</span><span class="mf">18.</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="p">[</span><span class="kr">x</span><span class="o">*</span><span class="kr">pi</span><span class="o">-</span><span class="kr">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">y</span><span class="o">*</span><span class="kr">pi</span><span class="p">]);</span> <span class="c1">// ]-pi/2, pi/2[X]0,2pi[</span>
<span class="kt">func</span> <span class="n">f1</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f2</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f3</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f1x</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f1y</span> <span class="o">=</span> <span class="o">-</span><span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f2x</span> <span class="o">=</span> <span class="o">-</span><span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f2y</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f3x</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f3y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">m11</span> <span class="o">=</span> <span class="n">f1x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">f2x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">f3x</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">m21</span> <span class="o">=</span> <span class="n">f1x</span><span class="o">*</span><span class="n">f1y</span> <span class="o">+</span> <span class="n">f2x</span><span class="o">*</span><span class="n">f2y</span> <span class="o">+</span> <span class="n">f3x</span><span class="o">*</span><span class="n">f3y</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">m22</span> <span class="o">=</span> <span class="n">f1y</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">f2y</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">f3y</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">perio</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">4</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kr">x</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="kr">x</span><span class="p">]];</span>
<span class="kt">real</span> <span class="n">vv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="nf">square</span><span class="p">(</span><span class="n">hh</span><span class="p">);</span>
<span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">m11</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="n">m21</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="n">m22</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="kp">IsMetric</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="n">perio</span><span class="p">);</span>
<span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">m11</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="n">m21</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="n">m22</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="kp">IsMetric</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="n">perio</span><span class="p">);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">);</span>

<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">domain</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">];</span>
<span class="kt">mesh3</span> <span class="n">Th3</span> <span class="o">=</span> <span class="nf">tetgtransfo</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">transfo</span><span class="o">=</span><span class="p">[</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">],</span> <span class="kp">nbofregions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">regionlist</span><span class="o">=</span><span class="n">domain</span><span class="p">);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th3</span><span class="p">);</span>

<span class="kt">border</span> <span class="nf">cc</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">mesh</span> <span class="n">Th2</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">cc</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th3</span><span class="p">,</span> <span class="nc">P23d</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">uhe</span> <span class="o">=</span> <span class="n">ue</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;uhe min: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">uhe</span><span class="p">[].</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - max: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">uhe</span><span class="p">[].</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">uhe</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Vh2</span><span class="p">(</span><span class="n">Th2</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span>
<span class="n">Vh2</span> <span class="n">u2</span><span class="p">,</span> <span class="n">u2e</span><span class="p">;</span>

<span class="c1">// Macro</span>
<span class="kt">macro</span> <span class="nf">Grad3</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dz</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="c1">//</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="n">Lap3d</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int3d</span><span class="p">(</span><span class="n">Th3</span><span class="p">)(</span>
          <span class="n">Grad3</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">&#39;</span> <span class="o">*</span> <span class="n">Grad3</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int3d</span><span class="p">(</span><span class="n">Th3</span><span class="p">)(</span>
          <span class="n">f</span> <span class="o">*</span> <span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">ue</span><span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Solve</span>
<span class="n">Lap3d</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;u min: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[].</span> <span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - max: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[].</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Error</span>
<span class="kt">real</span> <span class="kp">err</span> <span class="o">=</span> <span class="nf">int3d</span><span class="p">(</span><span class="n">Th3</span><span class="p">)(</span><span class="nf">square</span><span class="p">(</span><span class="n">u</span><span class="o">-</span><span class="n">ue</span><span class="p">));</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="nf">int3d</span><span class="p">(</span><span class="n">Th3</span><span class="p">)(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Th3</span><span class="p">.</span><span class="kr">measure</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="n">Vh</span> <span class="nf">d</span> <span class="o">=</span> <span class="n">ue</span> <span class="o">-</span> <span class="n">u</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">err</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - diff l^intfy = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">d</span><span class="p">[].</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Plot</span>
<span class="n">u2</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
<span class="n">u2e</span> <span class="o">=</span> <span class="n">ue</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">u2</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">u2</span><span class="p">,</span> <span class="n">u2e</span><span class="p">,</span><span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id2">
<img alt="../_images/poisson_3d.jpg" src="../_images/poisson_3d.jpg" />
<p class="caption"><span class="caption-number">Fig. 134 </span><span class="caption-text">Iso-surfaces of the solution</span></p>
</div>
</div>
<div class="section" id="stokes-equation-on-a-cube">
<span id="examplestokesequationonacube"></span><h2>Stokes Equation on a cube<a class="headerlink" href="#stokes-equation-on-a-cube" title="Permalink to this headline">¶</a></h2>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;msh3&quot;</span>
<span class="cp">load</span> <span class="s">&quot;</span><span class="nf">medit</span><span class="s">&quot;</span> <span class="c1">// Dynamically loaded tools for 3D</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">nn</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th0</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="p">);</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">rup</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">];</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">rdown</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">rmid</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span>
<span class="kt">real</span> <span class="n">zmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">mesh3</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildlayers</span><span class="p">(</span><span class="n">Th0</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="kp">zbound</span><span class="o">=</span><span class="p">[</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">],</span>
    <span class="kp">reffacemid</span><span class="o">=</span><span class="n">rmid</span><span class="p">,</span> <span class="kp">reffaceup</span><span class="o">=</span><span class="n">rup</span><span class="p">,</span> <span class="kp">reffacelow</span><span class="o">=</span><span class="n">rdown</span><span class="p">);</span>

<span class="nf">medit</span><span class="p">(</span><span class="s">&quot;c8x8x8&quot;</span><span class="p">,</span> <span class="n">Th</span><span class="p">);</span> <span class="c1">// 3D mesh visualization with medit</span>

<span class="c1">// Fespaces</span>
<span class="kt">fespace</span> <span class="nf">Vh2</span><span class="p">(</span><span class="n">Th0</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span>
<span class="n">Vh2</span> <span class="n">ux</span><span class="p">,</span> <span class="n">uz</span><span class="p">,</span> <span class="n">p2</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">VVh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="p">[</span><span class="nc">P2</span><span class="p">,</span> <span class="nc">P2</span><span class="p">,</span> <span class="nc">P2</span><span class="p">,</span> <span class="nc">P1</span><span class="p">]);</span>
<span class="n">VVh</span> <span class="p">[</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">u3</span><span class="p">,</span> <span class="n">p</span><span class="p">];</span>
<span class="n">VVh</span> <span class="p">[</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">q</span><span class="p">];</span>

<span class="c1">// Macro</span>
<span class="kt">macro</span> <span class="nf">Grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dz</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">div</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">u3</span><span class="p">)</span> <span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dz</span><span class="p">(</span><span class="n">u3</span><span class="p">))</span> <span class="c1">//</span>

<span class="c1">// Problem (directly solved)</span>
<span class="kt">solve</span> <span class="n">vStokes</span> <span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">u3</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">q</span><span class="p">])</span>
    <span class="o">=</span> <span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qforder</span><span class="o">=</span><span class="mi">3</span><span class="p">)(</span>
          <span class="n">Grad</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">&#39;</span> <span class="o">*</span> <span class="n">Grad</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">Grad</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span><span class="o">&#39;</span> <span class="o">*</span> <span class="n">Grad</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">Grad</span><span class="p">(</span><span class="n">u3</span><span class="p">)</span><span class="o">&#39;</span> <span class="o">*</span> <span class="n">Grad</span><span class="p">(</span><span class="n">v3</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">div</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">u3</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span>
        <span class="o">-</span> <span class="n">div</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span>
        <span class="o">+</span> <span class="mf">1e-10</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">p</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">u2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">u3</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">u2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">u3</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">nbiso</span><span class="o">=</span><span class="mi">5</span><span class="p">);</span> <span class="c1">// 3D visualization of pressure isolines</span>

<span class="c1">// See 10 plan of the velocity in 2D</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="c1">// Cut plane</span>
    <span class="kt">real</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">i</span><span class="o">/</span><span class="mf">10.</span><span class="p">;</span>
    <span class="c1">// 3D to 2D interpolation</span>
    <span class="n">ux</span> <span class="o">=</span> <span class="n">u1</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="kr">y</span><span class="p">);</span>
    <span class="n">uz</span> <span class="o">=</span> <span class="n">u3</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="kr">y</span><span class="p">);</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="kr">y</span><span class="p">);</span>
    <span class="c1">// Plot</span>
    <span class="nf">plot</span><span class="p">([</span><span class="n">ux</span><span class="p">,</span> <span class="n">uz</span><span class="p">],</span> <span class="n">p2</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;cut y = &quot;</span><span class="o">+</span><span class="n">yy</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="inline2 figure" id="id3">
<img alt="../_images/Stokes3d.jpg" src="../_images/Stokes3d.jpg" />
<p class="caption"><span class="caption-number">Fig. 135 </span><span class="caption-text">Solution</span></p>
</div>
<div class="inline2 figure" id="id4">
<img alt="../_images/Stokes3d-Th.jpg" src="../_images/Stokes3d-Th.jpg" />
<p class="caption"><span class="caption-number">Fig. 136 </span><span class="caption-text">Associated mesh</span></p>
</div>
</div>
<div class="section" id="cavity">
<span id="examplecavity"></span><h2>Cavity<a class="headerlink" href="#cavity" title="Permalink to this headline">¶</a></h2>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//Parameters</span>
<span class="kt">int</span> <span class="kr">m</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">L</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">rho</span> <span class="o">=</span> <span class="mf">500.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>

<span class="kt">real</span> <span class="n">uin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">fx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">fy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">noslip</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">];</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">inflow</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="kt">real</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

<span class="kt">real</span> <span class="kp">eps</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">;</span>

<span class="c1">//Macros</span>
<span class="kt">macro</span> <span class="n">div</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="o">#</span><span class="kr">x</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="o">#</span><span class="kr">y</span><span class="p">))</span><span class="c1">//</span>
<span class="kt">macro</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span><span class="c1">//</span>
<span class="kt">macro</span> <span class="n">Grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="o">#</span><span class="kr">x</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="o">#</span><span class="kr">y</span><span class="p">)]</span><span class="c1">//</span>

<span class="c1">//Time</span>
<span class="kt">real</span> <span class="n">cpu</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">tabcpu</span><span class="p">;</span>

<span class="c1">//mesh</span>
<span class="kt">border</span> <span class="nf">C1</span><span class="p">(</span><span class="kp">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">){</span> <span class="kr">x</span> <span class="o">=</span> <span class="kp">t</span><span class="p">;</span> <span class="kr">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">label</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">border</span> <span class="nf">C2</span><span class="p">(</span><span class="kp">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">){</span> <span class="kr">x</span> <span class="o">=</span> <span class="n">L</span><span class="p">;</span> <span class="kr">y</span> <span class="o">=</span> <span class="kp">t</span><span class="p">;</span> <span class="kr">label</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">border</span> <span class="nf">C3</span><span class="p">(</span><span class="kp">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">){</span> <span class="kr">x</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span> <span class="o">=</span> <span class="n">L</span><span class="p">;</span> <span class="kr">label</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">border</span> <span class="nf">C4</span><span class="p">(</span><span class="kp">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">){</span> <span class="kr">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">y</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">mesh</span> <span class="n">th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span> <span class="n">C1</span><span class="p">(</span><span class="kr">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">C2</span><span class="p">(</span><span class="kr">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">C3</span><span class="p">(</span><span class="kr">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">C4</span><span class="p">(</span><span class="kr">m</span><span class="p">)</span> <span class="p">);</span>

<span class="kt">fespace</span> <span class="nf">UPh</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="p">[</span><span class="nc">P2</span><span class="p">,</span><span class="nc">P2</span><span class="p">,</span><span class="nc">P1</span><span class="p">]);</span>
<span class="n">UPh</span> <span class="p">[</span><span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">,</span> <span class="n">p</span><span class="p">];</span>
<span class="n">UPh</span> <span class="p">[</span><span class="n">uhx</span><span class="p">,</span> <span class="n">uhy</span><span class="p">,</span> <span class="n">ph</span><span class="p">];</span>
<span class="n">UPh</span> <span class="p">[</span><span class="n">upx</span><span class="p">,</span> <span class="n">upy</span><span class="p">,</span> <span class="n">pp</span><span class="p">];</span>

<span class="c1">//Solve</span>
<span class="kt">varf</span> <span class="nf">navierstokes</span><span class="p">([</span><span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">uhx</span><span class="p">,</span> <span class="n">uhy</span><span class="p">,</span> <span class="n">ph</span><span class="p">])</span>
  <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)(</span>
      <span class="n">rho</span><span class="o">/</span><span class="n">dt</span><span class="o">*</span> <span class="p">[</span><span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">]</span><span class="o">&#39;*</span> <span class="p">[</span><span class="n">uhx</span><span class="p">,</span> <span class="n">uhy</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">mu</span><span class="o">*</span> <span class="p">(</span><span class="n">Grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">:</span><span class="n">Grad</span><span class="p">(</span><span class="n">uh</span><span class="p">))</span>
    <span class="o">-</span> <span class="n">p</span><span class="o">*</span> <span class="n">div</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span>
    <span class="o">-</span> <span class="n">ph</span><span class="o">*</span> <span class="n">div</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="o">-</span> <span class="mf">1e-10</span> <span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">ph</span>
    <span class="p">)</span>

  <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">th</span><span class="p">)</span> <span class="p">(</span>
      <span class="p">[</span><span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">]</span><span class="o">&#39;</span> <span class="o">*</span> <span class="p">[</span><span class="n">uhx</span><span class="p">,</span> <span class="n">uhy</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">rho</span><span class="o">/</span><span class="n">dt</span><span class="o">*</span> <span class="p">[</span><span class="nf">convect</span><span class="p">([</span><span class="n">upx</span><span class="p">,</span> <span class="n">upy</span><span class="p">],</span> <span class="o">-</span><span class="n">dt</span><span class="p">,</span> <span class="n">upx</span><span class="p">),</span> <span class="nf">convect</span><span class="p">([</span><span class="n">upx</span><span class="p">,</span> <span class="n">upy</span><span class="p">],</span> <span class="o">-</span><span class="n">dt</span><span class="p">,</span> <span class="n">upy</span><span class="p">)]</span><span class="o">&#39;*</span> <span class="p">[</span><span class="n">uhx</span><span class="p">,</span> <span class="n">uhy</span><span class="p">]</span>
    <span class="p">)</span>

  <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">noslip</span><span class="p">,</span> <span class="n">ux</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">uy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">inflow</span><span class="p">,</span> <span class="n">ux</span><span class="o">=</span><span class="n">uin</span><span class="p">,</span> <span class="n">uy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">;</span>

<span class="c1">//Initialization</span>
<span class="p">[</span><span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>

<span class="kt">matrix</span><span class="o">&lt;</span><span class="kt">real</span><span class="o">&gt;</span> <span class="n">NS</span> <span class="o">=</span> <span class="n">navierstokes</span><span class="p">(</span><span class="n">UPh</span><span class="p">,</span> <span class="n">UPh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">sparsesolver</span><span class="p">);</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">NSrhs</span> <span class="o">=</span> <span class="n">navierstokes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UPh</span><span class="p">);</span>

<span class="c1">//Time loop</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
  <span class="p">[</span><span class="n">upx</span><span class="p">,</span> <span class="n">upy</span><span class="p">,</span> <span class="n">pp</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">,</span> <span class="n">p</span><span class="p">];</span>

  <span class="n">NSrhs</span> <span class="o">=</span> <span class="n">navierstokes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UPh</span><span class="p">);</span>
  <span class="n">ux</span><span class="p">[]</span> <span class="o">=</span> <span class="n">NS</span><span class="o">^-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">NSrhs</span><span class="p">;</span>

  <span class="nf">plot</span><span class="p">(</span> <span class="p">[</span><span class="n">ux</span><span class="p">,</span><span class="n">uy</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="n">j</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//CPU</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; CPU = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">clock</span><span class="p">()</span><span class="o">-</span><span class="n">cpu</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span> <span class="p">;</span>
<span class="n">tabcpu</span> <span class="o">=</span> <span class="nf">clock</span><span class="p">()</span><span class="o">-</span><span class="n">cpu</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="mesh-generation">
<span id="examplemeshgeneration"></span><h2>Mesh Generation<a class="headerlink" href="#mesh-generation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="square-mesh">
<span id="examplemeshsquare"></span><h3>Square mesh<a class="headerlink" href="#square-mesh" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">mesh</span> <span class="n">Th0</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span> <span class="p">,</span><span class="mi">10</span><span class="p">);</span>

<span class="kt">mesh</span> <span class="n">Th1</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

<span class="kt">real</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">1.2</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">x1</span> <span class="o">=</span> <span class="mf">1.8</span><span class="p">;</span>
<span class="kt">real</span> <span class="nf">y0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">real</span> <span class="nf">y1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kt">real</span> <span class="kr">m</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="kt">mesh</span> <span class="n">Th2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="kr">n</span><span class="p">,</span> <span class="kr">m</span><span class="p">,</span> <span class="p">[</span><span class="n">x0</span><span class="o">+</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="kr">x</span><span class="p">,</span> <span class="nf">y0</span><span class="o">+</span><span class="p">(</span><span class="nf">y1</span><span class="o">-</span><span class="nf">y0</span><span class="p">)</span><span class="o">*</span><span class="kr">y</span><span class="p">]);</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">labs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">];</span>
    <span class="kt">mesh</span> <span class="n">Th3</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kp">flags</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="kr">label</span><span class="o">=</span><span class="n">labs</span><span class="p">,</span> <span class="kr">region</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">Th3</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;square flags = &quot;</span><span class="o">+</span><span class="n">i</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="mesh-adaptation">
<span id="examplemeshadaptation"></span><h3>Mesh adaptation<a class="headerlink" href="#mesh-adaptation" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">real</span> <span class="kp">eps</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">real</span> <span class="kp">hmin</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">*</span><span class="kr">x</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="kr">y</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="nf">atan2</span><span class="p">(</span><span class="kp">eps</span><span class="p">,</span> <span class="nf">sin</span><span class="p">(</span><span class="mf">5.0</span><span class="o">*</span><span class="kr">y</span><span class="p">)</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="kr">x</span><span class="p">);</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="kr">x</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="kr">y</span><span class="p">]);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

<span class="c1">// Adaptmesh</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span> <span class="c1">//old mesh is deleted</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="inline2 figure" id="id5">
<img alt="../_images/MeshAdaptation1.jpg" src="../_images/MeshAdaptation1.jpg" />
<p class="caption"><span class="caption-number">Fig. 137 </span><span class="caption-text">Initial mesh</span></p>
</div>
<div class="inline2 figure" id="id6">
<img alt="../_images/MeshAdaptation2.jpg" src="../_images/MeshAdaptation2.jpg" />
<p class="caption"><span class="caption-number">Fig. 138 </span><span class="caption-text">Adapted mesh</span></p>
</div>
</div>
<div class="section" id="mesh-adaptation-for-the-poisson-s-problem">
<span id="examplemeshadaptationforthepoissonproblem"></span><h3>Mesh adaptation for the Poisson’s problem<a class="headerlink" href="#mesh-adaptation-for-the-poisson-s-problem" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">real</span> <span class="n">error</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">border</span> <span class="nf">ba</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="kp">bb</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">bc</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">bd</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="kr">be</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">bf</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">ba</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="kp">bb</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">bc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">bd</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="kr">be</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">bf</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

<span class="c1">// Function</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="nf">Poisson</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// Adaptmesh loop</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">Poisson</span><span class="p">;</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">err</span><span class="o">=</span><span class="n">error</span><span class="p">);</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">error</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="inline3 figure" id="id7">
<img alt="../_images/MeshAdaptationPoisson1.jpg" src="../_images/MeshAdaptationPoisson1.jpg" />
<p class="caption"><span class="caption-number">Fig. 139 </span><span class="caption-text">Initial mesh</span></p>
</div>
<div class="inline3 figure" id="id8">
<img alt="../_images/MeshAdaptationPoisson2.jpg" src="../_images/MeshAdaptationPoisson2.jpg" />
<p class="caption"><span class="caption-number">Fig. 140 </span><span class="caption-text">Adapted mesh</span></p>
</div>
<div class="inline3 figure" id="id9">
<img alt="../_images/MeshAdaptationPoissonU.jpg" src="../_images/MeshAdaptationPoissonU.jpg" />
<p class="caption"><span class="caption-number">Fig. 141 </span><span class="caption-text">Solution on adapted mesh</span></p>
</div>
</div>
<div class="section" id="uniform-mesh-adaptation">
<span id="exampleuniformmeshadaptation"></span><h3>Uniform mesh adaptation<a class="headerlink" href="#uniform-mesh-adaptation" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// The initial mesh</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">30.</span><span class="p">,</span> <span class="kp">IsMetric</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">nbvx</span><span class="o">=</span><span class="mi">10000</span><span class="p">);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">30.</span><span class="p">,</span> <span class="kp">IsMetric</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">nbvx</span><span class="o">=</span><span class="mi">10000</span><span class="p">);</span> <span class="c1">// More than one time due to the</span>
<span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">30.</span><span class="p">,</span> <span class="kp">IsMetric</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">nbvx</span><span class="o">=</span><span class="mi">10000</span><span class="p">);</span> <span class="c1">// adaptation bound `maxsubdiv=`</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="inline2 figure" id="id10">
<img alt="../_images/UniformMeshAdaptation1.jpg" src="../_images/UniformMeshAdaptation1.jpg" />
<p class="caption"><span class="caption-number">Fig. 142 </span><span class="caption-text">Initial mesh</span></p>
</div>
<div class="inline2 figure" id="id11">
<img alt="../_images/UniformMeshAdaptation2.jpg" src="../_images/UniformMeshAdaptation2.jpg" />
<p class="caption"><span class="caption-number">Fig. 143 </span><span class="caption-text">Adapted mesh</span></p>
</div>
</div>
<div class="section" id="borders">
<span id="exampleborders"></span><h3>Borders<a class="headerlink" href="#borders" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="kt">int</span> <span class="n">upper</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">others</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">inner</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

    <span class="kt">border</span> <span class="nf">C01</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="mi">1</span><span class="o">+</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">upper</span><span class="p">;}</span>
    <span class="kt">border</span> <span class="nf">C02</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">1.5</span><span class="o">-</span><span class="mf">1.5</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">upper</span><span class="p">;}</span>
    <span class="kt">border</span> <span class="nf">C03</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">1.5</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">upper</span><span class="p">;}</span>
    <span class="kt">border</span> <span class="nf">C04</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">others</span><span class="p">;}</span>
    <span class="kt">border</span> <span class="nf">C05</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">others</span><span class="p">;}</span>
    <span class="kt">border</span> <span class="nf">C06</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">others</span><span class="p">;}</span>
    <span class="kt">border</span> <span class="nf">C11</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="mf">0.5</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">inner</span><span class="p">;}</span>
    <span class="kt">border</span> <span class="nf">C12</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">inner</span><span class="p">;}</span>
    <span class="kt">border</span> <span class="nf">C13</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">inner</span><span class="p">;}</span>

    <span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">C01</span><span class="p">(</span><span class="o">-</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C02</span><span class="p">(</span><span class="o">-</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C03</span><span class="p">(</span><span class="o">-</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C04</span><span class="p">(</span><span class="o">-</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C05</span><span class="p">(</span><span class="o">-</span><span class="kr">n</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">C06</span><span class="p">(</span><span class="o">-</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C11</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C12</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C13</span><span class="p">(</span><span class="kr">n</span><span class="p">),</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

    <span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">C01</span><span class="p">(</span><span class="o">-</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C02</span><span class="p">(</span><span class="o">-</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C03</span><span class="p">(</span><span class="o">-</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C04</span><span class="p">(</span><span class="o">-</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C05</span><span class="p">(</span><span class="o">-</span><span class="kr">n</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">C06</span><span class="p">(</span><span class="o">-</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C11</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C12</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C13</span><span class="p">(</span><span class="kr">n</span><span class="p">));</span>

    <span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Part 1 has region number &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Th</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">).</span><span class="kr">region</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Part 2 has redion number &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Th</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">).</span><span class="kr">region</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">{</span>
    <span class="kt">border</span> <span class="n">a</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
    <span class="kt">border</span> <span class="n">b</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">0.3</span><span class="o">+</span><span class="mf">0.3</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="mf">0.3</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;}</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">(</span><span class="mi">30</span><span class="p">));</span> <span class="c1">//to see a plot of the border mesh</span>
    <span class="kt">mesh</span> <span class="n">Thwithouthole</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">(</span><span class="mi">30</span><span class="p">));</span>
    <span class="kt">mesh</span> <span class="n">Thwithhole</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">));</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">Thwithouthole</span><span class="p">);</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">Thwithhole</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">{</span>
    <span class="kt">real</span> <span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">border</span> <span class="nf">a</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
    <span class="n">r</span><span class="o">=</span><span class="mf">0.3</span><span class="p">;</span>
    <span class="kt">border</span> <span class="nf">b</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="c1">//  mesh Thwithhole = buildmesh(a(50) + b(-30)); // do not do this because the two</span>
                                                 <span class="c1">// circles have the same radius = $0.3$</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="inline3 figure" id="id12">
<img alt="../_images/Borders1.jpg" src="../_images/Borders1.jpg" />
<p class="caption"><span class="caption-number">Fig. 144 </span><span class="caption-text">Mesh with two regions</span></p>
</div>
<div class="inline3 figure" id="id13">
<img alt="../_images/Borders2.jpg" src="../_images/Borders2.jpg" />
<p class="caption"><span class="caption-number">Fig. 145 </span><span class="caption-text">Mesh without a hole</span></p>
</div>
<div class="inline3 figure" id="id14">
<img alt="../_images/Borders3.jpg" src="../_images/Borders3.jpg" />
<p class="caption"><span class="caption-number">Fig. 146 </span><span class="caption-text">Mesh with a hole</span></p>
</div>
</div>
<div class="section" id="change">
<span id="examplechange"></span><h3>Change<a class="headerlink" href="#change" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kr">verbosity</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th1</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="kt">mesh</span> <span class="n">Th2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">[</span><span class="kr">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kr">y</span><span class="p">]);</span>

<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">r1</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th1</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="n">Th1</span> <span class="o">=</span> <span class="nf">change</span><span class="p">(</span><span class="n">Th1</span><span class="p">,</span> <span class="kr">label</span><span class="o">=</span><span class="n">r1</span><span class="p">);</span> <span class="c1">// Change edges&#39; label from 2 to 0</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th1</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">r2</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>
<span class="n">Th2</span> <span class="o">=</span> <span class="nf">change</span><span class="p">(</span><span class="n">Th2</span><span class="p">,</span> <span class="kr">label</span><span class="o">=</span><span class="n">r2</span><span class="p">);</span> <span class="c1">// Change edges&#39; label from 4 to 0</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th2</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="n">Th1</span> <span class="o">+</span> <span class="n">Th2</span><span class="p">;</span> <span class="c1">// &#39;gluing together&#39; Th1 and Th2 meshes</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;nb lab = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)(</span><span class="mf">1.</span><span class="o">/</span><span class="kr">lenEdge</span><span class="p">)</span><span class="o">+</span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)(</span><span class="mf">1.</span><span class="o">/</span><span class="kr">lenEdge</span><span class="p">)</span>
     <span class="o">&lt;&lt;</span> <span class="s">&quot; == &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)(</span><span class="mf">1.</span><span class="o">/</span><span class="kr">lenEdge</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; == &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mi">10</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

<span class="kt">macro</span> <span class="nf">Grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="c1">// Definition of a macro</span>

<span class="kt">solve</span> <span class="kr">P</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">Grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">&#39;*</span><span class="n">Grad</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id15">
<img alt="../_images/Change.jpg" src="../_images/Change.jpg" />
<p class="caption"><span class="caption-number">Fig. 147 </span><span class="caption-text">Result</span></p>
</div>
</div>
<div class="section" id="cube">
<span id="examplecube"></span><h3>Cube<a class="headerlink" href="#cube" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;msh3&quot;</span>

<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">l6</span> <span class="o">=</span> <span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">57</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">r11</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
<span class="kt">mesh3</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">cube</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">[</span><span class="kr">x</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kr">y</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kr">z</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kr">label</span><span class="o">=</span><span class="n">l6</span><span class="p">,</span> <span class="kp">flags</span> <span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="kr">region</span><span class="o">=</span><span class="n">r11</span><span class="p">);</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Volume = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Th</span><span class="p">.</span><span class="kr">measure</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, border area = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Th</span><span class="p">.</span><span class="kr">bordermeasure</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">int</span> <span class="kp">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="kt">real</span> <span class="n">s</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="n">i</span><span class="p">)(</span><span class="mf">1.</span><span class="p">);</span>
    <span class="kt">real</span> <span class="n">sx</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="n">i</span><span class="p">)(</span><span class="kr">x</span><span class="p">);</span>
    <span class="kt">real</span> <span class="n">sy</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="n">i</span><span class="p">)(</span><span class="kr">y</span><span class="p">);</span>
    <span class="kt">real</span> <span class="n">sz</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="n">i</span><span class="p">)(</span><span class="kr">z</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="p">(</span><span class="n">sx</span><span class="o">/</span><span class="n">s</span><span class="o">+</span><span class="mf">1.5</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">iy</span> <span class="o">=</span> <span class="p">(</span><span class="n">sy</span><span class="o">/</span><span class="n">s</span><span class="o">+</span><span class="mf">1.5</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">iz</span> <span class="o">=</span> <span class="p">(</span><span class="n">sz</span><span class="o">/</span><span class="n">s</span><span class="o">+</span><span class="mf">1.5</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">iy</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="o">*</span><span class="p">(</span><span class="n">iz</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">);</span>
        <span class="c1">//value of ix,iy,iz =&gt; face min 0, face max 2, no face 1</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Label = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, s = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ix</span> <span class="o">&lt;&lt;</span> <span class="n">iy</span> <span class="o">&lt;&lt;</span> <span class="n">iz</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ii</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">ii</span> <span class="p">)</span> <span class="kp">err</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kt">real</span> <span class="n">volr11</span> <span class="o">=</span> <span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="n">r11</span><span class="p">)(</span><span class="mf">1.</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Volume region = &quot;</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">volr11</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="k">if</span><span class="p">((</span><span class="n">volr11</span> <span class="o">-</span> <span class="n">Th</span><span class="p">.</span><span class="kr">measure</span> <span class="p">)</span><span class="o">&gt;</span><span class="mf">1e-8</span><span class="p">)</span> <span class="kp">err</span><span class="o">++</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="kr">false</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Nb err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">err</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="nf">assert</span><span class="p">(</span><span class="kp">err</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id16">
<img alt="../_images/Cube.jpg" src="../_images/Cube.jpg" />
<p class="caption"><span class="caption-number">Fig. 148 </span><span class="caption-text">Cube</span></p>
</div>
</div>
<div class="section" id="empty-mesh">
<span id="exampleemptymesh"></span><h3>Empty mesh<a class="headerlink" href="#empty-mesh" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="kt">border</span> <span class="n">a</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
    <span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="mi">20</span><span class="p">));</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">emptymesh</span><span class="p">(</span><span class="n">Th</span><span class="p">);</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">{</span>
    <span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">ssd</span><span class="p">(</span><span class="n">Th</span><span class="p">.</span><span class="kr">nt</span><span class="p">);</span>
    <span class="c1">// Builds the pseudo region numbering</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ssd</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">iq</span> <span class="o">=</span> <span class="n">i</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="c1">// Because we have 2 triangles per quad</span>
        <span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">iq</span><span class="o">%</span><span class="mi">10</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">iy</span> <span class="o">=</span> <span class="n">iq</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
        <span class="n">ssd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">ix</span><span class="o">&gt;=</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">iy</span><span class="o">&gt;=</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Builds an emtpy mesh with all edges that satisfy e=T1 cap T2 and ssd[T1] != ssd[T2]</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">emptymesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">ssd</span><span class="p">);</span>
    <span class="c1">// Plot</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="inline2 figure" id="id17">
<img alt="../_images/EmptyMesh1.jpg" src="../_images/EmptyMesh1.jpg" />
<p class="caption"><span class="caption-number">Fig. 149 </span><span class="caption-text">Empty square</span></p>
</div>
<div class="inline2 figure" id="id18">
<img alt="../_images/EmptyMesh2.jpg" src="../_images/EmptyMesh2.jpg" />
<p class="caption"><span class="caption-number">Fig. 150 </span><span class="caption-text">Empty diamond</span></p>
</div>
</div>
<div class="section" id="points">
<span id="example3points"></span><h3>3 points<a class="headerlink" href="#points" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Square for Three-Point Bend Specimens fixed on Fix1, Fix2</span>
<span class="c1">// It will be loaded on Load</span>
<span class="kt">real</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="kr">m</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="kr">n</span><span class="p">;</span>
<span class="kt">border</span> <span class="nf">Left</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="n">b</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">a</span><span class="o">-</span><span class="kp">t</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">Bot1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">c</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="n">b</span><span class="o">+</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="n">a</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">Fix1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">c</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="n">b</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">c</span><span class="o">+</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="n">a</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">Bot2</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">c</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="n">b</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="n">a</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">Fix2</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">c</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">b</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">c</span><span class="o">+</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="n">a</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">Bot3</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">c</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">b</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="n">a</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">Right</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">b</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="n">a</span><span class="o">+</span><span class="kp">t</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">Top1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">b</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">a</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">Load</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">c</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">c</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">a</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">Top2</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="n">c</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">a</span><span class="p">;}</span>

<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">Left</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Bot1</span><span class="p">(</span><span class="kr">m</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">Fix1</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">Bot2</span><span class="p">(</span><span class="kr">m</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">Fix2</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">Bot3</span><span class="p">(</span><span class="kr">m</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">Right</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Top1</span><span class="p">(</span><span class="kr">m</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">Load</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">Top2</span><span class="p">(</span><span class="kr">m</span><span class="o">/</span><span class="mi">2</span><span class="p">));</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">bw</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id19">
<img alt="../_images/3Points.jpg" src="../_images/3Points.jpg" />
<p class="caption"><span class="caption-number">Fig. 151 </span><span class="caption-text">3 Points</span></p>
</div>
</div>
<div class="section" id="bezier">
<span id="examplebezier"></span><h3>Bezier<a class="headerlink" href="#bezier" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// A cubic Bezier curve connecting two points with two control points</span>
<span class="kt">func</span> <span class="kt">real</span> <span class="nf">bzi</span><span class="p">(</span><span class="kt">real</span> <span class="n">p0</span><span class="p">,</span> <span class="kt">real</span> <span class="n">p1</span><span class="p">,</span> <span class="kt">real</span> <span class="n">q1</span><span class="p">,</span> <span class="kt">real</span> <span class="n">q2</span><span class="p">,</span> <span class="kt">real</span> <span class="kp">t</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">p0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">)</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="n">q1</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="kp">t</span> <span class="o">+</span> <span class="n">q2</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="kp">t</span><span class="p">)</span><span class="o">*</span><span class="kp">t</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p1</span><span class="o">*</span><span class="kp">t</span><span class="o">^</span><span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">p00</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">p01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">q00</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">q01</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">];</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">p11</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mf">0.9</span><span class="p">],</span> <span class="n">q10</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.95</span><span class="p">],</span> <span class="n">q11</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">p21</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span> <span class="n">q20</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4</span><span class="p">],</span> <span class="n">q21</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">];</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">q30</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="n">q31</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">];</span>
<span class="kt">border</span> <span class="nf">G1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span>
    <span class="kr">x</span><span class="o">=</span><span class="n">bzi</span><span class="p">(</span><span class="n">p00</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p01</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q00</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q01</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kp">t</span><span class="p">);</span>
    <span class="kr">y</span><span class="o">=</span><span class="n">bzi</span><span class="p">(</span><span class="n">p00</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p01</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q00</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q01</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kp">t</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">border</span> <span class="nf">G2</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span>
    <span class="kr">x</span><span class="o">=</span><span class="n">bzi</span><span class="p">(</span><span class="n">p01</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p11</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q10</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q11</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kp">t</span><span class="p">);</span>
    <span class="kr">y</span><span class="o">=</span><span class="n">bzi</span><span class="p">(</span><span class="n">p01</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p11</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q10</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q11</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kp">t</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">border</span> <span class="nf">G3</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span>
    <span class="kr">x</span><span class="o">=</span><span class="n">bzi</span><span class="p">(</span><span class="n">p11</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p21</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q20</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q21</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kp">t</span><span class="p">);</span>
    <span class="kr">y</span><span class="o">=</span><span class="n">bzi</span><span class="p">(</span><span class="n">p11</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p21</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q20</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q21</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kp">t</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">border</span> <span class="nf">G4</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span>
    <span class="kr">x</span><span class="o">=</span><span class="n">bzi</span><span class="p">(</span><span class="n">p21</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p00</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q30</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q31</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kp">t</span><span class="p">);</span>
    <span class="kr">y</span><span class="o">=</span><span class="n">bzi</span><span class="p">(</span><span class="n">p21</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p00</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q30</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q31</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kp">t</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="kr">m</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">G1</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="kr">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">G2</span><span class="p">(</span><span class="kr">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">G3</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="kr">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">G4</span><span class="p">(</span><span class="kr">m</span><span class="p">));</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">bw</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id20">
<img alt="../_images/Bezier.jpg" src="../_images/Bezier.jpg" />
<p class="caption"><span class="caption-number">Fig. 152 </span><span class="caption-text">Bezier</span></p>
</div>
</div>
<div class="section" id="build-layer-mesh">
<span id="examplebuildlayermesh"></span><h3>Build layer mesh<a class="headerlink" href="#build-layer-mesh" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;msh3&quot;</span>
<span class="cp">load</span> <span class="s">&quot;tetgen&quot;</span>
<span class="cp">load</span> <span class="s">&quot;</span><span class="nf">medit</span><span class="s">&quot;</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">C1</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">C2</span> <span class="o">=</span> <span class="mi">98</span><span class="p">;</span>

<span class="c1">// 2D mesh</span>
<span class="kt">border</span> <span class="nf">C01</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">C02</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span> <span class="kr">x</span><span class="o">=</span><span class="kr">pi</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">C03</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="kr">pi</span><span class="p">){</span> <span class="kr">x</span><span class="o">=</span><span class="kr">pi</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">C04</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span> <span class="kr">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>

<span class="kt">border</span> <span class="nf">C11</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">0.5</span><span class="o">+</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mf">2.5</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">C1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">C12</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">1.2</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mf">2.5</span><span class="o">+</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">C1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">C13</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">1.2</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mf">4.5</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">C1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">C14</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mf">4.5</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">C1</span><span class="p">;}</span>

<span class="kt">border</span> <span class="nf">C21</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">2.3</span><span class="o">+</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mf">2.5</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">C2</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">C22</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mf">2.5</span><span class="o">+</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">C2</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">C23</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">3</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mf">4.5</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">C2</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">C24</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mf">2.3</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mf">4.5</span><span class="o">-</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">C2</span><span class="p">;}</span>

<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">C01</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">C02</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">C03</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">C04</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">C11</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">C12</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">C13</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">C14</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">C21</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">C22</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">C23</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">C24</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">));</span>

<span class="kt">mesh</span> <span class="n">Ths</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">C01</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">C02</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">C03</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">C04</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">C11</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">C12</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">C13</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">C14</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>

<span class="c1">// Construction of a box with one hole and two regions</span>
<span class="kt">func</span> <span class="n">zmin</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">zmax</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">MaxLayer</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="kt">func</span> <span class="n">XX</span> <span class="o">=</span> <span class="kr">x</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">YY</span> <span class="o">=</span> <span class="kr">x</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">ZZ</span> <span class="o">=</span> <span class="kr">z</span><span class="p">;</span>

<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">r1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">41</span><span class="p">],</span> <span class="n">r2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">98</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">56</span><span class="p">];</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">r3</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">];</span> <span class="c1">// Change upper surface mesh&#39;s triangles labels</span>
                       <span class="c1">// generated by the 2D mesh&#39;s triangles Th</span>
                       <span class="c1">// from label 4 to label 12</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">r4</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">45</span><span class="p">];</span> <span class="c1">// Change lower surface mesh&#39;s triangles labels</span>
                       <span class="c1">// generated by the 2D mesh&#39;s triangles Th</span>
                       <span class="c1">// from label 4 to label 45</span>

<span class="kt">mesh3</span> <span class="n">Th3</span> <span class="o">=</span> <span class="nf">buildlayers</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">MaxLayer</span><span class="p">,</span> <span class="kp">zbound</span><span class="o">=</span><span class="p">[</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">],</span> <span class="kr">region</span><span class="o">=</span><span class="n">r1</span><span class="p">,</span>
    <span class="kp">labelmid</span><span class="o">=</span><span class="n">r2</span><span class="p">,</span> <span class="kp">labelup</span><span class="o">=</span><span class="n">r3</span><span class="p">,</span> <span class="kp">labeldown</span><span class="o">=</span><span class="n">r4</span><span class="p">);</span>
<span class="nf">medit</span><span class="p">(</span><span class="s">&quot;box 2 regions 1 hole&quot;</span><span class="p">,</span> <span class="n">Th3</span><span class="p">);</span>

<span class="c1">// Construction of a sphere with TetGen</span>
<span class="kt">func</span> <span class="n">XX1</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">YY1</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">ZZ1</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">);</span>

<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">domain</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">];</span>
<span class="kt">string</span> <span class="n">test</span> <span class="o">=</span> <span class="s">&quot;paACQ&quot;</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;test = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">test</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kt">mesh3</span> <span class="n">Th3sph</span> <span class="o">=</span> <span class="nf">tetgtransfo</span><span class="p">(</span><span class="n">Ths</span><span class="p">,</span> <span class="kp">transfo</span><span class="o">=</span><span class="p">[</span><span class="n">XX1</span><span class="p">,</span> <span class="n">YY1</span><span class="p">,</span> <span class="n">ZZ1</span><span class="p">],</span>
    <span class="kp">switch</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="kp">nbofregions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">regionlist</span><span class="o">=</span><span class="n">domain</span><span class="p">);</span>
<span class="nf">medit</span><span class="p">(</span><span class="s">&quot;sphere 2 regions&quot;</span><span class="p">,</span> <span class="n">Th3sph</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="inline2 figure" id="id21">
<img alt="../_images/BuildLayerMesh1.jpg" src="../_images/BuildLayerMesh1.jpg" />
<p class="caption"><span class="caption-number">Fig. 153 </span><span class="caption-text">Box with a hole</span></p>
</div>
<div class="inline2 figure" id="id22">
<img alt="../_images/BuildLayerMesh2.jpg" src="../_images/BuildLayerMesh2.jpg" />
<p class="caption"><span class="caption-number">Fig. 154 </span><span class="caption-text">Sphere</span></p>
</div>
</div>
<div class="section" id="sphere">
<span id="examplesphere"></span><h3>Sphere<a class="headerlink" href="#sphere" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Parameter</span>
<span class="kt">real</span> <span class="n">hh</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>

<span class="c1">// Mesh 2D</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="p">[</span><span class="kr">x</span><span class="o">*</span><span class="kr">pi</span><span class="o">-</span><span class="kr">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">y</span><span class="o">*</span><span class="kr">pi</span><span class="p">]);</span> <span class="c1">// ]-pi/2, pi/2[X]0, 2pi[</span>
<span class="c1">// A parametrization of a sphere</span>
<span class="kt">func</span> <span class="n">f1</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f2</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f3</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">);</span>
<span class="c1">// Partial derivative of the parametrization DF</span>
<span class="kt">func</span> <span class="n">f1x</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f1y</span> <span class="o">=</span> <span class="o">-</span><span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f2x</span> <span class="o">=</span> <span class="o">-</span><span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f2y</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f3x</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">f3y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">//M = DF^t DF</span>
<span class="kt">func</span> <span class="n">m11</span> <span class="o">=</span> <span class="n">f1x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">f2x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">f3x</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">m21</span> <span class="o">=</span> <span class="n">f1x</span><span class="o">*</span><span class="n">f1y</span> <span class="o">+</span> <span class="n">f2x</span><span class="o">*</span><span class="n">f2y</span> <span class="o">+</span> <span class="n">f3x</span><span class="o">*</span><span class="n">f3y</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">m22</span> <span class="o">=</span> <span class="n">f1y</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">f2y</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">f3y</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>

<span class="c1">// Periodic condition</span>
<span class="kt">func</span> <span class="n">perio</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">4</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kr">x</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="kr">x</span><span class="p">]];</span>

<span class="c1">// Mesh adaptation</span>
<span class="kt">real</span> <span class="n">vv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="nf">square</span><span class="p">(</span><span class="n">hh</span><span class="p">);</span>
<span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">m11</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="n">m21</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="n">m22</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="kp">IsMetric</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">inquire</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="n">perio</span><span class="p">);</span>
<span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">m11</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="n">m21</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="n">m22</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="kp">IsMetric</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="n">perio</span><span class="p">);</span>
<span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">m11</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="n">m21</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="n">m22</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="kp">IsMetric</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="n">perio</span><span class="p">);</span>
<span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">m11</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="n">m21</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="n">m22</span><span class="o">*</span><span class="n">vv</span><span class="p">,</span> <span class="kp">IsMetric</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="n">perio</span><span class="p">);</span>

<span class="c1">// Sphere</span>
<span class="kt">mesh3</span> <span class="n">Th3</span> <span class="o">=</span> <span class="nf">movemesh23</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">transfo</span><span class="o">=</span><span class="p">[</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">]);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th3</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="inline2 figure" id="id23">
<img alt="../_images/Sphere1.jpg" src="../_images/Sphere1.jpg" />
<p class="caption"><span class="caption-number">Fig. 155 </span><span class="caption-text">Initial mesh</span></p>
</div>
<div class="inline2 figure" id="id24">
<img alt="../_images/Sphere2.jpg" src="../_images/Sphere2.jpg" />
<p class="caption"><span class="caption-number">Fig. 156 </span><span class="caption-text">Sphere</span></p>
</div>
</div>
</div>
<div class="section" id="finite-element">
<span id="examplefinteelement"></span><h2>Finite Element<a class="headerlink" href="#finite-element" title="Permalink to this headline">¶</a></h2>
<div class="section" id="periodic-3d">
<span id="exampleperiodic3d"></span><h3>Periodic 3D<a class="headerlink" href="#periodic-3d" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;msh3&quot;</span>
<span class="cp">load</span> <span class="s">&quot;</span><span class="nf">medit</span><span class="s">&quot;</span>

<span class="c1">// Parameters</span>
<span class="kr">searchMethod</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// More safe seach algo</span>
<span class="kt">real</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nf">d</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">nnb</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">nni</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">nz</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">zmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>

<span class="c1">// Mesh 2D</span>
<span class="kt">border</span> <span class="nf">b1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">a</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=-</span><span class="n">a</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">b2</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">a</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">a</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">2</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">b3</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">a</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">a</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">3</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">b4</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">){</span><span class="kr">x</span><span class="o">=-</span><span class="n">a</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="n">a</span><span class="o">*</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="mi">4</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">i1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="nf">d</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=-</span><span class="nf">d</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">label</span><span class="o">=</span><span class="mi">7</span><span class="p">;}</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">b1</span><span class="p">(</span><span class="o">-</span><span class="n">nnb</span><span class="p">)</span> <span class="o">+</span> <span class="n">b3</span><span class="p">(</span><span class="n">nnb</span><span class="p">)</span> <span class="o">+</span> <span class="n">b2</span><span class="p">(</span><span class="o">-</span><span class="n">nnb</span><span class="p">)</span> <span class="o">+</span> <span class="n">b4</span><span class="p">(</span><span class="n">nnb</span><span class="p">)</span> <span class="o">+</span> <span class="n">i1</span><span class="p">(</span><span class="n">nni</span><span class="p">));</span>

<span class="p">{</span> <span class="c1">// Cleaning the memory correctly</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">old2new</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="n">Th</span><span class="p">.</span><span class="kr">nv</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="kt">fespace</span> <span class="nf">Vh2</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
    <span class="n">Vh2</span> <span class="n">sorder</span> <span class="o">=</span> <span class="kr">x</span> <span class="o">+</span> <span class="kr">y</span><span class="p">;</span>
    <span class="nf">sort</span><span class="p">(</span><span class="n">sorder</span><span class="p">[],</span> <span class="n">old2new</span><span class="p">);</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">new2old</span> <span class="o">=</span> <span class="n">old2new</span><span class="o">^-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// Inverse permutation</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">change</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">renumv</span><span class="o">=</span><span class="n">new2old</span><span class="p">);</span>
    <span class="n">sorder</span><span class="p">[]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">:</span><span class="n">Th</span><span class="p">.</span><span class="kr">nv</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">{</span>
    <span class="kt">fespace</span> <span class="n">Vh2</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
    <span class="n">Vh2</span> <span class="n">nu</span><span class="p">;</span>
    <span class="n">nu</span><span class="p">[]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">:</span><span class="n">Th</span><span class="p">.</span><span class="kr">nv</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;nu=&quot;</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Mesh 3D</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">rup</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">rlow</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">rmid</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="n">rtet</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">41</span><span class="p">];</span>
<span class="kt">mesh3</span> <span class="n">Th3</span> <span class="o">=</span> <span class="nf">buildlayers</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="kp">zbound</span><span class="o">=</span><span class="p">[</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">],</span>
    <span class="kp">reftet</span><span class="o">=</span><span class="n">rtet</span><span class="p">,</span> <span class="kp">reffacemid</span><span class="o">=</span><span class="n">rmid</span><span class="p">,</span> <span class="kp">reffaceup</span><span class="o">=</span><span class="n">rup</span><span class="p">,</span> <span class="kp">reffacelow</span><span class="o">=</span><span class="n">rlow</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; int &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th3</span><span class="p">,</span><span class="n">i</span><span class="p">)(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th3</span><span class="p">,</span><span class="n">i</span><span class="p">)(</span><span class="mf">1.</span><span class="o">/</span><span class="kr">area</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">Th3</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
<span class="nf">medit</span><span class="p">(</span><span class="s">&quot;Th3&quot;</span><span class="p">,</span> <span class="n">Th3</span><span class="p">);</span>

<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th3</span><span class="p">,</span> <span class="nc">P2</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="kr">x</span><span class="p">,</span> <span class="kr">z</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="kr">x</span><span class="p">,</span> <span class="kr">z</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="kr">z</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="kr">z</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">]]);</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id25">
<img alt="../_images/Periodic.jpg" src="../_images/Periodic.jpg" />
<p class="caption"><span class="caption-number">Fig. 157 </span><span class="caption-text">Periodic mesh</span></p>
</div>
</div>
<div class="section" id="lagrange-multipliers">
<span id="examplelagrangemultipliers"></span><h3>Lagrange multipliers<a class="headerlink" href="#lagrange-multipliers" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="kr">x</span> <span class="o">-</span> <span class="kr">y</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">n1</span> <span class="o">=</span> <span class="kr">n</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">varf</span> <span class="nf">va</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">vL</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f</span><span class="o">*</span><span class="n">vh</span><span class="p">);</span>
<span class="kt">varf</span> <span class="nf">vb</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="mf">1.</span><span class="o">*</span><span class="n">vh</span><span class="p">);</span>

<span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span> <span class="n">va</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span> <span class="o">=</span> <span class="n">vL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="kp">B</span> <span class="o">=</span> <span class="n">vb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>

<span class="c1">// Block matrix</span>
<span class="kt">matrix</span> <span class="n">AA</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="kp">A</span><span class="p">,</span> <span class="kp">B</span> <span class="p">],</span> <span class="p">[</span> <span class="kp">B</span><span class="o">&#39;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
<span class="nf">set</span><span class="p">(</span><span class="n">AA</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">sparsesolver</span><span class="p">);</span>

<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="kp">bb</span><span class="p">(</span><span class="kr">n</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">xx</span><span class="p">(</span><span class="kr">n</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">b1</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">l</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">b1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// Builds the right hand side block</span>
<span class="kp">bb</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">b1</span><span class="p">];</span>

<span class="c1">// Solve</span>
<span class="n">xx</span> <span class="o">=</span> <span class="n">AA</span><span class="o">^-</span><span class="mi">1</span> <span class="o">*</span> <span class="kp">bb</span><span class="p">;</span>

<span class="c1">// Set values</span>
<span class="p">[</span><span class="n">uh</span><span class="p">[],</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">;</span>

<span class="c1">// Display</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; l = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">l</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; , b(u, 1) =&quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">B</span><span class="o">&#39;*</span><span class="n">uh</span><span class="p">[]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uh</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id26">
<img alt="../_images/LagrangeMultipliers.jpg" src="../_images/LagrangeMultipliers.jpg" />
<p class="caption"><span class="caption-number">Fig. 158 </span><span class="caption-text">Result</span></p>
</div>
</div>
</div>
<div class="section" id="visualization">
<span id="examplevisualization"></span><h2>Visualization<a class="headerlink" href="#visualization" title="Permalink to this headline">¶</a></h2>
<div class="section" id="plot">
<span id="exampleplot"></span><h3>Plot<a class="headerlink" href="#plot" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>

<span class="c1">// Plot scalar and vectorial FE function</span>
<span class="n">Vh</span> <span class="n">uh</span><span class="o">=</span><span class="kr">x</span><span class="o">*</span><span class="kr">x</span><span class="o">+</span><span class="kr">y</span><span class="o">*</span><span class="kr">y</span><span class="p">,</span> <span class="n">vh</span><span class="o">=-</span><span class="kr">y</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">uh</span><span class="p">,</span> <span class="p">[</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">],</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="c1">// Zoom on box defined by the two corner points [0.1,0.2] and [0.5,0.6]</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="p">[</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">],</span> <span class="kp">bb</span><span class="o">=</span><span class="p">[[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">]],</span>
    <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">grey</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="c1">// Compute a cut</span>
<span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">xx</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">yy</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="kr">x</span> <span class="o">=</span> <span class="n">i</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="kr">n</span><span class="p">);</span>
    <span class="kr">y</span> <span class="o">=</span> <span class="n">i</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="kr">n</span><span class="p">);</span>
    <span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">yy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uh</span><span class="p">;</span> <span class="c1">// Value of uh at point (i/10., i/10.)</span>
<span class="p">}</span>
<span class="nf">plot</span><span class="p">([</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">],</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="p">{</span> <span class="c1">// File for gnuplot</span>
    <span class="kt">ofstream</span> <span class="n">gnu</span><span class="p">(</span><span class="s">&quot;plot.gp&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">gnu</span> <span class="o">&lt;&lt;</span> <span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">yy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Calls the gnuplot command, waits 5 seconds and generates a postscript plot (UNIX ONLY)</span>
<span class="nf">exec</span><span class="p">(</span><span class="s">&quot;echo &#39;plot </span><span class="se">\&quot;</span><span class="s">plot.gp</span><span class="se">\&quot;</span><span class="s"> w l </span><span class="se">\n</span><span class="s"> pause 5 </span><span class="se">\n</span><span class="s"> set term postscript </span><span class="se">\n</span><span class="s"> set output </span><span class="se">\&quot;</span><span class="s">gnuplot.eps</span><span class="se">\&quot;</span><span class="s"> </span><span class="se">\n</span><span class="s"> replot </span><span class="se">\n</span><span class="s"> quit&#39; | gnuplot&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="inline3 figure" id="id27">
<img alt="../_images/Plot1.jpg" src="../_images/Plot1.jpg" />
<p class="caption"><span class="caption-number">Fig. 159 </span><span class="caption-text">First plot</span></p>
</div>
<div class="inline3 figure" id="id28">
<img alt="../_images/Plot2.jpg" src="../_images/Plot2.jpg" />
<p class="caption"><span class="caption-number">Fig. 160 </span><span class="caption-text">Second plot</span></p>
</div>
<div class="inline3 figure" id="id29">
<img alt="../_images/Plot3.png" src="../_images/Plot3.png" />
<p class="caption"><span class="caption-number">Fig. 161 </span><span class="caption-text">Gnuplot</span></p>
</div>
</div>
<div class="section" id="hsv">
<span id="examplehsv"></span><h3>HSV<a class="headerlink" href="#hsv" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// From: http://en.wikipedia.org/wiki/HSV_color_space</span>
<span class="c1">// The HSV (Hue, Saturation, Value) model defines a color space</span>
<span class="c1">// in terms of three constituent components:</span>
<span class="c1">// HSV color space as a color wheel</span>
<span class="c1">// Hue, the color type (such as red, blue, or yellow):</span>
<span class="c1">// Ranges from 0-360 (but normalized to 0-100% in some applications like here)</span>
<span class="c1">// Saturation, the &quot;vibrancy&quot; of the color: Ranges from 0-100%</span>
<span class="c1">// The lower the saturation of a color, the more &quot;grayness&quot; is present</span>
<span class="c1">// and the more faded the color will appear.</span>
<span class="c1">// Value, the brightness of the color: Ranges from 0-100%</span>

<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="kr">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>

<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">uh</span><span class="o">=</span><span class="mi">2</span><span class="o">-</span><span class="kr">x</span><span class="o">*</span><span class="kr">x</span><span class="o">-</span><span class="kr">y</span><span class="o">*</span><span class="kr">y</span><span class="p">;</span>

<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">colorhsv</span><span class="o">=</span><span class="p">[</span> <span class="c1">// Color hsv model</span>
    <span class="mf">4.</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="c1">// Dark blue</span>
    <span class="mf">4.</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// Blue</span>
    <span class="mf">5.</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// Magenta</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// Red</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span> <span class="p">,</span> <span class="mi">1</span> <span class="c1">// Light red</span>
    <span class="p">];</span>
 <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="kp">viso</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>

 <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kp">viso</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="kp">viso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="mf">0.1</span><span class="p">;</span>

 <span class="nf">plot</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="kp">viso</span><span class="o">=</span><span class="kp">viso</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="kp">viso</span><span class="p">.</span><span class="kr">n</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">hsv</span><span class="o">=</span><span class="n">colorhsv</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id30">
<img alt="../_images/HSV.jpg" src="../_images/HSV.jpg" />
<p class="caption"><span class="caption-number">Fig. 162 </span><span class="caption-text">Result</span></p>
</div>
</div>
<div class="section" id="medit">
<span id="examplemedit"></span><h3>Medit<a class="headerlink" href="#medit" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;</span><span class="nf">medit</span><span class="s">&quot;</span>

<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="kr">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>

<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u</span><span class="o">=</span><span class="mi">2</span><span class="o">-</span><span class="kr">x</span><span class="o">*</span><span class="kr">x</span><span class="o">-</span><span class="kr">y</span><span class="o">*</span><span class="kr">y</span><span class="p">;</span>

<span class="nf">medit</span><span class="p">(</span><span class="s">&quot;u&quot;</span><span class="p">,</span> <span class="n">Th</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>

<span class="c1">// Old way</span>
<span class="nf">savemesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="s">&quot;u&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="mf">.5</span><span class="p">]);</span> <span class="c1">// Saves u.points and u.faces file</span>
<span class="c1">// build a u.bb file for medit</span>
<span class="p">{</span>
    <span class="kt">ofstream</span> <span class="kp">file</span><span class="p">(</span><span class="s">&quot;u.bb&quot;</span><span class="p">);</span>
    <span class="kp">file</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;2 1 1 &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[].</span><span class="kr">n</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; 2 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">u</span><span class="p">[].</span><span class="kr">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="kp">file</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// Calls medit command</span>
<span class="nf">exec</span><span class="p">(</span><span class="s">&quot;ffmedit u&quot;</span><span class="p">);</span>
<span class="c1">// Cleans files on unix-like OS</span>
<span class="nf">exec</span><span class="p">(</span><span class="s">&quot;rm u.bb u.faces u.points&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="inline2 figure" id="id31">
<img alt="../_images/Medit1.jpg" src="../_images/Medit1.jpg" />
<p class="caption"><span class="caption-number">Fig. 163 </span><span class="caption-text">2D plot</span></p>
</div>
<div class="inline2 figure" id="id32">
<img alt="../_images/Medit2.jpg" src="../_images/Medit2.jpg" />
<p class="caption"><span class="caption-number">Fig. 164 </span><span class="caption-text">Plot with elevation</span></p>
</div>
</div>
<div class="section" id="paraview">
<span id="exampleparaview"></span><h3>Paraview<a class="headerlink" href="#paraview" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;iovtk&quot;</span>

<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="kr">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>

<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u</span><span class="o">=</span><span class="mi">2</span><span class="o">-</span><span class="kr">x</span><span class="o">*</span><span class="kr">x</span><span class="o">-</span><span class="kr">y</span><span class="o">*</span><span class="kr">y</span><span class="p">;</span>

<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Order</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="kt">string</span> <span class="n">DataName</span> <span class="o">=</span> <span class="s">&quot;u&quot;</span><span class="p">;</span>
<span class="nf">savevtk</span><span class="p">(</span><span class="s">&quot;u.vtu&quot;</span><span class="p">,</span> <span class="n">Th</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">dataname</span><span class="o">=</span><span class="n">DataName</span><span class="p">,</span> <span class="kp">order</span><span class="o">=</span><span class="n">Order</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id33">
<img alt="../_images/Paraview.jpg" src="../_images/Paraview.jpg" />
<p class="caption"><span class="caption-number">Fig. 165 </span><span class="caption-text">Result</span></p>
</div>
</div>
</div>
<div class="section" id="algorithms-optimizations">
<span id="examplealgorithmsoptimization"></span><h2>Algorithms &amp; Optimizations<a class="headerlink" href="#algorithms-optimizations" title="Permalink to this headline">¶</a></h2>
<div class="section" id="algorithms">
<span id="examplealgorithms"></span><h3>Algorithms<a class="headerlink" href="#algorithms" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">nerr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">debugJ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">debugdJ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">umax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Algorithms tests</span>
<span class="p">{</span>
    <span class="kt">func</span> <span class="kt">bool</span> <span class="kp">stop</span> <span class="p">(</span><span class="kt">int</span> <span class="n">iter</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">u</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">g</span><span class="p">){</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; stop = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">iter</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">g</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">g</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;</span> <span class="mf">1e-5</span> <span class="o">||</span> <span class="n">iter</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// minimization of J(u) = 1./2 * sum (i+1) u_i^2 - b_i</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

    <span class="c1">//J</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">J</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">u</span><span class="p">){</span>
        <span class="kt">real</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">debugJ</span><span class="p">)</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;J = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//the gradiant of J (this is a affine version (the RHS is in)</span>
    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">DJ</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">){</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">debugdJ</span><span class="p">)</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dJ: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="n">u</span> <span class="o">-=</span> <span class="n">b</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">debugdJ</span><span class="p">)</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dJ-b: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">;</span> <span class="c1">//return of global variable ok</span>
    <span class="p">}</span>

    <span class="c1">//the gradiant of the bilinear part of J (the RHS is remove)</span>
    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">DJ0</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">){</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="n">debugdJ</span><span class="p">)</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dJ0: u =&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">;</span> <span class="c1">//return of global variable ok</span>
    <span class="p">}</span>

    <span class="c1">//erro calculation</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="n">error</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">u</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">b</span><span class="p">){</span>
        <span class="kt">real</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="nf">abs</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">matId</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">){</span> <span class="k">return</span> <span class="n">u</span><span class="p">;</span> <span class="p">}</span>

    <span class="kt">int</span> <span class="n">verb</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span> <span class="c1">//verbosity</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span> <span class="c1">//set right hand side</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span> <span class="c1">//set initial gest</span>

    <span class="nf">LinearCG</span><span class="p">(</span><span class="n">DJ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">matId</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">verb</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;LinearGC (Affine) : J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">nerr</span> <span class="o">+=</span> <span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nf">LinearCG</span><span class="p">(</span><span class="n">DJ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">matId</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span> <span class="kp">stop</span><span class="o">=</span><span class="kp">stop</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;LinearGC (Affine with stop) : J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">nerr</span> <span class="o">+=</span> <span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nf">LinearCG</span><span class="p">(</span><span class="n">DJ0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">matId</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">verb</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;LinearGC (Linear) : J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">nerr</span> <span class="o">+=</span> <span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>


    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nf">AffineGMRES</span><span class="p">(</span><span class="n">DJ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">matId</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">verb</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;AffineGMRES (Affine) : J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">nerr</span> <span class="o">+=</span> <span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="n">b</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="nf">LinearGMRES</span><span class="p">(</span><span class="n">DJ0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">matId</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">verb</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;LinearGMRES (Linear) : J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">nerr</span> <span class="o">+=</span> <span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>


    <span class="n">b</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="nf">NLCG</span><span class="p">(</span><span class="n">DJ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">matId</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">verb</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;NLCG: J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">nerr</span> <span class="o">+=</span> <span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u =&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>


    <span class="c1">//warning: BFGS use a full matrix of size nxn (where n=u.n)</span>
    <span class="n">b</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
    <span class="nf">BFGS</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">DJ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">nbiterline</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;BFGS: J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u =&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="nf">assert</span><span class="p">(</span><span class="n">nerr</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">{</span> <span class="c1">// A real non linear test</span>
    <span class="c1">// Parameters</span>
    <span class="kt">real</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">;</span>
    <span class="kt">real</span> <span class="kp">eps</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">;</span>
    <span class="c1">//f(u) = a*u + u-ln(1+u), f&#39;(u) = a+ u/(1+u), f&#39;&#39;(u) = 1/(1+u)^2</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">f</span><span class="p">(</span><span class="kt">real</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">u</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="n">u</span><span class="o">-</span><span class="nf">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">u</span><span class="p">);</span> <span class="p">}</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">df</span><span class="p">(</span><span class="kt">real</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">u</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">u</span><span class="p">);</span> <span class="p">}</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">ddf</span><span class="p">(</span><span class="kt">real</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">u</span><span class="p">));</span> <span class="p">}</span>

    <span class="c1">// Mesh</span>
    <span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

    <span class="c1">// Fespace</span>
    <span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
    <span class="n">Vh</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">Vh</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">fespace</span> <span class="nf">Ph</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>
    <span class="n">Ph</span> <span class="n">alpha</span><span class="p">;</span> <span class="c1">//store df(|nabla u|^2)</span>

    <span class="c1">// The functionnal J</span>
    <span class="c1">//J(u) = 1/2 int_Omega f(|nabla u|^2) - int_Omega u b</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">J</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">u</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">w</span><span class="p">;</span>
        <span class="n">w</span><span class="p">[]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
        <span class="kt">real</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// The gradiant of J</span>
    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">dJ</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">u</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">w</span><span class="p">;</span>
        <span class="n">w</span><span class="p">[]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">df</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">));</span>
        <span class="kt">varf</span> <span class="nf">au</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
            <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
                  <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vh</span><span class="p">))</span>
                <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">vh</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">uh</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">au</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">;</span> <span class="c1">//warning: no return of local array</span>
    <span class="p">}</span>

    <span class="c1">// Problem</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">df</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">));</span>
    <span class="kt">varf</span> <span class="nf">alap</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
              <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vh</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">uh</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="kt">varf</span> <span class="nf">amass</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
              <span class="n">uh</span><span class="o">*</span><span class="n">vh</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">uh</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="kt">matrix</span> <span class="n">Amass</span> <span class="o">=</span> <span class="n">amass</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">);</span>
    <span class="kt">matrix</span> <span class="n">Alap</span><span class="o">=</span> <span class="n">alap</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Cholesky</span><span class="p">,</span> <span class="kp">factorize</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Preconditionner</span>
    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">C</span><span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">u</span><span class="p">){</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">w</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">Alap</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">w</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">;</span> <span class="c1">//warning: no return of local array variable</span>
    <span class="p">}</span>

    <span class="c1">// Solve</span>
    <span class="kt">int</span> <span class="n">conv</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="nf">NLCG</span><span class="p">(</span><span class="n">dJ</span><span class="p">,</span> <span class="n">u</span><span class="p">[],</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="kp">veps</span><span class="o">=</span><span class="kp">eps</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="mi">5</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">conv</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">df</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">));</span>
        <span class="n">Alap</span> <span class="o">=</span> <span class="n">alap</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Cholesky</span><span class="p">,</span> <span class="kp">factorize</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Restart with new preconditionner &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">conv</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, eps =&quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">eps</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Plot</span>
    <span class="nf">plot</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;solution with NLCG&quot;</span><span class="p">);</span>
    <span class="n">umax</span> <span class="o">=</span> <span class="n">u</span><span class="p">[].</span><span class="kr">max</span><span class="p">;</span>

    <span class="n">Vh</span> <span class="n">sss</span><span class="o">=</span> <span class="n">df</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">));</span>
    <span class="nf">plot</span> <span class="p">(</span><span class="n">sss</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="nf">assert</span><span class="p">(</span><span class="n">nerr</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="inline2 figure" id="id34">
<img alt="../_images/Algorithms1.png" src="../_images/Algorithms1.png" />
<p class="caption"><span class="caption-number">Fig. 166 </span><span class="caption-text">Result <code class="docutils literal highlight highlight-default"><span></span><span class="n">u</span></code></span></p>
</div>
<div class="inline2 figure" id="id35">
<img alt="../_images/Algorithms2.png" src="../_images/Algorithms2.png" />
<p class="caption"><span class="caption-number">Fig. 167 </span><span class="caption-text"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">df</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">))</span></code></span></p>
</div>
</div>
<div class="section" id="cmaes-variational-inequality">
<span id="examplecmaesvariationalinequality"></span><h3>CMAES variational inequality<a class="headerlink" href="#cmaes-variational-inequality" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;ff-cmaes&quot;</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">NN</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f1</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">g1</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">g2</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">nadapt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">starttol</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">bctol</span> <span class="o">=</span> <span class="mf">6.e-12</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">pena</span> <span class="o">=</span> <span class="mf">1000.</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span> <span class="n">NN</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">ou1</span><span class="p">,</span> <span class="n">ou2</span><span class="p">;</span>

<span class="c1">// Mesh adaptation loops</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">al</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">al</span> <span class="o">&lt;</span> <span class="n">nadapt</span><span class="p">;</span> <span class="o">++</span><span class="n">al</span><span class="p">){</span>
    <span class="c1">// Problem</span>
    <span class="kt">varf</span> <span class="n">BVF</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
              <span class="mf">0.5</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="p">;</span>
    <span class="kt">varf</span> <span class="nf">LVF1</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f1</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
    <span class="kt">varf</span> <span class="nf">LVF2</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f2</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>

    <span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span>  <span class="n">BVF</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">LVF1</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">LVF2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>

    <span class="kt">varf</span> <span class="nf">Vbord</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">Vh</span> <span class="n">In</span><span class="p">,</span> <span class="n">Bord</span><span class="p">;</span>
    <span class="n">Bord</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Vbord</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">tgv</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">In</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Bord</span><span class="p">[]</span> <span class="o">?</span> <span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">Vh</span> <span class="n">gh1</span> <span class="o">=</span> <span class="n">Bord</span><span class="o">*</span><span class="n">g1</span><span class="p">;</span>
    <span class="n">Vh</span> <span class="n">gh2</span> <span class="o">=</span> <span class="n">Bord</span><span class="o">*</span><span class="n">g2</span><span class="p">;</span>

    <span class="c1">// Function which creates a vector of the search space type from</span>
    <span class="c1">// two finite element functions</span>
    <span class="kt">func</span> <span class="kt">int</span> <span class="nf">FEFToSSP</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef1</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef2</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">kX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">In</span><span class="p">[][</span><span class="n">i</span><span class="p">]){</span>
                <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="p">]</span> <span class="o">=</span> <span class="n">fef1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="o">+</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">]</span> <span class="o">=</span> <span class="n">fef2</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="o">++</span><span class="n">kX</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Splits a vector from the search space and fills</span>
    <span class="c1">// two finite element functions with it</span>
    <span class="kt">func</span> <span class="kt">int</span> <span class="nf">SSPToFEF</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef1</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef2</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">kX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">In</span><span class="p">[][</span><span class="n">i</span><span class="p">]){</span>
                <span class="n">fef1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="p">];</span>
                <span class="n">fef2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="o">+</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">];</span>
                <span class="o">++</span><span class="n">kX</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span><span class="p">{</span>
                <span class="n">fef1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gh1</span><span class="p">[][</span><span class="n">i</span><span class="p">];</span>
                <span class="n">fef2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gh2</span><span class="p">[][</span><span class="n">i</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">IneqC</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">constraints</span><span class="p">(</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">];</span>
            <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mf">0.</span> <span class="o">:</span> <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">constraints</span><span class="p">.</span><span class="kr">l2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">J</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">;</span>
        <span class="n">SSPToFEF</span><span class="p">(</span><span class="n">u1</span><span class="p">[],</span> <span class="n">u2</span><span class="p">[],</span> <span class="n">X</span><span class="p">);</span>
        <span class="n">iter</span><span class="o">++</span><span class="p">;</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Au1</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">u1</span><span class="p">[],</span> <span class="n">Au2</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">u2</span><span class="p">[];</span>
        <span class="n">Au1</span> <span class="o">-=</span> <span class="n">b1</span><span class="p">;</span>
        <span class="n">Au2</span> <span class="o">-=</span> <span class="n">b2</span><span class="p">;</span>
        <span class="kt">real</span> <span class="n">val</span> <span class="o">=</span> <span class="n">u1</span><span class="p">[]</span><span class="o">&#39;*</span><span class="n">Au1</span> <span class="o">+</span> <span class="n">u2</span><span class="p">[]</span><span class="o">&#39;*</span><span class="n">Au2</span><span class="p">;</span>
        <span class="n">val</span> <span class="o">+=</span>  <span class="n">pena</span> <span class="o">*</span> <span class="n">IneqC</span><span class="p">(</span><span class="n">X</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">%</span><span class="mi">200</span> <span class="o">==</span> <span class="mi">199</span><span class="p">)</span>
            <span class="nf">plot</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="kp">nbiso</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;adapt level &quot;</span><span class="o">+</span><span class="n">al</span><span class="o">+</span><span class="s">&quot; - iteration &quot;</span><span class="o">+</span><span class="n">iter</span><span class="o">+</span><span class="s">&quot; - J = &quot;</span><span class="o">+</span><span class="n">val</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">val</span> <span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Solve</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">start</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">al</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
        <span class="n">start</span><span class="p">(</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="o">:</span><span class="mi">2</span><span class="o">*</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">FEFToSSP</span><span class="p">(</span><span class="n">ou1</span><span class="p">[],</span> <span class="n">ou2</span><span class="p">[],</span> <span class="n">start</span><span class="p">);</span>

    <span class="kt">real</span> <span class="n">mini</span> <span class="o">=</span> <span class="nf">cmaes</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stopMaxFunEval</span><span class="o">=</span><span class="mi">10000</span><span class="o">*</span><span class="p">(</span><span class="n">al</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">stopTolX</span><span class="o">=</span><span class="mf">1.e-3</span><span class="o">/</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="n">al</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="n">initialStdDev</span><span class="o">=</span><span class="p">(</span><span class="mf">0.025</span><span class="o">/</span><span class="p">(</span><span class="nf">pow</span><span class="p">(</span><span class="mf">100.</span><span class="p">,</span><span class="n">al</span><span class="p">))));</span>
    <span class="n">Vh</span> <span class="n">best1</span><span class="p">,</span> <span class="n">best2</span><span class="p">;</span>
    <span class="n">SSPToFEF</span><span class="p">(</span><span class="n">best1</span><span class="p">[],</span> <span class="n">best2</span><span class="p">[],</span> <span class="n">start</span><span class="p">);</span>

    <span class="c1">// Mesh adaptation</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">best1</span><span class="p">,</span> <span class="n">best2</span><span class="p">);</span>
    <span class="n">ou1</span> <span class="o">=</span> <span class="n">best1</span><span class="p">;</span>
    <span class="n">ou2</span> <span class="o">=</span> <span class="n">best2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id36">
<img alt="../_images/CMAESVariationalInequality.png" src="../_images/CMAESVariationalInequality.png" />
<p class="caption"><span class="caption-number">Fig. 168 </span><span class="caption-text">Results</span></p>
</div>
</div>
<div class="section" id="ipopt-minimal-surface-volume">
<span id="exampleipoptminimalsurfacevolume"></span><h3>IPOPT minimal surface &amp; volume<a class="headerlink" href="#ipopt-minimal-surface-volume" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;msh3&quot;</span><span class="p">;</span>
<span class="cp">load</span> <span class="s">&quot;</span><span class="nf">medit</span><span class="s">&quot;</span><span class="p">;</span>
<span class="cp">load</span> <span class="s">&quot;ff-Ipopt&quot;</span><span class="p">;</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">nadapt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">np</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">regtest</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">shapeswitch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">real</span> <span class="kp">sigma</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">/</span><span class="mf">40.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">treshold</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">e</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">r0</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">rr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">-</span><span class="n">r0</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">E</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">e</span><span class="o">*</span><span class="n">e</span><span class="p">);</span>
<span class="kt">real</span> <span class="n">RR</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">rr</span><span class="o">*</span><span class="n">rr</span><span class="p">);</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">*</span><span class="kr">x</span><span class="p">,</span> <span class="kr">pi</span><span class="o">*</span><span class="kr">y</span><span class="p">]);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kr">y</span><span class="p">]]);</span>
<span class="c1">//Initial shape definition</span>
<span class="c1">//outside of the mesh adaptation loop to initialize with the previous optimial shape found on further iterations</span>
<span class="n">Vh</span> <span class="n">startshape</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">uz</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">lz</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>

<span class="c1">// Mesh adaptation loop</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">lm</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">kkk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">kkk</span> <span class="o">&lt;</span> <span class="n">nadapt</span><span class="p">;</span> <span class="o">++</span><span class="n">kkk</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">iter</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">func</span> <span class="n">sin2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">));</span>

    <span class="c1">// A function which transform Th in 3d mesh (r=rho)</span>
    <span class="c1">//a point (theta,phi) of Th becomes ( r(theta,phi)*cos(theta)*sin(phi) , r(theta,phi)*sin(theta)*sin(phi) , r(theta,phi)*cos(phi) )</span>
    <span class="c1">//then displays the resulting mesh with medit</span>
    <span class="kt">func</span> <span class="kt">int</span> <span class="nf">Plot3D</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">rho</span><span class="p">,</span> <span class="kt">string</span> <span class="kp">cmm</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">ffplot</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rhoo</span><span class="p">;</span>
        <span class="n">rhoo</span><span class="p">[]</span> <span class="o">=</span> <span class="n">rho</span><span class="p">;</span>
        <span class="c1">//mesh sTh = square(np, np/2, [2*pi*x, pi*y]);</span>
        <span class="c1">//fespace sVh(sTh, P1);</span>
        <span class="c1">//Vh rhoplot = rhoo;</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="kt">mesh3</span> <span class="n">Sphere</span> <span class="o">=</span> <span class="nf">movemesh23</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">transfo</span><span class="o">=</span><span class="p">[</span><span class="n">rhoo</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">),</span> <span class="n">rhoo</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">),</span> <span class="n">rhoo</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">)]);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">ffplot</span><span class="p">)</span>
                <span class="nf">plot</span><span class="p">(</span><span class="n">Sphere</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="nf">medit</span><span class="p">(</span><span class="kp">cmm</span><span class="p">,</span> <span class="n">Sphere</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(...){</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;PLOT ERROR&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Surface computation</span>
    <span class="c1">//Maybe is it possible to use movemesh23 to have the surface function less complicated</span>
    <span class="c1">//However, it would not simplify the gradient and the hessian</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">Area</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rho</span><span class="p">;</span>
        <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span>
        <span class="n">Vh</span> <span class="n">rho2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
        <span class="n">Vh</span> <span class="n">rho4</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">rho2</span><span class="p">);</span>
        <span class="kt">real</span> <span class="n">res</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">rho4</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="nf">square</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">))</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span><span class="o">*</span><span class="nf">square</span><span class="p">(</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">))));</span>
        <span class="o">++</span><span class="n">iter</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nf">plot</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;rho(theta,phi) on [0,2pi]x[0,pi] - S=&quot;</span><span class="o">+</span><span class="n">res</span><span class="p">,</span> <span class="kp">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">Plot3D</span><span class="p">(</span><span class="n">rho</span><span class="p">[],</span> <span class="s">&quot;shape_evolution&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">GradArea</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rho</span><span class="p">,</span> <span class="n">rho2</span><span class="p">;</span>
        <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span>
        <span class="n">rho2</span><span class="p">[]</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">X</span><span class="p">);</span>
        <span class="n">Vh</span> <span class="n">sqrtPsi</span><span class="p">,</span> <span class="n">alpha</span><span class="p">;</span>
        <span class="p">{</span>
            <span class="n">Vh</span> <span class="n">dxrho2</span> <span class="o">=</span> <span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">),</span> <span class="n">dyrho2</span> <span class="o">=</span> <span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
            <span class="n">sqrtPsi</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">rho2</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">dxrho2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">dyrho2</span><span class="o">*</span><span class="n">sin2</span><span class="p">);</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dxrho2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dyrho2</span><span class="o">*</span><span class="n">sin2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">varf</span> <span class="n">dArea</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
                <span class="mf">1.</span><span class="o">/</span><span class="n">sqrtPsi</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">v</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">sin2</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="p">;</span>

        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">dArea</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">grad</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">matrix</span> <span class="n">hessianA</span><span class="p">;</span>
    <span class="kt">func</span> <span class="kt">matrix</span> <span class="nf">HessianArea</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rho</span><span class="p">,</span> <span class="n">rho2</span><span class="p">;</span>
        <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span>
        <span class="n">rho2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
        <span class="n">Vh</span> <span class="n">sqrtPsi</span><span class="p">,</span> <span class="n">sqrtPsi3</span><span class="p">,</span> <span class="n">C00</span><span class="p">,</span> <span class="n">C01</span><span class="p">,</span> <span class="n">C02</span><span class="p">,</span> <span class="n">C11</span><span class="p">,</span> <span class="n">C12</span><span class="p">,</span> <span class="n">C22</span><span class="p">,</span> <span class="kp">A</span><span class="p">;</span>
        <span class="p">{</span>
            <span class="n">Vh</span> <span class="n">C0</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span><span class="p">;</span>
            <span class="n">Vh</span> <span class="n">dxrho2</span> <span class="o">=</span> <span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">),</span> <span class="n">dyrho2</span> <span class="o">=</span> <span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
            <span class="n">sqrtPsi</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span> <span class="n">rho2</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">dxrho2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">dyrho2</span><span class="o">*</span><span class="n">sin2</span><span class="p">);</span>
            <span class="n">sqrtPsi3</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho2</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">dxrho2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">dyrho2</span><span class="o">*</span><span class="n">sin2</span><span class="p">)</span><span class="o">*</span><span class="n">sqrtPsi</span><span class="p">;</span>
            <span class="n">C0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dxrho2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dyrho2</span><span class="o">*</span><span class="n">sin2</span><span class="p">;</span>
            <span class="n">C1</span> <span class="o">=</span> <span class="n">rho2</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
            <span class="n">C2</span> <span class="o">=</span> <span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
            <span class="n">C00</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">C0</span><span class="p">);</span>
            <span class="n">C01</span> <span class="o">=</span> <span class="n">C0</span><span class="o">*</span><span class="n">C1</span><span class="p">;</span>
            <span class="n">C02</span> <span class="o">=</span> <span class="n">C0</span><span class="o">*</span><span class="n">C2</span><span class="p">;</span>
            <span class="n">C11</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">C1</span><span class="p">);</span>
            <span class="n">C12</span> <span class="o">=</span> <span class="n">C1</span><span class="o">*</span><span class="n">C2</span><span class="p">;</span>
            <span class="n">C22</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">C2</span><span class="p">);</span>
            <span class="kp">A</span> <span class="o">=</span> <span class="mf">6.</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">dxrho2</span> <span class="o">+</span> <span class="n">dyrho2</span><span class="o">*</span><span class="n">sin2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">varf</span> <span class="n">d2Area</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="o">=</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
                <span class="mf">1.</span><span class="o">/</span><span class="n">sqrtPsi</span> <span class="o">*</span> <span class="p">(</span>
                      <span class="kp">A</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">v</span>
                    <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>
                    <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">sin2</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>
                    <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">sin2</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="n">sqrtPsi3</span> <span class="o">*</span> <span class="p">(</span>
                      <span class="n">C00</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">v</span>
                    <span class="o">+</span> <span class="n">C01</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>
                    <span class="o">+</span> <span class="n">C01</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">C02</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>
                    <span class="o">+</span> <span class="n">C02</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">C11</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">C12</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">C12</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">C22</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="p">;</span>
        <span class="n">hessianA</span> <span class="o">=</span> <span class="n">d2Area</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">hessianA</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Volume computation</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">Volume</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rho</span><span class="p">;</span>
        <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span>
        <span class="n">Vh</span> <span class="n">rho3</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">rho</span><span class="p">;</span>
        <span class="kt">real</span> <span class="n">res</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">rho3</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">GradVolume</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rho</span><span class="p">;</span>
        <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span>
        <span class="kt">varf</span> <span class="nf">dVolume</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">rho</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="n">v</span><span class="p">);</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">dVolume</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">grad</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">matrix</span> <span class="n">hessianV</span><span class="p">;</span>
    <span class="kt">func</span> <span class="kt">matrix</span> <span class="nf">HessianVolume</span><span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rho</span><span class="p">;</span>
        <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span>
        <span class="kt">varf</span> <span class="n">d2Volume</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
        <span class="n">hessianV</span> <span class="o">=</span> <span class="n">d2Volume</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">hessianV</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//if we want to use the volume as a constraint function</span>
    <span class="c1">//we must wrap it in some freefem functions returning the appropriate type</span>
    <span class="c1">//The lagrangian hessian also have to be wrapped since the Volume is not linear with</span>
    <span class="c1">//respect to rho, it will constribbute to the hessian.</span>
    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">ipVolume</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">vol</span> <span class="o">=</span> <span class="p">[</span><span class="n">Volume</span><span class="p">(</span><span class="n">X</span><span class="p">)];</span> <span class="k">return</span> <span class="n">vol</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">matrix</span> <span class="n">mdV</span><span class="p">;</span>
    <span class="kt">func</span> <span class="kt">matrix</span> <span class="nf">ipGradVolume</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">)</span> <span class="p">{</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">,</span><span class="kt">int</span><span class="p">]</span> <span class="n">dvol</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">);</span> <span class="n">dvol</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">:</span><span class="p">)</span> <span class="o">=</span> <span class="n">GradVolume</span><span class="p">(</span><span class="n">X</span><span class="p">);</span> <span class="n">mdV</span> <span class="o">=</span> <span class="n">dvol</span><span class="p">;</span> <span class="k">return</span> <span class="n">mdV</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">matrix</span> <span class="n">HLagrangian</span><span class="p">;</span>
    <span class="kt">func</span> <span class="kt">matrix</span> <span class="nf">ipHessianLag</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">,</span> <span class="kt">real</span> <span class="n">objfact</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">lambda</span><span class="p">){</span>
        <span class="n">HLagrangian</span> <span class="o">=</span> <span class="n">objfact</span><span class="o">*</span><span class="n">HessianArea</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">lambda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">HessianVolume</span><span class="p">(</span><span class="n">X</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HLagrangian</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//building struct for GradVolume</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">gvi</span><span class="p">(</span><span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">),</span> <span class="n">gvj</span><span class="o">=</span><span class="mi">0</span><span class="o">:</span><span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">gvi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">Vh</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">startshape</span><span class="p">;</span> <span class="c1">//the starting value</span>
    <span class="n">Vh</span> <span class="n">ub</span> <span class="o">=</span> <span class="mf">1.e19</span><span class="p">;</span> <span class="c1">//bounds definition</span>
    <span class="n">Vh</span> <span class="n">lb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">Gaussian</span> <span class="p">(</span><span class="kt">real</span> <span class="n">X</span><span class="p">,</span> <span class="kt">real</span> <span class="n">Y</span><span class="p">,</span> <span class="kt">real</span> <span class="n">theta</span><span class="p">,</span> <span class="kt">real</span> <span class="n">phi</span><span class="p">){</span>
        <span class="kt">real</span> <span class="n">deltax2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">((</span><span class="n">X</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="n">Y</span><span class="p">)),</span> <span class="n">deltay2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">Y</span><span class="o">-</span><span class="n">phi</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">deltax2</span> <span class="o">+</span> <span class="n">deltay2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="kp">sigma</span><span class="o">*</span><span class="kp">sigma</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="n">disc1</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">RR</span><span class="o">+</span><span class="p">(</span><span class="n">E</span><span class="o">-</span><span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="mi">7</span><span class="o">*</span><span class="kr">x</span><span class="p">));</span>
    <span class="kt">func</span> <span class="n">disc2</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">RR</span><span class="o">+</span><span class="p">(</span><span class="n">E</span><span class="o">-</span><span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="n">sin2</span><span class="p">));</span>

    <span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">r0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">q</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">q</span><span class="p">){</span>
            <span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="n">rr</span><span class="o">*</span><span class="n">Gaussian</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="kr">pi</span><span class="o">/</span><span class="mf">5.</span><span class="p">,</span> <span class="kr">pi</span><span class="o">/</span><span class="mf">3.</span><span class="p">);</span>
            <span class="kt">func</span> <span class="n">g</span> <span class="o">=</span> <span class="n">rr</span><span class="o">*</span><span class="n">Gaussian</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="kr">pi</span><span class="o">/</span><span class="mf">5.</span><span class="o">+</span><span class="kr">pi</span><span class="o">/</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">2.</span><span class="o">*</span><span class="kr">pi</span><span class="o">/</span><span class="mf">3.</span><span class="p">);</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="kr">max</span><span class="p">(</span><span class="kr">max</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">g</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="kr">max</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">rr</span><span class="o">*</span><span class="n">Gaussian</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">,</span> <span class="kr">pi</span><span class="o">/</span><span class="mi">3</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">lb</span> <span class="o">=</span> <span class="kr">max</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="kr">max</span><span class="p">(</span><span class="n">disc1</span><span class="p">,</span> <span class="n">disc2</span><span class="p">));</span>
    <span class="kt">real</span> <span class="n">Vobj</span> <span class="o">=</span> <span class="n">Volume</span><span class="p">(</span><span class="n">lb</span><span class="p">[]);</span>
    <span class="kt">real</span> <span class="n">Vnvc</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="kr">pi</span><span class="o">*</span><span class="nf">pow</span><span class="p">(</span><span class="n">lb</span><span class="p">[].</span><span class="kr">linfty</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Plot3D</span><span class="p">(</span><span class="n">lb</span><span class="p">[],</span> <span class="s">&quot;object_inside&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">clb</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">cub</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">Vobj</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="n">Vnvc</span><span class="p">];</span>

    <span class="c1">// Call IPOPT</span>
    <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">IPOPT</span><span class="p">(</span><span class="n">Area</span><span class="p">,</span> <span class="n">GradArea</span><span class="p">,</span> <span class="n">ipHessianLag</span><span class="p">,</span> <span class="n">ipVolume</span><span class="p">,</span> <span class="n">ipGradVolume</span><span class="p">,</span>
            <span class="n">rc</span><span class="p">[],</span> <span class="n">ub</span><span class="o">=</span><span class="n">ub</span><span class="p">[],</span> <span class="n">lb</span><span class="o">=</span><span class="n">lb</span><span class="p">[],</span> <span class="n">clb</span><span class="o">=</span><span class="n">clb</span><span class="p">,</span> <span class="n">cub</span><span class="o">=</span><span class="n">cub</span><span class="p">,</span> <span class="n">checkindex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">kkk</span><span class="o">&lt;</span><span class="n">nadapt</span><span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="mi">40</span><span class="o">:</span><span class="mi">150</span><span class="p">,</span>
            <span class="n">warmstart</span><span class="o">=</span><span class="n">kkk</span><span class="p">,</span> <span class="n">lm</span><span class="o">=</span><span class="n">lm</span><span class="p">,</span> <span class="n">uz</span><span class="o">=</span><span class="n">uz</span><span class="p">[],</span> <span class="n">lz</span><span class="o">=</span><span class="n">lz</span><span class="p">[],</span> <span class="kp">tol</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span> <span class="n">structjacc</span><span class="o">=</span><span class="p">[</span><span class="n">gvi</span><span class="p">,</span><span class="n">gvj</span><span class="p">]);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;IPOPT: res =&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">res</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span> <span class="p">;</span>

    <span class="c1">// Plot</span>
    <span class="n">Plot3D</span><span class="p">(</span><span class="n">rc</span><span class="p">[],</span> <span class="s">&quot;Shape_at_&quot;</span><span class="o">+</span><span class="n">kkk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">Plot3D</span><span class="p">(</span><span class="n">GradArea</span><span class="p">(</span><span class="n">rc</span><span class="p">[]),</span> <span class="s">&quot;ShapeGradient&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Mesh adaptation</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kkk</span> <span class="o">&lt;</span> <span class="n">nadapt</span><span class="o">-</span><span class="mi">1</span><span class="p">){</span>
        <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">rc</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">),</span> <span class="n">rc</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">),</span> <span class="n">rc</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">),</span>
            <span class="kp">nbvx</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kr">y</span><span class="p">]]);</span>
        <span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
        <span class="n">startshape</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
        <span class="n">uz</span> <span class="o">=</span> <span class="n">uz</span><span class="p">;</span>
        <span class="n">lz</span> <span class="o">=</span> <span class="n">lz</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">regtest</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[]</span><span class="o">&#39;*</span><span class="n">rc</span><span class="p">[];</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id37">
<img alt="../_images/IPOPTMinimalSurfaceVolume.png" src="../_images/IPOPTMinimalSurfaceVolume.png" />
<p class="caption"><span class="caption-number">Fig. 169 </span><span class="caption-text">Mesh</span></p>
</div>
</div>
<div class="section" id="cmaes-mpi-variational-inequality">
<span id="examplecmaesmpivariationalinequality"></span><h3>CMAES MPI variational inequality<a class="headerlink" href="#cmaes-mpi-variational-inequality" title="Permalink to this headline">¶</a></h3>
<p>Command:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>ff-mpirun -np <span class="m">4</span> CMAESMPIVariationalInequality.edp -glut ffglut
</pre></div>
</td></tr></table></div>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;mpi-cmaes&quot;</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">NN</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f1</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">g1</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">g2</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">nadapt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">starttol</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">bctol</span> <span class="o">=</span> <span class="mf">6.e-12</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">pena</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span> <span class="n">NN</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">ou1</span><span class="p">,</span> <span class="n">ou2</span><span class="p">;</span>

<span class="c1">// Mehs adaptation loop</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">al</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">al</span> <span class="o">&lt;</span> <span class="n">nadapt</span><span class="p">;</span> <span class="o">++</span><span class="n">al</span><span class="p">){</span>
    <span class="c1">// Problem</span>
    <span class="kt">varf</span> <span class="n">BVF</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
              <span class="mf">0.5</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="p">;</span>
    <span class="kt">varf</span> <span class="nf">LVF1</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f1</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
    <span class="kt">varf</span> <span class="nf">LVF2</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f2</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
    <span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span> <span class="n">BVF</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">LVF1</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">LVF2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>

    <span class="kt">varf</span> <span class="nf">Vbord</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">Vh</span> <span class="n">In</span><span class="p">,</span> <span class="n">Bord</span><span class="p">;</span>
    <span class="n">Bord</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Vbord</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">tgv</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">In</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Bord</span><span class="p">[]</span> <span class="o">?</span> <span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">Vh</span> <span class="n">gh1</span> <span class="o">=</span> <span class="n">Bord</span><span class="o">*</span><span class="n">g1</span><span class="p">,</span> <span class="n">gh2</span> <span class="o">=</span> <span class="n">Bord</span><span class="o">*</span><span class="n">g2</span><span class="p">;</span>

    <span class="c1">//Function which create a vector of the search space type from</span>
    <span class="c1">//two finite element functions</span>
    <span class="kt">func</span> <span class="kt">int</span> <span class="nf">FEFToSSP</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef1</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef2</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">kX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">In</span><span class="p">[][</span><span class="n">i</span><span class="p">]){</span>
                <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="p">]</span> <span class="o">=</span> <span class="n">fef1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="o">+</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">]</span> <span class="o">=</span> <span class="n">fef2</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="o">++</span><span class="n">kX</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//Function spliting a vector from the search space and fills</span>
    <span class="c1">//two finite element functions with it</span>
    <span class="kt">func</span> <span class="kt">int</span> <span class="nf">SSPToFEF</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef1</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef2</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">kX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">In</span><span class="p">[][</span><span class="n">i</span><span class="p">]){</span>
                <span class="n">fef1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="p">];</span>
                <span class="n">fef2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="o">+</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">];</span>
                <span class="o">++</span><span class="n">kX</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span><span class="p">{</span>
                <span class="n">fef1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gh1</span><span class="p">[][</span><span class="n">i</span><span class="p">];</span>
                <span class="n">fef2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gh2</span><span class="p">[][</span><span class="n">i</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">IneqC</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">constraints</span><span class="p">(</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">];</span>
            <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mf">0.</span> <span class="o">:</span> <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">constraints</span><span class="p">.</span><span class="kr">l2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">J</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">;</span>
        <span class="n">SSPToFEF</span><span class="p">(</span><span class="n">u1</span><span class="p">[],</span> <span class="n">u2</span><span class="p">[],</span> <span class="n">X</span><span class="p">);</span>
        <span class="n">iter</span><span class="o">++</span><span class="p">;</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Au1</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">u1</span><span class="p">[],</span> <span class="n">Au2</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">u2</span><span class="p">[];</span>
        <span class="n">Au1</span> <span class="o">-=</span> <span class="n">b1</span><span class="p">;</span>
        <span class="n">Au2</span> <span class="o">-=</span> <span class="n">b2</span><span class="p">;</span>
        <span class="kt">real</span> <span class="n">val</span> <span class="o">=</span> <span class="n">u1</span><span class="p">[]</span><span class="o">&#39;*</span><span class="n">Au1</span> <span class="o">+</span> <span class="n">u2</span><span class="p">[]</span><span class="o">&#39;*</span><span class="n">Au2</span><span class="p">;</span>
        <span class="n">val</span> <span class="o">+=</span>  <span class="n">pena</span> <span class="o">*</span> <span class="n">IneqC</span><span class="p">(</span><span class="n">X</span><span class="p">);</span>
        <span class="nf">plot</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="kp">nbiso</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;adapt level &quot;</span><span class="o">+</span><span class="n">al</span><span class="o">+</span><span class="s">&quot; - iteration &quot;</span><span class="o">+</span><span class="n">iter</span><span class="o">+</span><span class="s">&quot; - J = &quot;</span><span class="o">+</span><span class="n">val</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">val</span> <span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Solve</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">start</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">al</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
        <span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
        <span class="n">start</span><span class="p">(</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="o">:</span><span class="mi">2</span><span class="o">*</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">FEFToSSP</span><span class="p">(</span><span class="n">ou1</span><span class="p">[],</span> <span class="n">ou2</span><span class="p">[],</span> <span class="n">start</span><span class="p">);</span>

    <span class="kt">real</span> <span class="n">mini</span> <span class="o">=</span> <span class="n">cmaesMPI</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stopMaxFunEval</span><span class="o">=</span><span class="mi">10000</span><span class="o">*</span><span class="p">(</span><span class="n">al</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">stopTolX</span><span class="o">=</span><span class="mf">1.e-4</span><span class="o">/</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="n">al</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="n">initialStdDev</span><span class="o">=</span><span class="p">(</span><span class="mf">0.025</span><span class="o">/</span><span class="p">(</span><span class="nf">pow</span><span class="p">(</span><span class="mf">100.</span><span class="p">,</span><span class="n">al</span><span class="p">))));</span>
    <span class="n">Vh</span> <span class="n">best1</span><span class="p">,</span> <span class="n">best2</span><span class="p">;</span>
    <span class="n">SSPToFEF</span><span class="p">(</span><span class="n">best1</span><span class="p">[],</span> <span class="n">best2</span><span class="p">[],</span> <span class="n">start</span><span class="p">);</span>

    <span class="c1">// Mesh adaptation</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">best1</span><span class="p">,</span> <span class="n">best2</span><span class="p">);</span>
    <span class="n">ou1</span> <span class="o">=</span> <span class="n">best1</span><span class="p">;</span>
    <span class="n">ou2</span> <span class="o">=</span> <span class="n">best2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id38">
<img alt="../_images/CMAESMPIVariationalInequality.png" src="../_images/CMAESMPIVariationalInequality.png" />
<p class="caption"><span class="caption-number">Fig. 170 </span><span class="caption-text">Result</span></p>
</div>
</div>
</div>
<div class="section" id="parallelization">
<span id="exampleparallelization"></span><h2>Parallelization<a class="headerlink" href="#parallelization" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mpi-gmres-2d">
<span id="examplempigmres2d"></span><h3>MPI-GMRES 2D<a class="headerlink" href="#mpi-gmres-2d" title="Permalink to this headline">¶</a></h3>
<p>To launch this script, use for example:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>ff-mpirun -np <span class="m">12</span> MPIGMRES2D.edp -d <span class="m">1</span> -k <span class="m">1</span> -gmres <span class="m">2</span> -n <span class="m">50</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//usage :</span>
<span class="c1">//ff-mpirun [mpi parameter] MPIGMRES2d.edp [-glut ffglut] [-n N] [-k K] [-d D] [-ns] [-gmres [0|1]</span>
<span class="c1">//arguments:</span>
<span class="c1">//-glut ffglut : to see graphicaly the process</span>
<span class="c1">//-n N: set the mesh cube split NxNxN</span>
<span class="c1">//-d D: set debug flag D must be one for mpiplot</span>
<span class="c1">//-k K: to refined by K all element</span>
<span class="c1">//-ns: remove script dump</span>
<span class="c1">//-gmres</span>
<span class="c1">//0: use iterative schwarz algo.</span>
<span class="c1">//1: Algo GMRES on residu of schwarz algo</span>
<span class="c1">//2: DDM GMRES</span>
<span class="c1">//3: DDM GMRES with coarse grid preconditionner (Good one)</span>

<span class="cp">load</span> <span class="s">&quot;MPICG&quot;</span>
<span class="cp">load</span> <span class="s">&quot;</span><span class="nf">medit</span><span class="s">&quot;</span>
<span class="cp">load</span> <span class="s">&quot;metis&quot;</span>
<span class="cp">include</span> <span class="s">&quot;getARGV.idp&quot;</span>
<span class="cp">include</span> <span class="s">&quot;MPIplot.idp&quot;</span>
<span class="cp">include</span> <span class="s">&quot;MPIGMRESmacro.idp&quot;</span>

<span class="kr">searchMethod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//more safe seach algo (warning can be very expensive in case of lot of ouside point)</span>
<span class="nf">assert</span><span class="p">(</span><span class="kr">version</span> <span class="o">&gt;=</span> <span class="mf">3.11</span><span class="p">);</span> <span class="c1">//need at least v3.11</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">ttt</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">ittt</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="kt">macro</span> <span class="n">settt</span> <span class="p">{</span><span class="n">ttt</span><span class="p">[</span><span class="n">ittt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nf">mpiWtime</span><span class="p">();}</span><span class="c1">//</span>

<span class="c1">// Arguments</span>
<span class="kr">verbosity</span> <span class="o">=</span> <span class="nf">getARGV</span><span class="p">(</span><span class="s">&quot;-vv&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">vdebug</span> <span class="o">=</span> <span class="nf">getARGV</span><span class="p">(</span><span class="s">&quot;-d&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">ksplit</span> <span class="o">=</span> <span class="nf">getARGV</span><span class="p">(</span><span class="s">&quot;-k&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">nloc</span> <span class="o">=</span> <span class="nf">getARGV</span><span class="p">(</span><span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="kt">string</span> <span class="n">sff</span> <span class="o">=</span> <span class="nf">getARGV</span><span class="p">(</span><span class="s">&quot;-p&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">gmres</span> <span class="o">=</span> <span class="nf">getARGV</span><span class="p">(</span><span class="s">&quot;-gmres&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="kt">bool</span> <span class="n">dplot</span> <span class="o">=</span> <span class="nf">getARGV</span><span class="p">(</span><span class="s">&quot;-dp&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">nC</span> <span class="o">=</span> <span class="nf">getARGV</span><span class="p">(</span><span class="s">&quot;-N&quot;</span><span class="p">,</span> <span class="kr">max</span><span class="p">(</span><span class="n">nloc</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>

<span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="kr">verbosity</span><span class="p">){</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ARGV: &quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kr">ARGV</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kr">ARGV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="kr">mpirank</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="kr">verbosity</span><span class="p">)</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; vdebug: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">vdebug</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, kspilt &quot;</span><span class="o">&lt;&lt;</span> <span class="n">ksplit</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, nloc &quot;</span><span class="o">&lt;&lt;</span> <span class="n">nloc</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, sff &quot;</span><span class="o">&lt;&lt;</span> <span class="n">sff</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">withplot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">withmetis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">RAS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">string</span> <span class="n">sPk</span> <span class="o">=</span> <span class="s">&quot;P2-2gd&quot;</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">Pk</span> <span class="o">=</span> <span class="nc">P2</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">sizeoverlaps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//size of overlap</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">l111</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span> <span class="c1">//mesh labels</span>

<span class="c1">// MPI function</span>
<span class="kt">func</span> <span class="kt">bool</span> <span class="nf">plotMPIall</span><span class="p">(</span><span class="kt">mesh</span> <span class="o">&amp;</span><span class="n">Th</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">,</span> <span class="kt">string</span> <span class="n">cm</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">vdebug</span><span class="p">)</span>
        <span class="n">PLOTMPIALL</span><span class="p">(</span><span class="kt">mesh</span><span class="p">,</span> <span class="n">Pk</span><span class="p">,</span> <span class="n">Th</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="p">{</span><span class="kp">cmm</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span> <span class="kp">nbiso</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="mi">1</span><span class="p">});</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// MPI</span>
<span class="kt">mpiComm</span> <span class="nf">comm</span><span class="p">(</span><span class="kr">mpiCommWorld</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="c1">//trick : make a no split mpiWorld</span>

<span class="kt">int</span> <span class="n">npart</span> <span class="o">=</span> <span class="nf">mpiSize</span><span class="p">(</span><span class="n">comm</span><span class="p">);</span> <span class="c1">//total number of partion</span>
<span class="kt">int</span> <span class="n">ipart</span> <span class="o">=</span> <span class="nf">mpiRank</span><span class="p">(</span><span class="n">comm</span><span class="p">);</span> <span class="c1">//current partition number</span>

<span class="kt">int</span> <span class="n">njpart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//Number of part with intersection (a jpart) with ipart without ipart</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">jpart</span><span class="p">(</span><span class="n">npart</span><span class="p">);</span> <span class="c1">//list of jpart</span>
<span class="k">if</span><span class="p">(</span><span class="n">ipart</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; Final N = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ksplit</span><span class="o">*</span><span class="n">nloc</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, nloc = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nloc</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, split = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ksplit</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="n">settt</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Thg</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">nloc</span><span class="p">,</span> <span class="n">nloc</span><span class="p">,</span> <span class="kr">label</span><span class="o">=</span><span class="n">l111</span><span class="p">);</span>
<span class="kt">mesh</span> <span class="n">ThC</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">nC</span><span class="p">,</span> <span class="n">nC</span><span class="p">,</span> <span class="kr">label</span><span class="o">=</span><span class="n">l111</span><span class="p">);</span><span class="c1">// Coarse mesh</span>

<span class="kt">mesh</span> <span class="n">Thi</span><span class="p">,</span> <span class="n">Thin</span><span class="p">;</span> <span class="c1">//with overlap, without olverlap</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Phg</span><span class="p">(</span><span class="n">Thg</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>
<span class="n">Phg</span> <span class="n">part</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Vhg</span><span class="p">(</span><span class="n">Thg</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vhg</span> <span class="n">unssd</span><span class="p">;</span> <span class="c1">//boolean function: 1 in the subdomain, 0 elswhere</span>

<span class="kt">fespace</span> <span class="nf">VhC</span><span class="p">(</span><span class="n">ThC</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span> <span class="c1">// of the coarse problem</span>

<span class="c1">// Partitioning</span>
<span class="p">{</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">nupart</span><span class="p">(</span><span class="n">Thg</span><span class="p">.</span><span class="kr">nt</span><span class="p">);</span>
    <span class="n">nupart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">npart</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ipart</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">metisdual</span><span class="p">(</span><span class="n">nupart</span><span class="p">,</span> <span class="n">Thg</span><span class="p">,</span> <span class="n">npart</span><span class="p">);</span>

    <span class="nf">broadcast</span><span class="p">(</span><span class="nf">processor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">comm</span><span class="p">),</span> <span class="n">nupart</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nupart</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">part</span><span class="p">[][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nupart</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">withplot</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;dual&quot;</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">// Overlapping partition</span>
<span class="n">Phg</span> <span class="n">suppi</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">part</span><span class="o">-</span><span class="n">ipart</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">;</span>

<span class="n">Thin</span> <span class="o">=</span> <span class="nf">trunc</span><span class="p">(</span><span class="n">Thg</span><span class="p">,</span> <span class="n">suppi</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="kr">label</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span> <span class="c1">// non-overlapping mesh, interfaces have label 10</span>
<span class="kt">int</span> <span class="n">nnn</span> <span class="o">=</span> <span class="n">sizeoverlaps</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="c1">// to be sure</span>
<span class="n">AddLayers</span><span class="p">(</span><span class="n">Thg</span><span class="p">,</span> <span class="n">suppi</span><span class="p">[],</span> <span class="n">nnn</span><span class="p">,</span> <span class="n">unssd</span><span class="p">[]);</span> <span class="c1">//see above! suppi and unssd are modified</span>
<span class="n">unssd</span><span class="p">[]</span> <span class="o">*=</span> <span class="n">nnn</span><span class="p">;</span> <span class="c1">//to put value nnn a 0</span>
<span class="kt">real</span> <span class="n">nnn0</span> <span class="o">=</span> <span class="n">nnn</span> <span class="o">-</span> <span class="n">sizeoverlaps</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">;</span>
<span class="n">Thi</span> <span class="o">=</span> <span class="nf">trunc</span><span class="p">(</span><span class="n">Thg</span><span class="p">,</span> <span class="n">unssd</span><span class="o">&gt;</span><span class="n">nnn0</span><span class="p">,</span> <span class="kr">label</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span> <span class="c1">//overlapping mesh, interfaces have label 10</span>

<span class="n">settt</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="n">Vhi</span><span class="p">(</span><span class="n">Thi</span><span class="p">,</span><span class="nc">P1</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">npij</span> <span class="o">=</span> <span class="n">npart</span><span class="p">;</span>
<span class="n">Vhi</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">pij</span><span class="p">(</span><span class="n">npij</span><span class="p">);</span> <span class="c1">//local partition of unit + pii</span>
<span class="n">Vhi</span> <span class="n">pii</span><span class="p">;</span>

<span class="kt">real</span> <span class="n">nnn1</span> <span class="o">=</span> <span class="o">+</span><span class="mf">0.001</span><span class="p">;</span>
<span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">    construction of the partition of the unit,</span>
<span class="cm">    let phi_i P1 FE function 1 on Thin and zero ouside of Thi and positive</span>
<span class="cm">    the partition is build with</span>
<span class="cm">    p_i = phi_i/ \sum phi_i</span>

<span class="cm">    to build the partition of one domain i</span>
<span class="cm">    we nned to find all j such that supp(phi_j) \cap supp(phi_j) is not empty</span>
<span class="cm">    &lt;=&gt; int phi_j</span>
<span class="cm">    */</span>
    <span class="c1">//build a local mesh of thii such that all computation of the unit partition are</span>
    <span class="c1">//exact in thii</span>
    <span class="kt">mesh</span> <span class="n">Thii</span> <span class="o">=</span> <span class="nf">trunc</span><span class="p">(</span><span class="n">Thg</span><span class="p">,</span> <span class="n">unssd</span><span class="o">&gt;</span><span class="n">nnn1</span><span class="p">,</span> <span class="kr">label</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span> <span class="c1">//overlapping mesh, interfaces have label 10</span>

    <span class="p">{</span>
        <span class="c1">//find all j mes (supp(p_j) cap supp(p_i)) &gt;0</span>
        <span class="c1">//compute all phi_j on Thii</span>
        <span class="c1">//remark: supp p_i include in Thi</span>

        <span class="c1">// Fespace</span>
        <span class="kt">fespace</span> <span class="n">Phii</span><span class="p">(</span><span class="n">Thii</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>
        <span class="kt">fespace</span> <span class="nf">Vhii</span><span class="p">(</span><span class="n">Thii</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
        <span class="n">Vhi</span> <span class="n">sumphi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">Vhii</span> <span class="n">phii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">jpart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">njpart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">nlayer</span> <span class="o">=</span> <span class="n">RAS</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">sizeoverlaps</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ipart</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;nlayer = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nlayer</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="n">pii</span> <span class="o">=</span> <span class="kr">max</span><span class="p">(</span><span class="n">unssd</span><span class="o">-</span><span class="n">nnn</span><span class="o">+</span><span class="n">nlayer</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span><span class="o">/</span><span class="n">nlayer</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">dplot</span><span class="p">)</span>
            <span class="nf">plot</span><span class="p">(</span><span class="n">pii</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot; 0000&quot;</span><span class="p">);</span>
        <span class="n">sumphi</span><span class="p">[]</span> <span class="o">+=</span> <span class="n">pii</span><span class="p">[];</span>
        <span class="k">if</span><span class="p">(</span><span class="n">dplot</span><span class="p">)</span>
            <span class="nf">plot</span><span class="p">(</span><span class="n">sumphi</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot; summ 0000&quot;</span><span class="p">);</span>

        <span class="kt">real</span> <span class="n">epsmes</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="o">*</span><span class="n">Thii</span><span class="p">.</span><span class="kr">area</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npart</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">ipart</span><span class="p">){</span>
            <span class="n">Phii</span> <span class="n">suppii</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">part</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">suppii</span><span class="p">[].</span><span class="kr">max</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">){</span>
                <span class="n">AddLayers</span><span class="p">(</span><span class="n">Thii</span><span class="p">,</span> <span class="n">suppii</span><span class="p">[],</span> <span class="n">nlayer</span><span class="p">,</span> <span class="n">phii</span><span class="p">[]);</span>
                <span class="nf">assert</span><span class="p">(</span><span class="n">phii</span><span class="p">[].</span><span class="kr">min</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
                <span class="kt">real</span> <span class="n">interij</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Thi</span><span class="p">)(</span><span class="n">phii</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">interij</span> <span class="o">&gt;</span> <span class="n">epsmes</span><span class="p">){</span>
                    <span class="n">pij</span><span class="p">[</span><span class="n">njpart</span><span class="p">]</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">phii</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">vdebug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ***** &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Thi</span><span class="p">)(</span><span class="kt">real</span><span class="p">(</span><span class="n">pij</span><span class="p">[</span><span class="n">njpart</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span><span class="n">pij</span><span class="p">[</span><span class="n">njpart</span><span class="p">][].</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">phii</span><span class="p">[].</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
                    <span class="nf">assert</span><span class="p">(</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Thi</span><span class="p">)(</span><span class="kt">real</span><span class="p">(</span><span class="n">pij</span><span class="p">[</span><span class="n">njpart</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">dplot</span><span class="p">)</span>
                        <span class="nf">plot</span><span class="p">(</span><span class="n">pij</span><span class="p">[</span><span class="n">njpart</span><span class="p">],</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot; j = &quot;</span><span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">njpart</span><span class="p">);</span>
                    <span class="n">sumphi</span><span class="p">[]</span> <span class="o">+=</span> <span class="n">pij</span><span class="p">[</span><span class="n">njpart</span><span class="p">][];</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">dplot</span><span class="p">)</span>
                        <span class="nf">plot</span><span class="p">(</span><span class="n">sumphi</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot; sum j = &quot;</span><span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">njpart</span><span class="p">);</span>
                    <span class="n">jpart</span><span class="p">[</span><span class="n">njpart</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">dplot</span><span class="p">)</span>
            <span class="nf">plot</span><span class="p">(</span><span class="n">sumphi</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;sum &quot;</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">pii</span><span class="p">[]</span> <span class="o">=</span> <span class="n">pii</span><span class="p">[]</span> <span class="p">.</span><span class="o">/</span> <span class="n">sumphi</span><span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">njpart</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="n">pij</span><span class="p">[</span><span class="n">j</span><span class="p">][]</span> <span class="o">=</span> <span class="n">pij</span><span class="p">[</span><span class="n">j</span><span class="p">][]</span> <span class="p">.</span><span class="o">/</span> <span class="n">sumphi</span><span class="p">[];</span>
        <span class="n">jpart</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">njpart</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">njpart</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="nf">assert</span><span class="p">(</span><span class="n">pij</span><span class="p">[</span><span class="n">j</span><span class="p">][].</span><span class="kr">max</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">{</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ipart</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; number of jpart &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">njpart</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">njpart</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
                <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">jpart</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">sumphi</span><span class="p">[]</span> <span class="o">=</span> <span class="n">pii</span><span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">njpart</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="n">sumphi</span><span class="p">[]</span> <span class="o">+=</span> <span class="n">pij</span><span class="p">[</span><span class="n">j</span><span class="p">][];</span>
        <span class="k">if</span><span class="p">(</span><span class="n">vdebug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sum min &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sumphi</span><span class="p">[].</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sumphi</span><span class="p">[].</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="nf">assert</span><span class="p">(</span><span class="n">sumphi</span><span class="p">[].</span><span class="kr">min</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="o">-</span><span class="mf">1e-6</span> <span class="o">&amp;&amp;</span> <span class="n">sumphi</span><span class="p">[].</span><span class="kr">max</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="o">+</span><span class="mf">1e-6</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="c1">//Thii is remove here</span>
<span class="c1">// end of the construction of the local partition of the unity ...</span>
<span class="c1">// on Thi</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ipart</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;End build partition&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Computation of number of intersection</span>
<span class="c1">//here pii and the pij is the local partition of the unit on</span>
<span class="c1">//Thi (mesh with overlap)</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">dplot</span><span class="p">){</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">Thi</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">njpart</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="nf">plot</span><span class="p">(</span><span class="n">pij</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot; j=&quot;</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//Partition of the unity on Thi</span>
<span class="c1">//computation of message</span>
<span class="c1">//all j &gt; we have to receive</span>
<span class="c1">//data on intersection of the support of pij[0] and pij[j]</span>
<span class="n">settt</span>

<span class="k">if</span><span class="p">(</span><span class="n">vdebug</span><span class="p">)</span>
    <span class="n">plotMPIall</span><span class="p">(</span><span class="n">Thi</span><span class="p">,</span> <span class="n">pii</span><span class="p">[],</span> <span class="s">&quot;pi_i&quot;</span><span class="p">);</span>

<span class="kt">mesh</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">aThij</span><span class="p">(</span><span class="n">njpart</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="n">Pii</span><span class="p">;</span>
<span class="kt">matrix</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">sMj</span><span class="p">(</span><span class="n">njpart</span><span class="p">);</span> <span class="c1">//M of send to j</span>
<span class="kt">matrix</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">rMj</span><span class="p">(</span><span class="n">njpart</span><span class="p">);</span> <span class="c1">//M to recv from j</span>
<span class="kt">fespace</span> <span class="nf">Whi</span><span class="p">(</span><span class="n">Thi</span><span class="p">,</span> <span class="n">Pk</span><span class="p">);</span>
<span class="kt">mesh</span> <span class="n">Thij</span> <span class="o">=</span> <span class="n">Thi</span><span class="p">;</span>
<span class="kt">fespace</span> <span class="nf">Whij</span><span class="p">(</span><span class="n">Thij</span><span class="p">,</span> <span class="n">Pk</span><span class="p">);</span><span class="c1">//</span>

<span class="c1">//construction of the mesh intersect i,j part</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">jp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">jp</span> <span class="o">&lt;</span> <span class="n">njpart</span><span class="p">;</span> <span class="o">++</span><span class="n">jp</span><span class="p">)</span>
    <span class="n">aThij</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span> <span class="o">=</span> <span class="nf">trunc</span><span class="p">(</span><span class="n">Thi</span><span class="p">,</span> <span class="n">pij</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="kr">label</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span> <span class="c1">//mesh of the supp of pij</span>

<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">jp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">jp</span> <span class="o">&lt;</span> <span class="n">njpart</span><span class="p">;</span> <span class="o">++</span><span class="n">jp</span><span class="p">)</span>
    <span class="n">aThij</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span> <span class="o">=</span> <span class="nf">trunc</span><span class="p">(</span><span class="n">aThij</span><span class="p">[</span><span class="n">jp</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">split</span><span class="o">=</span><span class="n">ksplit</span><span class="p">);</span>

<span class="n">Thi</span> <span class="o">=</span> <span class="nf">trunc</span><span class="p">(</span><span class="n">Thi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">split</span><span class="o">=</span><span class="n">ksplit</span><span class="p">);</span>

<span class="n">settt</span>

<span class="nf">if</span> <span class="p">(</span><span class="n">ipart</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;End build mesh intersection&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Construction of transfert matrix</span>
<span class="p">{</span>
    <span class="n">Whi</span> <span class="n">wpii</span> <span class="o">=</span> <span class="n">pii</span><span class="p">;</span>
    <span class="n">Pii</span> <span class="o">=</span> <span class="n">wpii</span><span class="p">[];</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">jp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">jp</span> <span class="o">&lt;</span> <span class="n">njpart</span><span class="p">;</span> <span class="o">++</span><span class="n">jp</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">jpart</span><span class="p">[</span><span class="n">jp</span><span class="p">];</span>
        <span class="n">Thij</span> <span class="o">=</span> <span class="n">aThij</span><span class="p">[</span><span class="n">jp</span><span class="p">];</span>
        <span class="kt">matrix</span> <span class="n">I</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Whij</span><span class="p">,</span> <span class="n">Whi</span><span class="p">);</span> <span class="c1">//Whji &lt;- Whi</span>
        <span class="n">sMj</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="o">*</span><span class="n">Pii</span><span class="p">;</span> <span class="c1">//Whi -&gt; s Whij</span>
        <span class="n">rMj</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Whij</span><span class="p">,</span> <span class="n">Whi</span><span class="p">,</span> <span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//Whji -&gt; Whi</span>
        <span class="k">if</span><span class="p">(</span><span class="n">vdebug</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">){</span>
            <span class="p">{</span><span class="n">Whi</span> <span class="n">uuu</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">Whij</span> <span class="n">vvv</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span> <span class="n">vvv</span><span class="p">[]</span><span class="o">+=</span><span class="n">I</span><span class="o">*</span><span class="n">uuu</span><span class="p">[];</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">jp</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; %%% &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">vvv</span><span class="p">[].</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span> <span class="nf">assert</span><span class="p">(</span><span class="n">vvv</span><span class="p">[].</span><span class="kr">linfty</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">);}</span>
            <span class="p">{</span><span class="n">Whi</span> <span class="n">uuu</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">Whij</span> <span class="n">vvv</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span> <span class="n">vvv</span><span class="p">[]</span><span class="o">+=</span><span class="n">rMj</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span><span class="o">&#39;*</span><span class="n">uuu</span><span class="p">[];</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">jp</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ### &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">vvv</span><span class="p">[].</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span> <span class="nf">assert</span><span class="p">(</span><span class="n">vvv</span><span class="p">[].</span><span class="kr">linfty</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">);}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ipart</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;End build transfert matrix&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Allocate array of send and recv data</span>
<span class="n">InitU</span><span class="p">(</span><span class="n">njpart</span><span class="p">,</span> <span class="n">Whij</span><span class="p">,</span> <span class="n">Thij</span><span class="p">,</span> <span class="n">aThij</span><span class="p">,</span> <span class="n">Usend</span><span class="p">)</span> <span class="c1">//initU(n, Vh, Th, aTh, U)</span>
<span class="n">InitU</span><span class="p">(</span><span class="n">njpart</span><span class="p">,</span> <span class="n">Whij</span><span class="p">,</span> <span class="n">Thij</span><span class="p">,</span> <span class="n">aThij</span><span class="p">,</span> <span class="n">Vrecv</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ipart</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;End init data for send/revc&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="n">Whi</span> <span class="n">ui</span><span class="p">,</span> <span class="n">vi</span><span class="p">;</span>

<span class="kt">func</span> <span class="kt">bool</span> <span class="nf">Update</span><span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">ui</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">vi</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">njpart</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="n">Usend</span><span class="p">[</span><span class="n">j</span><span class="p">][]</span> <span class="o">=</span> <span class="n">sMj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">ui</span><span class="p">;</span>
    <span class="n">SendRecvUV</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">jpart</span><span class="p">,</span> <span class="n">Usend</span><span class="p">,</span> <span class="n">Vrecv</span><span class="p">)</span>
    <span class="n">vi</span> <span class="o">=</span> <span class="n">Pii</span><span class="o">*</span><span class="n">ui</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">njpart</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="n">vi</span> <span class="o">+=</span> <span class="n">rMj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">Vrecv</span><span class="p">[</span><span class="n">j</span><span class="p">][];</span>
    <span class="k">return</span> <span class="kr">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Definition of the Problem</span>
<span class="kt">func</span> <span class="n">G</span> <span class="o">=</span> <span class="kr">x</span><span class="o">*</span><span class="mf">0.1</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">F</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">macro</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="c1">//</span>
<span class="kt">varf</span> <span class="n">vBC</span> <span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span> <span class="o">=</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="n">G</span><span class="p">);</span>
<span class="kt">varf</span> <span class="nf">vPb</span> <span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Thi</span><span class="p">)(</span><span class="n">grad</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">&#39;*</span><span class="n">grad</span><span class="p">(</span><span class="n">V</span><span class="p">))</span> <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Thi</span><span class="p">)(</span><span class="n">F</span><span class="o">*</span><span class="n">V</span><span class="p">)</span> <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="n">G</span><span class="p">);</span>
<span class="kt">varf</span> <span class="nf">vPbC</span> <span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">ThC</span><span class="p">)(</span><span class="n">grad</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">&#39;*</span><span class="n">grad</span><span class="p">(</span><span class="n">V</span><span class="p">))</span> <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="kt">varf</span> <span class="nf">vPbon</span> <span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span> <span class="o">=</span> <span class="nf">on</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
<span class="kt">varf</span> <span class="nf">vPbon10only</span> <span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span> <span class="o">=</span> <span class="nf">on</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="c1">//remark the order is important we want 0 part on 10 and 1</span>

<span class="kt">matrix</span> <span class="n">Ai</span> <span class="o">=</span> <span class="n">vPb</span><span class="p">(</span><span class="n">Whi</span><span class="p">,</span> <span class="n">Whi</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">sparsesolver</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="n">AC</span><span class="p">,</span> <span class="n">Rci</span><span class="p">,</span> <span class="n">Pci</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nf">mpiRank</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">AC</span> <span class="o">=</span> <span class="n">vPbC</span><span class="p">(</span><span class="n">VhC</span><span class="p">,</span> <span class="n">VhC</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">sparsesolver</span><span class="p">);</span>

<span class="n">Pci</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Whi</span><span class="p">,</span> <span class="n">VhC</span><span class="p">);</span>
<span class="n">Rci</span> <span class="o">=</span> <span class="n">Pci</span><span class="o">&#39;*</span><span class="n">Pii</span><span class="p">;</span>

<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">onG10</span> <span class="o">=</span> <span class="n">vPbon10only</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Whi</span><span class="p">);</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">onG</span> <span class="o">=</span> <span class="n">vPbon</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Whi</span><span class="p">);</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Bi</span><span class="o">=</span><span class="n">vPb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Whi</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">kiter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="kt">func</span> <span class="kt">bool</span> <span class="nf">CoarseSolve</span><span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">V</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">U</span><span class="p">,</span> <span class="kt">mpiComm</span> <span class="o">&amp;</span><span class="n">comm</span><span class="p">){</span>
    <span class="c1">//solving the coarse probleme</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Uc</span><span class="p">(</span><span class="n">Rci</span><span class="p">.</span><span class="kr">n</span><span class="p">),</span> <span class="n">Bc</span><span class="p">(</span><span class="n">Uc</span><span class="p">.</span><span class="kr">n</span><span class="p">);</span>
    <span class="n">Uc</span> <span class="o">=</span> <span class="n">Rci</span><span class="o">*</span><span class="n">U</span><span class="p">;</span>
    <span class="nf">mpiReduce</span><span class="p">(</span><span class="n">Uc</span><span class="p">,</span> <span class="n">Bc</span><span class="p">,</span> <span class="nf">processor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">comm</span><span class="p">),</span> <span class="kr">mpiSUM</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">mpiRank</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">Uc</span> <span class="o">=</span> <span class="n">AC</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">Bc</span><span class="p">;</span>
    <span class="nf">broadcast</span><span class="p">(</span><span class="nf">processor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">comm</span><span class="p">),</span> <span class="n">Uc</span><span class="p">);</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">Pci</span><span class="o">*</span><span class="n">Uc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">DJ</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">U</span><span class="p">){</span>
    <span class="o">++</span><span class="n">kiter</span><span class="p">;</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">V</span><span class="p">(</span><span class="n">U</span><span class="p">.</span><span class="kr">n</span><span class="p">);</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">Ai</span><span class="o">*</span><span class="n">U</span><span class="p">;</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">onG10</span> <span class="o">?</span> <span class="mf">0.</span><span class="o">:</span> <span class="n">V</span><span class="p">;</span> <span class="c1">//remove internal boundary</span>
    <span class="k">return</span> <span class="n">V</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">PDJ</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">U</span><span class="p">){</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">V</span><span class="p">(</span><span class="n">U</span><span class="p">.</span><span class="kr">n</span><span class="p">);</span>

    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span> <span class="o">=</span> <span class="n">onG10</span> <span class="o">?</span> <span class="mf">0.</span> <span class="o">:</span> <span class="n">U</span><span class="p">;</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">Ai</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="n">Update</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">U</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">U</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">PDJC</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">U</span><span class="p">){</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">V</span><span class="p">(</span><span class="n">U</span><span class="p">.</span><span class="kr">n</span><span class="p">);</span>
    <span class="n">CoarseSolve</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">comm</span><span class="p">);</span>
    <span class="n">V</span> <span class="o">=</span> <span class="o">-</span><span class="n">V</span><span class="p">;</span> <span class="c1">//-C2*Uo</span>
    <span class="n">U</span> <span class="o">+=</span> <span class="n">Ai</span><span class="o">*</span><span class="n">V</span><span class="p">;</span> <span class="c1">//U = (I-A C2) Uo</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span> <span class="o">=</span> <span class="n">onG10</span> <span class="o">?</span> <span class="mf">0.</span> <span class="o">:</span> <span class="n">U</span><span class="p">;</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">Ai</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">;</span> <span class="c1">// (C1( I -A C2) Uo</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">U</span> <span class="o">-</span><span class="n">V</span><span class="p">;</span>
    <span class="n">Update</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">U</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">U</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">DJ0</span><span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">U</span><span class="p">){</span>
    <span class="o">++</span><span class="n">kiter</span><span class="p">;</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">V</span><span class="p">(</span><span class="n">U</span><span class="p">.</span><span class="kr">n</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span> <span class="o">=</span> <span class="n">onG</span> <span class="p">.</span><span class="o">*</span> <span class="n">U</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">onG</span> <span class="o">?</span> <span class="nl">b</span> <span class="o">:</span> <span class="n">Bi</span> <span class="p">;</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">Ai</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="n">Update</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">U</span><span class="p">);</span>
    <span class="n">V</span> <span class="o">-=</span> <span class="n">U</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">V</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Whi</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
<span class="p">{</span> <span class="c1">//verification</span>
    <span class="n">Whi</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">Update</span><span class="p">(</span><span class="n">u</span><span class="p">[],</span> <span class="n">v</span><span class="p">[]);</span>
    <span class="n">u</span><span class="p">[]</span> <span class="o">-=</span> <span class="n">v</span><span class="p">[];</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">u</span><span class="p">[].</span><span class="kr">linfty</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">settt</span>
<span class="n">u</span><span class="p">[]</span> <span class="o">=</span> <span class="n">vBC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Whi</span><span class="p">,</span> <span class="kp">tgv</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//set u with tgv BC value</span>

<span class="kt">real</span> <span class="n">epss</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">rgmres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">gmres</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
    <span class="n">rgmres</span> <span class="o">=</span> <span class="n">MPIAffineGMRES</span><span class="p">(</span><span class="n">DJ0</span><span class="p">,</span> <span class="n">u</span><span class="p">[],</span> <span class="kp">veps</span><span class="o">=</span><span class="n">epss</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">,</span> <span class="nf">dimKrylov</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">ipart</span> <span class="o">?</span> <span class="mi">0</span><span class="o">:</span> <span class="mi">50</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span> <span class="o">=</span> <span class="n">onG</span> <span class="p">.</span><span class="o">*</span> <span class="n">u</span><span class="p">[];</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">onG</span> <span class="o">?</span> <span class="nl">b</span> <span class="o">:</span> <span class="n">Bi</span><span class="p">;</span>
    <span class="n">v</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Ai</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="n">Update</span><span class="p">(</span><span class="n">v</span><span class="p">[],</span> <span class="n">u</span><span class="p">[]);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gmres</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">rgmres</span> <span class="o">=</span> <span class="n">MPILinearGMRES</span><span class="p">(</span><span class="n">DJ</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">PDJ</span><span class="p">,</span> <span class="n">u</span><span class="p">[],</span> <span class="n">Bi</span><span class="p">,</span> <span class="kp">veps</span><span class="o">=</span><span class="n">epss</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">,</span> <span class="nf">dimKrylov</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">ipart</span> <span class="o">?</span> <span class="mi">0</span><span class="o">:</span> <span class="mi">50</span><span class="p">);</span>
<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">gmres</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">rgmres</span> <span class="o">=</span> <span class="n">MPILinearGMRES</span><span class="p">(</span><span class="n">DJ</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">PDJC</span><span class="p">,</span> <span class="n">u</span><span class="p">[],</span> <span class="n">Bi</span><span class="p">,</span> <span class="kp">veps</span><span class="o">=</span><span class="n">epss</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">,</span> <span class="nf">dimKrylov</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">ipart</span> <span class="o">?</span> <span class="mi">0</span><span class="o">:</span> <span class="mi">50</span><span class="p">);</span>
<span class="k">else</span> <span class="c1">//algo Shwarz for demo</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">iter</span><span class="p">){</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span> <span class="o">=</span> <span class="n">onG</span> <span class="p">.</span><span class="o">*</span> <span class="n">u</span><span class="p">[];</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">onG</span> <span class="o">?</span> <span class="nl">b</span> <span class="o">:</span> <span class="n">Bi</span> <span class="p">;</span>
        <span class="n">v</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Ai</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>

        <span class="n">Update</span><span class="p">(</span><span class="n">v</span><span class="p">[],</span> <span class="n">u</span><span class="p">[]);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">vdebug</span><span class="p">)</span>
            <span class="n">plotMPIall</span><span class="p">(</span><span class="n">Thi</span><span class="p">,</span> <span class="n">u</span><span class="p">[],</span> <span class="s">&quot;u-&quot;</span><span class="o">+</span><span class="n">iter</span><span class="p">);</span>
        <span class="n">v</span><span class="p">[]</span> <span class="o">-=</span> <span class="n">u</span><span class="p">[];</span>

        <span class="kt">real</span> <span class="kp">err</span> <span class="o">=</span> <span class="n">v</span><span class="p">[].</span><span class="kr">linfty</span><span class="p">;</span>
        <span class="kt">real</span> <span class="n">umax</span> <span class="o">=</span> <span class="n">u</span><span class="p">[].</span><span class="kr">max</span><span class="p">;</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">aa</span> <span class="o">=</span> <span class="p">[</span><span class="kp">err</span><span class="p">,</span> <span class="n">umax</span><span class="p">],</span> <span class="kp">bb</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="nf">mpiAllReduce</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="kp">bb</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="kr">mpiMAX</span><span class="p">);</span>
        <span class="kt">real</span> <span class="kp">errg</span> <span class="o">=</span> <span class="kp">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="kt">real</span> <span class="n">umaxg</span> <span class="o">=</span> <span class="kp">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ipart</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ipart</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">errg</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; u. max &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">umaxg</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="kp">errg</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">vdebug</span><span class="p">)</span>
    <span class="n">plotMPIall</span><span class="p">(</span><span class="n">Thi</span><span class="p">,</span> <span class="n">u</span><span class="p">[],</span> <span class="s">&quot;u-final&quot;</span><span class="p">);</span>

<span class="n">settt</span>

<span class="kt">real</span> <span class="kp">errg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">umaxg</span><span class="p">;</span>
<span class="p">{</span>
    <span class="kt">real</span> <span class="n">umax</span> <span class="o">=</span> <span class="n">u</span><span class="p">[].</span><span class="kr">max</span><span class="p">,</span> <span class="n">umaxg</span><span class="p">;</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">aa</span> <span class="o">=</span> <span class="p">[</span><span class="n">umax</span><span class="p">],</span> <span class="kp">bb</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nf">mpiAllReduce</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="kp">bb</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="kr">mpiMAX</span><span class="p">);</span>
    <span class="kp">errg</span> <span class="o">=</span> <span class="kp">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ipart</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;umax global = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; Wtime = &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ttt</span><span class="p">[</span><span class="n">ittt</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ttt</span><span class="p">[</span><span class="n">ittt</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; s &quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">kiter</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">sff</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">){</span>
    <span class="kt">ofstream</span> <span class="n">ff</span><span class="p">(</span><span class="n">sff</span><span class="o">+</span><span class="s">&quot;.txt&quot;</span><span class="p">,</span> <span class="kr">append</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ++++ &quot;</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kr">mpirank</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="o">/</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">mpisize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; k=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ksplit</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; n= &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nloc</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sizeoverlaps</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; it= &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">kiter</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ittt</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ttt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ttt</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">epss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Ai</span><span class="p">.</span><span class="n">nbcoef</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Ai</span><span class="p">.</span><span class="kr">n</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">    1 mpirank</span>
<span class="cm">    2 mpisize</span>
<span class="cm">    3 ksplit</span>
<span class="cm">    4 nloc</span>
<span class="cm">    5 sizeoverlaps</span>
<span class="cm">    6 kiter</span>
<span class="cm">    7 mesh &amp; part build</span>
<span class="cm">    8 build the partion</span>
<span class="cm">    9 build mesh, transfere , and the fine mesh ..</span>
<span class="cm">    10 build the matrix, the trans matrix, factorizatioon</span>
<span class="cm">    11 GMRES</span>
<span class="cm">    */</span>

    <span class="n">ff</span> <span class="o">&lt;&lt;</span> <span class="kr">mpirank</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">mpisize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sPk</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">ff</span> <span class="o">&lt;&lt;</span> <span class="n">ksplit</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nloc</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sizeoverlaps</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">kiter</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ittt</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ff</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ttt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ttt</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">ff</span> <span class="o">&lt;&lt;</span> <span class="n">epss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Ai</span><span class="p">.</span><span class="n">nbcoef</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Ai</span><span class="p">.</span><span class="kr">n</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">gmres</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id39">
<img alt="../_images/MPIGMRES2D.png" src="../_images/MPIGMRES2D.png" />
<p class="caption"><span class="caption-number">Fig. 171 </span><span class="caption-text">Results</span></p>
</div>
</div>
<div class="section" id="mpi-gmres-3d">
<span id="examplempigmres3d"></span><h3>MPI-GMRES 3D<a class="headerlink" href="#mpi-gmres-3d" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">todo</p>
</div>
</div>
<div class="section" id="direct-solvers">
<span id="exampledirectsolvers"></span><h3>Direct solvers<a class="headerlink" href="#direct-solvers" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;MUMPS_FreeFem&quot;</span>
<span class="c1">//default solver: real-&gt; MUMPS, complex -&gt; MUMPS</span>
<span class="cp">load</span> <span class="s">&quot;real_SuperLU_DIST_FreeFem&quot;</span>
<span class="kr">default</span> <span class="kp">solver</span><span class="o">:</span> <span class="kt">real</span><span class="o">-&gt;</span> <span class="n">SuperLU_DIST</span><span class="p">,</span> <span class="kt">complex</span> <span class="o">-&gt;</span> <span class="n">MUMPS</span>
<span class="cp">load</span> <span class="s">&quot;real_pastix_FreeFem&quot;</span>
<span class="c1">//default solver: real-&gt; pastix, complex -&gt; MUMPS</span>

<span class="c1">// Solving with pastix</span>
<span class="p">{</span>
    <span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span>
        <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">22</span><span class="p">]];</span>

    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="kr">x</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">b</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">di</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">b</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">xx</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;xx = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">xx</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="nf">set</span><span class="p">(</span><span class="kp">A</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">sparsesolver</span><span class="p">,</span> <span class="kp">datafilename</span><span class="o">=</span><span class="s">&quot;ffpastix_iparm_dparm.txt&quot;</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="kt">solve</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">x</span> <span class="o">=</span> <span class="kp">A</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kr">x</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">-</span> <span class="kr">x</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x-xx = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Linf = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">di</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, L2 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">di</span><span class="p">.</span><span class="kr">l2</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Solving with SuperLU_DIST</span>
<span class="n">realdefaulttoSuperLUdist</span><span class="p">();</span>
<span class="c1">//default solver: real-&gt; SuperLU_DIST, complex -&gt; MUMPS</span>
<span class="p">{</span>
    <span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span>
        <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">22</span><span class="p">]];</span>

    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="kr">x</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">b</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">di</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">b</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">xx</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;xx = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">xx</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="nf">set</span><span class="p">(</span><span class="kp">A</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">sparsesolver</span><span class="p">,</span> <span class="kp">datafilename</span><span class="o">=</span><span class="s">&quot;ffsuperlu_dist_fileparam.txt&quot;</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="kt">solve</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">x</span> <span class="o">=</span> <span class="kp">A</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kr">x</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">-</span> <span class="kr">x</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x-xx = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Linf = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">di</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, L2 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">di</span><span class="p">.</span><span class="kr">l2</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Solving with MUMPS</span>
<span class="n">defaulttoMUMPS</span><span class="p">();</span>
<span class="c1">//default solver: real-&gt; MUMPS, complex -&gt; MUMPS</span>
<span class="p">{</span>
    <span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span>
        <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">22</span><span class="p">]];</span>

    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="kr">x</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">b</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">di</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">b</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">xx</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;xx = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">xx</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="nf">set</span><span class="p">(</span><span class="kp">A</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">sparsesolver</span><span class="p">,</span> <span class="kp">datafilename</span><span class="o">=</span><span class="s">&quot;ffmumps_fileparam.txt&quot;</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;solving solution&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">x</span> <span class="o">=</span> <span class="kp">A</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kr">x</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">-</span> <span class="kr">x</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x-xx = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Linf = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">di</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, L2 &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">di</span><span class="p">.</span><span class="kr">l2</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="solver-mumps">
<span id="examplesolvermumps"></span><h3>Solver MUMPS<a class="headerlink" href="#solver-mumps" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;MUMPS_FreeFem&quot;</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">ICNTL</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span> <span class="c1">//declaration of ICNTL parameter for MUMPS</span>

<span class="c1">//get value of ICNTL from file</span>
<span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="kt">ifstream</span> <span class="n">ff</span><span class="p">(</span><span class="s">&quot;ffmumps_fileparam.txt&quot;</span><span class="p">);</span>
    <span class="kt">string</span> <span class="n">line</span><span class="p">;</span>
    <span class="nf">getline</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
    <span class="nf">getline</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">iii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iii</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="n">iii</span><span class="o">++</span><span class="p">){</span>
        <span class="n">ff</span> <span class="o">&gt;&gt;</span> <span class="n">ICNTL</span><span class="p">[</span><span class="n">iii</span><span class="p">];</span>
        <span class="nf">getline</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nf">broadcast</span><span class="p">(</span><span class="nf">processor</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ICNTL</span><span class="p">);</span>

<span class="c1">// Given data of MUMPS solver in array lparams(SYM, PAR, ICNTL)</span>
<span class="c1">// There is no symmetric storage for a matrix associated with a sparse solver.</span>
<span class="c1">// Therefore, the matrix will be considered unsymmetric for parallel sparse solver even if symmetric.</span>
<span class="p">{</span>
    <span class="c1">// Problem</span>
    <span class="kt">int</span> <span class="n">SYM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">PAR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">22</span><span class="p">]</span>
        <span class="p">];</span>

    <span class="c1">// Construction of integer parameter for MUMPS</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">MumpsLParams</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
    <span class="n">MumpsLParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SYM</span><span class="p">;</span>
    <span class="n">MumpsLParams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PAR</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
        <span class="n">MumpsLParams</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ICNTL</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span> <span class="c1">//ICNTL begin with index 0 here</span>

    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="kr">x</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">b</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">di</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">b</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">xx</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;xx = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">xx</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="nf">set</span><span class="p">(</span><span class="kp">A</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">sparsesolver</span><span class="p">,</span> <span class="kp">lparams</span><span class="o">=</span><span class="n">MumpsLParams</span><span class="p">);</span> <span class="c1">//we take the default value for CNTL MUMPS parameter</span>

    <span class="c1">// Solve</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Solve&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">x</span> <span class="o">=</span> <span class="kp">A</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kr">x</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">xx</span><span class="o">-</span><span class="kr">x</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x-xx = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Linf = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">di</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, L2 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">di</span><span class="p">.</span><span class="kr">l2</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Read parameter of MUMPS solver in file ffmumps_fileparam.txt</span>
<span class="p">{</span>
    <span class="c1">// Problem</span>
    <span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">22</span><span class="p">]</span>
        <span class="p">];</span>

    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">7000</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="kr">x</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">b</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">di</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">b</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">xx</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;xx = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">xx</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nf">set</span><span class="p">(</span><span class="kp">A</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">sparsesolver</span><span class="p">,</span> <span class="kp">datafilename</span><span class="o">=</span><span class="s">&quot;ffmumps_fileparam.txt&quot;</span><span class="p">);</span>

    <span class="c1">// Solve</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Solve&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">x</span> <span class="o">=</span> <span class="kp">A</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">x</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">xx</span><span class="o">-</span><span class="kr">x</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">mpirank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x-xx = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Linf = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">di</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, L2 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">di</span><span class="p">.</span><span class="kr">l2</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="solver-superlu-dist">
<span id="examplesolversuperludist"></span><h3>Solver superLU_DIST<a class="headerlink" href="#solver-superlu-dist" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">write code (SuperLU_DIST seems to have a bug)</p>
</div>
</div>
<div class="section" id="solver-pastix">
<span id="examplesolverpastix"></span><h3>Solver PaStiX<a class="headerlink" href="#solver-pastix" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p class="last">write code (PaStiX seems to have a bug)</p>
</div>
</div>
</div>
<div class="section" id="developers">
<span id="exampledevelopers"></span><h2>Developers<a class="headerlink" href="#developers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="fft">
<span id="examplefft"></span><h3>FFT<a class="headerlink" href="#fft" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;</span><span class="nf">dfft</span><span class="s">&quot;</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">nx</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">ny</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="kt">real</span> <span class="kr">N</span> <span class="o">=</span> <span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f1</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="kr">x</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="kr">y</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">);</span>

<span class="c1">// Mesh</span>
<span class="c1">//warning: the fourier space is not exactly the unit square due to periodic condition</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="kr">x</span><span class="o">/</span><span class="n">nx</span><span class="p">,</span> <span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="kr">y</span><span class="o">/</span><span class="n">ny</span><span class="p">]);</span>
<span class="c1">//warning: the numbering of the vertices (x,y) is</span>
<span class="c1">//given by i = x/nx + nx*y/ny</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span><span class="o">&lt;</span><span class="kt">complex</span><span class="o">&gt;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">f1</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">w</span> <span class="o">=</span> <span class="n">f1</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">ur</span><span class="p">,</span> <span class="n">ui</span><span class="p">;</span>

<span class="c1">// FFT</span>
<span class="c1">//in dfft the matrix n, m is in row-major order and array n, m is</span>
<span class="c1">//store j + m*i (the transpose of the square numbering)</span>
<span class="n">v</span><span class="p">[]</span> <span class="o">=</span> <span class="nf">dfft</span><span class="p">(</span><span class="n">u</span><span class="p">[],</span> <span class="n">ny</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="n">u</span><span class="p">[]</span> <span class="o">=</span> <span class="nf">dfft</span><span class="p">(</span><span class="n">v</span><span class="p">[],</span> <span class="n">ny</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;||u||_\infty &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[].</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="n">u</span><span class="p">[]</span> <span class="o">*=</span> <span class="mf">1.</span><span class="o">/</span><span class="kr">N</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;||u||_\infty &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[].</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="n">ur</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">ur</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;u&quot;</span><span class="p">);</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">u</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;diff = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">[].</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">[].</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="nf">assert</span><span class="p">(</span> <span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">[].</span><span class="kr">max</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span> <span class="o">&amp;&amp;</span> <span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">[].</span><span class="kr">min</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">);</span>

<span class="c1">// Other example</span>
<span class="c1">//FFT Lapacian</span>
<span class="c1">//-\Delta u = f with biperiodic condition</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">*</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">*</span><span class="kr">y</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">ue</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="nf">square</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">)</span><span class="o">*</span><span class="mf">13.</span><span class="p">))</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">*</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">*</span><span class="kr">y</span><span class="p">);</span> <span class="c1">//the exact solution</span>
<span class="n">Vh</span><span class="o">&lt;</span><span class="kt">complex</span><span class="o">&gt;</span> <span class="n">ff</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
<span class="n">Vh</span><span class="o">&lt;</span><span class="kt">complex</span><span class="o">&gt;</span> <span class="n">fhat</span><span class="p">;</span>
<span class="n">Vh</span><span class="o">&lt;</span><span class="kt">complex</span><span class="o">&gt;</span> <span class="n">wij</span><span class="p">;</span>

<span class="c1">// FFT</span>
<span class="n">fhat</span><span class="p">[]</span> <span class="o">=</span> <span class="nf">dfft</span><span class="p">(</span><span class="n">ff</span><span class="p">[],</span><span class="n">ny</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">//warning in fact we take mode between -nx/2, nx/2 and -ny/2, ny/2</span>
<span class="c1">//thanks to the operator ?:</span>
<span class="n">wij</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="kr">pi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nf">square</span><span class="p">((</span> <span class="kr">x</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="o">?</span><span class="kr">x</span><span class="o">*</span><span class="nl">nx</span><span class="o">:</span><span class="p">(</span><span class="kr">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nx</span><span class="p">))</span> <span class="o">+</span> <span class="nf">square</span><span class="p">((</span><span class="kr">y</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="o">?</span><span class="kr">y</span><span class="o">*</span><span class="nl">ny</span><span class="o">:</span><span class="p">(</span><span class="kr">y</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ny</span><span class="p">)));</span>
<span class="n">wij</span><span class="p">[][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">;</span> <span class="c1">//to remove div / 0</span>
<span class="n">fhat</span><span class="p">[]</span> <span class="o">=</span> <span class="n">fhat</span><span class="p">[]</span> <span class="p">.</span><span class="o">/</span> <span class="n">wij</span><span class="p">[];</span>
<span class="n">u</span><span class="p">[]</span> <span class="o">=</span> <span class="nf">dfft</span><span class="p">(</span><span class="n">fhat</span><span class="p">[],</span> <span class="n">ny</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">u</span><span class="p">[]</span> <span class="o">/=</span> <span class="kt">complex</span><span class="p">(</span><span class="kr">N</span><span class="p">);</span>
<span class="n">ur</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">u</span><span class="p">);</span> <span class="c1">//the solution</span>
<span class="n">w</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ue</span><span class="p">);</span> <span class="c1">//the exact solution</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">ur</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;ue&quot;</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">// Error</span>
<span class="n">w</span><span class="p">[]</span> <span class="o">-=</span> <span class="n">ur</span><span class="p">[];</span>
<span class="kt">real</span> <span class="kp">err</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">w</span><span class="p">[].</span><span class="kr">max</span><span class="p">)</span> <span class="o">+</span> <span class="nf">abs</span><span class="p">(</span><span class="n">w</span><span class="p">[].</span><span class="kr">min</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">err</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="nf">assert</span><span class="p">(</span><span class="kp">err</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">);</span>

<span class="n">fftwplan</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">plandfft</span><span class="p">(</span><span class="n">u</span><span class="p">[],</span> <span class="n">v</span><span class="p">[],</span> <span class="n">ny</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="n">fftwplan</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">plandfft</span><span class="p">(</span><span class="n">u</span><span class="p">[],</span> <span class="n">v</span><span class="p">[],</span> <span class="n">ny</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="kt">real</span> <span class="n">ccc</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="kr">pi</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ny = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ny</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="n">map</span><span class="p">(</span><span class="n">wij</span><span class="p">[],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">ccc</span><span class="o">*</span><span class="p">(</span><span class="kr">x</span><span class="o">*</span><span class="kr">x</span><span class="o">+</span><span class="kr">y</span><span class="o">*</span><span class="kr">y</span><span class="p">));</span>
<span class="n">wij</span><span class="p">[][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">;</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">wij</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;wij&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="complex">
<span id="examplecomplex"></span><h3>Complex<a class="headerlink" href="#complex" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">real</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">2.45</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">5.33</span><span class="p">;</span>
<span class="kt">complex</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="mi">1</span><span class="n">i</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="nf">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="n">i</span><span class="p">;</span>

<span class="kt">func</span> <span class="kt">string</span> <span class="nf">pc</span><span class="p">(</span><span class="kt">complex</span> <span class="kr">z</span><span class="p">){</span>
    <span class="kt">string</span> <span class="n">r</span> <span class="o">=</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span><span class="kr">z</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">imag</span><span class="p">(</span><span class="kr">z</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="s">&quot;</span><span class="o">+</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">r</span> <span class="o">+</span> <span class="nf">imag</span><span class="p">(</span><span class="kr">z</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;i)&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">func</span> <span class="kt">string</span> <span class="nf">toPolar</span><span class="p">(</span><span class="kt">complex</span> <span class="kr">z</span><span class="p">){</span>
    <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span><span class="c1">//abs(z) + &quot;*(cos(&quot; + arg(z) + &quot;)+i*sin(&quot; + arg(z) + &quot;))&quot;;</span>
<span class="p">}</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Standard output of the complex &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; is the pair: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">z1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; + &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="o">+</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; * &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="o">*</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; / &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="o">/</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Real part of &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kt">real</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Imaginary part of &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">imag</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;abs(&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">abs</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Polar coordinates of &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">toPolar</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;de Moivre formula: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;^3 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">toPolar</span><span class="p">(</span><span class="n">z2</span><span class="o">^</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; and polar(&quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">abs</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">arg</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="nf">polar</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">z2</span><span class="p">),</span> <span class="nf">arg</span><span class="p">(</span><span class="n">z2</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Conjugate of &quot;</span> <span class="o">&lt;&lt;</span><span class="n">pc</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="nf">conj</span><span class="p">(</span><span class="n">z2</span><span class="p">))</span> <span class="o">&lt;&lt;</span><span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ^ &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pc</span><span class="p">(</span><span class="n">z1</span><span class="o">^</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>Output of this script is:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span>Standard output of the complex <span class="o">(</span><span class="m">2</span>.45+5.33i<span class="o">)</span> is the pair: <span class="o">(</span><span class="m">2</span>.45,5.33<span class="o">)</span>
<span class="o">(</span><span class="m">2</span>.45+5.33i<span class="o">)</span> + <span class="o">(</span><span class="m">2</span>.45+1.41421i<span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="m">4</span>.9+6.74421i<span class="o">)</span>
<span class="o">(</span><span class="m">2</span>.45+5.33i<span class="o">)</span> - <span class="o">(</span><span class="m">2</span>.45+1.41421i<span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="m">0</span>+3.91579i<span class="o">)</span>
<span class="o">(</span><span class="m">2</span>.45+5.33i<span class="o">)</span> * <span class="o">(</span><span class="m">2</span>.45+1.41421i<span class="o">)</span> <span class="o">=</span> <span class="o">(</span>-1.53526+16.5233i<span class="o">)</span>
<span class="o">(</span><span class="m">2</span>.45+5.33i<span class="o">)</span> / <span class="o">(</span><span class="m">2</span>.45+1.41421i<span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="m">1</span>.692+1.19883i<span class="o">)</span>
Real part of <span class="o">(</span><span class="m">2</span>.45+5.33i<span class="o">)</span> <span class="o">=</span> <span class="m">2</span>.45
Imaginary part of <span class="o">(</span><span class="m">2</span>.45+5.33i<span class="o">)</span> <span class="o">=</span> <span class="m">5</span>.33
abs<span class="o">((</span><span class="m">2</span>.45+5.33i<span class="o">))</span> <span class="o">=</span> <span class="m">5</span>.86612
Polar coordinates of <span class="o">(</span><span class="m">2</span>.45+1.41421i<span class="o">)</span> <span class="o">=</span>
de Moivre formula: <span class="o">(</span><span class="m">2</span>.45+1.41421i<span class="o">)</span>^3 <span class="o">=</span>
 and polar<span class="o">(</span><span class="m">2</span>.82887, <span class="m">0</span>.523509<span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="m">2</span>.45+1.41421i<span class="o">)</span>
Conjugate of <span class="o">(</span><span class="m">2</span>.45+1.41421i<span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="m">2</span>.45-1.41421i<span class="o">)</span>
<span class="o">(</span><span class="m">2</span>.45+5.33i<span class="o">)</span> ^ <span class="o">(</span><span class="m">2</span>.45+1.41421i<span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="m">8</span>.37072-12.7078i<span class="o">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="string">
<span id="examplestring"></span><h3>String<a class="headerlink" href="#string" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Concatenation</span>
<span class="kt">string</span> <span class="n">tt</span> <span class="o">=</span> <span class="s">&quot;toto1&quot;</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="s">&quot; -- 77&quot;</span><span class="p">;</span>

<span class="c1">// Append</span>
<span class="kt">string</span> <span class="n">t1</span> <span class="o">=</span> <span class="s">&quot;0123456789&quot;</span><span class="p">;</span>
<span class="n">t1</span><span class="p">(</span><span class="mi">4</span><span class="o">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="s">&quot;abcdefghijk-&quot;</span><span class="p">;</span>

<span class="c1">// Sub string</span>
<span class="kt">string</span> <span class="n">t55</span> <span class="o">=</span> <span class="n">t1</span><span class="p">(</span><span class="mi">4</span><span class="o">:</span><span class="mi">14</span><span class="p">);</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tt = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tt</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;t1 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">t1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;t1.find(abc) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">t1</span><span class="p">.</span><span class="kr">find</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;t1.rfind(abc) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">t1</span><span class="p">.</span><span class="kr">rfind</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;t1.find(abc, 10) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">t1</span><span class="p">.</span><span class="kr">find</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;t1.ffind(abc, 10) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">t1</span><span class="p">.</span><span class="kr">rfind</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;t1.length = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">t1</span><span class="p">.</span><span class="kr">length</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;t55 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">t55</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>The output of this script is:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nv">tt</span> <span class="o">=</span> toto11 -- <span class="m">77</span>
<span class="nv">t1</span> <span class="o">=</span> 0123abcdefghijk-456789
t1.find<span class="o">(</span>abc<span class="o">)</span> <span class="o">=</span> <span class="m">4</span>
t1.rfind<span class="o">(</span>abc<span class="o">)</span> <span class="o">=</span> <span class="m">4</span>
t1.find<span class="o">(</span>abc, <span class="m">10</span><span class="o">)</span> <span class="o">=</span> -1
t1.ffind<span class="o">(</span>abc, <span class="m">10</span><span class="o">)</span> <span class="o">=</span> <span class="m">4</span>
t1.length <span class="o">=</span> <span class="m">22</span>
<span class="nv">t55</span> <span class="o">=</span> abcdefghijk
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="elementary-function">
<span id="exampleelementaryfunction"></span><h3>Elementary function<a class="headerlink" href="#elementary-function" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">real</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
<span class="kt">func</span> <span class="kt">real</span> <span class="nf">phix</span><span class="p">(</span><span class="kt">real</span> <span class="kp">t</span><span class="p">){</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kp">t</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">func</span> <span class="kt">real</span> <span class="nf">phiy</span><span class="p">(</span><span class="kt">real</span> <span class="kp">t</span><span class="p">){</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kp">t</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">border</span> <span class="nf">C</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="n">phix</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="kr">y</span><span class="o">=</span><span class="n">phiy</span><span class="p">(</span><span class="kp">t</span><span class="p">);}</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id40">
<img alt="../_images/ElementaryFunction.png" src="../_images/ElementaryFunction.png" />
<p class="caption"><span class="caption-number">Fig. 172 </span><span class="caption-text">Mesh</span></p>
</div>
</div>
<div class="section" id="array">
<span id="examplearray"></span><h3>Array<a class="headerlink" href="#array" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">tab</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">tab1</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="c1">//2 array of 10 real</span>
<span class="c1">//real[int] tab2; //bug: array with no size</span>

<span class="n">tab</span> <span class="o">=</span> <span class="mf">1.03</span><span class="p">;</span> <span class="c1">//set all the array to 1.03</span>
<span class="n">tab</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.15</span><span class="p">;</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tab: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tab</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;min: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tab</span><span class="p">.</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;max: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tab</span><span class="p">.</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sum: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tab</span><span class="p">.</span><span class="kr">sum</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="n">tab</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span> <span class="c1">//change the size of array tab to 12 with preserving first value</span>
<span class="n">tab</span><span class="p">(</span><span class="mi">10</span><span class="o">:</span><span class="mi">11</span><span class="p">)</span> <span class="o">=</span> <span class="mf">3.14</span><span class="p">;</span> <span class="c1">//set values 10 &amp; 11</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;resized tab: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tab</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="n">tab</span><span class="p">.</span><span class="nf">sort</span> <span class="p">;</span> <span class="c1">//sort the array tab</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sorted tab:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tab</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">real</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span> <span class="n">tt</span><span class="p">;</span> <span class="c1">//array with string index</span>
<span class="n">tt</span><span class="p">[</span><span class="s">&quot;</span><span class="o">+</span><span class="s">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tt[</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;</span><span class="s">] = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tt</span><span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tt[</span><span class="se">\&quot;</span><span class="o">+</span><span class="se">\&quot;</span><span class="s">] = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tt</span><span class="p">[</span><span class="s">&quot;</span><span class="o">+</span><span class="s">&quot;</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">a</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">b</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">c</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="nf">d</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nf">d</span> <span class="o">=</span> <span class="p">(</span> <span class="n">a</span> <span class="o">?</span> <span class="nl">b</span> <span class="o">:</span> <span class="n">c</span> <span class="p">);</span> <span class="c1">//for i = 0, n-1 : d[i] = a[i] ? b[i] : c[i]</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; d = ( a ? b : c ) is &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">d</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="nf">d</span> <span class="o">=</span> <span class="p">(</span> <span class="n">a</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">c</span> <span class="p">);</span> <span class="c1">//for i = 0, n-1: d[i] = a[i] ? 1 : c[i]</span>
<span class="nf">d</span> <span class="o">=</span> <span class="p">(</span> <span class="n">a</span> <span class="o">?</span> <span class="nl">b</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">);</span> <span class="c1">//for i = 0, n-1: d[i] = a[i] ? b[i] : 0</span>
<span class="nf">d</span> <span class="o">=</span> <span class="p">(</span> <span class="n">a</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">);</span> <span class="c1">//for i = 0, n-1: d[i] = a[i] ? 0 : 1</span>

<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">ii</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="nf">d</span><span class="p">.</span><span class="kr">n</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//set array ii to 0, 1, ..., d.n-1</span>
<span class="nf">d</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">:-</span><span class="mi">5</span><span class="p">;</span> <span class="c1">//set d to -1, -2, ..., -5</span>

<span class="nf">sort</span><span class="p">(</span><span class="nf">d</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span> <span class="c1">//sort array d and ii in parallel</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;d: &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">d</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ii: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ii</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>


<span class="p">{</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="kp">A1</span><span class="p">(</span><span class="mi">2</span><span class="o">:</span><span class="mi">10</span><span class="p">);</span> <span class="c1">//2, 3, 4, 5, 6, 7, 8, 9, 10</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">A2</span><span class="p">(</span><span class="mi">2</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="mi">10</span><span class="p">);</span> <span class="c1">//2, 5, 8</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A1(2:10): &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A2(2:3:10): &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kp">A1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="mi">5</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;1:2:5 =&gt; &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">{</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="kp">A1</span><span class="p">(</span><span class="mi">2</span><span class="o">:</span><span class="mi">10</span><span class="p">);</span> <span class="c1">//2, 3, 4, 5, 6, 7, 8, 9, 10</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">A2</span><span class="p">(</span><span class="mi">2</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="mi">10</span><span class="p">);</span> <span class="c1">//2, 5, 8</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A1(2:10): &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A2(2:3:10): &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kp">A1</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">:</span><span class="mf">0.5</span><span class="o">:</span><span class="mf">3.999</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;1.:0.5:3.999 =&gt; &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">{</span>
    <span class="kt">complex</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="kp">A1</span><span class="p">(</span><span class="mf">2.</span><span class="o">+</span><span class="mi">0</span><span class="nl">i</span><span class="o">:</span><span class="mf">10.</span><span class="o">+</span><span class="mi">0</span><span class="n">i</span><span class="p">);</span> <span class="c1">//2, 3, 4, 5, 6, 7, 8, 9, 10</span>
    <span class="kt">complex</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">A2</span><span class="p">(</span><span class="mf">2.</span><span class="o">:</span><span class="mf">3.</span><span class="o">:</span><span class="mf">10.</span><span class="p">);</span> <span class="c1">//2, 5, 8</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; A1(2.+0i:10.+0i): &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; A2(2.:3.:10.)= &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">A2</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; A1.re real part array: &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A1</span><span class="p">.</span><span class="kr">re</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span> <span class="p">;</span>
    <span class="c1">// he real part array of the complex array</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; A1.im imag part array: &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A1</span><span class="p">.</span><span class="kr">im</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span> <span class="p">;</span>
    <span class="c1">//the imaginary part array of the complex array</span>
<span class="p">}</span>

<span class="c1">// Integer array operators</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="kr">N</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">a</span><span class="p">(</span><span class="kr">N</span><span class="p">),</span> <span class="n">b</span><span class="p">(</span><span class="kr">N</span><span class="p">),</span> <span class="n">c</span><span class="p">(</span><span class="kr">N</span><span class="p">);</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">a</span><span class="p">(</span><span class="mi">3</span><span class="o">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;a: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">a</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span><span class="s">&quot;b = a + a: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">+=</span> <span class="n">a</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span><span class="s">&quot;b += a: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span><span class="s">&quot;b += 2*a: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span><span class="s">&quot; b /= 2: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">b</span> <span class="p">.</span><span class="o">*=</span> <span class="n">a</span><span class="p">;</span> <span class="c1">// same as b = b .* a</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b .*= a: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">b</span> <span class="p">.</span><span class="o">/=</span> <span class="n">a</span><span class="p">;</span> <span class="c1">//same as b = b ./ a</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b ./= a: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;c = a + b: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;c = 2*a + 4b: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;c = a + 4b: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;c = -a + 4b: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;c = -a - 4b: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;c = -a -b: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="p">.</span><span class="o">*</span> <span class="n">b</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;c = a .* b: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="p">.</span><span class="o">/</span> <span class="n">b</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;c = a ./ b: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;c = 2 * b: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;c = b * 2: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="c1">//this operator do not exist</span>
    <span class="c1">//c = b/2;</span>
    <span class="c1">//cout &lt;&lt; &quot;c = b / 2: &quot; &lt;&lt; c &lt;&lt; endl;</span>

    <span class="c1">//Array methods</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;||a||_1 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="kr">l1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;||a||_2 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="kr">l2</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;||a||_infty = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sum a_i = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="kr">sum</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;max a_i = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; a[ &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="kr">imax</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ] = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">.</span><span class="kr">imax</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;min a_i = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; a[ &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="kr">imin</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ] = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">.</span><span class="kr">imin</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;a&#39; * a = &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">a</span><span class="o">&#39;*</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;a quantile 0.2 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="kr">quantile</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="c1">//Array mapping</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">I</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">];</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">I</span><span class="p">);</span> <span class="c1">//for (i = 0; i &lt; b.n; i++) if (I[i] &gt;= 0) b[i] = a[I[i]];</span>
    <span class="n">c</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span> <span class="c1">//for (i = 0; i &lt; I.n; i++) if (I[i] &gt;= 0) C(I[i]) = a[i];</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b = a(I) : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;c(I) = a &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">c</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">+=</span> <span class="n">a</span><span class="p">;</span> <span class="c1">//for (i = 0; i &lt; I.n; i++) if (I[i] &gt;= 0) C(I[i]) += a[i];</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b = a(I) : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;c(I) = a &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="p">}</span>

<span class="p">{</span>
    <span class="c1">// Array versus matrix</span>
    <span class="kt">int</span> <span class="kr">N</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">]</span> <span class="kp">A</span><span class="p">(</span><span class="kr">N</span><span class="p">,</span> <span class="n">M</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span><span class="p">(</span><span class="kr">N</span><span class="p">),</span> <span class="n">c</span><span class="p">(</span><span class="n">M</span><span class="p">);</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">];</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">];</span>

    <span class="kt">complex</span><span class="p">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">]</span> <span class="n">C</span><span class="p">(</span><span class="kr">N</span><span class="p">,</span> <span class="n">M</span><span class="p">);</span>
    <span class="kt">complex</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">cb</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">cc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="n">i</span><span class="p">,</span> <span class="mi">20</span><span class="n">i</span><span class="p">,</span> <span class="mi">30</span><span class="n">i</span><span class="p">,</span> <span class="mi">40</span><span class="n">i</span><span class="p">];</span>

    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">];</span>

    <span class="kt">int</span> <span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">I</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span>
    <span class="kt">int</span> <span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">J</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">];</span>

    <span class="kp">A</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//set all the matrix</span>
    <span class="kp">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">:</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">//the full line 2</span>
    <span class="kp">A</span><span class="p">(</span><span class="o">:</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">//the full column 1</span>
    <span class="kp">A</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="kr">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">//set the column 2</span>
    <span class="kp">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="o">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">//set the line 1 from 0 to 2</span>

    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="c1">//outer product</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">cc</span><span class="o">&#39;</span><span class="p">;</span>
    <span class="n">C</span> <span class="o">+=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">cc</span><span class="o">&#39;</span><span class="p">;</span>
    <span class="n">C</span> <span class="o">-=</span> <span class="mi">5</span><span class="n">i</span> <span class="o">*</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">cc</span><span class="o">&#39;</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;C = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">C</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="c1">//this transforms an array into a sparse matrix</span>
    <span class="kt">matrix</span> <span class="kp">B</span><span class="p">;</span>
    <span class="kp">B</span> <span class="o">=</span> <span class="kp">A</span><span class="p">;</span>
    <span class="kp">B</span> <span class="o">=</span> <span class="kp">A</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">);</span> <span class="c1">//B(i, j) = A(I(i), J(j))</span>
    <span class="kp">B</span> <span class="o">=</span> <span class="kp">A</span><span class="p">(</span><span class="n">I</span><span class="o">^-</span><span class="mi">1</span><span class="p">,</span> <span class="n">J</span><span class="o">^-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//B(I(i), J(j)) = A(i,j)</span>

    <span class="c1">//outer product</span>
    <span class="kp">A</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span><span class="o">&#39;</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kp">B</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">c</span><span class="o">&#39;</span><span class="p">;</span> <span class="c1">//outer product B(i, j) = b(i)*c(j)</span>
    <span class="kp">B</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">c</span><span class="o">&#39;</span><span class="p">;</span> <span class="c1">//outer product B(i, j) = b(i)*c(j)</span>
    <span class="kp">B</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">c</span><span class="o">&#39;</span><span class="p">)(</span><span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">);</span> <span class="c1">//outer product B(i, j) = b(I(i))*c(J(j))</span>
    <span class="kp">B</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">c</span><span class="o">&#39;</span><span class="p">)(</span><span class="n">I</span><span class="o">^-</span><span class="mi">1</span><span class="p">,</span><span class="n">J</span><span class="o">^-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//outer product B(I(i), J(j)) = b(i)*c(j)</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;B = (3.*b*c&#39;)(I^-1,J^-1) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">B</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="c1">//row and column of the maximal coefficient of A</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">;</span>
    <span class="n">ijmax</span><span class="p">(</span><span class="kp">A</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">);</span>

    <span class="n">i</span> <span class="o">=</span> <span class="kp">A</span><span class="p">.</span><span class="kr">imax</span><span class="p">;</span>
    <span class="n">j</span> <span class="o">=</span> <span class="kp">A</span><span class="p">.</span><span class="n">jmax</span><span class="p">;</span>

    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Max &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A</span><span class="p">.</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="c1">//row and column of the minimal coefficient of A</span>
    <span class="n">ijmin</span><span class="p">(</span><span class="kp">A</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

    <span class="n">ii</span> <span class="o">=</span> <span class="kp">A</span><span class="p">.</span><span class="kr">imin</span><span class="p">;</span>
    <span class="n">jj</span> <span class="o">=</span> <span class="kp">A</span><span class="p">.</span><span class="n">jmin</span><span class="p">;</span>

    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Min &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ii</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">jj</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A</span><span class="p">.</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The output os this script is:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156</pre></div></td><td class="code"><div class="highlight"><pre><span></span>tab: <span class="m">10</span>
    <span class="m">1</span>.03    <span class="m">2</span>.15    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03
    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03

min: <span class="m">1</span>.03
max: <span class="m">2</span>.15
sum: <span class="m">11</span>.42
resized tab: <span class="m">12</span>
    <span class="m">1</span>.03    <span class="m">2</span>.15    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03
    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03
    <span class="m">3</span>.14    <span class="m">3</span>.14
sorted tab:12
    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03
    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">1</span>.03    <span class="m">2</span>.15
    <span class="m">3</span>.14    <span class="m">3</span>.14
tt<span class="o">[</span><span class="s2">&quot;a&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="m">0</span>
tt<span class="o">[</span><span class="s2">&quot;+&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="m">1</span>.5
 <span class="nv">d</span> <span class="o">=</span> <span class="o">(</span> a ? b : c <span class="o">)</span> is <span class="m">5</span>
      <span class="m">2</span>   <span class="m">2</span>   <span class="m">3</span>   <span class="m">2</span>   <span class="m">2</span>

d: <span class="m">5</span>
     -5  -4  -3  -2  -1

ii: <span class="m">5</span>
      <span class="m">4</span>   <span class="m">3</span>   <span class="m">2</span>   <span class="m">1</span>   <span class="m">0</span>

A1<span class="o">(</span><span class="m">2</span>:10<span class="o">)</span>: <span class="m">9</span>
      <span class="m">2</span>   <span class="m">3</span>   <span class="m">4</span>   <span class="m">5</span>   <span class="m">6</span>
      <span class="m">7</span>   <span class="m">8</span>   <span class="m">9</span>  <span class="m">10</span>
A2<span class="o">(</span><span class="m">2</span>:3:10<span class="o">)</span>: <span class="m">9</span>
      <span class="m">2</span>   <span class="m">3</span>   <span class="m">4</span>   <span class="m">5</span>   <span class="m">6</span>
      <span class="m">7</span>   <span class="m">8</span>   <span class="m">9</span>  <span class="m">10</span>
<span class="m">1</span>:2:5 <span class="o">=</span>&gt; <span class="m">3</span>
      <span class="m">1</span>   <span class="m">3</span>   <span class="m">5</span>
A1<span class="o">(</span><span class="m">2</span>:10<span class="o">)</span>: <span class="m">9</span>
      <span class="m">2</span>   <span class="m">3</span>   <span class="m">4</span>   <span class="m">5</span>   <span class="m">6</span>
      <span class="m">7</span>   <span class="m">8</span>   <span class="m">9</span>  <span class="m">10</span>
A2<span class="o">(</span><span class="m">2</span>:3:10<span class="o">)</span>: <span class="m">9</span>
      <span class="m">2</span>   <span class="m">3</span>   <span class="m">4</span>   <span class="m">5</span>   <span class="m">6</span>
      <span class="m">7</span>   <span class="m">8</span>   <span class="m">9</span>  <span class="m">10</span>
<span class="m">1</span>.:0.5:3.999 <span class="o">=</span>&gt; <span class="m">6</span>
      <span class="m">1</span> <span class="m">1</span>.5   <span class="m">2</span> <span class="m">2</span>.5   <span class="m">3</span>
    <span class="m">3</span>.5
 A1<span class="o">(</span><span class="m">2</span>.+0i:10.+0i<span class="o">)</span>: <span class="m">9</span>
    <span class="o">(</span><span class="m">2</span>,0<span class="o">)</span>   <span class="o">(</span><span class="m">3</span>,0<span class="o">)</span>   <span class="o">(</span><span class="m">4</span>,0<span class="o">)</span>   <span class="o">(</span><span class="m">5</span>,0<span class="o">)</span>   <span class="o">(</span><span class="m">6</span>,0<span class="o">)</span>
    <span class="o">(</span><span class="m">7</span>,0<span class="o">)</span>   <span class="o">(</span><span class="m">8</span>,0<span class="o">)</span>   <span class="o">(</span><span class="m">9</span>,0<span class="o">)</span>   <span class="o">(</span><span class="m">10</span>,0<span class="o">)</span>
 A2<span class="o">(</span><span class="m">2</span>.:3.:10.<span class="o">)=</span> <span class="m">3</span>
    <span class="o">(</span><span class="m">2</span>,0<span class="o">)</span>   <span class="o">(</span><span class="m">5</span>,0<span class="o">)</span>   <span class="o">(</span><span class="m">8</span>,0<span class="o">)</span>
 A1.re real part array: <span class="m">9</span>
      <span class="m">2</span>   <span class="m">3</span>   <span class="m">4</span>   <span class="m">5</span>   <span class="m">6</span>
      <span class="m">7</span>   <span class="m">8</span>   <span class="m">9</span>  <span class="m">10</span>
 A1.im imag part array: <span class="m">9</span>
      <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>
      <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>
a: <span class="m">5</span>
      <span class="m">2</span>   <span class="m">1</span>   <span class="m">2</span>   <span class="m">4</span>   <span class="m">4</span>

<span class="nv">b</span> <span class="o">=</span> a + a: <span class="m">5</span>
      <span class="m">4</span>   <span class="m">2</span>   <span class="m">4</span>   <span class="m">8</span>   <span class="m">8</span>

<span class="nv">b</span> <span class="o">+=</span> a: <span class="m">5</span>
      <span class="m">6</span>   <span class="m">3</span>   <span class="m">6</span>  <span class="m">12</span>  <span class="m">12</span>

<span class="nv">b</span> <span class="o">+=</span> <span class="m">2</span>*a: <span class="m">5</span>
     <span class="m">10</span>   <span class="m">5</span>  <span class="m">10</span>  <span class="m">20</span>  <span class="m">20</span>

 b /<span class="o">=</span> <span class="m">2</span>: <span class="m">5</span>
      <span class="m">5</span> <span class="m">2</span>.5   <span class="m">5</span>  <span class="m">10</span>  <span class="m">10</span>

b .*<span class="o">=</span> a: <span class="m">5</span>
     <span class="m">10</span> <span class="m">2</span>.5  <span class="m">10</span>  <span class="m">40</span>  <span class="m">40</span>

b ./<span class="o">=</span> a: <span class="m">5</span>
      <span class="m">5</span> <span class="m">2</span>.5   <span class="m">5</span>  <span class="m">10</span>  <span class="m">10</span>

<span class="nv">c</span> <span class="o">=</span> a + b: <span class="m">5</span>
      <span class="m">7</span> <span class="m">3</span>.5   <span class="m">7</span>  <span class="m">14</span>  <span class="m">14</span>

<span class="nv">c</span> <span class="o">=</span> <span class="m">2</span>*a + 4b: <span class="m">5</span>
     <span class="m">24</span>  <span class="m">12</span>  <span class="m">24</span>  <span class="m">48</span>  <span class="m">48</span>

<span class="nv">c</span> <span class="o">=</span> a + 4b: <span class="m">5</span>
     <span class="m">22</span>  <span class="m">11</span>  <span class="m">22</span>  <span class="m">44</span>  <span class="m">44</span>

<span class="nv">c</span> <span class="o">=</span> -a + 4b: <span class="m">5</span>
     <span class="m">18</span>   <span class="m">9</span>  <span class="m">18</span>  <span class="m">36</span>  <span class="m">36</span>

<span class="nv">c</span> <span class="o">=</span> -a - 4b: <span class="m">5</span>
    -22 -11 -22 -44 -44

<span class="nv">c</span> <span class="o">=</span> -a -b: <span class="m">5</span>
     -7 -3.5     -7 -14 -14

<span class="nv">c</span> <span class="o">=</span> a .* b: <span class="m">5</span>
     <span class="m">10</span> <span class="m">2</span>.5  <span class="m">10</span>  <span class="m">40</span>  <span class="m">40</span>

<span class="nv">c</span> <span class="o">=</span> a ./ b: <span class="m">5</span>
    <span class="m">0</span>.4 <span class="m">0</span>.4 <span class="m">0</span>.4 <span class="m">0</span>.4 <span class="m">0</span>.4

<span class="nv">c</span> <span class="o">=</span> <span class="m">2</span> * b: <span class="m">5</span>
     <span class="m">10</span>   <span class="m">5</span>  <span class="m">10</span>  <span class="m">20</span>  <span class="m">20</span>

<span class="nv">c</span> <span class="o">=</span> b * <span class="m">2</span>: <span class="m">5</span>
     <span class="m">10</span>   <span class="m">5</span>  <span class="m">10</span>  <span class="m">20</span>  <span class="m">20</span>

<span class="o">||</span>a<span class="o">||</span><span class="nv">_1</span> <span class="o">=</span> <span class="m">13</span>
<span class="o">||</span>a<span class="o">||</span><span class="nv">_2</span> <span class="o">=</span> <span class="m">6</span>.40312
<span class="o">||</span>a<span class="o">||</span><span class="nv">_infty</span> <span class="o">=</span> <span class="m">4</span>
sum <span class="nv">a_i</span> <span class="o">=</span> <span class="m">13</span>
max <span class="nv">a_i</span> <span class="o">=</span> <span class="m">4</span> a<span class="o">[</span> <span class="m">3</span> <span class="o">]</span> <span class="o">=</span> <span class="m">4</span>
min <span class="nv">a_i</span> <span class="o">=</span> <span class="m">1</span> a<span class="o">[</span> <span class="m">1</span> <span class="o">]</span> <span class="o">=</span> <span class="m">1</span>
a<span class="s1">&#39; * a = 41</span>
<span class="s1">a quantile 0.2 = 2</span>
<span class="s1">b = a(I) : 5</span>
<span class="s1">      2   4   4  -3   4</span>

<span class="s1">c(I) = a 5</span>
<span class="s1">     -3  -3   2   4   2</span>

<span class="s1">b = a(I) : 5</span>
<span class="s1">      2   4   4  -3   4</span>

<span class="s1">c(I) = a 5</span>
<span class="s1">     -3  -3   4   9   4</span>

<span class="s1">A = 3 4</span>
<span class="s1">       1   5   2   1</span>
<span class="s1">       3   3   3   1</span>
<span class="s1">       4   5   2   4</span>

<span class="s1">C = 3 4</span>
<span class="s1">     (-50,-40) (-100,-80) (-150,-120) (-200,-160)</span>
<span class="s1">     (-100,-80) (-200,-160) (-300,-240) (-400,-320)</span>
<span class="s1">     (-150,-120) (-300,-240) (-450,-360) (-600,-480)</span>

<span class="s1">A = 3 4</span>
<span class="s1">       8  10  12  14</span>
<span class="s1">      16  20  24  28</span>
<span class="s1">      24  30  36  42</span>

<span class="s1">B = (3.*b*c&#39;</span><span class="o">)(</span>I^-1,J^-1<span class="o">)</span> <span class="o">=</span> <span class="c1"># Sparse Matrix (Morse)</span>
<span class="c1"># first line: n m (is symmetic) nbcoef</span>
<span class="c1"># after for each nonzero coefficient:   i j a_ij where (i,j) \in  {1,...,n}x{1,...,m}</span>
<span class="m">3</span> <span class="m">4</span> <span class="m">0</span>  <span class="m">12</span>
        <span class="m">1</span>         <span class="m">1</span> <span class="m">10</span>
        <span class="m">1</span>         <span class="m">2</span> <span class="m">12</span>
        <span class="m">1</span>         <span class="m">3</span> <span class="m">8</span>
        <span class="m">1</span>         <span class="m">4</span> <span class="m">14</span>
        <span class="m">2</span>         <span class="m">1</span> <span class="m">15</span>
        <span class="m">2</span>         <span class="m">2</span> <span class="m">18</span>
        <span class="m">2</span>         <span class="m">3</span> <span class="m">12</span>
        <span class="m">2</span>         <span class="m">4</span> <span class="m">21</span>
        <span class="m">3</span>         <span class="m">1</span> <span class="m">5</span>
        <span class="m">3</span>         <span class="m">2</span> <span class="m">6</span>
        <span class="m">3</span>         <span class="m">3</span> <span class="m">4</span>
        <span class="m">3</span>         <span class="m">4</span> <span class="m">7</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="block-matrix">
<span id="exampleblockmatrix"></span><h3>Block matrix<a class="headerlink" href="#block-matrix" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">real</span> <span class="n">f1</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">f2</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th1</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="kt">mesh</span> <span class="n">Th2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="kr">x</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="kr">y</span><span class="p">]);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th1</span><span class="p">,</span> <span class="n">Th2</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Uh1</span><span class="p">(</span><span class="n">Th1</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Uh1</span> <span class="n">u1</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Uh2</span><span class="p">(</span><span class="n">Th2</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span>
<span class="n">Uh2</span> <span class="n">u2</span><span class="p">;</span>

<span class="c1">// Macro</span>
<span class="kt">macro</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="c1">//</span>

<span class="c1">// Problem</span>
<span class="kt">varf</span> <span class="n">vPoisson1</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th1</span><span class="p">)(</span>
          <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">&#39;</span> <span class="o">*</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th1</span><span class="p">)(</span>
          <span class="n">f1</span> <span class="o">*</span> <span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">vPoisson2</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th2</span><span class="p">)(</span>
          <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">&#39;</span> <span class="o">*</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th2</span><span class="p">)(</span>
          <span class="n">f1</span> <span class="o">*</span> <span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>
<span class="kt">matrix</span><span class="o">&lt;</span><span class="kt">real</span><span class="o">&gt;</span> <span class="n">Poisson1</span> <span class="o">=</span> <span class="n">vPoisson1</span><span class="p">(</span><span class="n">Uh1</span><span class="p">,</span> <span class="n">Uh1</span><span class="p">);</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Poisson1b</span> <span class="o">=</span> <span class="n">vPoisson1</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Uh1</span><span class="p">);</span>

<span class="kt">matrix</span><span class="o">&lt;</span><span class="kt">real</span><span class="o">&gt;</span> <span class="n">Poisson2</span> <span class="o">=</span> <span class="n">vPoisson2</span><span class="p">(</span><span class="n">Uh2</span><span class="p">,</span> <span class="n">Uh2</span><span class="p">);</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Poisson2b</span> <span class="o">=</span> <span class="n">vPoisson2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Uh2</span><span class="p">);</span>

<span class="c1">//block matrix</span>
<span class="kt">matrix</span><span class="o">&lt;</span><span class="kt">real</span><span class="o">&gt;</span> <span class="n">G</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Poisson1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Poisson2</span><span class="p">]];</span>
<span class="nf">set</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">sparsesolver</span><span class="p">);</span>

<span class="c1">//block right hand side</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Gb</span> <span class="o">=</span> <span class="p">[</span><span class="n">Poisson1b</span><span class="p">,</span> <span class="n">Poisson2b</span><span class="p">];</span>

<span class="c1">// Solve</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">sol</span> <span class="o">=</span> <span class="n">G</span><span class="o">^-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">Gb</span><span class="p">;</span>

<span class="c1">// Dispatch</span>
<span class="p">[</span><span class="n">u1</span><span class="p">[],</span> <span class="n">u2</span><span class="p">[]]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id41">
<img alt="../_images/BlockMatrix.png" src="../_images/BlockMatrix.png" />
<p class="caption"><span class="caption-number">Fig. 173 </span><span class="caption-text">Result</span></p>
</div>
</div>
<div class="section" id="matrix-operations">
<span id="examplematrixoperations"></span><h3>Matrix operations<a class="headerlink" href="#matrix-operations" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>
<span class="n">f</span> <span class="o">=</span> <span class="kr">x</span><span class="o">*</span><span class="kr">y</span><span class="p">;</span>
<span class="n">g</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="kr">pi</span><span class="o">*</span><span class="kr">x</span><span class="p">);</span>

<span class="n">Vh</span><span class="o">&lt;</span><span class="kt">complex</span><span class="o">&gt;</span> <span class="n">ff</span><span class="p">,</span> <span class="n">gg</span><span class="p">;</span> <span class="c1">//a complex valued finite element function</span>
<span class="n">ff</span><span class="o">=</span> <span class="kr">x</span><span class="o">*</span><span class="p">(</span><span class="kr">y</span><span class="o">+</span><span class="mi">1</span><span class="n">i</span><span class="p">);</span>
<span class="n">gg</span> <span class="o">=</span> <span class="nf">exp</span><span class="p">(</span><span class="kr">pi</span><span class="o">*</span><span class="kr">x</span><span class="o">*</span><span class="mi">1</span><span class="n">i</span><span class="p">);</span>

<span class="c1">// Problem</span>
<span class="kt">varf</span> <span class="nf">mat</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="mi">1</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">mati</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
         <span class="mi">1</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="mi">2</span><span class="n">i</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span> <span class="n">mat</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
<span class="kt">matrix</span><span class="o">&lt;</span><span class="kt">complex</span><span class="o">&gt;</span> <span class="n">AA</span> <span class="o">=</span> <span class="n">mati</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span> <span class="c1">//a complex sparse matrix</span>

<span class="c1">// Operations</span>
<span class="n">Vh</span> <span class="n">m0</span><span class="p">;</span> <span class="n">m0</span><span class="p">[]</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">f</span><span class="p">[];</span>
<span class="n">Vh</span> <span class="n">m01</span><span class="p">;</span> <span class="n">m01</span><span class="p">[]</span> <span class="o">=</span> <span class="kp">A</span><span class="o">&#39;*</span><span class="n">f</span><span class="p">[];</span>
<span class="n">Vh</span> <span class="n">m1</span><span class="p">;</span> <span class="n">m1</span><span class="p">[]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[].</span><span class="o">*</span><span class="n">g</span><span class="p">[];</span>
<span class="n">Vh</span> <span class="n">m2</span><span class="p">;</span> <span class="n">m2</span><span class="p">[]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[].</span><span class="o">/</span><span class="n">g</span><span class="p">[];</span>

<span class="c1">// Display</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;f = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">f</span><span class="p">[]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;g = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">g</span><span class="p">[]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A = &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">A</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;m0 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m0</span><span class="p">[]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;m01 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m01</span><span class="p">[]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;m1 = &quot;</span><span class="o">&lt;&lt;</span> <span class="n">m1</span><span class="p">[]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;m2 = &quot;</span><span class="o">&lt;&lt;</span> <span class="n">m2</span><span class="p">[]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dot Product = &quot;</span><span class="o">&lt;&lt;</span> <span class="n">f</span><span class="p">[]</span><span class="o">&#39;*</span><span class="n">g</span><span class="p">[]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;hermitien Product = &quot;</span><span class="o">&lt;&lt;</span> <span class="n">ff</span><span class="p">[]</span><span class="o">&#39;*</span><span class="n">gg</span><span class="p">[]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;outer Product = &quot;</span><span class="o">&lt;&lt;</span> <span class="p">(</span><span class="kp">A</span><span class="o">=</span><span class="n">f</span><span class="p">[]</span><span class="o">*</span><span class="n">g</span><span class="p">[]</span><span class="o">&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;hermitien outer Product = &quot;</span><span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">AA</span><span class="o">=</span><span class="n">ff</span><span class="p">[]</span><span class="o">*</span><span class="n">gg</span><span class="p">[]</span><span class="o">&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Diagonal</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">diagofA</span><span class="p">(</span><span class="kp">A</span><span class="p">.</span><span class="kr">n</span><span class="p">);</span>
<span class="n">diagofA</span> <span class="o">=</span> <span class="kp">A</span><span class="p">.</span><span class="kr">diag</span><span class="p">;</span> <span class="c1">//get the diagonal of the matrix</span>
<span class="kp">A</span><span class="p">.</span><span class="kr">diag</span> <span class="o">=</span> <span class="n">diagofA</span> <span class="p">;</span> <span class="c1">//set the diagonal of the matrix</span>

<span class="c1">// Sparse matrix set</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">I</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">J</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">C</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="p">[</span><span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">C</span><span class="p">]</span> <span class="o">=</span> <span class="kp">A</span><span class="p">;</span> <span class="c1">//get the sparse term of the matrix A (the array are resized)</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;I = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">I</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;J = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;C = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">C</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kp">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">C</span><span class="p">];</span> <span class="c1">//set a new matrix</span>
<span class="kt">matrix</span> <span class="n">D</span> <span class="o">=</span> <span class="p">[</span><span class="n">diagofA</span><span class="p">];</span> <span class="c1">//set a diagonal matrix D from the array diagofA</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;D = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">D</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>The output of this script is:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nv">f</span> <span class="o">=</span> <span class="m">6</span>
      <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span> <span class="m">0</span>.5
      <span class="m">1</span>
<span class="nv">g</span> <span class="o">=</span> <span class="m">6</span>
      <span class="m">0</span>   <span class="m">1</span> <span class="m">1</span>.224646799e-16   <span class="m">0</span>   <span class="m">1</span>
    <span class="m">1</span>.224646799e-16
<span class="nv">A</span> <span class="o">=</span> <span class="c1"># Sparse Matrix (Morse)</span>
<span class="c1"># first line: n m (is symmetic) nbcoef</span>
<span class="c1"># after for each nonzero coefficient:   i j a_ij where (i,j) \in  {1,...,n}x{1,...,m}</span>
<span class="m">6</span> <span class="m">6</span> <span class="m">0</span>  <span class="m">24</span>
        <span class="m">1</span>         <span class="m">1</span> <span class="m">1</span>.0000000000000000199e+30
        <span class="m">1</span>         <span class="m">2</span> <span class="m">0</span>.49999999999999994449
        <span class="m">1</span>         <span class="m">4</span> <span class="m">0</span>
        <span class="m">1</span>         <span class="m">5</span> -2.5
        <span class="m">2</span>         <span class="m">1</span> <span class="m">0</span>
        <span class="m">2</span>         <span class="m">2</span> <span class="m">1</span>.0000000000000000199e+30
        <span class="m">2</span>         <span class="m">3</span> <span class="m">0</span>.49999999999999994449
        <span class="m">2</span>         <span class="m">5</span> <span class="m">0</span>.49999999999999977796
        <span class="m">2</span>         <span class="m">6</span> -2.5
        <span class="m">3</span>         <span class="m">2</span> <span class="m">0</span>
        <span class="m">3</span>         <span class="m">3</span> <span class="m">1</span>.0000000000000000199e+30
        <span class="m">3</span>         <span class="m">6</span> <span class="m">0</span>.49999999999999977796
        <span class="m">4</span>         <span class="m">1</span> <span class="m">0</span>.49999999999999977796
        <span class="m">4</span>         <span class="m">4</span> <span class="m">1</span>.0000000000000000199e+30
        <span class="m">4</span>         <span class="m">5</span> <span class="m">0</span>
        <span class="m">5</span>         <span class="m">1</span> -2.5
        <span class="m">5</span>         <span class="m">2</span> <span class="m">0</span>.49999999999999977796
        <span class="m">5</span>         <span class="m">4</span> <span class="m">0</span>.49999999999999994449
        <span class="m">5</span>         <span class="m">5</span> <span class="m">1</span>.0000000000000000199e+30
        <span class="m">5</span>         <span class="m">6</span> <span class="m">0</span>
        <span class="m">6</span>         <span class="m">2</span> -2.5
        <span class="m">6</span>         <span class="m">3</span> <span class="m">0</span>
        <span class="m">6</span>         <span class="m">5</span> <span class="m">0</span>.49999999999999994449
        <span class="m">6</span>         <span class="m">6</span> <span class="m">1</span>.0000000000000000199e+30

<span class="nv">m0</span> <span class="o">=</span> <span class="m">6</span>
    -1.25   -2.25   <span class="m">0</span>.5   <span class="m">0</span> 5e+29
    1e+30
<span class="nv">m01</span> <span class="o">=</span> <span class="m">6</span>
    -1.25   -2.25     <span class="m">0</span> <span class="m">0</span>.25    5e+29
    1e+30
<span class="nv">m1</span> <span class="o">=</span> <span class="m">6</span>
      <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span> <span class="m">0</span>.5
    <span class="m">1</span>.224646799e-16
<span class="nv">m2</span> <span class="o">=</span> <span class="m">6</span>
    -nan      <span class="m">0</span>   <span class="m">0</span> -nan    <span class="m">0</span>.5
    <span class="m">8</span>.165619677e+15
dot <span class="nv">Product</span> <span class="o">=</span> <span class="m">0</span>.5
hermitien <span class="nv">Product</span> <span class="o">=</span> <span class="o">(</span><span class="m">1</span>.11022e-16,2.5<span class="o">)</span>
outer <span class="nv">Product</span> <span class="o">=</span> <span class="c1"># Sparse Matrix (Morse)</span>
<span class="c1"># first line: n m (is symmetic) nbcoef</span>
<span class="c1"># after for each nonzero coefficient:   i j a_ij where (i,j) \in  {1,...,n}x{1,...,m}</span>
<span class="m">6</span> <span class="m">6</span> <span class="m">0</span>  <span class="m">8</span>
        <span class="m">5</span>         <span class="m">2</span> <span class="m">0</span>.5
        <span class="m">5</span>         <span class="m">3</span> <span class="m">6</span>.1232339957367660359e-17
        <span class="m">5</span>         <span class="m">5</span> <span class="m">0</span>.5
        <span class="m">5</span>         <span class="m">6</span> <span class="m">6</span>.1232339957367660359e-17
        <span class="m">6</span>         <span class="m">2</span> <span class="m">1</span>
        <span class="m">6</span>         <span class="m">3</span> <span class="m">1</span>.2246467991473532072e-16
        <span class="m">6</span>         <span class="m">5</span> <span class="m">1</span>
        <span class="m">6</span>         <span class="m">6</span> <span class="m">1</span>.2246467991473532072e-16

hermitien outer <span class="nv">Product</span> <span class="o">=</span> <span class="c1"># Sparse Matrix (Morse)</span>
<span class="c1"># first line: n m (is symmetic) nbcoef</span>
<span class="c1"># after for each nonzero coefficient:   i j a_ij where (i,j) \in  {1,...,n}x{1,...,m}</span>
<span class="m">6</span> <span class="m">6</span> <span class="m">0</span>  <span class="m">24</span>
        <span class="m">2</span>         <span class="m">1</span> <span class="o">(</span><span class="m">0</span>,0.5<span class="o">)</span>
        <span class="m">2</span>         <span class="m">2</span> <span class="o">(</span><span class="m">0</span>.5,3.0616169978683830179e-17<span class="o">)</span>
        <span class="m">2</span>         <span class="m">3</span> <span class="o">(</span><span class="m">6</span>.1232339957367660359e-17,-0.5<span class="o">)</span>
        <span class="m">2</span>         <span class="m">4</span> <span class="o">(</span><span class="m">0</span>,0.5<span class="o">)</span>
        <span class="m">2</span>         <span class="m">5</span> <span class="o">(</span><span class="m">0</span>.5,3.0616169978683830179e-17<span class="o">)</span>
        <span class="m">2</span>         <span class="m">6</span> <span class="o">(</span><span class="m">6</span>.1232339957367660359e-17,-0.5<span class="o">)</span>
        <span class="m">3</span>         <span class="m">1</span> <span class="o">(</span><span class="m">0</span>,1<span class="o">)</span>
        <span class="m">3</span>         <span class="m">2</span> <span class="o">(</span><span class="m">1</span>,6.1232339957367660359e-17<span class="o">)</span>
        <span class="m">3</span>         <span class="m">3</span> <span class="o">(</span><span class="m">1</span>.2246467991473532072e-16,-1<span class="o">)</span>
        <span class="m">3</span>         <span class="m">4</span> <span class="o">(</span><span class="m">0</span>,1<span class="o">)</span>
        <span class="m">3</span>         <span class="m">5</span> <span class="o">(</span><span class="m">1</span>,6.1232339957367660359e-17<span class="o">)</span>
        <span class="m">3</span>         <span class="m">6</span> <span class="o">(</span><span class="m">1</span>.2246467991473532072e-16,-1<span class="o">)</span>
        <span class="m">5</span>         <span class="m">1</span> <span class="o">(</span><span class="m">0</span>.5,0.5<span class="o">)</span>
        <span class="m">5</span>         <span class="m">2</span> <span class="o">(</span><span class="m">0</span>.5,-0.49999999999999994449<span class="o">)</span>
        <span class="m">5</span>         <span class="m">3</span> <span class="o">(</span>-0.49999999999999994449,-0.50000000000000011102<span class="o">)</span>
        <span class="m">5</span>         <span class="m">4</span> <span class="o">(</span><span class="m">0</span>.5,0.5<span class="o">)</span>
        <span class="m">5</span>         <span class="m">5</span> <span class="o">(</span><span class="m">0</span>.5,-0.49999999999999994449<span class="o">)</span>
        <span class="m">5</span>         <span class="m">6</span> <span class="o">(</span>-0.49999999999999994449,-0.50000000000000011102<span class="o">)</span>
        <span class="m">6</span>         <span class="m">1</span> <span class="o">(</span><span class="m">1</span>,1<span class="o">)</span>
        <span class="m">6</span>         <span class="m">2</span> <span class="o">(</span><span class="m">1</span>,-0.99999999999999988898<span class="o">)</span>
        <span class="m">6</span>         <span class="m">3</span> <span class="o">(</span>-0.99999999999999988898,-1.000000000000000222<span class="o">)</span>
        <span class="m">6</span>         <span class="m">4</span> <span class="o">(</span><span class="m">1</span>,1<span class="o">)</span>
        <span class="m">6</span>         <span class="m">5</span> <span class="o">(</span><span class="m">1</span>,-0.99999999999999988898<span class="o">)</span>
        <span class="m">6</span>         <span class="m">6</span> <span class="o">(</span>-0.99999999999999988898,-1.000000000000000222<span class="o">)</span>

<span class="nv">I</span> <span class="o">=</span> <span class="m">8</span>
      <span class="m">4</span>   <span class="m">4</span>   <span class="m">4</span>   <span class="m">4</span>   <span class="m">5</span>
      <span class="m">5</span>   <span class="m">5</span>   <span class="m">5</span>
<span class="nv">J</span> <span class="o">=</span> <span class="m">8</span>
      <span class="m">1</span>   <span class="m">2</span>   <span class="m">4</span>   <span class="m">5</span>   <span class="m">1</span>
      <span class="m">2</span>   <span class="m">4</span>   <span class="m">5</span>
<span class="nv">C</span> <span class="o">=</span> <span class="m">8</span>
    <span class="m">0</span>.5 <span class="m">6</span>.123233996e-17 <span class="m">0</span>.5 <span class="m">6</span>.123233996e-17   <span class="m">1</span>
    <span class="m">1</span>.224646799e-16   <span class="m">1</span> <span class="m">1</span>.224646799e-16
  -- Raw Matrix    <span class="nv">nxm</span>  <span class="o">=</span>6x6 nb  none zero coef. <span class="m">8</span>
  -- Raw Matrix    <span class="nv">nxm</span>  <span class="o">=</span>6x6 nb  none zero coef. <span class="m">6</span>
<span class="nv">D</span> <span class="o">=</span> <span class="c1"># Sparse Matrix (Morse)</span>
<span class="c1"># first line: n m (is symmetic) nbcoef</span>
<span class="c1"># after for each nonzero coefficient:   i j a_ij where (i,j) \in  {1,...,n}x{1,...,m}</span>
<span class="m">6</span> <span class="m">6</span> <span class="m">1</span>  <span class="m">6</span>
        <span class="m">1</span>         <span class="m">1</span> <span class="m">0</span>
        <span class="m">2</span>         <span class="m">2</span> <span class="m">0</span>
        <span class="m">3</span>         <span class="m">3</span> <span class="m">0</span>
        <span class="m">4</span>         <span class="m">4</span> <span class="m">0</span>
        <span class="m">5</span>         <span class="m">5</span> <span class="m">0</span>.5
        <span class="m">6</span>         <span class="m">6</span> <span class="m">1</span>.2246467991473532072e-16
</pre></div>
</td></tr></table></div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Due to <code class="docutils literal highlight highlight-default"><span></span><span class="n">Fortran</span></code> indices starting at one, the output of a diagonal matrix <code class="docutils literal highlight highlight-default"><span></span><span class="n">D</span></code> is indexed from 1. but in <strong>FreeFem++</strong>, the indices start from 0.</p>
</div>
</div>
<div class="section" id="matrix-inversion">
<span id="examplematrixinversion"></span><h3>Matrix inversion<a class="headerlink" href="#matrix-inversion" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;lapack&quot;</span>
<span class="cp">load</span> <span class="s">&quot;fflapack&quot;</span>

<span class="c1">// Matrix</span>
<span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">]</span> <span class="kp">A</span><span class="p">(</span><span class="kr">n</span><span class="p">,</span> <span class="kr">n</span><span class="p">),</span> <span class="kp">A1</span><span class="p">(</span><span class="kr">n</span><span class="p">,</span> <span class="kr">n</span><span class="p">),</span> <span class="kp">B</span><span class="p">(</span><span class="kr">n</span><span class="p">,</span><span class="kr">n</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kr">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="kr">n</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="kp">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span> <span class="o">?</span> <span class="kr">n</span><span class="o">+</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kp">A</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Inversion (lapack)</span>
<span class="kp">A1</span> <span class="o">=</span> <span class="kp">A</span><span class="o">^-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//def in &quot;lapack&quot;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kp">A1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kp">B</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kr">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="kr">n</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="kr">n</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span>
            <span class="kp">B</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">+=</span> <span class="kp">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="kp">A1</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kp">B</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Inversion (fflapack)</span>
<span class="n">inv</span><span class="p">(</span><span class="kp">A1</span><span class="p">);</span> <span class="c1">//def in &quot;fflapack&quot;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kp">A1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>The output of this script is:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="m">5</span> <span class="m">5</span>
       <span class="m">6</span>   <span class="m">1</span>   <span class="m">1</span>   <span class="m">1</span>   <span class="m">1</span>
       <span class="m">1</span>   <span class="m">6</span>   <span class="m">1</span>   <span class="m">1</span>   <span class="m">1</span>
       <span class="m">1</span>   <span class="m">1</span>   <span class="m">6</span>   <span class="m">1</span>   <span class="m">1</span>
       <span class="m">1</span>   <span class="m">1</span>   <span class="m">1</span>   <span class="m">6</span>   <span class="m">1</span>
       <span class="m">1</span>   <span class="m">1</span>   <span class="m">1</span>   <span class="m">1</span>   <span class="m">6</span>

<span class="m">5</span> <span class="m">5</span>
     <span class="m">0</span>.18 -0.02 -0.02 -0.02 -0.02
     -0.02 <span class="m">0</span>.18 -0.02 -0.02 -0.02
     -0.02 -0.02 <span class="m">0</span>.18 -0.02 -0.02
     -0.02 -0.02 -0.02 <span class="m">0</span>.18 -0.02
     -0.02 -0.02 -0.02 -0.02 <span class="m">0</span>.18

<span class="m">5</span> <span class="m">5</span>
       <span class="m">1</span> <span class="m">1</span>.040834086e-17 <span class="m">1</span>.040834086e-17 <span class="m">1</span>.734723476e-17 <span class="m">2</span>.775557562e-17
     <span class="m">3</span>.469446952e-18   <span class="m">1</span> -1.734723476e-17 <span class="m">1</span>.734723476e-17 <span class="m">2</span>.775557562e-17
     <span class="m">2</span>.428612866e-17 -3.122502257e-17   <span class="m">1</span> <span class="m">1</span>.734723476e-17 <span class="m">2</span>.775557562e-17
     <span class="m">2</span>.081668171e-17 -6.938893904e-17 -3.469446952e-17   <span class="m">1</span>   <span class="m">0</span>
     <span class="m">2</span>.775557562e-17 -4.163336342e-17 -2.775557562e-17   <span class="m">0</span>   <span class="m">1</span>

<span class="m">5</span> <span class="m">5</span>
       <span class="m">6</span>   <span class="m">1</span>   <span class="m">1</span>   <span class="m">1</span>   <span class="m">1</span>
       <span class="m">1</span>   <span class="m">6</span>   <span class="m">1</span>   <span class="m">1</span>   <span class="m">1</span>
       <span class="m">1</span>   <span class="m">1</span>   <span class="m">6</span>   <span class="m">1</span>   <span class="m">1</span>
       <span class="m">1</span>   <span class="m">1</span>   <span class="m">1</span>   <span class="m">6</span>   <span class="m">1</span>
       <span class="m">1</span>   <span class="m">1</span>   <span class="m">1</span>   <span class="m">1</span>   <span class="m">6</span>
</pre></div>
</td></tr></table></div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>To compile <code class="docutils literal highlight highlight-default"><span></span><span class="n">lapack</span><span class="o">.</span><span class="n">cpp</span></code> and <code class="docutils literal highlight highlight-default"><span></span><span class="n">fflapack</span><span class="o">.</span><span class="n">cpp</span></code>, you must have the <code class="docutils literal highlight highlight-default"><span></span><span class="n">lapack</span></code> library on your system and compile the plugin with the command:</p>
<div class="last highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>ff-c++ lapack.cpp -llapack     ff-c++ fflapack.cpp -llapack
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="fe-array">
<span id="examplefearray"></span><h3>FE array<a class="headerlink" href="#fe-array" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="kr">x</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">y</span><span class="p">]);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">f</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="nf">Poisson</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="n">Vh</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">uu</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="c1">//an array of FE function</span>
<span class="c1">// Solve problem 1</span>
<span class="n">f</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">Poisson</span><span class="p">;</span>
<span class="n">uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
<span class="c1">// Solve problem 2</span>
<span class="n">f</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="kr">pi</span><span class="o">*</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">pi</span><span class="o">*</span><span class="kr">y</span><span class="p">);</span>
<span class="n">Poisson</span><span class="p">;</span>
<span class="n">uu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
<span class="c1">// Solve problem 3</span>
<span class="n">f</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="kr">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nf">abs</span><span class="p">(</span><span class="kr">y</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="n">Poisson</span><span class="p">;</span>
<span class="n">uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

<span class="c1">// Plot</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">uu</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="inline3 figure" id="id42">
<img alt="../_images/FEArray1.png" src="../_images/FEArray1.png" />
<p class="caption"><span class="caption-number">Fig. 174 </span><span class="caption-text">First result</span></p>
</div>
<div class="inline3 figure" id="id43">
<img alt="../_images/FEArray2.png" src="../_images/FEArray2.png" />
<p class="caption"><span class="caption-number">Fig. 175 </span><span class="caption-text">Second result</span></p>
</div>
<div class="inline3 figure" id="id44">
<img alt="../_images/FEArray3.png" src="../_images/FEArray3.png" />
<p class="caption"><span class="caption-number">Fig. 176 </span><span class="caption-text">Third result</span></p>
</div>
</div>
<div class="section" id="loop">
<span id="exampleloop"></span><h3>Loop<a class="headerlink" href="#loop" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">real</span> <span class="kp">eps</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="kp">eps</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">){</span>
    <span class="kp">eps</span> <span class="o">=</span> <span class="kp">eps</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kp">eps</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;j = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="implicit-loop">
<span id="exampleimplicitloop"></span><h3>Implicit loop<a class="headerlink" href="#implicit-loop" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">real</span> <span class="p">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">]</span> <span class="n">a</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="kt">real</span> <span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="k">for</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="nl">bi</span> <span class="o">:</span> <span class="n">b</span><span class="p">]{</span>
    <span class="n">bi</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">bi</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;b = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="k">for</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="nl">aij</span> <span class="o">:</span> <span class="n">a</span><span class="p">]{</span>
    <span class="n">aij</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">aij</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">)</span> <span class="n">aij</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;a = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
<span class="kt">string</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span> <span class="n">ss</span><span class="p">;</span> <span class="c1">//a map</span>
<span class="n">ss</span><span class="p">[</span><span class="s">&quot;1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">ss</span><span class="p">[</span><span class="s">&quot;2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">ss</span><span class="p">[</span><span class="s">&quot;3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">for</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="nl">bi</span> <span class="o">:</span> <span class="n">ss</span><span class="p">]</span>
    <span class="n">bi</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="s">&quot;-dddd&quot;</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ss = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">int</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span> <span class="n">si</span><span class="p">;</span>
<span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">si</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">for</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="nl">vi</span> <span class="o">:</span> <span class="n">si</span><span class="p">]{</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; i &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">setw</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">setw</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">vi</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">vi</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;si = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">si</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="k">for</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="nl">aij</span> <span class="o">:</span> <span class="kp">A</span><span class="p">]{</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">aij</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">aij</span> <span class="o">=</span> <span class="o">-</span><span class="n">aij</span><span class="p">;</span>
<span class="p">}</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kp">A</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>The output of this script is:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="m">0</span> <span class="m">1</span>
<span class="m">1</span> <span class="m">2</span>
<span class="m">2</span> <span class="m">3</span>
<span class="m">3</span> <span class="m">4</span>
<span class="m">4</span> <span class="m">5</span>
<span class="m">5</span> <span class="m">6</span>
<span class="m">6</span> <span class="m">7</span>
<span class="m">7</span> <span class="m">8</span>
<span class="m">8</span> <span class="m">9</span>
<span class="m">9</span> <span class="m">10</span>
<span class="nv">b</span> <span class="o">=</span> <span class="m">10</span>
      <span class="m">1</span>   <span class="m">2</span>   <span class="m">3</span>   <span class="m">4</span>   <span class="m">5</span>
      <span class="m">6</span>   <span class="m">7</span>   <span class="m">8</span>   <span class="m">9</span>  <span class="m">10</span>

<span class="nv">a</span> <span class="o">=</span> <span class="m">10</span> <span class="m">10</span>
     <span class="m">0</span>.5 <span class="m">0</span>.3333333333 <span class="m">0</span>.25 <span class="m">0</span>.2   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>
     <span class="m">0</span>.3333333333 <span class="m">0</span>.25 <span class="m">0</span>.2   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>
     <span class="m">0</span>.25 <span class="m">0</span>.2   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>
     <span class="m">0</span>.2   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>
       <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>
       <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>
       <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>
       <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>
       <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>
       <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>   <span class="m">0</span>

<span class="nv">ss</span> <span class="o">=</span> <span class="m">1</span> <span class="m">1</span>
<span class="m">2</span> <span class="m">2</span>
<span class="m">3</span> <span class="m">5</span>

 i   <span class="m">1</span>          <span class="m">2</span>
 i  <span class="m">50</span>          <span class="m">1</span>
<span class="nv">si</span> <span class="o">=</span> <span class="m">1</span> <span class="m">2</span>
<span class="m">50</span> <span class="m">100</span>

<span class="m">0</span> <span class="m">0</span> <span class="m">0</span>.5
<span class="m">0</span> <span class="m">1</span> <span class="m">0</span>.333333
<span class="m">0</span> <span class="m">2</span> <span class="m">0</span>.25
<span class="m">0</span> <span class="m">3</span> <span class="m">0</span>.2
<span class="m">1</span> <span class="m">0</span> <span class="m">0</span>.333333
<span class="m">1</span> <span class="m">1</span> <span class="m">0</span>.25
<span class="m">1</span> <span class="m">2</span> <span class="m">0</span>.2
<span class="m">2</span> <span class="m">0</span> <span class="m">0</span>.25
<span class="m">2</span> <span class="m">1</span> <span class="m">0</span>.2
<span class="m">3</span> <span class="m">0</span> <span class="m">0</span>.2
<span class="c1"># Sparse Matrix (Morse)</span>
<span class="c1"># first line: n m (is symmetic) nbcoef</span>
<span class="c1"># after for each nonzero coefficient:   i j a_ij where (i,j) \in  {1,...,n}x{1,...,m}</span>
<span class="m">10</span> <span class="m">10</span> <span class="m">0</span>  <span class="m">10</span>
        <span class="m">1</span>         <span class="m">1</span> -0.5
        <span class="m">1</span>         <span class="m">2</span> -0.33333333333333331483
        <span class="m">1</span>         <span class="m">3</span> -0.25
        <span class="m">1</span>         <span class="m">4</span> -0.2000000000000000111
        <span class="m">2</span>         <span class="m">1</span> -0.33333333333333331483
        <span class="m">2</span>         <span class="m">2</span> -0.25
        <span class="m">2</span>         <span class="m">3</span> -0.2000000000000000111
        <span class="m">3</span>         <span class="m">1</span> -0.25
        <span class="m">3</span>         <span class="m">2</span> -0.2000000000000000111
        <span class="m">4</span>         <span class="m">1</span> -0.2000000000000000111
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="i-o">
<span id="exampleio"></span><h3>I/O<a class="headerlink" href="#i-o" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;std-out&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; enter i = ?&quot;</span><span class="p">;</span>
<span class="kr">cin</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">;</span>

<span class="p">{</span>
    <span class="kt">ofstream</span> <span class="n">f</span><span class="p">(</span><span class="s">&quot;toto.txt&quot;</span><span class="p">);</span>
    <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;hello world&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">//close the file f because the variable f is delete</span>

<span class="p">{</span>
    <span class="kt">ifstream</span> <span class="n">f</span><span class="p">(</span><span class="s">&quot;toto.txt&quot;</span><span class="p">);</span>
    <span class="n">f</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">{</span>
    <span class="kt">ofstream</span> <span class="n">f</span><span class="p">(</span><span class="s">&quot;toto.txt&quot;</span><span class="p">,</span> <span class="kr">append</span><span class="p">);</span>
    <span class="c1">//to append to the existing file &quot;toto.txt&quot;</span>
    <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;hello world&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">//close the file f because the variable f is delete</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="file-stream">
<span id="examplefilestream"></span><h3>File stream<a class="headerlink" href="#file-stream" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">where</span><span class="p">;</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">];</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">g</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

<span class="p">{</span>
    <span class="kt">ofstream</span> <span class="kp">file</span><span class="p">(</span><span class="s">&quot;f.txt&quot;</span><span class="p">,</span> <span class="kr">binary</span><span class="p">);</span>
    <span class="kp">file</span><span class="p">.</span><span class="kr">precision</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
    <span class="kp">file</span> <span class="o">&lt;&lt;</span> <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">where</span> <span class="o">=</span> <span class="kp">file</span><span class="p">.</span><span class="kr">tellp</span><span class="p">();</span>
    <span class="kp">file</span> <span class="o">&lt;&lt;</span> <span class="mf">0.1</span> <span class="p">;</span>

    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Where in file &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">where</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kp">file</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; # comment bla bla ... 0.3 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="kp">file</span> <span class="o">&lt;&lt;</span> <span class="mf">0.2</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kp">file</span><span class="p">.</span><span class="kr">flush</span><span class="p">;</span> <span class="c1">//to flush the buffer of file</span>
<span class="p">}</span>

<span class="c1">//Function to skip comment starting with # in a file</span>
<span class="kt">func</span> <span class="kt">ifstream</span> <span class="n">skipcomment</span><span class="p">(</span><span class="kt">ifstream</span> <span class="o">&amp;</span><span class="n">ff</span><span class="p">){</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">where</span> <span class="o">=</span> <span class="n">ff</span><span class="p">.</span><span class="nf">tellg</span><span class="p">();</span> <span class="c1">//store file position</span>
        <span class="kt">string</span> <span class="n">comment</span><span class="p">;</span>
        <span class="n">ff</span> <span class="o">&gt;&gt;</span> <span class="n">comment</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ff</span><span class="p">.</span><span class="kr">good</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">comment</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="s">&quot;</span><span class="o">#</span><span class="s">&quot;</span><span class="p">){</span>
            <span class="nf">getline</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">comment</span><span class="p">);</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; -- #&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">comment</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span><span class="p">{</span>
            <span class="n">ff</span><span class="p">.</span><span class="nf">seekg</span><span class="p">(</span><span class="n">where</span><span class="p">);</span> <span class="c1">//restore file position</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ff</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">{</span>
    <span class="kt">real</span> <span class="n">xx</span><span class="p">;</span>
    <span class="kt">ifstream</span> <span class="kp">file</span><span class="p">(</span><span class="s">&quot;f.txt&quot;</span><span class="p">,</span> <span class="kr">binary</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Where &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">file</span><span class="p">.</span><span class="nf">seekg</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kp">file</span><span class="p">.</span><span class="nf">seekg</span><span class="p">(</span><span class="n">where</span><span class="p">);</span>
    <span class="kp">file</span> <span class="o">&gt;&gt;</span> <span class="n">xx</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; xx = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">xx</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; good ? &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">file</span><span class="p">.</span><span class="kr">good</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">xx</span> <span class="o">==</span> <span class="mf">0.1</span><span class="p">);</span>
    <span class="n">skipcomment</span><span class="p">(</span><span class="kp">file</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">xx</span><span class="p">;</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">xx</span> <span class="o">==</span> <span class="mf">0.2</span><span class="p">);</span>
    <span class="kp">file</span><span class="p">.</span><span class="nf">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">//rewind</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Where &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">file</span><span class="p">.</span><span class="nf">tellg</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">file</span><span class="p">.</span><span class="kr">good</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="kp">file</span> <span class="o">&gt;&gt;</span> <span class="n">g</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="command-line-arguments">
<span id="examplecommandlinearguments"></span><h3>Command line arguments<a class="headerlink" href="#command-line-arguments" title="Permalink to this headline">¶</a></h3>
<p>When using the command:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>FreeFem++ script.edp arg1 arg2
</pre></div>
</td></tr></table></div>
<p>The arguments can be used in the script with:</p>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kr">ARGV</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kr">ARGV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>When using the command:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>FreeFem++ script.edp -n <span class="m">10</span> -a <span class="m">1</span>. -d <span class="m">42</span>.
</pre></div>
</td></tr></table></div>
<p>The arguments can be used in the script with:</p>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">include</span> <span class="s">&quot;getARGV.idp&quot;</span>

<span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="nf">getARGV</span><span class="p">(</span><span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="kt">real</span> <span class="n">a</span> <span class="o">=</span> <span class="nf">getARGV</span><span class="p">(</span><span class="s">&quot;-a&quot;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">);</span>
<span class="kt">real</span> <span class="nf">d</span> <span class="o">=</span> <span class="nf">getARGV</span><span class="p">(</span><span class="s">&quot;-d&quot;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="macro">
<span id="examplemacro"></span><h3>Macro<a class="headerlink" href="#macro" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Macro without parameters</span>
<span class="kt">macro</span> <span class="nf">xxx</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">real</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span><span class="c1">//</span>

<span class="n">xxx</span>

<span class="c1">// Macro with parameters</span>
<span class="kt">macro</span> <span class="n">toto</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="n">i</span> <span class="c1">//</span>

<span class="n">toto</span><span class="p">({</span><span class="kt">real</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;})</span>

<span class="c1">// Macro as parameter of a macro</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">,</span><span class="kt">int</span><span class="p">]</span> <span class="n">CC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">EE</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">EEps</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

<span class="kt">macro</span> <span class="nf">VIL6</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">[</span><span class="n">v</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">i</span><span class="p">)]</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">VIL3</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">[</span><span class="n">v</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">)]</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">VV6</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vv</span><span class="p">)</span> <span class="p">[</span>
    <span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">6</span><span class="p">)]</span> <span class="c1">//</span>
<span class="kt">macro</span> <span class="n">VV3</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vv</span><span class="p">)</span> <span class="p">[</span><span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span> <span class="c1">//</span>

<span class="kt">func</span> <span class="n">C5x5</span> <span class="o">=</span> <span class="n">VV6</span><span class="p">(</span><span class="n">VIL6</span><span class="p">,</span> <span class="n">CC</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">E5x2</span> <span class="o">=</span> <span class="n">VV6</span><span class="p">(</span><span class="n">VIL3</span><span class="p">,</span> <span class="n">EE</span><span class="p">);</span>
<span class="kt">func</span> <span class="n">Eps</span> <span class="o">=</span> <span class="n">VV3</span><span class="p">(</span><span class="n">VIL3</span><span class="p">,</span> <span class="n">EEps</span><span class="p">);</span>

<span class="c1">// Macro concatenation</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">Ux</span><span class="o">=</span><span class="kr">x</span><span class="p">,</span> <span class="n">Uy</span><span class="o">=</span><span class="kr">y</span><span class="p">;</span>

<span class="kt">macro</span> <span class="n">div</span><span class="p">(</span><span class="n">V</span><span class="p">)</span> <span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">V</span><span class="o">#</span><span class="kr">x</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">V</span><span class="o">#</span><span class="kr">y</span><span class="p">))</span> <span class="c1">//</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">div</span><span class="p">(</span><span class="n">U</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Verify the quoting</span>
<span class="kt">macro</span> <span class="nf">foo</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">i</span> <span class="n">j</span> <span class="n">k</span> <span class="c1">//</span>
<span class="n">foo</span><span class="p">(,</span> <span class="p">,</span> <span class="p">)</span>
<span class="n">foo</span><span class="p">({</span><span class="kt">int</span><span class="p">[},</span> <span class="p">{</span><span class="kt">int</span><span class="p">]</span> <span class="n">a</span><span class="p">(</span><span class="mi">10</span><span class="p">},</span> <span class="p">{);})</span>

<span class="c1">//NewMacro - EndMacro</span>
<span class="kt">NewMacro</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="kt">EndMacro</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">grad</span><span class="p">(</span><span class="n">Ux</span><span class="p">)</span><span class="o">&#39;</span> <span class="o">*</span> <span class="n">grad</span><span class="p">(</span><span class="n">Uy</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// IFMACRO - ENDIFMACRO</span>
<span class="kt">macro</span> <span class="n">AA</span> <span class="n">CAS1</span> <span class="c1">//</span>

<span class="cp">IFMACRO</span><span class="p">(</span><span class="n">AA</span><span class="p">,</span><span class="n">CAS1</span> <span class="p">)</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;AA = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">Stringification</span><span class="p">(</span><span class="n">AA</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kt">macro</span> <span class="n">CASE</span> <span class="n">file1</span><span class="p">.</span><span class="n">edp</span><span class="c1">//</span>
<span class="cp">ENDIFMACRO</span>
<span class="cp">IFMACRO</span><span class="p">(</span><span class="n">AA</span><span class="p">,</span> <span class="n">CAS2</span><span class="p">)</span>
<span class="kt">macro</span> <span class="n">CASE</span> <span class="n">file2</span><span class="p">.</span><span class="n">edp</span><span class="c1">//</span>
<span class="cp">ENDIFMACRO</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;CASE = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">Stringification</span><span class="p">(</span><span class="n">CASE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="cp">IFMACRO</span><span class="p">(</span><span class="n">CASE</span><span class="p">)</span>
<span class="cp">include</span> <span class="nf">Stringification</span><span class="p">(</span><span class="n">CASE</span><span class="p">)</span>
<span class="cp">ENDIFMACRO</span>

<span class="c1">// FILE - LINE</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;In &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">FILE</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, line &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">LINE</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>The output script generated with macros is:</p>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="o">:</span> <span class="c1">// Macro without parameters</span>
<span class="mi">2</span> <span class="o">:</span>  <span class="kt">macro</span> <span class="n">xxx</span> <span class="p">{</span>
<span class="mi">3</span> <span class="o">:</span>     <span class="kt">real</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">4</span> <span class="o">:</span>     <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">5</span> <span class="o">:</span>     <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="mi">6</span> <span class="o">:</span> <span class="p">}</span><span class="c1">//</span>
<span class="mi">7</span> <span class="o">:</span>
<span class="mi">8</span> <span class="o">:</span>
<span class="mi">1</span> <span class="o">:</span>
<span class="mi">2</span> <span class="o">:</span>
<span class="mi">3</span> <span class="o">:</span>
<span class="mi">4</span> <span class="o">:</span>  <span class="p">{</span>
<span class="mi">1</span> <span class="o">:</span>     <span class="kt">real</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">2</span> <span class="o">:</span>     <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">3</span> <span class="o">:</span>     <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="mi">4</span> <span class="o">:</span> <span class="p">}</span>
<span class="mi">9</span> <span class="o">:</span>
<span class="mi">10</span> <span class="o">:</span> <span class="c1">// Macro with parameters</span>
<span class="mi">11</span> <span class="o">:</span>  <span class="kt">macro</span> <span class="n">toto</span><span class="p">(</span><span class="n">i</span> <span class="p">)</span>   <span class="n">i</span> <span class="c1">//</span>
<span class="mi">12</span> <span class="o">:</span>
<span class="mi">13</span> <span class="o">:</span>                    <span class="kt">real</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="mi">14</span> <span class="o">:</span>
<span class="mi">15</span> <span class="o">:</span> <span class="c1">// Macro as parameter of a macro</span>
<span class="mi">16</span> <span class="o">:</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">,</span><span class="kt">int</span><span class="p">]</span> <span class="n">CC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">EE</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">EEps</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="mi">17</span> <span class="o">:</span>
<span class="mi">18</span> <span class="o">:</span>   <span class="kt">macro</span> <span class="n">VIL6</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">i</span> <span class="p">)</span>   <span class="p">[</span><span class="n">v</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">i</span><span class="p">)]</span> <span class="c1">//</span>
<span class="mi">19</span> <span class="o">:</span>   <span class="kt">macro</span> <span class="n">VIL3</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">i</span> <span class="p">)</span>   <span class="p">[</span><span class="n">v</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">)]</span> <span class="c1">//</span>
<span class="mi">20</span> <span class="o">:</span>   <span class="kt">macro</span> <span class="n">VV6</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">vv</span> <span class="p">)</span>   <span class="p">[</span>
<span class="mi">21</span> <span class="o">:</span>    <span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="mi">22</span> <span class="o">:</span>    <span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
<span class="mi">23</span> <span class="o">:</span>    <span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">6</span><span class="p">)]</span> <span class="c1">//</span>
<span class="mi">24</span> <span class="o">:</span>   <span class="kt">macro</span> <span class="n">VV3</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">vv</span> <span class="p">)</span>   <span class="p">[</span><span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">v</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span> <span class="c1">//</span>
<span class="mi">25</span> <span class="o">:</span>
<span class="mi">26</span> <span class="o">:</span> <span class="kt">func</span> <span class="n">C5x5</span> <span class="o">=</span>
<span class="mi">1</span> <span class="o">:</span>
<span class="mi">2</span> <span class="o">:</span>
<span class="mi">3</span> <span class="o">:</span>       <span class="p">[</span>
<span class="mi">1</span> <span class="o">:</span>             <span class="p">[</span> <span class="n">CC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span> <span class="p">,</span>         <span class="p">[</span> <span class="n">CC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span> <span class="p">,</span>
<span class="mi">2</span> <span class="o">:</span>             <span class="p">[</span> <span class="n">CC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span> <span class="p">,</span>         <span class="p">[</span> <span class="n">CC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)]</span> <span class="p">,</span>
<span class="mi">3</span> <span class="o">:</span>             <span class="p">[</span> <span class="n">CC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>  <span class="n">CC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)]</span> <span class="p">]</span> <span class="p">;</span>
<span class="mi">27</span> <span class="o">:</span> <span class="kt">func</span> <span class="n">E5x2</span> <span class="o">=</span>
<span class="mi">1</span> <span class="o">:</span>
<span class="mi">2</span> <span class="o">:</span>
<span class="mi">3</span> <span class="o">:</span>       <span class="p">[</span>
<span class="mi">1</span> <span class="o">:</span>          <span class="p">[</span> <span class="n">EE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  <span class="n">EE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span> <span class="p">,</span>      <span class="p">[</span> <span class="n">EE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>  <span class="n">EE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span> <span class="p">,</span>
<span class="mi">2</span> <span class="o">:</span>          <span class="p">[</span> <span class="n">EE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>  <span class="n">EE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span> <span class="p">,</span>      <span class="p">[</span> <span class="n">EE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>  <span class="n">EE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)]</span> <span class="p">,</span>
<span class="mi">3</span> <span class="o">:</span>          <span class="p">[</span> <span class="n">EE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>  <span class="n">EE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)]</span> <span class="p">]</span> <span class="p">;</span>
<span class="mi">28</span> <span class="o">:</span> <span class="kt">func</span> <span class="n">Eps</span> <span class="o">=</span>      <span class="p">[</span>     <span class="p">[</span> <span class="n">EEps</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  <span class="n">EEps</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span> <span class="p">,</span>      <span class="p">[</span> <span class="n">EEps</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>  <span class="n">EEps</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span> <span class="p">]</span> <span class="p">;</span>
<span class="mi">29</span> <span class="o">:</span>
<span class="mi">30</span> <span class="o">:</span> <span class="c1">// Macro concatenation</span>
<span class="mi">31</span> <span class="o">:</span> <span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="mi">32</span> <span class="o">:</span> <span class="kt">fespace</span> <span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="mi">33</span> <span class="o">:</span> <span class="n">Vh</span> <span class="n">Ux</span><span class="o">=</span><span class="kr">x</span><span class="p">,</span> <span class="n">Uy</span><span class="o">=</span><span class="kr">y</span><span class="p">;</span>
<span class="mi">34</span> <span class="o">:</span>
<span class="mi">35</span> <span class="o">:</span>  <span class="kt">macro</span> <span class="n">div</span><span class="p">(</span><span class="n">V</span> <span class="p">)</span>   <span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">V</span><span class="o">#</span><span class="kr">x</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">V</span><span class="o">#</span><span class="kr">y</span><span class="p">))</span> <span class="c1">//</span>
<span class="mi">36</span> <span class="o">:</span>
<span class="mi">37</span> <span class="o">:</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>     <span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">Ux</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">Uy</span><span class="p">))</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="mi">38</span> <span class="o">:</span>
<span class="mi">39</span> <span class="o">:</span> <span class="c1">// Verify the quoting</span>
<span class="mi">40</span> <span class="o">:</span>    <span class="kt">macro</span> <span class="n">foo</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="p">)</span>   <span class="n">i</span> <span class="n">j</span> <span class="n">k</span> <span class="c1">//</span>
<span class="mi">41</span> <span class="o">:</span>
<span class="mi">42</span> <span class="o">:</span>         <span class="kt">int</span><span class="p">[</span> <span class="kt">int</span><span class="p">]</span> <span class="n">a</span><span class="p">(</span><span class="mi">10</span> <span class="p">);</span>
<span class="mi">43</span> <span class="o">:</span>
<span class="mi">44</span> <span class="o">:</span> <span class="c1">//NewMacro - EndMacro</span>
<span class="mi">45</span> <span class="o">:</span>  <span class="kt">macro</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span> <span class="p">)</span>   <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span>
<span class="mi">46</span> <span class="o">:</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>    <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">Ux</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">Ux</span><span class="p">)]</span> <span class="o">&#39;</span> <span class="o">*</span>     <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">Uy</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">Uy</span><span class="p">)]</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="mi">47</span> <span class="o">:</span>
<span class="mi">48</span> <span class="o">:</span> <span class="c1">// IFMACRO - ENDIFMACRO</span>
<span class="mi">49</span> <span class="o">:</span>   <span class="kt">macro</span> <span class="n">AACAS1</span> <span class="c1">//</span>
<span class="mi">50</span> <span class="o">:</span>
<span class="mi">51</span> <span class="o">:</span>
<span class="mi">1</span> <span class="o">:</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;AA = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">Stringification</span><span class="p">(</span> <span class="n">CAS1</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="mi">2</span> <span class="o">:</span>   <span class="kt">macro</span> <span class="n">CASEfile1</span><span class="p">.</span><span class="n">edp</span><span class="c1">//</span>
<span class="mi">3</span> <span class="o">:</span>
<span class="mi">52</span> <span class="o">:</span>
<span class="mi">53</span> <span class="o">:</span>
<span class="mi">54</span> <span class="o">:</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;CASE = &quot;</span> <span class="o">&lt;&lt;</span> <span class="nf">Stringification</span><span class="p">(</span><span class="n">file1</span><span class="p">.</span><span class="n">edp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="mi">55</span> <span class="o">:</span>
<span class="mi">56</span> <span class="o">:</span>
<span class="mi">1</span> <span class="o">:</span> <span class="cp">include</span> <span class="nf">Stringification</span><span class="p">(</span><span class="n">file1</span><span class="p">.</span><span class="n">edp</span><span class="p">)</span><span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;This is the file 1&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="mi">2</span> <span class="o">:</span>
<span class="mi">2</span> <span class="o">:</span>
<span class="mi">57</span> <span class="o">:</span>
<span class="mi">58</span> <span class="o">:</span> <span class="c1">// FILE - LINE</span>
<span class="mi">59</span> <span class="o">:</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;In &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">FILE</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, line &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">LINE</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>The output os this script is:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nv">AA</span> <span class="o">=</span> CAS1
<span class="nv">CASE</span> <span class="o">=</span> file1.edp
This is the file <span class="m">1</span>
In Macro.edp, line <span class="m">59</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="basic-error-handling">
<span id="examplebasicerrorhandling"></span><h3>Basic error handling<a class="headerlink" href="#basic-error-handling" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">real</span> <span class="n">a</span><span class="p">;</span>
<span class="k">try</span><span class="p">{</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">0.</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">catch</span> <span class="p">(...)</span> <span class="c1">//all exceptions can be caught</span>
<span class="p">{</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Catch an ExecError&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The output of this script is:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="m">1</span>/0 : d d d
  current <span class="nv">line</span> <span class="o">=</span> <span class="m">3</span>
Exec error :  Div by <span class="m">0</span>
   -- number :1
Catch an ExecError
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="error-handling">
<span id="exampleerrorhandling"></span><h3>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h3>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">nn</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//right hand side function</span>
<span class="kt">func</span> <span class="n">g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//boundary condition function</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">real</span> <span class="n">cpu</span> <span class="o">=</span> <span class="nf">clock</span><span class="p">();</span>
<span class="kt">problem</span> <span class="nf">laplace</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Cholesky</span><span class="p">,</span> <span class="kp">tolpivot</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
          <span class="nf">dx</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="o">-</span> <span class="n">f</span><span class="o">*</span><span class="n">vh</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="k">try</span><span class="p">{</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Try Cholesky&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="c1">// Solve</span>
    <span class="n">laplace</span><span class="p">;</span>

    <span class="c1">// Plot</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">uh</span><span class="p">);</span>

    <span class="c1">// Display</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;laplacian Cholesky &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nn</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, x_&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nn</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="n">cpu</span><span class="o">+</span><span class="nf">clock</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; s, max = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">uh</span><span class="p">[].</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">catch</span><span class="p">(...)</span> <span class="p">{</span> <span class="c1">//catch all error</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; Catch cholesky PB &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The output of this script is:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span>Try Cholesky
ERREUR choleskypivot <span class="o">(</span><span class="m">35</span><span class="o">)=</span> -6.43929e-15 &lt; 1e-06
  current <span class="nv">line</span> <span class="o">=</span> <span class="m">29</span>
Exec error : FATAL ERREUR dans ./../femlib/MatriceCreuse_tpl.hpp
cholesky line:
   -- number :688
 catch an erreur in  <span class="nv">solve</span>  <span class="o">=</span>&gt;  <span class="nb">set</span>  <span class="nv">sol</span> <span class="o">=</span> <span class="m">0</span> !!!!!!!
 Catch cholesky PB
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>