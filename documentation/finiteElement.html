<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Finite element</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">Finite element</a><ul>
<li><a class="reference internal" href="#use-of-freefem-fespace-in-2d">Use of freefem fespace in 2D</a></li>
<li><a class="reference internal" href="#use-of-fespace-in-3d">Use of fespace in 3D</a></li>
<li><a class="reference internal" href="#lagrangian-finite-elements">Lagrangian Finite Elements</a><ul>
<li><a class="reference internal" href="#p0-element">P0-element</a></li>
<li><a class="reference internal" href="#p1-element">P1-element</a></li>
<li><a class="reference internal" href="#p2-element">P2-element</a></li>
</ul>
</li>
<li><a class="reference internal" href="#p1-nonconforming-element">P1 Nonconforming Element</a></li>
<li><a class="reference internal" href="#other-fe-space">Other FE-space</a></li>
<li><a class="reference internal" href="#vector-valued-fe-function">Vector Valued FE-function</a><ul>
<li><a class="reference internal" href="#raviart-thomas-element">Raviart-Thomas Element</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-fast-finite-element-interpolator">A Fast Finite Element Interpolator</a></li>
<li><a class="reference internal" href="#keywords-problem-and-solve">Keywords: Problem and Solve</a><ul>
<li><a class="reference internal" href="#weak-form-and-boundary-condition">Weak Form and Boundary Condition</a></li>
</ul>
</li>
<li><a class="reference internal" href="#parameters-affecting-solve-and-problem">Parameters affecting solve and problem</a></li>
<li><a class="reference internal" href="#problem-definition">Problem definition</a></li>
<li><a class="reference internal" href="#numerical-integration">Numerical Integration</a></li>
<li><a class="reference internal" href="#variational-form-sparse-matrix-pde-data-vector">Variational Form, Sparse Matrix, PDE Data Vector</a></li>
<li><a class="reference internal" href="#interpolation-matrix">Interpolation matrix</a></li>
<li><a class="reference internal" href="#finite-elements-connectivity">Finite elements connectivity</a></li>
</ul>
</li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="math notranslate nohighlight">
\[\begin{split}\def\R{{\mathbb{R}}}
\def\P{{\mathbb{P}}}
\def\p{{\partial}}
\def\d{{\text{d}}}
\def\vecttwo#1#2{\left|\begin{smallmatrix} #1 \\ #2 \end{smallmatrix}\right.}
\def\vectthree#1#2#3{\left|\begin{smallmatrix} #1 \\ #2 \\ #3\end{smallmatrix}\right.}
\def\n{{\nabla}}\end{split}\]</div>
<div class="section" id="finite-element">
<span id="finiteelement"></span><h1>Finite element<a class="headerlink" href="#finite-element" title="Permalink to this headline">¶</a></h1>
<p>As stated in <a class="reference internal" href="../tutorial/index.html#tutorial"><span class="std std-ref">tutorials</span></a>, FEM approximates all functions <span class="math notranslate nohighlight">\(w\)</span> as:</p>
<div class="math notranslate nohighlight">
\[w(x,y)\simeq w_0\phi_0(x,y)+w_1\phi_1(x,y)+\cdots+w_{M-1}\phi_{M-1}(x,y)\]</div>
<p>with finite element basis functions <span class="math notranslate nohighlight">\(\phi_k(x,y)\)</span> and numbers <span class="math notranslate nohighlight">\(w_k\)</span> (<span class="math notranslate nohighlight">\(k=0,\cdots,M-1\)</span>).
The functions <span class="math notranslate nohighlight">\(\phi_k(x,y)\)</span> are constructed from the triangle <span class="math notranslate nohighlight">\(T_{i_k}\)</span>, and called <em>shape functions</em>.</p>
<p>In <strong>FreeFem++</strong>, the finite element space:</p>
<div class="math notranslate nohighlight">
\[V_h=\left\{w\left|\; w_0\phi_0+w_1\phi_1+\cdots+w_{M-1}\phi_{M-1},\, w_i\in \R\right.\right\}\]</div>
<p>is easily created by:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">fespace</span> <span class="nf">IDspace</span><span class="p">(</span><span class="n">IDmesh</span><span class="p">,</span><span class="o">&lt;</span><span class="n">IDFE</span><span class="o">&gt;</span><span class="p">);</span>
</pre></div>
</div>
<p>or with <span class="math notranslate nohighlight">\(\ell\)</span> pairs of periodic boundary conditions in 2D:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">fespace</span> <span class="nf">IDspace</span><span class="p">(</span><span class="n">IDmesh</span><span class="p">,</span><span class="o">&lt;</span><span class="n">IDFE</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="n">la1</span><span class="p">,</span> <span class="n">sa1</span><span class="p">],</span> <span class="p">[</span><span class="n">lb1</span><span class="p">,</span> <span class="n">sb1</span><span class="p">],</span>
              <span class="p">...</span>
              <span class="p">[</span><span class="n">lak</span><span class="p">,</span> <span class="n">sak</span><span class="p">],</span> <span class="p">[</span><span class="n">lbk</span><span class="p">,</span> <span class="n">sbl</span><span class="p">]]);</span>
</pre></div>
</div>
<p>and in 3D:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">fespace</span> <span class="nf">IDspace</span><span class="p">(</span><span class="n">IDmesh</span><span class="p">,</span><span class="o">&lt;</span><span class="n">IDFE</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="n">la1</span><span class="p">,</span> <span class="n">sa1</span><span class="p">,</span> <span class="n">ta1</span><span class="p">],</span> <span class="p">[</span><span class="n">lb1</span><span class="p">,</span> <span class="n">sb1</span><span class="p">,</span> <span class="n">tb1</span><span class="p">],</span>
              <span class="p">...</span>
              <span class="p">[</span><span class="n">lak</span><span class="p">,</span> <span class="n">sak</span><span class="p">,</span> <span class="n">tak</span><span class="p">],</span> <span class="p">[</span><span class="n">lbk</span><span class="p">,</span> <span class="n">sbl</span><span class="p">,</span> <span class="n">tbl</span><span class="p">]]);</span>
</pre></div>
</div>
<p>where <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">IDspace</span></code> is the name of the space (e.g.&nbsp;<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span></code>), <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">IDmesh</span></code> is the name of the associated mesh and <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="o">&lt;</span><span class="n">IDFE</span><span class="o">&gt;</span></code> is an identifier of finite element type.</p>
<p>In 2D we have a pair of periodic boundary conditions, if <span class="math notranslate nohighlight">\([la_i, sa_i]\)</span>, <span class="math notranslate nohighlight">\([lb_i, sb_i]\)</span> is a pair of <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">int</span></code>, and the 2 labels <span class="math notranslate nohighlight">\(la_i\)</span> and <span class="math notranslate nohighlight">\(lb_i\)</span> refer to 2 pieces of boundary to be in equivalence.</p>
<p>If <span class="math notranslate nohighlight">\([la_i, sa_i]\)</span>, <span class="math notranslate nohighlight">\([lb_i, sb_i]\)</span> is a pair of <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">real</span></code>, then <span class="math notranslate nohighlight">\(sa_i\)</span> and <span class="math notranslate nohighlight">\(sb_i\)</span> give two common abscissa on the two boundary curves, and two points are identified as one if the two abscissa are equal.</p>
<p>In 2D, we have a pair of periodic boundary conditions, if <span class="math notranslate nohighlight">\([la_i, sa_i, ta_i]\)</span>, <span class="math notranslate nohighlight">\([lb_i, sb_i, tb_i]\)</span> is a pair of <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">int</span></code>, the 2 labels <span class="math notranslate nohighlight">\(la_i\)</span> and <span class="math notranslate nohighlight">\(lb_i\)</span> define the 2 pieces of boundary to be in equivalence.</p>
<p>If <span class="math notranslate nohighlight">\([la_i, sa_i, ta_i]\)</span>, <span class="math notranslate nohighlight">\([lb_i, sb_i, tb_i]\)</span> is a pair of <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">real</span></code>, then <span class="math notranslate nohighlight">\(sa_i\)</span>, <span class="math notranslate nohighlight">\(ta_i\)</span> and <span class="math notranslate nohighlight">\(sb_i\)</span>, <span class="math notranslate nohighlight">\(tb_i\)</span> give two common parameters on the two boundary surfaces, and two points are identified as one if the two parameters are equal.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The 2D mesh of the two identified borders must be the same, so to be sure, use the parameter <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">fixedborder</span><span class="o">=</span><span class="kr">true</span></code> in <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">buildmesh</span></code> command (see <a class="reference internal" href="meshGeneration.html#meshborder"><span class="std std-ref">fixedborder</span></a>).</p>
</div>
<p>As of today, the known types of finite elements are:</p>
<ul>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P0</span><span class="p">,</span> <span class="nc">P03d</span><span class="p">]</span></code> piecewise constant discontinuous finite element (2d, 3d), the degrees of freedom are the barycenter element value.</p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-eq-p0">
<span class="eqno">(3)<a class="headerlink" href="#equation-eq-p0" title="Permalink to this equation">¶</a></span>\[\P^0_{h} = \left\{ v \in L^2(\Omega) \left|\; \textrm{for all }K \in \mathcal{T}_{h}\;\;\textrm{there is }\alpha_{K}\in \R : \;\; v_{|K} = \alpha_{K } \right.\right\}\]</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P1</span><span class="p">,</span> <span class="nc">P13d</span><span class="p">]</span></code> piecewise linear continuous finite element (2d, 3d), the degrees of freedom are the vertices values.</p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-eq-p1">
<span class="eqno">(4)<a class="headerlink" href="#equation-eq-p1" title="Permalink to this equation">¶</a></span>\[\P^1_{h} = \left\{ v \in H^{1}(\Omega) \left|\; \forall K \in \mathcal{T}_{h},\ v_{|K} \in P_{1} \right.\right\}\]</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P1dc</span><span class="p">]</span></code> piecewise linear discontinuous finite element</p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-eq-p1dc">
<span class="eqno">(5)<a class="headerlink" href="#equation-eq-p1dc" title="Permalink to this equation">¶</a></span>\[\P^1_{dc|h} = \left\{ v \in L^{2}(\Omega) \left|\; \forall K \in \mathcal{T}_{h}, \ v_{|K} \in P_{1} \right.\right\}\]</div>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Due to an interpolation problem, the degree of freedom is not the vertices but three vertices which move inside <span class="math notranslate nohighlight">\(T(X)= G + .99 (X-G)\)</span> where <span class="math notranslate nohighlight">\(G\)</span> is the barycenter.</p>
</div>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P1b</span><span class="p">,</span> <span class="nc">P1b3d</span><span class="p">]</span></code> piecewise linear continuous finite element plus bubble (2d, 3d)</p>
<p><strong>The 2D Case:</strong></p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-eq-p1b">
<span class="eqno">(6)<a class="headerlink" href="#equation-eq-p1b" title="Permalink to this equation">¶</a></span>\[\P^1_{b|h} = \left\{ v \in H^{1}(\Omega) \left|\; \forall K \in \mathcal{T}_{h}, \ v_{|K} \in P_{1} \oplus \mathrm{Span}\{ \lambda^{K}_{0} \lambda^{K}_{1} \lambda^{K}_{2} \} \right.\right\}\]</div>
</div></blockquote>
<p><strong>The 3D Case:</strong></p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-eq-p1b-3d">
<span class="eqno">(7)<a class="headerlink" href="#equation-eq-p1b-3d" title="Permalink to this equation">¶</a></span>\[\P^1_{b|h} = \left\{ v \in H^{1}(\Omega) \left|\; \forall K \in \mathcal{T}_{h}, \ v_{|K} \in P_{1} \oplus \mathrm{Span}\{ \lambda^{K}_{0} \lambda^{K}_{1} \lambda^{K}_{2} \lambda^{K}_{3} \} \right.\right\}\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda^{K}_{i}, i=0,..,d\)</span> are the <span class="math notranslate nohighlight">\(d+1\)</span> barycentric coordinate functions of the element <span class="math notranslate nohighlight">\(K\)</span> (triangle or tetrahedron).</p>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nc">P1bl</span><span class="p">,</span><span class="nc">P1bl3d</span></code> piecewise linear continuous finite element plus linear bubble (2d, 3d).</p>
<p>The bubble is built by splitting the <span class="math notranslate nohighlight">\(K\)</span>, a barycenter in <span class="math notranslate nohighlight">\(d+1\)</span> sub element. (need <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_P1bl&quot;</span></code>)</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P2</span><span class="p">,</span> <span class="nc">P23d</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{2}\)</span> continuous finite element (2d, 3d)</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\P^2_{h} = \left\{ v \in H^{1}(\Omega) \left|\; \forall K \in \mathcal{T}_{h}, \ v_{|K} \in P_{2} \right.\right\}\]</div>
<p>where <span class="math notranslate nohighlight">\(P_{2}\)</span> is the set of polynomials of <span class="math notranslate nohighlight">\(\R^{2}\)</span> of degrees <span class="math notranslate nohighlight">\(\le 2\)</span>.</p>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P2b</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{2}\)</span> continuous finite element plus bubble</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\P^2_{h} = \left\{ v \in H^{1}(\Omega) \left|\; \forall K \in \mathcal{T}_{h}, \ v_{|K} \in P_{2} \oplus \mathrm{Span}\{ \lambda^{K}_{0} \lambda^{K}_{1} \lambda^{K}_{2} \} \right.\right\}\]</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P2dc</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{2}\)</span> discontinuous finite element</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\P^2_{dc|h} = \left\{ v \in L^{2}(\Omega) \left|\; \forall K \in \mathcal{T}_{h}, \ v_{|K} \in P_{2} \right.\right\}\]</div>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Due to an interpolation problem, the degree of freedom is not the six P2 nodes but six nodes which move inside <span class="math notranslate nohighlight">\(T(X)= G + .99 (X-G)\)</span> where <span class="math notranslate nohighlight">\(G\)</span> is the barycenter.</p>
</div>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P2h</span><span class="p">]</span></code> quadratic homogeneous continuous (without <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nc">P1</span></code>).</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P3</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{3}\)</span> continuous finite element (2d) (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_P3&quot;</span></code>)</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\P^3_{h} = \left\{ v \in H^{1}(\Omega) \left|\; \forall K \in \mathcal{T}_{h}, \ v_{|K} \in P_{3} \right.\right\}\]</div>
<p>where <span class="math notranslate nohighlight">\(P_{3}\)</span> is the set of polynomials of <span class="math notranslate nohighlight">\(\R^{2}\)</span> of degrees <span class="math notranslate nohighlight">\(\le 3\)</span>.</p>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P3dc</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{3}\)</span> discontinuous finite element (2d) (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_P3dc&quot;</span></code>)</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\P^3_{dc|h} = \left\{ v \in L^2(\Omega) \left|\; \forall K \in \mathcal{T}_{h}, \ v_{|K} \in P_{3} \right.\right\}\]</div>
<p>where <span class="math notranslate nohighlight">\(P_{3}\)</span> is the set of polynomials of <span class="math notranslate nohighlight">\(\R^{2}\)</span> of degrees <span class="math notranslate nohighlight">\(\le 3\)</span>.</p>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P4</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{4}\)</span> continuous finite element (2d) (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_P4&quot;</span></code>)</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\P^4_{h} = \left\{ v \in H^{1}(\Omega) \left|\; \forall K \in \mathcal{T}_{h},\ v_{|K} \in P_{4} \right.\right\}\]</div>
<p>where <span class="math notranslate nohighlight">\(P_{4}\)</span> is the set of polynomials of <span class="math notranslate nohighlight">\(\R^{2}\)</span> of degrees <span class="math notranslate nohighlight">\(\le 4\)</span>.</p>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P4dc</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{4}\)</span> discontinuous finite element (2d) (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_P4dc&quot;</span></code>)</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\P^4_{dc|h} = \left\{ v \in L^2(\Omega) \left|\; \forall K \in \mathcal{T}_{h}, \ v_{|K} \in P_{3} \right.\right\}\]</div>
<p>where <span class="math notranslate nohighlight">\(P_{4}\)</span> is the set of polynomials of <span class="math notranslate nohighlight">\(\R^{2}\)</span> of degrees <span class="math notranslate nohighlight">\(\le 3\)</span>.</p>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P0Edge</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{0}\)</span> discontinuous finite element (2d) contained on each edge of the mesh.</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P1Edge</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{1}\)</span> discontinuous finite element (2d) (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_PkEdge&quot;</span></code>) <span class="math notranslate nohighlight">\(P_1\)</span> on each edge of the mesh.</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P2Edge</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{2}\)</span> discontinuous finite element (2d) (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_PkEdge&quot;</span></code>) <span class="math notranslate nohighlight">\(P_2\)</span> on each edge of the mesh.</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P3Edge</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{3}\)</span> discontinuous finite element (2d) (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_PkEdge&quot;</span></code>) <span class="math notranslate nohighlight">\(P_3\)</span> on each edge of the mesh.</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P4Edge</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{4}\)</span> discontinuous finite element (2d) (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_PkEdge&quot;</span></code>) <span class="math notranslate nohighlight">\(P_4\)</span> on each edge of the mesh.</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P5Edge</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{5}\)</span> discontinuous finite element (2d) (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_PkEdge&quot;</span></code>) <span class="math notranslate nohighlight">\(P_5\)</span> on each edge of the mesh.</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P2Morley</span><span class="p">]</span></code> piecewise <span class="math notranslate nohighlight">\(P_{2}\)</span> non conform finite element (2d) (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Morley&quot;</span></code>)</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\begin{split}\P^2_{h} = \left\{ v \in L^2(\Omega) \left|\; \forall K \in \mathcal{T}_{h}, \ v_{|K} \in P_{3},
\left\{\begin{array}{c}
    v \mbox{ continuous at vertices,}\\
    \p_n{v} \mbox{ continuous at middle of edge,}
\end{array}\right.
\right.\right\}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(P_{2}\)</span> is the set of polynomials of <span class="math notranslate nohighlight">\(\R^{2}\)</span> of degrees <span class="math notranslate nohighlight">\(\le 2\)</span>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">To build the interplant of a function <span class="math notranslate nohighlight">\(u\)</span> (scalar) for this finite element, we need the function and 2 partial derivatives <span class="math notranslate nohighlight">\((u,u_x, u_y)\)</span>, creating this vectorial finite element with 3 components <span class="math notranslate nohighlight">\((u,u_x,u_y)\)</span>.</p>
</div>
<p>See our example for solving the BiLaplacien problem:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;Morley&quot;</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">nn</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">h</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>

<span class="kt">real</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="p">);</span>
<span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="kp">IsMetric</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2Morley</span><span class="p">);</span> <span class="c1">//The Morley finite element space</span>
<span class="n">Vh</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">],</span> <span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">];</span>

<span class="c1">// Macro</span>
<span class="kt">macro</span> <span class="nf">bilaplacien</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="p">(</span><span class="nf">dxx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dxx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dyy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dyy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="nf">dxy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="c1">//</span>

<span class="c1">// Problem</span>
<span class="kt">solve</span> <span class="n">bilap</span> <span class="p">([</span><span class="n">u</span><span class="p">,</span> <span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">],</span> <span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">])</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">bilaplacien</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ux</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">uy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;u&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">HCT</span><span class="p">]</span></code> <span class="math notranslate nohighlight">\(P_3\)</span> <span class="math notranslate nohighlight">\(C^1\)</span> conforms finite element (2d) (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_HCT&quot;</span></code>) one 3 sub triangles.</p>
<blockquote>
<div><p>Lets call <span class="math notranslate nohighlight">\(\mathcal{T}^\triangle_{h}\)</span> the sub mesh of <span class="math notranslate nohighlight">\(\mathcal{T}_{h}\)</span> where all triangles are split in 3 at the barycenter.</p>
<div class="math notranslate nohighlight">
\[\P^{HCT}_{h} = \left\{ v \in C^1(\Omega) \left|\; \forall K \in \mathcal{T}^\triangle_{h}, \ v_{|K} \in P_{3} \right.\right\}\]</div>
<p>where <span class="math notranslate nohighlight">\(P_{3}\)</span> is the set of polynomials of <span class="math notranslate nohighlight">\(\R^{2}\)</span> of degrees <span class="math notranslate nohighlight">\(\le 3\)</span>.</p>
<p>The degrees of freedom are the values of the normal derivative at the mid-point of each edge <a class="reference internal" href="../reference.html#bernadou1980" id="id1">[BERNADOU1980]</a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">To build the interplant of a function <span class="math notranslate nohighlight">\(u\)</span> (scalar) for this finite element, we need the function and 2 partial derivatives <span class="math notranslate nohighlight">\((u,u_x, u_y)\)</span>, creating this vectorial finite element with 3 components <span class="math notranslate nohighlight">\((u,u_x,u_y)\)</span> like in previous finite element.</p>
</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P2BR</span><span class="p">]</span></code> (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;BernadiRaugel&quot;</span></code>) the Bernadi Raugel Finite Element is a Vectorial element (2d) with 2 components, see <a class="reference internal" href="../reference.html#bernardi1985" id="id2">[BERNARDI1985]</a>.</p>
<blockquote>
<div><p>It is a 2D coupled Finite Element, where the Polynomial space is <span class="math notranslate nohighlight">\(P_1^2\)</span> with 3 normal bubble edge functions <span class="math notranslate nohighlight">\((P_2)\)</span>.
There are 9 degrees of freedom:</p>
<ul class="simple">
<li>2 components at each of the 3 vertices and</li>
<li>the 3 flux on the 3 edges.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">RT0</span><span class="p">,</span> <span class="nc">RT03d</span><span class="p">]</span></code> Raviart-Thomas finite element of degree <span class="math notranslate nohighlight">\(0\)</span>.</p>
<blockquote>
<div><p><strong>The 2D Case:</strong></p>
<div class="math notranslate nohighlight" id="equation-eq-rt0">
<span class="eqno">(8)<a class="headerlink" href="#equation-eq-rt0" title="Permalink to this equation">¶</a></span>\[RT0_{h} = \left\{ \mathbf{v} \in H(\textrm{div}) \left|\; \forall K \in \mathcal{T}_{h} ,\ \mathbf{v}_{|K}(x,y) =
\vecttwo{\alpha^1_{K}}{\alpha^2_{K}} + \beta_{K}\vecttwo{x}{y} \right.\right\}\]</div>
<p><strong>The 3D Case:</strong></p>
<div class="math notranslate nohighlight" id="equation-eq-rt03d">
<span class="eqno">(9)<a class="headerlink" href="#equation-eq-rt03d" title="Permalink to this equation">¶</a></span>\[RT0_{h} = \left\{ \mathbf{v} \in H(\textrm{div}) \left|\; \forall K \in \mathcal{T}_{h},\ \mathbf{v}_{|K}(x,y,z) =
\vectthree{\alpha^1_{K}}{\alpha^2_{K}}{\alpha^3_{K}} + \beta_{K}\vectthree{x}{y}{z} \right.\right\}\]</div>
<p>where by writing <span class="math notranslate nohighlight">\(\textrm{div }\mathbf{w}=\sum_{i=1}^d\p w_i/\p x_i\)</span> with <span class="math notranslate nohighlight">\(\mathbf{w}=(w_i)_{i=1}^d\)</span>:</p>
<div class="math notranslate nohighlight">
\[H(\textrm{div})=\left\{\mathbf{w}\in L^{2}(\Omega)^d\left|\textrm{div } \mathbf{w}\in L^{2}(\Omega)\right.\right\}\]</div>
<p>and where <span class="math notranslate nohighlight">\(\alpha^1_{K}\)</span>, <span class="math notranslate nohighlight">\(\alpha^2_{K}\)</span>, <span class="math notranslate nohighlight">\(\alpha^3_{K}\)</span>, <span class="math notranslate nohighlight">\(\beta_{K}\)</span> are real numbers.</p>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">RT0Ortho</span><span class="p">]</span></code> Raviart-Thomas Orthogonal, or Nedelec finite element type I of degree <span class="math notranslate nohighlight">\(0\)</span> in dimension 2</p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-rt0ortho">
<span class="eqno">(10)<a class="headerlink" href="#equation-rt0ortho" title="Permalink to this equation">¶</a></span>\[RT0Ortho{h} = \left\{ \mathbf{v} \in H(\textrm{curl}) \left|\; \forall K \in \mathcal{T}_{h},\ \mathbf{v}_{|K}(x,y) =
\vecttwo{\alpha^1_{K}}{\alpha^2_{K}} + \beta_{K}\vecttwo{-y}{x} \right.\right\}\]</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">Edge03d</span><span class="p">]</span></code> 3d Nedelec finite element or Edge Element of degree <span class="math notranslate nohighlight">\(0\)</span>.</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[Edge0_{h} = \left\{ \mathbf{v} \in H(\textrm{Curl}) \left|\; \forall K \in\mathcal{T}_{h}, \ \mathbf{v}_{|K}(x,y,z) =
    \vectthree{\alpha^1_{K}}{\alpha^2_{K}}{\alpha^3_{K}} + \vectthree{\beta^1_{K}}{\beta^2_{K}}{\beta^3_{K}}\times\vectthree{x}{y}{z} \right.\right\}
:label:eq:Edge03d\]</div>
<p>where by writing <span class="math notranslate nohighlight">\(\textrm{curl}\mathbf{w}=\vectthree{\p w_2/\p x_3-\p w_3/\p x_2}{\p w_3/\p x_1-\p w_1/\p x_3}{\p w_1/\p x_2-\p w_2/\p x_1}\)</span> with <span class="math notranslate nohighlight">\(\mathbf{w}=(w_i)_{i=1}^d\)</span>:</p>
<div class="math notranslate nohighlight">
\[H(\textrm{curl})=\left\{\mathbf{w}\in L^{2}(\Omega)^d\left|\textrm{curl } \mathbf{w}\in L^{2}(\Omega)^d\right.\right\}\]</div>
<p>and <span class="math notranslate nohighlight">\(\alpha^1_{K},\alpha^2_{K},\alpha^3_{K},\beta^1_{K},\beta^2_{K},\beta^3_{K}\)</span> are real numbers.</p>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">Edge13d</span><span class="p">]</span></code> (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_Mixte3d&quot;</span></code>) 3d Nedelec finite element or Edge Element of degree <span class="math notranslate nohighlight">\(1\)</span>.</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">Edge23d</span><span class="p">]</span></code> (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_Mixte3d&quot;</span></code>) 3d Nedelec finite element or Edge Element of degree <span class="math notranslate nohighlight">\(2\)</span>.</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P1nc</span><span class="p">]</span></code> piecewise linear element continuous at the mid-point of the edge only in 2D (Crouzeix-Raviart Finite Element 2D).</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">P2pnc</span><span class="p">]</span></code> piecewise quadratic plus a P3 bubble element with the continuity of the 2 moments on each edge (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_P2pnc&quot;</span></code>)</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">RT1</span><span class="p">]</span></code> (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_Mixte&quot;</span></code>)</p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-eq-rt1">
<span class="eqno">(11)<a class="headerlink" href="#equation-eq-rt1" title="Permalink to this equation">¶</a></span>\[RT1_{h} = \left\{ \mathbf{v} \in H(\textrm{div}) \left|\; \forall K \in\mathcal{T}_{h}, \ \alpha^1_{K}, \alpha^2_{K}, \beta_{K} \in P_1^2,P_0, \mathbf{v}_{|K}(x,y) =
    \vecttwo{\alpha^1_{K}}{\alpha^2_{K}} + \beta_{K}\vecttwo{x}{y} \right.\right\}\]</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">RT1Ortho</span><span class="p">]</span></code> (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_Mixte&quot;</span></code>)</p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-eq-rt1ortho">
<span class="eqno">(12)<a class="headerlink" href="#equation-eq-rt1ortho" title="Permalink to this equation">¶</a></span>\[RT1_{h} = \left\{ \mathbf{v} \in H(\textrm{curl}) \left|\; \forall K \in\mathcal{T}_{h},\ \alpha^1_{K}, \alpha^2_{K}, \beta_{K} \in P_1^2,P_0, \mathbf{v}_{|K}(x,y) =
    \vecttwo{\alpha^1_{K}}{\alpha^2_{K}} + \beta_{K}\vecttwo{-y}{x} \right.\right\}\]</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">RT2</span><span class="p">]</span></code> (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_Mixte&quot;</span></code>)</p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-eq-rt2">
<span class="eqno">(13)<a class="headerlink" href="#equation-eq-rt2" title="Permalink to this equation">¶</a></span>\[RT2_{h} = \left\{ \mathbf{v} \in H(\textrm{div}) \left|\; \forall K \in\mathcal{T}_{h},\ \alpha^1_{K}, \alpha^2_{K}, \beta_{K} \in P_2^2, P_1, \mathbf{v}_{|K}(x,y) =
    \vecttwo{\alpha^1_{K}}{\alpha^2_{K}} + \beta_{K}\vecttwo{x}{y} \right.\right\}\]</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">RT2Ortho</span><span class="p">]</span></code> (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_Mixte&quot;</span></code>)</p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-eq-rt2ortho">
<span class="eqno">(14)<a class="headerlink" href="#equation-eq-rt2ortho" title="Permalink to this equation">¶</a></span>\[RT2_{h} = \left\{ \mathbf{v} \in H(\textrm{curl}) \left|\; \forall K \in\mathcal{T}_{h} ,\ \alpha^1_{K}, \alpha^2_{K}, \beta_{K} \in P_2^2, P_1,\ \mathbf{v}_{|K}(x,y) =
    \vecttwo{\alpha^1_{K}}{\alpha^2_{K}} + \beta_{K}\vecttwo{-y}{x} \right.\right\}\]</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">BDM1</span><span class="p">]</span></code> (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_Mixte&quot;</span></code>) the Brezzi-Douglas-Marini finite element:</p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-eq-bdm1">
<span class="eqno">(15)<a class="headerlink" href="#equation-eq-bdm1" title="Permalink to this equation">¶</a></span>\[BDM1_{h} = \left\{ \mathbf{v} \in H(\textrm{div}) \left|\; \forall K \in\mathcal{T}_{h},\ \mathbf{v}_{|K} \in P_1^2\right.\right\}\]</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">BDM1Ortho</span><span class="p">]</span></code> (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_Mixte&quot;</span></code>) the Brezzi-Douglas-Marini Orthogonal also call Nedelec of type II , finite element</p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-eq-bdm1ortho">
<span class="eqno">(16)<a class="headerlink" href="#equation-eq-bdm1ortho" title="Permalink to this equation">¶</a></span>\[BDM1Ortho_{h} = \left\{ \mathbf{v} \in H(\textrm{curl}) \left|\; \forall K \in\mathcal{T}_{h},\ \mathbf{v}_{|K} \in P_1^2\right.\right\}\]</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="nc">FEQF</span><span class="p">]</span></code> (needs <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="cp">load</span> <span class="s">&quot;Element_QF&quot;</span></code>) the finite element to store functions at default quadrature points (so the quadrature is <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf5pT</span></code> in 2D and is <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qfV5</span></code> in 3d).</p>
<blockquote>
<div><p>For over quadrature you have the following corresponding finite element’s quadrature formula.</p>
<ul class="simple">
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">FEQF1</span></code> <span class="math notranslate nohighlight">\(\mapsto\)</span> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf1pT</span></code>,</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">FEQF2</span></code> <span class="math notranslate nohighlight">\(\mapsto\)</span> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf2pT</span></code>,</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">FEQF5</span></code> <span class="math notranslate nohighlight">\(\mapsto\)</span> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf5pT</span></code>,</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">FEQF7</span></code> <span class="math notranslate nohighlight">\(\mapsto\)</span> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf7pT</span></code>,</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">FEQF9</span></code> <span class="math notranslate nohighlight">\(\mapsto\)</span> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf9pT</span></code>,</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">FEQF13d</span></code> <span class="math notranslate nohighlight">\(\mapsto\)</span> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qfV1</span></code>,</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">FEQF23d</span></code> <span class="math notranslate nohighlight">\(\mapsto\)</span> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qfV2</span></code>,</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">FEQF53d</span></code> <span class="math notranslate nohighlight">\(\mapsto\)</span> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qfV5</span></code></li>
</ul>
</div></blockquote>
</li>
</ul>
<p>You can use this element to optimize the storage and reuse of functions with a long formula inside an integral for non linear processes.</p>
<div class="section" id="use-of-freefem-fespace-in-2d">
<h2>Use of freefem fespace in 2D<a class="headerlink" href="#use-of-freefem-fespace-in-2d" title="Permalink to this headline">¶</a></h2>
<p>With the 2D finite element spaces</p>
<div class="math notranslate nohighlight">
\[X_{h} = \left\{ v \in H^{1}(]0,1[^2) |\; \forall K \in \mathcal{T}_{h}\quad v_{|K} \in P_{1} \right\}\]</div>
<div class="math notranslate nohighlight">
\[X_{ph} = \left\{ v \in X_{h} |\; v\left(\vecttwo{0}{.}\right) = v\left(\vecttwo{1}{.}\right) , v\left(\vecttwo{.}{0}\right) = v\left(\vecttwo{.}{1}\right) \right\}\]</div>
<div class="math notranslate nohighlight">
\[M_{h} = \left\{ v \in H^{1}(]0,1[^2) |\; \forall K \in \mathcal{T}_{h}\quad v_{|K} \in P_{2} \right\}\]</div>
<div class="math notranslate nohighlight">
\[R_{h} = \left\{ \mathbf{v} \in H^{1}(]0,1[^2)^{2} |\; \forall K \in \mathcal{T}_{h}\quad \mathbf{v}_{|K}(x,y) = \vecttwo{\alpha_{K}}{\beta_{K}} + \gamma_{K}\vecttwo{x}{y} \right\}\]</div>
<p>when <span class="math notranslate nohighlight">\(\mathcal{T}_h\)</span> is a mesh <span class="math notranslate nohighlight">\(10\times 10\)</span> of the unit square <span class="math notranslate nohighlight">\(]0,1[^2\)</span>, we only write in <strong>FreeFem++</strong>:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="kt">fespace</span> <span class="nf">Xh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span> <span class="c1">//scalar FE</span>
<span class="kt">fespace</span> <span class="nf">Xph</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="nc">P1</span><span class="p">,</span>
    <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kr">x</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="kr">x</span><span class="p">]]);</span> <span class="c1">//bi-periodic FE</span>
<span class="kt">fespace</span> <span class="nf">Mh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span> <span class="c1">//scalar FE</span>
<span class="kt">fespace</span> <span class="nf">Rh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">RT0</span><span class="p">);</span> <span class="c1">//vectorial FE</span>
</pre></div>
</div>
<p>where <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Xh</span><span class="p">,</span> <span class="n">Mh</span><span class="p">,</span> <span class="n">Rh</span></code> expresses finite element spaces (called FE spaces) <span class="math notranslate nohighlight">\(X_h,\, M_h,\, R_h\)</span>, respectively.</p>
<p>To use FE-functions <span class="math notranslate nohighlight">\(u_{h},v_{h} \in X_{h}\)</span>, <span class="math notranslate nohighlight">\(p_{h},q_{h} \in M_{h}\)</span> and <span class="math notranslate nohighlight">\(U_{h},V_{h} \in R_{h}\)</span>, we write:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="n">Xh</span> <span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">;</span>
<span class="n">Xph</span> <span class="n">uph</span><span class="p">,</span> <span class="n">vph</span><span class="p">;</span>
<span class="n">Mh</span> <span class="n">ph</span><span class="p">,</span> <span class="n">qh</span><span class="p">;</span>
<span class="n">Rh</span> <span class="p">[</span><span class="n">Uxh</span><span class="p">,</span> <span class="n">Uyh</span><span class="p">],</span> <span class="p">[</span><span class="n">Vxh</span><span class="p">,</span> <span class="n">Vyh</span><span class="p">];</span>
<span class="n">Xh</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Uh</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>         <span class="c1">//array of 10 functions in Xh</span>
<span class="n">Rh</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="p">[</span><span class="n">Wxh</span><span class="p">,</span> <span class="n">Wyh</span><span class="p">](</span><span class="mi">10</span><span class="p">);</span> <span class="c1">//array of 10 functions in Rh</span>
<span class="n">Wxh</span><span class="p">[</span><span class="mi">5</span><span class="p">](</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">);</span>        <span class="c1">//the 6th function at point (0.5, 0.5)</span>
<span class="n">Wxh</span><span class="p">[</span><span class="mi">5</span><span class="p">][];</span>               <span class="c1">//the array of the degree of freedom of the 6th function</span>
</pre></div>
</div>
<p>The functions <span class="math notranslate nohighlight">\(U_{h}, V_{h}\)</span> have two components so we have</p>
<div class="math notranslate nohighlight">
\[U_{h}=\vecttwo{Uxh}{Uyh} \quad \mbox{and}\quad V_{h}=\vecttwo{Vxh}{Vyh}\]</div>
</div>
<div class="section" id="use-of-fespace-in-3d">
<h2>Use of fespace in 3D<a class="headerlink" href="#use-of-fespace-in-3d" title="Permalink to this headline">¶</a></h2>
<p>With the 3D finite element spaces</p>
<div class="math notranslate nohighlight">
\[X_{h} = \{ v \in H^{1}(]0,1[^3) |\; \forall K \in \mathcal{T}_{h}\quad v_{|K} \in P_{1} \}\]</div>
<div class="math notranslate nohighlight">
\[X_{ph} = \left\{ v \in X_{h} |\; v\left(\vecttwo{0}{.}\right) = v\left(\vecttwo{1}{.}\right) , v\left(\vecttwo{.}{0}\right) = v\left(\vecttwo{.}{1}\right) \right\}\]</div>
<div class="math notranslate nohighlight">
\[M_{h} = \{ v \in H^{1}(]0,1[^2) |\; \forall K \in \mathcal{T}_{h}\quad v_{|K} \in P_{2} \}\]</div>
<div class="math notranslate nohighlight">
\[R_{h} = \left\{ \mathbf{v} \in H^{1}(]0,1[^2)^{2} |\; \forall K \in \mathcal{T}_{h}\quad \mathbf{v}_{|K}(x,y) = \vecttwo{\alpha_{K}}{\beta_{K}} + \gamma_{K}\vecttwo{x}{y} \right\}\]</div>
<p>when <span class="math notranslate nohighlight">\(\mathcal{T}_h\)</span> is a mesh <span class="math notranslate nohighlight">\(10\times 10\times 10\)</span> of the unit cubic <span class="math notranslate nohighlight">\(]0,1[^2\)</span>, we write in <strong>FreeFem++</strong>:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">mesh3</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">buildlayers</span><span class="p">(</span><span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span><span class="mi">10</span><span class="p">,</span> <span class="kp">zbound</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
<span class="c1">//label: 0 up, 1 down, 2 front, 3 left, 4 back, 5 right</span>
<span class="kt">fespace</span> <span class="nf">Xh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span> <span class="c1">//scalar FE</span>
<span class="kt">fespace</span> <span class="nf">Xph</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">,</span>
    <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="kr">x</span><span class="p">,</span> <span class="kr">z</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kr">x</span><span class="p">,</span> <span class="kr">z</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="kr">z</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="kr">z</span><span class="p">]]);</span> <span class="c1">//three-periodic FE</span>
<span class="kt">fespace</span> <span class="nf">Mh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span> <span class="c1">//scalar FE</span>
<span class="kt">fespace</span> <span class="nf">Rh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">RT03d</span><span class="p">);</span> <span class="c1">//vectorial FE</span>
</pre></div>
</div>
<p>where <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Xh</span><span class="p">,</span> <span class="n">Mh</span><span class="p">,</span> <span class="n">Rh</span></code> expresses finite element spaces (called FE spaces) <span class="math notranslate nohighlight">\(X_h,\, M_h,\, R_h\)</span>, respectively.</p>
<p>To define and use FE-functions <span class="math notranslate nohighlight">\(u_{h},v_{h} \in X_{h}\)</span>, <span class="math notranslate nohighlight">\(p_{h},q_{h} \in M_{h}\)</span> and <span class="math notranslate nohighlight">\(U_{h},V_{h} \in R_{h}\)</span>, we write:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="n">Xh</span> <span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">;</span>
<span class="n">Xph</span> <span class="n">uph</span><span class="p">,</span> <span class="n">vph</span><span class="p">;</span>
<span class="n">Mh</span> <span class="n">ph</span><span class="p">,</span> <span class="n">qh</span><span class="p">;</span>
<span class="n">Rh</span> <span class="p">[</span><span class="n">Uxh</span><span class="p">,</span> <span class="n">Uyh</span><span class="p">,</span> <span class="n">Uyzh</span><span class="p">],</span> <span class="p">[</span><span class="n">Vxh</span><span class="p">,</span> <span class="n">Vyh</span><span class="p">,</span> <span class="n">Vyzh</span><span class="p">];</span>
<span class="n">Xh</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Uh</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>             <span class="c1">//array of 10 functions in Xh</span>
<span class="n">Rh</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="p">[</span><span class="n">Wxh</span><span class="p">,</span><span class="n">Wyh</span><span class="p">,</span><span class="n">Wzh</span><span class="p">](</span><span class="mi">10</span><span class="p">);</span>  <span class="c1">// array of 10 functions in Rh</span>
<span class="n">Wxh</span><span class="p">[</span><span class="mi">5</span><span class="p">](</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">);</span>        <span class="c1">//the 6th function at point (0.5, 0.5, 0.5)</span>
<span class="n">Wxh</span><span class="p">[</span><span class="mi">5</span><span class="p">][];</span>                   <span class="c1">//the array of the degree of freedom of the 6th function</span>
</pre></div>
</div>
<p>The functions <span class="math notranslate nohighlight">\(U_{h}, V_{h}\)</span> have three components, so we have:</p>
<div class="math notranslate nohighlight">
\[U_{h}=\vectthree{Uxh}{Uyh}{Uzh} \quad \mbox{and}\quad V_{h}=\vectthree{Vxh}{Vyh}{Vzh}\]</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>One challenge of the periodic boundary condition is that the mesh must have equivalent faces.</p>
<p>The <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">buildlayers</span></code> mesh generator splits each quadrilateral face with the diagonal passing through the vertex with maximum number, so to be sure to have the same mesh one both face periodic the 2D numbering in corresponding edges must be compatible (for example the same variation).</p>
<p>By Default, the numbering of square vertex is correct.</p>
<p>To change the mesh numbering you can use the <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">change</span></code> function like:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">old2new</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="n">Th</span><span class="p">.</span><span class="kr">nv</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//array set on 0, 1, .., nv-1</span>
    <span class="kt">fespace</span> <span class="nf">Vh2</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
    <span class="n">Vh2</span> <span class="n">sorder</span> <span class="o">=</span> <span class="kr">x</span><span class="o">+</span><span class="kr">y</span><span class="p">;</span> <span class="c1">//choose an order increasing on 4 square borders with x or y</span>
    <span class="nf">sort</span><span class="p">(</span><span class="n">sorder</span><span class="p">[],</span> <span class="n">old2new</span><span class="p">);</span> <span class="c1">//build the inverse permutation</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">new2old</span> <span class="o">=</span> <span class="n">old2new</span><span class="o">^-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//inverse the permutation</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">change</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">renumv</span><span class="o">=</span><span class="n">new2old</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="last">The full example is in <a class="reference internal" href="../example/index.html#exampleperiodic3d"><span class="std std-ref">examples</span></a>.</p>
</div>
</div>
<div class="section" id="lagrangian-finite-elements">
<h2>Lagrangian Finite Elements<a class="headerlink" href="#lagrangian-finite-elements" title="Permalink to this headline">¶</a></h2>
<div class="section" id="p0-element">
<h3>P0-element<a class="headerlink" href="#p0-element" title="Permalink to this headline">¶</a></h3>
<p>For each triangle (d=2) or tetrahedron (d=3) <span class="math notranslate nohighlight">\(T_k\)</span>, the basis function <span class="math notranslate nohighlight">\(\phi_k\)</span> in <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">)</span></code> is given by:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\phi_k(\mathbf{x})=
\left\{
\begin{array}{cl}
    1 &amp; \textrm{ if }(\mathbf{x})\in T_k\\
    0 &amp; \textrm{ if }(\mathbf{x})\not\in T_k
\end{array}
\right.\end{split}\]</div>
<p>If we write:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span><span class="kr">y</span><span class="p">);</span>
</pre></div>
</div>
<p>then for vertices <span class="math notranslate nohighlight">\(q^{k_i},\, i=1,2,.. d+1\)</span> in <a class="reference internal" href="#finiteelementp1p2"><span class="std std-numref">Fig. 42</span></a>, <span class="math notranslate nohighlight">\(f_h\)</span> is built as <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">fh</span><span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle f_h(x,y)=\sum_k f(\frac{\sum_i q^{k_i}}{d+1}) \phi_k\)</span></p>
<p>See <a class="reference internal" href="#finiteelementprojp0"><span class="std std-numref">Fig. 44</span></a> for the projection of <span class="math notranslate nohighlight">\(f(x,y)=\sin(\pi x)\cos(\pi y)\)</span> on <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">)</span></code> when the mesh <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Th</span></code> is a <span class="math notranslate nohighlight">\(4\times 4\)</span>-grid of <span class="math notranslate nohighlight">\([-1,1]^2\)</span> as in <a class="reference internal" href="#finiteelementp0p1p2p1nc"><span class="std std-numref">Fig. 43</span></a>.</p>
</div>
<div class="section" id="p1-element">
<h3>P1-element<a class="headerlink" href="#p1-element" title="Permalink to this headline">¶</a></h3>
<div class="figure" id="finiteelementp1p2">
<img alt="../_images/FiniteElement_P1P2.png" src="../_images/FiniteElement_P1P2.png" />
<p class="caption"><span class="caption-number">Fig. 42 </span><span class="caption-text"><span class="math notranslate nohighlight">\(P_1\)</span> and <span class="math notranslate nohighlight">\(P_2\)</span> degrees of freedom on triangle <span class="math notranslate nohighlight">\(T_k\)</span></span></p>
</div>
<p>For each vertex <span class="math notranslate nohighlight">\(q^i\)</span>, the basis function <span class="math notranslate nohighlight">\(\phi_i\)</span> in <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">)</span></code> is given by:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\phi_i(x,y)&amp;=a^k_i+b^k_ix+c^k_iy \textrm{ for }(x,y)\in T_k,\\
\phi_i(q^i)&amp;=1,\quad \phi_i(q^j)=0 \textrm{ if }i\neq j\end{split}\]</div>
<p>The basis function <span class="math notranslate nohighlight">\(\phi_{k_1}(x,y)\)</span> with the vertex <span class="math notranslate nohighlight">\(q^{k_1}\)</span> in <a class="reference internal" href="#finiteelementp1p2"><span class="std std-numref">Fig. 42</span></a> at point <span class="math notranslate nohighlight">\(p=(x,y)\)</span> in triangle <span class="math notranslate nohighlight">\(T_k\)</span> simply coincide with the <em>barycentric coordinates</em> <span class="math notranslate nohighlight">\(\lambda^k_1\)</span> <em>(area coordinates)</em>:</p>
<div class="math notranslate nohighlight">
\[\phi_{k_1}(x,y) = \lambda^k_{1}(x,y)=
\frac{\textrm{area of triangle} (p, q^{k_2},q^{k_3})}
{\textrm{area of triangle}(q^{k_1},q^{k_2},q^{k_3})}\]</div>
<p>If we write:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">fh</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="kr">x</span><span class="p">.</span><span class="kr">y</span><span class="p">);</span>
</pre></div>
</div>
<p>then:</p>
<p><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">fh</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle f_h(x,y)=\sum_{i=1}^{n_v}f(q^i)\phi_i(x,y)\)</span></p>
<p>See <a class="reference internal" href="#finiteelementprojp1"><span class="std std-numref">Fig. 45</span></a> for the projection of <span class="math notranslate nohighlight">\(f(x,y)=\sin(\pi x)\cos(\pi y)\)</span> into <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">)</span></code>.</p>
<div class="inline2 figure" id="finiteelementp0p1p2p1nc">
<img alt="../_images/FiniteElement_P0P1P2P1nc.png" src="../_images/FiniteElement_P0P1P2P1nc.png" />
<p class="caption"><span class="caption-number">Fig. 43 </span><span class="caption-text">Test mesh <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Th</span></code> for projection</span></p>
</div>
<div class="inline2 figure" id="finiteelementprojp0">
<img alt="../_images/FiniteElement_projP0.png" src="../_images/FiniteElement_projP0.png" />
<p class="caption"><span class="caption-number">Fig. 44 </span><span class="caption-text">Projection to <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">)</span></code></span></p>
</div>
</div>
<div class="section" id="p2-element">
<h3>P2-element<a class="headerlink" href="#p2-element" title="Permalink to this headline">¶</a></h3>
<p>For each vertex or mid-point <span class="math notranslate nohighlight">\(q^i\)</span>.
The basis function <span class="math notranslate nohighlight">\(\phi_i\)</span> in <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">)</span></code> is given by:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    \phi_i(x,y)&amp;=&amp;a^k_i+b^k_ix+c^k_iy+d^k_ix^2+e^k_ixy+f^f_jy^2\textrm{ for }(x,y)\in T_k,\\
    \phi_i(q^i)&amp;=&amp;1,\quad \phi_i(q^j)=0\textrm{ if }i\neq j
\end{array}\end{split}\]</div>
<p>The basis function <span class="math notranslate nohighlight">\(\phi_{k_1}(x,y)\)</span> with the vertex <span class="math notranslate nohighlight">\(q^{k_1}\)</span> in <a class="reference internal" href="#finiteelementp1p2"><span class="std std-numref">Fig. 42</span></a> is defined by the <em>barycentric coordinates</em>:</p>
<div class="math notranslate nohighlight">
\[\phi_{k_1}(x,y) = \lambda^k_{1}(x,y)(2\lambda^k_1(x,y)-1)\]</div>
<p>and for the mid-point <span class="math notranslate nohighlight">\(q^{k_2}\)</span>:</p>
<div class="math notranslate nohighlight">
\[\phi_{k_2}(x,y) = 4\lambda^k_1(x,y)\lambda^k_4(x,y)\]</div>
<p>If we write:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="kr">x</span><span class="p">.</span><span class="kr">y</span><span class="p">);</span>
</pre></div>
</div>
<p>then:</p>
<p><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">fh</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle f_h(x,y)=\sum_{i=1}^{M}f(q^i)\phi_i(x,y)\quad (\textrm{summation over all vertex or mid-point})\)</span></p>
<p>See <a class="reference internal" href="#finiteelementprojp2"><span class="std std-ref">Projection to Vh(Th, P2)</span></a> for the projection of <span class="math notranslate nohighlight">\(f(x,y)=\sin(\pi x)\cos(\pi y)\)</span> into <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">)</span></code>.</p>
<div class="inline2 figure" id="finiteelementprojp1">
<img alt="../_images/FiniteElement_projP1.png" src="../_images/FiniteElement_projP1.png" />
<p class="caption"><span class="caption-number">Fig. 45 </span><span class="caption-text">Projection to <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">)</span></code></span></p>
</div>
<div class="inline2 figure" id="finiteelementprojp2">
<img alt="../_images/FiniteElement_projP2.png" src="../_images/FiniteElement_projP2.png" />
<p class="caption"><span class="caption-number">Fig. 46 </span><span class="caption-text">Projection to <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">)</span></code></span></p>
</div>
</div>
</div>
<div class="section" id="p1-nonconforming-element">
<h2>P1 Nonconforming Element<a class="headerlink" href="#p1-nonconforming-element" title="Permalink to this headline">¶</a></h2>
<p>Refer to <a class="reference internal" href="../reference.html#thomasset2012" id="id3">[THOMASSET2012]</a> for details; briefly, we now consider non-continuous approximations so we will lose the property:</p>
<div class="math notranslate nohighlight">
\[w_h\in V_h\subset H^1(\Omega)\]</div>
<p>If we write:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1nc</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="kr">x</span><span class="p">.</span><span class="kr">y</span><span class="p">);</span>
</pre></div>
</div>
<p>then:</p>
<p><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">fh</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle f_h(x,y)=\sum_{i=1}^{n_v}f(m^i)\phi_i(x,y)\quad (\textrm{summation over all midpoint})\)</span></p>
<p>Here the basis function <span class="math notranslate nohighlight">\(\phi_i\)</span> associated with the mid-point <span class="math notranslate nohighlight">\(m^i=(q^{k_i}+q^{k_{i+1}})/2\)</span> where <span class="math notranslate nohighlight">\(q^{k_i}\)</span> is the <span class="math notranslate nohighlight">\(i\)</span>-th point in <span class="math notranslate nohighlight">\(T_k\)</span>, and we assume that <span class="math notranslate nohighlight">\(j+1=0\)</span> if <span class="math notranslate nohighlight">\(j=3\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\phi_i(x,y) &amp;= a^k_i+b^k_ix+c^k_iy~\textrm{for }(x,y)\in T_k,\\
\phi_i(m^i) &amp;= 1,\quad \phi_i(m^j)=0\textrm{ if }i\neq j\end{split}\]</div>
<p>Strictly speaking <span class="math notranslate nohighlight">\(\p \phi_i/\p x,\, \p \phi_i/\p y\)</span> contain Dirac distribution <span class="math notranslate nohighlight">\(\rho \delta_{\p T_k}\)</span>.</p>
<p>The numerical calculations will automatically <em>ignore</em> them.
In <a class="reference internal" href="../reference.html#thomasset2012" id="id4">[THOMASSET2012]</a>, there is a proof of the estimation</p>
<div class="math notranslate nohighlight">
\[\left(\sum_{k=1}^{n_v}\int_{T_k}|\nabla w-\nabla w_h|^2\d x\d y\right)^{1/2} =O(h)\]</div>
<p>The basis functions <span class="math notranslate nohighlight">\(\phi_k\)</span> have the following properties.</p>
<ol class="arabic">
<li><p class="first">For the bilinear form <span class="math notranslate nohighlight">\(a\)</span> defined in <a class="reference internal" href="#finiteelementprojp1nc"><span class="std std-numref">Fig. 47</span></a> satisfy:</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    a(\phi_i,\phi_i)&gt;0,\qquad a(\phi_i,\phi_j)&amp;\le&amp; 0\quad\textrm{if }i\neq j\\
    \sum_{k=1}^{n_v}a(\phi_i,\phi_k)&amp;\ge&amp; 0
\end{array}\end{split}\]</div>
</div></blockquote>
</li>
<li><p class="first"><span class="math notranslate nohighlight">\(f\ge 0 \Rightarrow u_h\ge 0\)</span></p>
</li>
<li><p class="first">If <span class="math notranslate nohighlight">\(i\neq j\)</span>, the basis function <span class="math notranslate nohighlight">\(\phi_i\)</span> and <span class="math notranslate nohighlight">\(\phi_j\)</span> are <span class="math notranslate nohighlight">\(L^2\)</span>-orthogonal:</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\int_{\Omega}\phi_i\phi_j\, \d x\d y=0\qquad \textrm{if }i\neq j\]</div>
<p>which is false for <span class="math notranslate nohighlight">\(P_1\)</span>-element.</p>
</div></blockquote>
</li>
</ol>
<p>See <a class="reference internal" href="#finiteelementprojp1nc"><span class="std std-numref">Fig. 47</span></a> for the projection of <span class="math notranslate nohighlight">\(f(x,y)=\sin(\pi x)\cos(\pi y)\)</span> into <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1nc</span><span class="p">)</span></code>.</p>
<div class="inline2 figure" id="finiteelementprojp1nc">
<img alt="../_images/FiniteElement_projP1nc.png" src="../_images/FiniteElement_projP1nc.png" />
<p class="caption"><span class="caption-number">Fig. 47 </span><span class="caption-text">Projection to <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1nc</span><span class="p">)</span></code></span></p>
</div>
<div class="inline2 figure" id="finiteelementprojp1b">
<img alt="../_images/FiniteElement_projP1b.png" src="../_images/FiniteElement_projP1b.png" />
<p class="caption"><span class="caption-number">Fig. 48 </span><span class="caption-text">Projection to <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1b</span><span class="p">)</span></code></span></p>
</div>
</div>
<div class="section" id="other-fe-space">
<h2>Other FE-space<a class="headerlink" href="#other-fe-space" title="Permalink to this headline">¶</a></h2>
<p>For each triangle <span class="math notranslate nohighlight">\(T_k\in \mathcal{T}_h\)</span>, let <span class="math notranslate nohighlight">\(\lambda_{k_1}(x,y),\, \lambda_{k_2}(x,y),\, \lambda_{k_3}(x,y)\)</span> be the area cordinate of the triangle (see <a class="reference internal" href="#finiteelementp1p2"><span class="std std-numref">Fig. 42</span></a>), and put:</p>
<div class="math notranslate nohighlight">
\[\beta_k(x,y)=27\lambda_{k_1}(x,y)\lambda_{k_2}(x,y)\lambda_{k_3}(x,y)\]</div>
<p>called <em>bubble</em> function on <span class="math notranslate nohighlight">\(T_k\)</span>.
The bubble function has the feature: 1. <span class="math notranslate nohighlight">\(\beta_k(x,y)=0\quad \textrm{if }(x,y)\in \p T_k\)</span>.</p>
<ol class="arabic simple" start="2">
<li><span class="math notranslate nohighlight">\(\beta_k(q^{k_b})=1\)</span> where <span class="math notranslate nohighlight">\(q^{k_b}\)</span> is the barycenter <span class="math notranslate nohighlight">\(\frac{q^{k_1}+q^{k_2}+q^{k_3}}{3}\)</span>.</li>
</ol>
<p>If we write:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1b</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="kr">x</span><span class="p">.</span><span class="kr">y</span><span class="p">);</span>
</pre></div>
</div>
<p>then:</p>
<p><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">fh</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle f_h(x,y)=\sum_{i=1}^{n_v}f(q^i)\phi_i(x,y)+\sum_{k=1}^{n_t}f(q^{k_b})\beta_k(x,y)\)</span></p>
<p>See <a class="reference internal" href="#finiteelementprojp1b"><span class="std std-numref">Fig. 48</span></a> for the projection of <span class="math notranslate nohighlight">\(f(x,y)=\sin(\pi x)\cos(\pi y)\)</span> into <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1b</span><span class="p">)</span></code>.</p>
</div>
<div class="section" id="vector-valued-fe-function">
<h2>Vector Valued FE-function<a class="headerlink" href="#vector-valued-fe-function" title="Permalink to this headline">¶</a></h2>
<p>Functions from <span class="math notranslate nohighlight">\(\R^{2}\)</span> to <span class="math notranslate nohighlight">\(\R^{N}\)</span> with <span class="math notranslate nohighlight">\(N=1\)</span> are called scalar functions and called <em>vector valued</em> when <span class="math notranslate nohighlight">\(N&gt;1\)</span>.
When <span class="math notranslate nohighlight">\(N=2\)</span></p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="p">[</span><span class="nc">P0</span><span class="p">,</span> <span class="nc">P1</span><span class="p">])</span> <span class="p">;</span>
</pre></div>
</div>
<p>makes the space</p>
<div class="math notranslate nohighlight">
\[V_h=\{\mathbf{w}=(w_1,w_2)|\; w_1\in V_h(\mathcal{T}_h,P_0),\,
w_2\in V_h(\mathcal{T}_h,P_1)\}\]</div>
<div class="section" id="raviart-thomas-element">
<h3>Raviart-Thomas Element<a class="headerlink" href="#raviart-thomas-element" title="Permalink to this headline">¶</a></h3>
<p>In the Raviart-Thomas finite element <span class="math notranslate nohighlight">\(RT0_{h}\)</span>, the degrees of freedom are the fluxes across edges <span class="math notranslate nohighlight">\(e\)</span> of the mesh, where the flux of the function <span class="math notranslate nohighlight">\(\mathbf{f} : \R^2 \longrightarrow \R^2\)</span> is <span class="math notranslate nohighlight">\(\int_{e} \mathbf{f}.n_{e}\)</span>, <span class="math notranslate nohighlight">\(n_{e}\)</span> is the unit normal of edge <span class="math notranslate nohighlight">\(e\)</span>.</p>
<p>This implies an orientation of all the edges of the mesh, for example we can use the global numbering of the edge vertices and we just go from small to large numbers.</p>
<p>To compute the flux, we use a quadrature with one Gauss point, the mid-point of the edge.</p>
<p>Consider a triangle <span class="math notranslate nohighlight">\(T_k\)</span> with three vertices <span class="math notranslate nohighlight">\((\mathbf{a},\mathbf{b},\mathbf{c})\)</span>.</p>
<p>Lets denote the vertices numbers by <span class="math notranslate nohighlight">\(i_{a},i_{b},i_{c}\)</span>, and define the three edge vectors <span class="math notranslate nohighlight">\(\mathbf{e}^{1},\mathbf{e}^{2},\mathbf{e}^{3}\)</span> by <span class="math notranslate nohighlight">\(sgn(i_{b}-i_{c})(\mathbf{b}-\mathbf{c})\)</span>, <span class="math notranslate nohighlight">\(sgn(i_{c}-i_{a})(\mathbf{c}-\mathbf{a})\)</span>, <span class="math notranslate nohighlight">\(sgn(i_{a}-i_{b})(\mathbf{a}-\mathbf{b})\)</span>.</p>
<p>We get three basis functions:</p>
<div class="math notranslate nohighlight">
\[\boldsymbol{\phi}^{k}_{1}= \frac{sgn(i_{b}-i_{c})}{2|T_k|}(\mathbf{x}-\mathbf{a}),\quad
\boldsymbol{\phi}^{k}_{2}= \frac{sgn(i_{c}-i_{a})}{2|T_k|}(\mathbf{x}-\mathbf{b}),\quad
\boldsymbol{\phi}^{k}_{3}= \frac{sgn(i_{a}-i_{b})}{2|T_k|}(\mathbf{x}-\mathbf{c}),\]</div>
<p>where <span class="math notranslate nohighlight">\(|T_k|\)</span> is the area of the triangle <span class="math notranslate nohighlight">\(T_k\)</span>.
If we write:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="n">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">RT0</span><span class="p">);</span>
<span class="n">Vh</span> <span class="p">[</span><span class="n">f1h</span><span class="p">,</span> <span class="n">f2h</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f1</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">),</span> <span class="n">f2</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">)];</span>
</pre></div>
</div>
<p>then:</p>
<p><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">fh</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle \mathbf{f}_h(x,y)=\sum_{k=1}^{n_t}\sum_{l=1}^6 n_{i_lj_l}|\mathbf{e^{i_l}}|f_{j_l}(m^{i_l})\phi_{i_lj_l}\)</span></p>
<p>where <span class="math notranslate nohighlight">\(n_{i_lj_l}\)</span> is the <span class="math notranslate nohighlight">\(j_l\)</span>-th component of the normal vector <span class="math notranslate nohighlight">\(\mathbf{n}_{i_l}\)</span>,</p>
<div class="math notranslate nohighlight">
\[\{m_1,m_2,m_3\} = \left\{\frac{\mathbf{b}+\mathbf{c}}{2},
\frac{\mathbf{a}+\mathbf{c}}{2},
\frac{\mathbf{b}+\mathbf{a}}{2} \right\}\]</div>
<p>and <span class="math notranslate nohighlight">\(i_l=\{1,1,2,2,3,3\},\, j_l=\{1,2,1,2,1,2\}\)</span> with the order of <span class="math notranslate nohighlight">\(l\)</span>.</p>
<div class="figure" id="finiteelementrt0">
<img alt="../_images/FiniteElement_RT0.png" src="../_images/FiniteElement_RT0.png" />
<p class="caption"><span class="caption-number">Fig. 49 </span><span class="caption-text">Normal vectors of each edge</span></p>
</div>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Xh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Xh</span> <span class="n">uh</span> <span class="o">=</span> <span class="kr">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="kr">y</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="n">vh</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">RT0</span><span class="p">);</span>
<span class="n">Vh</span> <span class="p">[</span><span class="n">Uxh</span><span class="p">,</span> <span class="n">Uyh</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">),</span> <span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">)];</span> <span class="c1">//vectorial FE function</span>

<span class="c1">// Change the mesh</span>
<span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>

<span class="c1">//Xh is unchanged</span>
<span class="c1">//Uxh = x; //error: impossible to set only 1 component</span>
          <span class="c1">//of a vector FE function</span>
<span class="n">vh</span> <span class="o">=</span> <span class="n">Uxh</span><span class="p">;</span><span class="c1">//ok</span>
<span class="c1">//and now vh use the 5x5 mesh</span>
<span class="c1">//but the fespace of vh is always the 2x2 mesh</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uh</span><span class="p">);</span>
<span class="n">uh</span> <span class="o">=</span> <span class="n">uh</span><span class="p">;</span> <span class="c1">//do a interpolation of uh (old) of 5x5 mesh</span>
        <span class="c1">//to get the new uh on 10x10 mesh</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uh</span><span class="p">);</span>

<span class="n">vh</span><span class="p">([</span><span class="kr">x</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="kr">y</span><span class="p">])</span> <span class="o">=</span> <span class="kr">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="kr">y</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span> <span class="c1">//interpolate vh = ((x-1/2)^2 + y^2)</span>
</pre></div>
</div>
<div class="inline2 figure" id="finiteelementonoldmesh">
<img alt="../_images/FiniteElement_onoldmesh.png" src="../_images/FiniteElement_onoldmesh.png" />
<p class="caption"><span class="caption-number">Fig. 50 </span><span class="caption-text"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">vh</span></code> Iso on mesh <span class="math notranslate nohighlight">\(2\times 2\)</span></span></p>
</div>
<div class="inline2 figure" id="finiteelementonnewmesh">
<img alt="../_images/FiniteElement_onnewmesh.png" src="../_images/FiniteElement_onnewmesh.png" />
<p class="caption"><span class="caption-number">Fig. 51 </span><span class="caption-text"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">vh</span></code> Iso on  mesh <span class="math notranslate nohighlight">\(5\times 5\)</span></span></p>
</div>
<p>To get the value at a point <span class="math notranslate nohighlight">\(x=1,y=2\)</span> of the FE function <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">uh</span></code>, or <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="n">Uxh</span><span class="p">,</span> <span class="n">Uyh</span><span class="p">]</span></code>, one writes:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">real</span> <span class="kp">value</span><span class="p">;</span>
<span class="kp">value</span> <span class="o">=</span> <span class="n">uh</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span> <span class="c1">//get value = uh(2, 4)</span>
<span class="kp">value</span> <span class="o">=</span> <span class="n">Uxh</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="c1">//get value = Uxh(2, 4)</span>
<span class="c1">//OR</span>
<span class="kr">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="kr">y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="kp">value</span> <span class="o">=</span> <span class="n">uh</span><span class="p">;</span> <span class="c1">//get value = uh(1, 2)</span>
<span class="kp">value</span> <span class="o">=</span> <span class="n">Uxh</span><span class="p">;</span> <span class="c1">//get value = Uxh(1, 2)</span>
<span class="kp">value</span> <span class="o">=</span> <span class="n">Uyh</span><span class="p">;</span> <span class="c1">//get value = Uyh(1, 2)</span>
</pre></div>
</div>
<p>To get the value of the array associated to the FE function <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">uh</span></code>, one writes</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">real</span> <span class="kp">value</span> <span class="o">=</span> <span class="n">uh</span><span class="p">[][</span><span class="mi">0</span><span class="p">];</span> <span class="c1">//get the value of degree of freedom 0</span>
<span class="kt">real</span> <span class="n">maxdf</span> <span class="o">=</span> <span class="n">uh</span><span class="p">[].</span><span class="kr">max</span><span class="p">;</span> <span class="c1">//maximum value of degree of freedom</span>
<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">uh</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="c1">//the number of degree of freedom</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">array</span><span class="p">(</span><span class="n">uh</span><span class="p">.</span><span class="kr">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">uh</span><span class="p">[];</span> <span class="c1">//copy the array of the function uh</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">For a non-scalar finite element function <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">[</span><span class="n">Uxh</span><span class="p">,</span> <span class="n">Uyh</span><span class="p">]</span></code> the two arrays <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Uxh</span><span class="p">[]</span></code> and <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Uyh</span><span class="p">[]</span></code> are the same array, because the degree of freedom can touch more than one component.</p>
</div>
</div>
</div>
<div class="section" id="a-fast-finite-element-interpolator">
<h2>A Fast Finite Element Interpolator<a class="headerlink" href="#a-fast-finite-element-interpolator" title="Permalink to this headline">¶</a></h2>
<p>In practice, one may discretize the variational equations by the Finite Element method.
Then there will be one mesh for <span class="math notranslate nohighlight">\(\Omega_1\)</span> and another one for <span class="math notranslate nohighlight">\(\Omega_2\)</span>.
The computation of integrals of products of functions defined on different meshes is difficult.</p>
<p>Quadrature formula and interpolations from one mesh to another at quadrature points are needed.
We present below the interpolation operator which we have used and which is new, to the best of our knowledge.</p>
<p>Let <span class="math notranslate nohighlight">\({\cal T}_{h}^0=\cup_k T^0_k,{\cal T}_{h}^1=\cup_k T^1_k\)</span> be two triangulations of a domain <span class="math notranslate nohighlight">\(\Omega\)</span>.
Let:</p>
<div class="math notranslate nohighlight">
\[V({\hbox{{\cal T}}_{h}^i}) =\{ C^0(\Omega_h^i)~:~f|_{T^i_k}\in P_0\},~~~i=0,1\]</div>
<p>be the spaces of continuous piecewise affine functions on each triangulation.</p>
<p>Let <span class="math notranslate nohighlight">\(f\in V({\cal T}_{h}^0)\)</span>.
The problem is to find <span class="math notranslate nohighlight">\(g\in V({\cal T}_{h}^1)\)</span> such that:</p>
<div class="math notranslate nohighlight">
\[g(q) = f(q) \quad \forall q\hbox{~vertex of ~} {\cal T}_{h}^1\]</div>
<p>Although this is a seemingly simple problem, it is difficult to find an efficient algorithm in practice.</p>
<p>We propose an algorithm which is of complexity <span class="math notranslate nohighlight">\(N^1\log N^0\)</span>, where <span class="math notranslate nohighlight">\(N^i\)</span> is the number of vertices of <span class="math notranslate nohighlight">\(\cal T_{h}^i\)</span>, and which is very fast for most practical 2D applications.</p>
<p><strong>Algorithm</strong></p>
<p>The method has 5 steps.</p>
<p>First a quadtree is built containing all the vertices of the mesh <span class="math notranslate nohighlight">\({\cal T}_{h}^0\)</span> such that in each terminal cell there are at least one, and at most 4, vertices of <span class="math notranslate nohighlight">\({\cal T}_{h}^0\)</span>.</p>
<p>For each <span class="math notranslate nohighlight">\(q^1\)</span>, vertex of <span class="math notranslate nohighlight">\({\cal T}_{h}^1\)</span> do:</p>
<ol class="arabic">
<li><p class="first">Find the terminal cell of the quadtree containing <span class="math notranslate nohighlight">\(q^1\)</span>.</p>
</li>
<li><p class="first">Find the the nearest vertex <span class="math notranslate nohighlight">\(q^0_j\)</span> to <span class="math notranslate nohighlight">\(q^1\)</span> in that cell.</p>
</li>
<li><p class="first">Choose one triangle <span class="math notranslate nohighlight">\(T_k^0\in{\cal T}_{h}^0\)</span> which has <span class="math notranslate nohighlight">\(q^0_j\)</span> for vertex.</p>
</li>
<li><p class="first">Compute the barycentric coordinates <span class="math notranslate nohighlight">\(\{\lambda_j\}_{j=1,2,3}\)</span> of <span class="math notranslate nohighlight">\(q^1\)</span> in <span class="math notranslate nohighlight">\(T^0_k\)</span>.</p>
<blockquote>
<div><ul class="simple">
<li>if all barycentric coordinates are positive, go to Step 5</li>
<li>otherwise, if one barycentric coordinate <span class="math notranslate nohighlight">\(\lambda_i\)</span> is negative, replace <span class="math notranslate nohighlight">\(T^0_k\)</span> by the adjacent triangle opposite <span class="math notranslate nohighlight">\(q^0_i\)</span> and go to Step 4.</li>
<li>otherwise, if two barycentric coordinates are negative, take one of the two randomly and replace <span class="math notranslate nohighlight">\(T^0_k\)</span> by the adjacent triangle as above.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Calculate <span class="math notranslate nohighlight">\(g(q^1)\)</span> on <span class="math notranslate nohighlight">\(T^0_k\)</span> by linear interpolation of <span class="math notranslate nohighlight">\(f\)</span>:</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[g(q^1) = \sum_{j=1,2,3} \lambda_j f(q^0_j)\]</div>
</div></blockquote>
</li>
</ol>
<div class="figure" id="finiteelementfastinterpolate">
<img alt="../_images/FiniteElement_fastInterpolate.png" src="../_images/FiniteElement_fastInterpolate.png" />
<p class="caption"><span class="caption-number">Fig. 52 </span><span class="caption-text">To interpolate a function at <span class="math notranslate nohighlight">\(q^0\)</span>, the knowledge of the triangle which contains <span class="math notranslate nohighlight">\(q^0\)</span> is needed. The algorithm may start at <span class="math notranslate nohighlight">\(q^1\in T_k^0\)</span> and stall on the boundary (thick line) because the line <span class="math notranslate nohighlight">\(q^0q^1\)</span> is not inside <span class="math notranslate nohighlight">\(\Omega\)</span>.
But if the holes are triangulated too (doted line) then the problem does not arise.</span></p>
</div>
<p>Two problems need to be solved:</p>
<ul>
<li><p class="first"><em>What if :math:`q^1` is not in</em> <span class="math notranslate nohighlight">\(\Omega^0_h\)</span> <em>?</em> Then Step 5 will stop with a boundary triangle.</p>
<blockquote>
<div><p>So we add a step which tests the distance of <span class="math notranslate nohighlight">\(q^1\)</span> with the two adjacent boundary edges and selects the nearest, and so on till the distance grows.</p>
</div></blockquote>
</li>
<li><p class="first"><em>What if</em> <span class="math notranslate nohighlight">\(\Omega^0_h\)</span> <em>is not convex and the marching process of Step 4 locks on a boundary?</em> By construction Delaunay-Voronoï’s mesh generators always triangulate the convex hull of the vertices of the domain.</p>
<blockquote>
<div><p>Therefore, we make sure that this information is not lost when <span class="math notranslate nohighlight">\({\cal T}_{h}^0,{\cal T}_{h}^1\)</span> are constructed and we keep the triangles which are outside the domain on a special list.</p>
<p>That way, in step 5 we can use that list to step over holes if needed.</p>
</div></blockquote>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Sometimes, in rare cases, the interpolation process misses some points, we can change the search algorithm through a global variable <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">searchMethod</span></code></p>
<div class="last highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kr">searchMethod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// default value for fast search algorithm</span>
<span class="kr">searchMethod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// safe search algorithm, uses brute force in case of missing point</span>
<span class="c1">// (warning: can be very expensive in cases where a lot of points are outside of the domain)</span>
<span class="kr">searchMethod</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// always uses brute force. It is very computationally expensive.</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Step 3 requires an array of pointers such that each vertex points to one triangle of the triangulation.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The operator <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="o">=</span></code> is the interpolation operator of <strong>FreeFem++</strong>, the continuous finite functions are extended by continuity to the outside of the domain.</p>
<p>Try the following example :</p>
<blockquote class="last">
<div><div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Ths</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="kt">mesh</span> <span class="n">Thg</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="p">[</span><span class="kr">x</span><span class="o">*</span><span class="mi">3</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kr">y</span><span class="o">*</span><span class="mi">3</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Ths</span><span class="p">,</span> <span class="n">Thg</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Ch</span><span class="p">(</span><span class="n">Ths</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span>
<span class="n">Ch</span> <span class="n">us</span> <span class="o">=</span> <span class="p">(</span><span class="kr">x</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kr">y</span><span class="o">-</span><span class="mf">0.5</span><span class="p">);</span>

<span class="kt">fespace</span> <span class="nf">Dh</span><span class="p">(</span><span class="n">Ths</span><span class="p">,</span> <span class="nc">P2dc</span><span class="p">);</span>
<span class="n">Dh</span> <span class="n">vs</span> <span class="o">=</span> <span class="p">(</span><span class="kr">x</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kr">y</span><span class="o">-</span><span class="mf">0.5</span><span class="p">);</span>

<span class="kt">fespace</span> <span class="nf">Fh</span><span class="p">(</span><span class="n">Thg</span><span class="p">,</span> <span class="nc">P2dc</span><span class="p">);</span>
<span class="n">Fh</span> <span class="n">ug</span><span class="o">=</span><span class="n">us</span><span class="p">,</span> <span class="n">vg</span><span class="o">=</span><span class="n">vs</span><span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">ug</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span> <span class="n">vg</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
</pre></div>
</div>
<div class="inline2 figure" id="finiteelementusug">
<img alt="../_images/FiniteElement_UsUg.png" src="../_images/FiniteElement_UsUg.png" />
<p class="caption"><span class="caption-number">Fig. 53 </span><span class="caption-text">Extension of a continuous FE-function</span></p>
</div>
<div class="inline2 figure" id="finiteelementvsvg">
<img alt="../_images/FiniteElement_VsVg.png" src="../_images/FiniteElement_VsVg.png" />
<p class="caption"><span class="caption-number">Fig. 54 </span><span class="caption-text">Extension of discontinuous FE-function</span></p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="keywords-problem-and-solve">
<h2>Keywords: Problem and Solve<a class="headerlink" href="#keywords-problem-and-solve" title="Permalink to this headline">¶</a></h2>
<p>For <strong>FreeFem++</strong>, a problem must be given in variational form, so we need a bilinear form <span class="math notranslate nohighlight">\(a(u,v)\)</span>, a linear form <span class="math notranslate nohighlight">\(\ell(f,v)\)</span>, and possibly a boundary condition form must be added.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">problem</span> <span class="kr">P</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="n">l</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    <span class="o">+</span> <span class="p">(</span><span class="kp">boundary</span> <span class="n">condition</span><span class="p">)</span>
    <span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When you want to formulate the problem and solve it in the same time, you can use the keyword <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">solve</span></code>.</p>
</div>
<div class="section" id="weak-form-and-boundary-condition">
<h3>Weak Form and Boundary Condition<a class="headerlink" href="#weak-form-and-boundary-condition" title="Permalink to this headline">¶</a></h3>
<p>To present the principles of Variational Formulations, also called weak form, for the Partial Differential Equations, let’s take a model problem: a Poisson equation with Dirichlet and Robin Boundary condition.</p>
<p>The problem: Find <span class="math notranslate nohighlight">\(u\)</span> a real function defined on a domain <span class="math notranslate nohighlight">\(\Omega\)</span> of <span class="math notranslate nohighlight">\(\R^d\)</span> <span class="math notranslate nohighlight">\((d=2,3)\)</span> such that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcll}
    -\nabla\cdot(\kappa \nabla u) &amp;=&amp; f &amp; \mbox{ in }\Omega\\
    a u + \kappa \frac{\p u}{\p n} &amp;=&amp; b &amp; \mbox{ on }\Gamma_r\\
    u &amp;=&amp; g &amp; \mbox{ on }\Gamma_d
\end{array}\end{split}\]</div>
<p>where:</p>
<ul class="simple">
<li>if <span class="math notranslate nohighlight">\(d=2\)</span> then <span class="math notranslate nohighlight">\(\nabla.(\kappa \nabla u) = \p_x(\kappa \p_x u ) + \p_y(\kappa \p_y u )\)</span> with <span class="math notranslate nohighlight">\(\p_x u = \frac{\p u}{\p x}\)</span> and <span class="math notranslate nohighlight">\(\p_y u = \frac{\p u}{\p y}\)</span></li>
<li>if <span class="math notranslate nohighlight">\(d=3\)</span> then <span class="math notranslate nohighlight">\(\nabla.(\kappa \nabla u) = \p_x(\kappa \p_x u) + \p_y(\kappa \p_y u) + \p_z(\kappa \p_z u)\)</span> with <span class="math notranslate nohighlight">\(\p_x u = \frac{\p u}{\p x}\)</span>, <span class="math notranslate nohighlight">\(\p_y u = \frac{\p u}{\p y}\)</span> and , <span class="math notranslate nohighlight">\(\p_z u = \frac{\p u}{\p z}\)</span></li>
<li>The border <span class="math notranslate nohighlight">\(\Gamma=\p \Omega\)</span> is split in <span class="math notranslate nohighlight">\(\Gamma_d\)</span> and <span class="math notranslate nohighlight">\(\Gamma_n\)</span> such that <span class="math notranslate nohighlight">\(\Gamma_d \cap \Gamma_n = \emptyset\)</span> and <span class="math notranslate nohighlight">\(\Gamma_d \cup \Gamma_n = \p \Omega\)</span>,</li>
<li><span class="math notranslate nohighlight">\(\kappa\)</span> is a given positive function, such that <span class="math notranslate nohighlight">\(\exists \kappa_0 \in \R ,\quad 0 &lt; \kappa_0 \leq \kappa\)</span>.</li>
<li><span class="math notranslate nohighlight">\(a\)</span> a given non negative function,</li>
<li><span class="math notranslate nohighlight">\(b\)</span> a given function.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This is the well known Neumann boundary condition if <span class="math notranslate nohighlight">\(a=0\)</span>, and if <span class="math notranslate nohighlight">\(\Gamma_d\)</span> is empty.</p>
<p class="last">In this case the function appears in the problem just by its derivatives, so it is defined only up to a constant (if <span class="math notranslate nohighlight">\(u\)</span> is a solution then <span class="math notranslate nohighlight">\(u+c\)</span> is also a solution).</p>
</div>
<p>Let <span class="math notranslate nohighlight">\({v}\)</span>, a regular test function, null on <span class="math notranslate nohighlight">\(\Gamma_d\)</span>, by integration by parts we get:</p>
<div class="math notranslate nohighlight">
\[- \int_{\Omega} \nabla\cdot(\kappa \nabla u) \, {v} \,d\omega
= \int_{\Omega} \kappa \nabla{ v} \cdot \nabla u \,d\omega
- \int_{\Gamma} {v}\kappa \frac{ \p u}{\p \mathbf{n}} \,d\gamma,= \int_{\Omega} f {v} \,d\omega\]</div>
<p>where if <span class="math notranslate nohighlight">\(d=2\)</span> the <span class="math notranslate nohighlight">\(\nabla{ v} . \nabla u = (\frac{\p u}{\p x}\frac{\p { v}}{\p x}+\frac{\p u}{\p y}\frac{\p { v}}{\p y})\)</span>,</p>
<p>where if <span class="math notranslate nohighlight">\(d=3\)</span> the <span class="math notranslate nohighlight">\(\nabla{ v} . \nabla u = (\frac{\p u}{\p x}\frac{\p { v}}{\p x}+\frac{\p u}{\p y}\frac{\p { v}}{\p y} + \frac{\p u}{\p z}\frac{\p { v}}{\p z})\)</span>,</p>
<p>and where <span class="math notranslate nohighlight">\(\mathbf{n}\)</span> is the unitary outer-pointing normal of the <span class="math notranslate nohighlight">\(\Gamma\)</span>.</p>
<p>Now we note that <span class="math notranslate nohighlight">\(\kappa \frac{ \p u}{\p n} = - a u + b\)</span> on <span class="math notranslate nohighlight">\(\Gamma_r\)</span> and <span class="math notranslate nohighlight">\(v=0\)</span> on <span class="math notranslate nohighlight">\(\Gamma_d\)</span> and <span class="math notranslate nohighlight">\(\Gamma = \Gamma_d \cup \Gamma_n\)</span> thus:</p>
<div class="math notranslate nohighlight">
\[- \int_{\Gamma} {v}
\kappa \frac{ \p u}{\p n} = \int_{\Gamma_r} a u v - \int_{\Gamma_r} b v\]</div>
<p>The problem becomes:</p>
<p>Find <span class="math notranslate nohighlight">\(u \in V_g = \{w \in H^1(\Omega) / w = g \mbox{ on } \Gamma_d \}\)</span> such that:</p>
<div class="math notranslate nohighlight" id="equation-eqn-v-poisson">
<span class="eqno">(17)<a class="headerlink" href="#equation-eqn-v-poisson" title="Permalink to this equation">¶</a></span>\[{\int_{\Omega} \kappa \nabla{ v} . \nabla u \,d\omega + \int_{\Gamma_r} a u v \,d\gamma = \int_{\Omega} f {v}} \,d\omega
+ \int_{\Gamma_r} b v \,d\gamma , \quad \forall v \in V_0\]</div>
<p>where <span class="math notranslate nohighlight">\(V_0 = \{v \in H^1(\Omega) / v = 0 \mbox{ on } \Gamma_d \}\)</span></p>
<p>Except in the case of Neumann conditions everywhere, the problem <a class="reference internal" href="#equation-eqn-v-poisson">(17)</a> is well posed when <span class="math notranslate nohighlight">\(\kappa\geq \kappa_0&gt;0\)</span>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If we have only the Neumann boundary condition, linear algebra tells us that the right hand side must be orthogonal to the kernel of the operator for the solution to exist.</p>
<blockquote>
<div><p>One way of writing the compatibility condition is:</p>
<div class="math notranslate nohighlight">
\[\int_{\Omega} f \,d\omega + \int_{\Gamma} b \,d\gamma=0\]</div>
<p>and a way to fix the constant is to solve for <span class="math notranslate nohighlight">\(u \in H^1(\Omega)\)</span> such that:</p>
<div class="math notranslate nohighlight">
\[{\int_{\Omega} (\varepsilon u v \; + \; \kappa \nabla{ v} . \nabla u) \,d\omega
= \int_{\Omega} f {v}} \,d\omega + \int_{\Gamma_r} b v \,d\gamma , \quad \forall v \in H^1(\Omega)\]</div>
<p>where <span class="math notranslate nohighlight">\(\varepsilon\)</span> is a small parameter (<span class="math notranslate nohighlight">\(\sim \kappa\; 10^{-10} |\Omega|^{\frac2d}\)</span>).</p>
</div></blockquote>
<p class="last">Remark that if the solution is of order <span class="math notranslate nohighlight">\(\frac{1}{\varepsilon}\)</span> then the compatibility condition is unsatisfied, otherwise we get the solution such that <span class="math notranslate nohighlight">\(\int_\Omega u = 0\)</span>, you can also add a Lagrange multiplier to solve the real mathematical problem like in the <a class="reference internal" href="../example/index.html#examplelagrangemultipliers"><span class="std std-ref">Lagrange multipliers example</span></a>.</p>
</div>
<p>In <strong>FreeFem++</strong>, the bidimensional problem <a class="reference internal" href="#equation-eqn-v-poisson">(17)</a> becomes:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">problem</span> <span class="nf">Pw</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span> <span class="o">//</span><span class="n">int_</span><span class="p">{</span><span class="n">Omega</span><span class="p">}</span> <span class="n">kappa</span> <span class="n">nabla</span> <span class="n">v</span> <span class="p">.</span> <span class="n">nabla</span> <span class="n">u</span>
        <span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">gn</span><span class="p">)(</span> <span class="c1">//int_{Gamma_r} a u v</span>
        <span class="n">a</span> <span class="o">*</span> <span class="n">u</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span> <span class="c1">//int_{Omega} f v</span>
        <span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">gn</span><span class="p">)(</span> <span class="c1">//int_{Gamma_r} b v</span>
        <span class="n">b</span> <span class="o">*</span> <span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">gd</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">g</span><span class="p">)</span> <span class="c1">//u = g on Gamma_d</span>
    <span class="p">;</span>
</pre></div>
</div>
<p>where <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Th</span></code> is a mesh of the bi-dimensional domain <span class="math notranslate nohighlight">\(\Omega\)</span>, and <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">gd</span></code> and <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">gn</span></code> are respectively the boundary labels of boundary <span class="math notranslate nohighlight">\(\Gamma_d\)</span> and <span class="math notranslate nohighlight">\(\Gamma_n\)</span>.</p>
<p>And the three dimensional problem <a class="reference internal" href="#equation-eqn-v-poisson">(17)</a> becomes</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">macro</span> <span class="nf">Grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dz</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">]</span><span class="c1">//</span>
<span class="kt">problem</span> <span class="n">Pw</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span> <span class="o">//</span><span class="n">int_</span><span class="p">{</span><span class="n">Omega</span><span class="p">}</span> <span class="n">kappa</span> <span class="n">nabla</span> <span class="n">v</span> <span class="p">.</span> <span class="n">nabla</span> <span class="n">u</span>
        <span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="n">Grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">&#39;*</span><span class="n">Grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">gn</span><span class="p">)(</span> <span class="c1">//int_{Gamma_r} a u v</span>
        <span class="n">a</span> <span class="o">*</span> <span class="n">u</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span> <span class="c1">//int_{Omega} f v</span>
        <span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">gn</span><span class="p">)(</span> <span class="c1">//int_{Gamma_r} b v</span>
        <span class="n">b</span> <span class="o">*</span> <span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">gd</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">g</span><span class="p">)</span> <span class="c1">//u = g on Gamma_d</span>
    <span class="p">;</span>
</pre></div>
</div>
<p>where <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Th</span></code> is a mesh of the three dimensional domain <span class="math notranslate nohighlight">\(\Omega\)</span>, and <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">gd</span></code> and <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">gn</span></code> are respectively the boundary labels of boundary <span class="math notranslate nohighlight">\(\Gamma_d\)</span> and <span class="math notranslate nohighlight">\(\Gamma_n\)</span>.</p>
</div>
</div>
<div class="section" id="parameters-affecting-solve-and-problem">
<h2>Parameters affecting solve and problem<a class="headerlink" href="#parameters-affecting-solve-and-problem" title="Permalink to this headline">¶</a></h2>
<p>The parameters are FE functions real or complex, the number <span class="math notranslate nohighlight">\(n\)</span> of parameters is even (<span class="math notranslate nohighlight">\(n=2*k\)</span>), the <span class="math notranslate nohighlight">\(k\)</span> first function parameters are unknown, and the <span class="math notranslate nohighlight">\(k\)</span> last are test functions.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the functions are a part of vectorial FE then you must give all the functions of the vectorial FE in the same order (see <a class="reference internal" href="../model/staticProblems.html#modelstaticpoissonwithmixedboundarycondition"><span class="std std-ref">Poisson problem with mixed finite element</span></a> for example).</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Don’t mix complex and real parameters FE function.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Bug:</strong></p>
<p>The mixing of multiple <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">fespace</span></code> with different periodic boundary conditions are not implemented.</p>
<p>So all the finite element spaces used for tests or unknown functions in a problem, must have the same type of periodic boundary conditions or no periodic boundary conditions.</p>
<p class="last">No clean message is given and the result is unpredictable.</p>
</div>
<p>The parameters are:</p>
<ul>
<li><p class="first"><strong>solver=</strong> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">LU</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">CG</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Crout</span></code>,  <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Cholesky</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">GMRES</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">sparsesolver</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">UMFPACK</span></code> …</p>
<blockquote>
<div><p>The default solver is <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">sparsesolver</span></code> (it is equal to <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">UMFPACK</span></code> if no other sparse solver is defined) or is set to <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">LU</span></code> if no direct sparse solver is available.</p>
<p>The storage mode of the matrix of the underlying linear system depends on the type of solver chosen; for <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">LU</span></code> the matrix is sky-line non symmetric, for <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Crout</span></code> the matrix is sky-line symmetric, for <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Cholesky</span></code> the matrix is sky-line symmetric positive definite, for <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">CG</span></code> the matrix is sparse symmetric positive, and for <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">GMRES</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">sparsesolver</span></code> or <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">UMFPACK</span></code> the matrix is just sparse.</p>
</div></blockquote>
</li>
<li><p class="first"><strong>eps=</strong> a real expression.</p>
<blockquote>
<div><p><span class="math notranslate nohighlight">\(\varepsilon\)</span> sets the stopping test for the iterative methods like <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">CG</span></code>.</p>
<p>Note that if <span class="math notranslate nohighlight">\(\varepsilon\)</span> is negative then the stopping test is:</p>
<div class="math notranslate nohighlight">
\[|| A x - b || &lt; |\varepsilon|\]</div>
<p>if it is positive, then the stopping test is:</p>
<div class="math notranslate nohighlight">
\[|| A x - b || &lt; \frac{|\varepsilon|}{|| A x_{0} - b ||}\]</div>
</div></blockquote>
</li>
<li><p class="first"><strong>init=</strong> boolean expression, if it is false or 0 the matrix is reconstructed.</p>
<blockquote>
<div><p>Note that if the mesh changes the matrix is reconstructed too.</p>
</div></blockquote>
</li>
<li><p class="first"><strong>precon=</strong> name of a function (for example <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">P</span></code>) to set the preconditioner.</p>
<blockquote>
<div><p>The prototype for the function <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">P</span></code> must be:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="kr">P</span><span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">xx</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>tgv=</strong> Huge value (<span class="math notranslate nohighlight">\(10^{30}\)</span>) used to implement Dirichlet boundary conditions.</p>
</li>
<li><p class="first"><strong>tolpivot=</strong> sets the tolerance of the pivot in <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">UMFPACK</span></code> (<span class="math notranslate nohighlight">\(10^{-1}\)</span>) and, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">LU</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Crout</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Cholesky</span></code> factorisation (<span class="math notranslate nohighlight">\(10^{-20}\)</span>).</p>
</li>
<li><p class="first"><strong>tolpivotsym=</strong> sets the tolerance of the pivot sym in <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">UMFPACK</span></code></p>
</li>
<li><p class="first"><strong>strategy=</strong> sets the integer <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">UMFPACK</span></code> strategy (<span class="math notranslate nohighlight">\(0\)</span> by default).</p>
</li>
</ul>
</div>
<div class="section" id="problem-definition">
<span id="problemdefinition"></span><h2>Problem definition<a class="headerlink" href="#problem-definition" title="Permalink to this headline">¶</a></h2>
<p>Below <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">v</span></code> is the unknown function and <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">w</span></code> is the test function.</p>
<p>After the “=” sign, one may find sums of:</p>
<ul>
<li><p class="first">Identifier(s); this is the name given earlier to the variational form(s) (type <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">varf</span></code> ) for possible reuse.</p>
<blockquote>
<div><p>Remark, that the name in the <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">varf</span></code> of the unknown test function is forgotten, we use the order in the argument list to recall names as in a <code class="docutils literal highlight highlight-default"><span></span><span class="n">C</span><span class="o">++</span></code> function,</p>
</div></blockquote>
</li>
<li><p class="first">The terms of the bilinear form itself: if <span class="math notranslate nohighlight">\(K\)</span> is a given function,</p>
</li>
<li><p class="first">Bilinear part for 3D meshes <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Th</span></code></p>
<blockquote>
<div><ul class="simple">
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{T } K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\subset \Omega_{1}}\int_{T} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{T,\phi&lt;0} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\subset \Omega_{l}}\int_{T,\phi&lt;0} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{(\p T\cup\Gamma) \cap ( \Gamma_2 \cup \Gamma_{5})} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\subset \Omega_{1}}\int_{T} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{(\p T\cup\Gamma) \cap (\Gamma_2 \cup \Gamma_{5})} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{T,\phi=0} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\subset \Omega_{l}}\int_{T,\phi=0} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">intallfaces</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{\p T } K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">intallfaces</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{{T\in\mathtt{Th},T\subset \Omega_{1}}}\int_{\p T } K\,v\,w\)</span></li>
<li>They contribute to the sparse matrix of type <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">matrix</span></code> which, whether declared explicitly or not, is constructed by <strong>FreeFem++</strong>.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Bilinear part for 2D meshes <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Th</span></code></p>
<blockquote>
<div><ul class="simple">
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{T } K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\subset \Omega_{1}}\int_{T} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{T,\phi&lt;0} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\subset \Omega_{l}}\int_{T,\phi&lt;0} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{(\p T\cup\Gamma) \cap ( \Gamma_2 \cup \Gamma_{5})} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\subset \Omega_{1}}\int_{T} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{(\p T\cup\Gamma) \cap ( \Gamma_2 \cup \Gamma_{5})} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{T,\phi=0} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\subset \Omega_{l}}\int_{T,\phi=0} K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">intalledges</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{\p T } K\,v\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">intalledges</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{{T\in\mathtt{Th},T\subset \Omega_{1}}}\int_{\p T } K\,v\,w\)</span></li>
<li>They contribute to the sparse matrix of type <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">matrix</span></code> which, whether declared explicitly or not, is constructed by <strong>FreeFem++</strong>.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">The right hand-side of the Partial Differential Equation in 3D, the terms of the linear form: for given functions <span class="math notranslate nohighlight">\(K,\, f\)</span>:</p>
<blockquote>
<div><ul class="simple">
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{T} K\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">l</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\in\Omega_l}\int_{T} K\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{T,\phi&lt;0} K\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\subset\Omega_{l}}\int_{T,\phi&lt;0} K\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{(\p T\cup\Gamma) \cap ( \Gamma_2 \cup \Gamma_{5}) } K \,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{T,\phi=0} K\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\subset \Omega_{l}}\int_{T,\phi=0} K\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">intallfaces</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{\p T } f\,w\)</span></li>
<li>A vector of type <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span></code></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">The right hand-side of the Partial Differential Equation in 2D, the terms of the linear form: for given functions <span class="math notranslate nohighlight">\(K,\, f\)</span>:</p>
<blockquote>
<div><ul class="simple">
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{T} K\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">l</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\in\Omega_l}\int_{T} K\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{T,\phi&lt;0} K\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\subset\Omega_{l}}\int_{T,\phi&lt;0} K\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{(\p T\cup\Gamma) \cap ( \Gamma_2 \cup \Gamma_{5}) } K \,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{T,\phi=0} K\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="kp">levelset</span><span class="o">=</span><span class="n">phi</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th},T\subset\Omega_{l}}\int_{T,\phi=0} K\,w\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">intalledges</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f</span><span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span></code> <span class="math notranslate nohighlight">\(\displaystyle\sum_{T\in\mathtt{Th}}\int_{\p T } f\,w\)</span></li>
<li>a vector of type <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span></code></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">The boundary condition terms:</p>
<blockquote>
<div><ul>
<li><p class="first">An “on” scalar form (for Dirichlet) : <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">g</span><span class="p">)</span></code></p>
<blockquote>
<div><p>Used for all degrees of freedom <span class="math notranslate nohighlight">\(i\)</span> of the boundary referred by “1”, the diagonal term of the matrix <span class="math notranslate nohighlight">\(a_{ii}= tgv\)</span> with the <em>terrible giant value</em> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">tgv</span></code> (= <span class="math notranslate nohighlight">\(10^{30}\)</span> by default), and the right hand side <span class="math notranslate nohighlight">\(b[i] = &quot;(\Pi_h g)[i]&quot; \times tgv\)</span>, where the <span class="math notranslate nohighlight">\(&quot;(\Pi_h g)g[i]&quot;\)</span> is the boundary node value given by the interpolation of <span class="math notranslate nohighlight">\(g\)</span>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">if <span class="math notranslate nohighlight">\(\mathrm{tgv} &lt; 0\)</span> then we put to <span class="math notranslate nohighlight">\(0\)</span> all term of the line <span class="math notranslate nohighlight">\(i\)</span> in the matrix, except diagonal term <span class="math notranslate nohighlight">\(a_{ii}=1\)</span>, and <span class="math notranslate nohighlight">\(b[i] = &quot;(\Pi_h g)[i]&quot;\)</span>.</p>
</div>
</div></blockquote>
</li>
<li><p class="first">An “on” vectorial form (for Dirichlet): <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="n">g1</span><span class="p">,</span> <span class="n">u2</span><span class="o">=</span><span class="n">g2</span><span class="p">)</span></code></p>
</li>
</ul>
<p>If you have vectorial finite element like <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nc">RT0</span></code>, the 2 components are coupled, and so you have : <span class="math notranslate nohighlight">\(b[i] = &quot;(\Pi_h (g1,g2))[i]&quot; \times tgv\)</span>, where <span class="math notranslate nohighlight">\(\Pi_h\)</span> is the vectorial finite element interpolant.</p>
<ul class="simple">
<li>A linear form on <span class="math notranslate nohighlight">\(\Gamma\)</span> (for Neumann in 2d) <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="o">-</span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f</span><span class="o">*</span><span class="n">w</span><span class="p">)</span></code> or <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="o">-</span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">3</span><span class="p">)(</span><span class="n">f</span><span class="o">*</span><span class="n">w</span><span class="p">)</span></code></li>
<li>A bilinear form on <span class="math notranslate nohighlight">\(\Gamma\)</span> or <span class="math notranslate nohighlight">\(\Gamma_{2}\)</span> (for Robin in 2d) <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span></code> or <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="mi">2</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span></code></li>
<li>A linear form on <span class="math notranslate nohighlight">\(\Gamma\)</span> (for Neumann in 3d) <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="o">-</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f</span><span class="o">*</span><span class="n">w</span><span class="p">)</span></code> or <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="o">-</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">3</span><span class="p">)(</span><span class="n">f</span><span class="o">*</span><span class="n">w</span><span class="p">)</span></code></li>
<li>A bilinear form on <span class="math notranslate nohighlight">\(\Gamma\)</span> or <span class="math notranslate nohighlight">\(\Gamma_{2}\)</span> (for Robin in 3d) <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span></code> or <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="mi">2</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">)</span></code></li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>If needed, the different kind of terms in the sum can appear more than once.</li>
<li>The integral mesh and the mesh associated to test functions or unknown functions can be different in the case of linear form.</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">N</span><span class="p">.</span><span class="kr">x</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">N</span><span class="p">.</span><span class="kr">y</span></code> and <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">N</span><span class="p">.</span><span class="kr">z</span></code> are the normal’s components.</li>
</ul>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">It is not possible to write in the same integral the linear part and the bilinear part such as in <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">K</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span> <span class="o">-</span> <span class="n">f</span><span class="o">*</span><span class="n">w</span><span class="p">)</span></code>.</p>
</div>
</div>
<div class="section" id="numerical-integration">
<h2>Numerical Integration<a class="headerlink" href="#numerical-integration" title="Permalink to this headline">¶</a></h2>
<p>Let <span class="math notranslate nohighlight">\(D\)</span> be a <span class="math notranslate nohighlight">\(N\)</span>-dimensional bounded domain.</p>
<p>For an arbitrary polynomial <span class="math notranslate nohighlight">\(f\)</span> of degree <span class="math notranslate nohighlight">\(r\)</span>, if we can find particular (quadrature) points <span class="math notranslate nohighlight">\(\mathbf{\xi}_j,\, j=1,\cdots,J\)</span> in <span class="math notranslate nohighlight">\(D\)</span> and (quadrature) constants <span class="math notranslate nohighlight">\(\omega_j\)</span> such that</p>
<div class="math notranslate nohighlight">
\[\int_{D}f(\mathbf{x}) = \sum_{\ell =1}^L c_\ell f(\mathbf{\xi}_\ell)\]</div>
<p>then we have an error estimate (see <a class="reference internal" href="../reference.html#crouzeix1984" id="id5">[CROUZEIX1984]</a>), and then there exists a constant <span class="math notranslate nohighlight">\(C&gt;0\)</span> such that</p>
<div class="math notranslate nohighlight">
\[\left|\int_{D}f(\mathbf{x}) - \sum_{\ell =1}^L \omega_\ell
f(\mathbf{\xi}_\ell )\right|
\le C|D|h^{r+1}\]</div>
<p>for any function <span class="math notranslate nohighlight">\(r + 1\)</span> times continuously differentiable <span class="math notranslate nohighlight">\(f\)</span> in <span class="math notranslate nohighlight">\(D\)</span>, where <span class="math notranslate nohighlight">\(h\)</span> is the diameter of <span class="math notranslate nohighlight">\(D\)</span> and <span class="math notranslate nohighlight">\(|D|\)</span> its measure (a point in the segment <span class="math notranslate nohighlight">\([q^iq^j]\)</span> is given as</p>
<div class="math notranslate nohighlight">
\[\{(x,y)|\; x=(1-t)q^i_x+tq^j_x,\, y=(1-t)q^i_y+tq^j_y,\, 0\le t\le 1\}\]</div>
<p>For a domain <span class="math notranslate nohighlight">\(\Omega_h=\sum_{k=1}^{n_t}T_k,\, \mathcal{T}_h=\{T_k\}\)</span>, we can calculate the integral over <span class="math notranslate nohighlight">\(\Gamma_h=\p\Omega_h\)</span> by:</p>
<p><span class="math notranslate nohighlight">\(\int_{\Gamma_h}f(\mathbf{x})ds\)</span> =<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></code>
=<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qfe</span><span class="o">=*</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></code>
=<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qforder</span><span class="o">=*</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></code></p>
<p>where * stands for the name of the quadrature formula or the precision (order) of the Gauss formula.</p>
<table border="1" class="docutils">
<colgroup>
<col width="6%" />
<col width="13%" />
<col width="12%" />
<col width="26%" />
<col width="28%" />
<col width="16%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" colspan="6">Quadrature formula on an edge</th>
</tr>
<tr class="row-even"><th class="head"><span class="math notranslate nohighlight">\(L\)</span></th>
<th class="head"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">qfe</span></code></th>
<th class="head"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">qforder</span></code></th>
<th class="head">Point in <span class="math notranslate nohighlight">\([q^i, q^j]\)</span></th>
<th class="head"><span class="math notranslate nohighlight">\(\omega_\ell\)</span></th>
<th class="head">Exact on <span class="math notranslate nohighlight">\(P_k,\ k=\)</span></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-odd"><td><span class="math notranslate nohighlight">\(1\)</span></td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf1pE</span></code></td>
<td><span class="math notranslate nohighlight">\(2\)</span></td>
<td><span class="math notranslate nohighlight">\(1/2\)</span></td>
<td><span class="math notranslate nohighlight">\(||q^iq^j||\)</span></td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
</tr>
<tr class="row-even"><td><span class="math notranslate nohighlight">\(2\)</span></td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf2pE</span></code></td>
<td><span class="math notranslate nohighlight">\(3\)</span></td>
<td><span class="math notranslate nohighlight">\((1\pm\sqrt{1/3})/2\)</span></td>
<td><span class="math notranslate nohighlight">\(||q^iq^j||/2\)</span></td>
<td><span class="math notranslate nohighlight">\(3\)</span></td>
</tr>
<tr class="row-odd"><td><span class="math notranslate nohighlight">\(3\)</span></td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf3pE</span></code></td>
<td><span class="math notranslate nohighlight">\(6\)</span></td>
<td><p class="first"><span class="math notranslate nohighlight">\((1\pm\sqrt{3/5})/2\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(1/2\)</span></p>
</td>
<td><p class="first"><span class="math notranslate nohighlight">\((5/18)||q^iq^j||\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\((8/18)||q^iq^j||\)</span></p>
</td>
<td><span class="math notranslate nohighlight">\(5\)</span></td>
</tr>
<tr class="row-even"><td><span class="math notranslate nohighlight">\(4\)</span></td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf4pE</span></code></td>
<td><span class="math notranslate nohighlight">\(8\)</span></td>
<td><p class="first"><span class="math notranslate nohighlight">\((1\pm\frac{525+70\sqrt{30}}{35})/2\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\((1\pm\frac{525-70\sqrt{30}}{35})/2\)</span></p>
</td>
<td><p class="first"><span class="math notranslate nohighlight">\(\frac{18-\sqrt{30}}{72}||q^iq^j||\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(\frac{18+\sqrt{30}}{72}||q^iq^j||\)</span></p>
</td>
<td><span class="math notranslate nohighlight">\(7\)</span></td>
</tr>
<tr class="row-odd"><td><span class="math notranslate nohighlight">\(5\)</span></td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf5pE</span></code></td>
<td><span class="math notranslate nohighlight">\(10\)</span></td>
<td><p class="first"><span class="math notranslate nohighlight">\((1\pm\frac{245+14\sqrt{70}}{21})/2\)</span></p>
<p><span class="math notranslate nohighlight">\(1/2\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\((1\pm\frac{245-14\sqrt{70}}{21})/2\)</span></p>
</td>
<td><p class="first"><span class="math notranslate nohighlight">\(\frac{322-13\sqrt{70}}{1800}||q^iq^j||\)</span></p>
<p><span class="math notranslate nohighlight">\(\frac{64}{225}||q^iq^j||\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(\frac{322+13\sqrt{70}}{1800}||q^iq^j||\)</span></p>
</td>
<td><span class="math notranslate nohighlight">\(9\)</span></td>
</tr>
<tr class="row-even"><td><span class="math notranslate nohighlight">\(2\)</span></td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf1pElump</span></code></td>
<td><span class="math notranslate nohighlight">\(2\)</span></td>
<td><p class="first"><span class="math notranslate nohighlight">\(0\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(1\)</span></p>
</td>
<td><p class="first"><span class="math notranslate nohighlight">\(||q^iq^j||/2\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(||q^iq^j||/2\)</span></p>
</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
</tr>
</tbody>
</table>
<p>where <span class="math notranslate nohighlight">\(|q^iq^j|\)</span> is the length of segment <span class="math notranslate nohighlight">\(\overline{q^iq^j}\)</span>.</p>
<p>For a part <span class="math notranslate nohighlight">\(\Gamma_1\)</span> of <span class="math notranslate nohighlight">\(\Gamma_h\)</span> with the label “1”, we can calculate the integral over <span class="math notranslate nohighlight">\(\Gamma_1\)</span> by:</p>
<p><span class="math notranslate nohighlight">\(\int_{\Gamma_1}f(x,y)ds\)</span> =<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></code>
=<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">qfe</span><span class="o">=</span><span class="kr">qf2pE</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></code></p>
<p>The integrals over <span class="math notranslate nohighlight">\(\Gamma_1,\, \Gamma_3\)</span> are given by:</p>
<p><span class="math notranslate nohighlight">\(\int_{\Gamma_1\cup \Gamma_3}f(x,y)ds\)</span></p>
<p>For each triangle <span class="math notranslate nohighlight">\(T_k=[q^{k_1}q^{k_2}q^{k_3}]\)</span>, the point <span class="math notranslate nohighlight">\(P(x,y)\)</span> in <span class="math notranslate nohighlight">\(T_k\)</span> is expressed by the <em>area coordinate</em> as <span class="math notranslate nohighlight">\(P(\xi,\eta)\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}&amp;|T_k|=\frac12 \left|
\begin{array}{ccc}
    1&amp;q^{k_1}_x&amp;q^{k_1}_y\\
    1&amp;q^{k_2}_x&amp;q^{k_2}_y\\
    1&amp;q^{k_3}_x&amp;q^{k_3}_y
\end{array}
\right|\quad
D_1=\left|
\begin{array}{ccc}
    1&amp;x&amp;y\\
    1&amp;q^{k_2}_x&amp;q^{k_2}_y\\
    1&amp;q^{k_3}_x&amp;q^{k_3}_y
\end{array}
\right|
\quad
D_2=\left|
\begin{array}{ccc}
    1&amp;q^{k_1}_x&amp;q^{k_1}_y\\
    1&amp;x&amp;y\\
    1&amp;q^{k_3}_x&amp;q^{k_3}_y
\end{array}
\right|
\quad
D_3=\left|
\begin{array}{ccc}
    1&amp;q^{k_1}_x&amp;q^{k_1}_y\\
    1&amp;q^{k_2}_x&amp;q^{k_2}_y\\
    1&amp;x&amp;y
\end{array}
\right|\\
&amp;\xi=\frac12 D_1/|T_k|\qquad
\eta=\frac12 D_2/|T_k|\qquad \textrm{then }
1-\xi-\eta=\frac12 D_3/|T_k|\end{split}\]</div>
<p>For a two dimensional domain or a border of three dimensional domain <span class="math notranslate nohighlight">\(\Omega_h=\sum_{k=1}^{n_t}T_k,\, \mathcal{T}_h=\{T_k\}\)</span>, we can calculate the integral over <span class="math notranslate nohighlight">\(\Omega_h\)</span> by:</p>
<p><span class="math notranslate nohighlight">\(\int_{\Omega_h}f(x,y)\)</span> =<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></code>
=<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qft</span><span class="o">=*</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></code>
=<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qforder</span><span class="o">=*</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></code></p>
<p>where * stands for the name of quadrature formula or the order of the Gauss formula.</p>
<table border="1" class="docutils">
<colgroup>
<col width="6%" />
<col width="11%" />
<col width="10%" />
<col width="36%" />
<col width="22%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" colspan="6">Quadrature formula on a triangle</th>
</tr>
<tr class="row-even"><th class="head"><span class="math notranslate nohighlight">\(L\)</span></th>
<th class="head"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">qft</span></code></th>
<th class="head"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">qforder</span></code></th>
<th class="head">Point in <span class="math notranslate nohighlight">\(T_k\)</span></th>
<th class="head"><span class="math notranslate nohighlight">\(\omega_\ell\)</span></th>
<th class="head">Exact on <span class="math notranslate nohighlight">\(P_k,\ k=\)</span></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-odd"><td>1</td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf1pT</span></code></td>
<td>2</td>
<td><span class="math notranslate nohighlight">\(\left(\frac{1}{3},\frac{1}{3}\right)\)</span></td>
<td><span class="math notranslate nohighlight">\(|T_k|\)</span></td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
</tr>
<tr class="row-even"><td>3</td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf2pT</span></code></td>
<td>3</td>
<td><p class="first"><span class="math notranslate nohighlight">\(\left(\frac{1}{2},\frac{1}{2}\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(\frac{1}{2},0\right)\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(\left(0,\frac{1}{2}\right)\)</span></p>
</td>
<td><p class="first"><span class="math notranslate nohighlight">\(|T_k|/3\)</span></p>
<p><span class="math notranslate nohighlight">\(|T_k|/3\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(|T_k|/3\)</span></p>
</td>
<td><span class="math notranslate nohighlight">\(2\)</span></td>
</tr>
<tr class="row-odd"><td>7</td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf5pT</span></code></td>
<td>6</td>
<td><p class="first"><span class="math notranslate nohighlight">\(\left(\frac{1}{3},\frac{1}{3}\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(\frac{6-\sqrt{15}}{21},\frac{6-\sqrt{15}}{21}\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(\frac{6-\sqrt{15}}{21},\frac{9+2\sqrt{15}}{21}\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(\frac{9+2\sqrt{15}}{21},\frac{6-\sqrt{15}}{21}\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(\frac{6+\sqrt{15}}{21},\frac{6+\sqrt{15}}{21}\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(\frac{6+\sqrt{15}}{21},\frac{9-2\sqrt{15}}{21}\right)\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(\left(\frac{9-2\sqrt{15}}{21},\frac{6+\sqrt{15}}{21}\right)\)</span></p>
</td>
<td><p class="first"><span class="math notranslate nohighlight">\(0.225|T_k|\)</span></p>
<p><span class="math notranslate nohighlight">\(\frac{(155-\sqrt{15})|T_k|}{1200}\)</span></p>
<p><span class="math notranslate nohighlight">\(\frac{(155-\sqrt{15})|T_k|}{1200}\)</span></p>
<p><span class="math notranslate nohighlight">\(\frac{(155-\sqrt{15})|T_k|}{1200}\)</span></p>
<p><span class="math notranslate nohighlight">\(\frac{(155+\sqrt{15})|T_k|}{1200}\)</span></p>
<p><span class="math notranslate nohighlight">\(\frac{(155+\sqrt{15})|T_k|}{1200}\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(\frac{(155+\sqrt{15})|T_k|}{1200}\)</span></p>
</td>
<td><span class="math notranslate nohighlight">\(5\)</span></td>
</tr>
<tr class="row-even"><td>3</td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf1pTlump</span></code></td>
<td>&#160;</td>
<td><p class="first"><span class="math notranslate nohighlight">\(\left(0,0\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(1,0\right)\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(\left(0,1\right)\)</span></p>
</td>
<td><p class="first"><span class="math notranslate nohighlight">\(|T_k|/3\)</span></p>
<p><span class="math notranslate nohighlight">\(|T_k|/3\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(|T_k|/3\)</span></p>
</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
</tr>
<tr class="row-odd"><td>9</td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf2pT4P1</span></code></td>
<td>&#160;</td>
<td><p class="first"><span class="math notranslate nohighlight">\(\left(\frac{1}{4},\frac{3}{4}\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(\frac{3}{4},\frac{1}{4}\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(0,\frac{1}{4}\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(0,\frac{3}{4}\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(\frac{1}{4},0\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(\frac{3}{4},0\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(\frac{1}{4},\frac{1}{4}\right)\)</span></p>
<p><span class="math notranslate nohighlight">\(\left(\frac{1}{4},\frac{1}{2}\right)\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(\left(\frac{1}{2},\frac{1}{4}\right)\)</span></p>
</td>
<td><p class="first"><span class="math notranslate nohighlight">\(|T_k|/12\)</span></p>
<p><span class="math notranslate nohighlight">\(|T_k|/12\)</span></p>
<p><span class="math notranslate nohighlight">\(|T_k|/12\)</span></p>
<p><span class="math notranslate nohighlight">\(|T_k|/12\)</span></p>
<p><span class="math notranslate nohighlight">\(|T_k|/12\)</span></p>
<p><span class="math notranslate nohighlight">\(|T_k|/12\)</span></p>
<p><span class="math notranslate nohighlight">\(|T_k|/6\)</span></p>
<p><span class="math notranslate nohighlight">\(|T_k|/6\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(|T_k|/6\)</span></p>
</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
</tr>
<tr class="row-even"><td>15</td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf7pT</span></code></td>
<td>8</td>
<td>See <a class="reference internal" href="../reference.html#taylor2005" id="id6">[TAYLOR2005]</a> for detail</td>
<td>&#160;</td>
<td>7</td>
</tr>
<tr class="row-odd"><td>21</td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qf9pT</span></code></td>
<td>10</td>
<td>See <a class="reference internal" href="../reference.html#taylor2005" id="id7">[TAYLOR2005]</a> for detail</td>
<td>&#160;</td>
<td>9</td>
</tr>
</tbody>
</table>
<p>For a three dimensional domain <span class="math notranslate nohighlight">\(\Omega_h=\sum_{k=1}^{n_t}T_k,\, \mathcal{T}_h=\{T_k\}\)</span>, we can calculate the integral over <span class="math notranslate nohighlight">\(\Omega_h\)</span> by:</p>
<p><span class="math notranslate nohighlight">\(\int_{\Omega_h}f(x,y)\)</span> =<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></code>
=<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">int3d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="kp">qfV</span><span class="o">=*</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></code>
=<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">int3D</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="kp">qforder</span><span class="o">=*</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></code></p>
<p>where * stands for the name of quadrature formula or the order of the Gauss formula.</p>
<table border="1" class="docutils">
<colgroup>
<col width="7%" />
<col width="13%" />
<col width="12%" />
<col width="36%" />
<col width="16%" />
<col width="17%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" colspan="6">Quadrature formula on a tetrahedron</th>
</tr>
<tr class="row-even"><th class="head"><span class="math notranslate nohighlight">\(L\)</span></th>
<th class="head"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">qfV</span></code></th>
<th class="head"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">qforder</span></code></th>
<th class="head">Point in <span class="math notranslate nohighlight">\(T_k\in\R^3\)</span></th>
<th class="head"><span class="math notranslate nohighlight">\(\omega_\ell\)</span></th>
<th class="head">Exact on <span class="math notranslate nohighlight">\(P_k,\ k=\)</span></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-odd"><td>1</td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qfV1</span></code></td>
<td><span class="math notranslate nohighlight">\(2\)</span></td>
<td><span class="math notranslate nohighlight">\(\left(\frac{1}{4},\frac{1}{4},\frac{1}{4}\right)\)</span></td>
<td><span class="math notranslate nohighlight">\(|T_k|\)</span></td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
</tr>
<tr class="row-even"><td>4</td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qfV2</span></code></td>
<td><span class="math notranslate nohighlight">\(3\)</span></td>
<td><span class="math notranslate nohighlight">\(G4(0.58\ldots,0.13\ldots,0.13\ldots)\)</span></td>
<td><span class="math notranslate nohighlight">\(|T_k|/4\)</span></td>
<td><span class="math notranslate nohighlight">\(2\)</span></td>
</tr>
<tr class="row-odd"><td>14</td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qfV5</span></code></td>
<td><span class="math notranslate nohighlight">\(6\)</span></td>
<td><p class="first"><span class="math notranslate nohighlight">\(G4(0.72\ldots,0.092\ldots,0.092\ldots)\)</span></p>
<p><span class="math notranslate nohighlight">\(G4(0.067\ldots,0.31\ldots,0.31\ldots)\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(G6(0.45\ldots,0.045\ldots,0.45\ldots)\)</span></p>
</td>
<td><p class="first"><span class="math notranslate nohighlight">\(0.073\ldots|T_k|\)</span></p>
<p><span class="math notranslate nohighlight">\(0.11\ldots|T_k|\)</span></p>
<p class="last"><span class="math notranslate nohighlight">\(0.042\ldots|T_k|\)</span></p>
</td>
<td><span class="math notranslate nohighlight">\(5\)</span></td>
</tr>
<tr class="row-even"><td>4</td>
<td><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">qfV1lump</span></code></td>
<td>&#160;</td>
<td><span class="math notranslate nohighlight">\(G4(1,0,0)\)</span></td>
<td><span class="math notranslate nohighlight">\(|T_k|/4\)</span></td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
</tr>
</tbody>
</table>
<p>Where <span class="math notranslate nohighlight">\(G4(a,b,b)\)</span> such that <span class="math notranslate nohighlight">\(a+3b=1\)</span> is the set of the four point in barycentric coordinate:</p>
<div class="math notranslate nohighlight">
\[\{(a,b,b,b),(b,a,b,b),(b,b,a,b),(b,b,b,a)\}\]</div>
<p>and where <span class="math notranslate nohighlight">\(G6(a,b,b)\)</span> such that <span class="math notranslate nohighlight">\(2a+2b=1\)</span> is the set of the six points in barycentric coordinate:</p>
<div class="math notranslate nohighlight">
\[\{(a,a,b,b),(a,b,a,b),(a,b,b,a),(b,b,a,a),(b,a,b,a),(b,a,a,b)\}\]</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">These tetrahedral quadrature formulae come from <a class="reference external" href="http://nines.cs.kuleuven.be/research/ecf/mtables.html">http://nines.cs.kuleuven.be/research/ecf/mtables.html</a></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">By default, we use the formula which is exact for polynomials of degree <span class="math notranslate nohighlight">\(5\)</span> on triangles or edges (in bold in three tables).</p>
</div>
<p>It is possible to add an own quadrature formulae with using plugin <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">qf11to25</span></code> on segment, triangle or Tetrahedron.</p>
<p>The quadrature formulae in <span class="math notranslate nohighlight">\(D\)</span> dimension is a bidimentional array of size <span class="math notranslate nohighlight">\(N_q\times (D+1)\)</span> such that the <span class="math notranslate nohighlight">\(D+1\)</span> value of on row <span class="math notranslate nohighlight">\(i=0,...,N_p-1\)</span> are <span class="math notranslate nohighlight">\(w^i,\hat{x}^i_1,...,\hat{x}^i_D\)</span> where <span class="math notranslate nohighlight">\(w^i\)</span> is the weight of the quadrature point, and <span class="math notranslate nohighlight">\(1-\sum_{k=1}^D \hat{x}^i_k ,\hat{x}^i_1,...,\hat{x}^i_D\)</span> is the barycentric coordinate the quadrature point.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;qf11to25&quot;</span>

<span class="c1">// Quadrature on segment</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">]</span> <span class="n">qq1</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">];</span>

<span class="n">QF1</span> <span class="nf">qf1</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">qq1</span><span class="p">);</span> <span class="c1">//def of quadrature formulae qf1 on segment</span>
<span class="c1">//remark:</span>
<span class="c1">//1 is the order of the quadrature exact for polynome of degree &lt; 1</span>

<span class="c1">//Quadrature on triangle</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">]</span> <span class="n">qq2</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">];</span>

<span class="n">QF2</span> <span class="nf">qf2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">qq2</span><span class="p">);</span> <span class="c1">//def of quadrature formulae qf2 on triangle</span>
<span class="c1">//remark:</span>
<span class="c1">//1 is the order of the quadrature exact for polynome of degree &lt; 1</span>
<span class="c1">//so must have sum w^i = 1</span>

<span class="c1">// Quadrature on tetrahedron</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">]</span> <span class="n">qq3</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">];</span>

<span class="n">QF3</span> <span class="nf">qf3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">qq3</span><span class="p">);</span> <span class="c1">//def of quadrature formulae qf3 on get</span>
<span class="c1">//remark:</span>
<span class="c1">//1 is the order of the quadrature exact for polynome of degree &lt; 1)</span>

<span class="c1">// Verification in 1d and 2d</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

<span class="kt">real</span> <span class="n">I1</span> <span class="o">=</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qfe</span><span class="o">=</span><span class="n">qf1</span><span class="p">)(</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="p">);</span>
<span class="kt">real</span> <span class="n">I1l</span> <span class="o">=</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qfe</span><span class="o">=</span><span class="kr">qf1pElump</span><span class="p">)(</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="p">);</span>

<span class="kt">real</span> <span class="n">I2</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qft</span><span class="o">=</span><span class="n">qf2</span><span class="p">)(</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="p">);</span>
<span class="kt">real</span> <span class="n">I2l</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">qft</span><span class="o">=</span><span class="kr">qf1pTlump</span><span class="p">)(</span><span class="kr">x</span><span class="o">^</span><span class="mi">2</span><span class="p">);</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">I1</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; == &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">I1l</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">I2</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; == &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">I2l</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="nf">assert</span><span class="p">(</span> <span class="nf">abs</span><span class="p">(</span><span class="n">I1</span><span class="o">-</span><span class="n">I1l</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span> <span class="p">);</span>
<span class="nf">assert</span><span class="p">(</span> <span class="nf">abs</span><span class="p">(</span><span class="n">I2</span><span class="o">-</span><span class="n">I2l</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span> <span class="p">);</span>
</pre></div>
</div>
<p>The output is</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">1</span>.67 <span class="o">==</span> <span class="m">1</span>.67
<span class="m">0</span>.335 <span class="o">==</span> <span class="m">0</span>.335
</pre></div>
</div>
</div>
<div class="section" id="variational-form-sparse-matrix-pde-data-vector">
<span id="variationalformsparsematrixpde"></span><h2>Variational Form, Sparse Matrix, PDE Data Vector<a class="headerlink" href="#variational-form-sparse-matrix-pde-data-vector" title="Permalink to this headline">¶</a></h2>
<p>In <strong>FreeFem++</strong> it is possible to define variational forms, and use them to build matrices and vectors, and store them to speed-up the script (4 times faster here).</p>
<p>For example let us solve the <a class="reference internal" href="../tutorial/thermalConduction.html#thermalconduction"><span class="std std-ref">Thermal Conduction problem</span></a>.</p>
<p>The variational formulation is in <span class="math notranslate nohighlight">\(L^2(0,T;H^1(\Omega))\)</span>; we shall seek <span class="math notranslate nohighlight">\(u^n\)</span> satisfying:</p>
<div class="math notranslate nohighlight">
\[\forall w \in V_{0}; \qquad \int_\Omega \frac{u^n-u^{n-1}}{\delta t} w + \kappa\n u^n\n w) +\int_\Gamma\alpha(u^n-u_{ue})w=0\]</div>
<p>where <span class="math notranslate nohighlight">\(V_0 = \{w\in H^1(\Omega)/ w_{|\Gamma_{24}}=0\}\)</span>.</p>
<p>So to code the method with the matrices <span class="math notranslate nohighlight">\(A=(A_{ij})\)</span>, <span class="math notranslate nohighlight">\(M=(M_{ij})\)</span>, and the vectors <span class="math notranslate nohighlight">\(u^n, b^n, b',b&quot;, b_{cl}\)</span> (notation if <span class="math notranslate nohighlight">\(w\)</span> is a vector then <span class="math notranslate nohighlight">\(w_i\)</span> is a component of the vector).</p>
<div class="math notranslate nohighlight">
\[\begin{split}u^n = A^{-1} b^n, \quad
\quad b' = b_0 + M u^{n-1},
\quad b&quot;= \frac{1}{\varepsilon} \; b_{cl},
\quad b^n_i = \left\{
\begin{array}{cl} b&quot;_i &amp; \mbox{if }\ i \in \Gamma_{24} \\
b'_i &amp; \mbox{else if } \not\in \Gamma_{24} \end{array}\right.\end{split}\]</div>
<p>Where with <span class="math notranslate nohighlight">\(\frac{1}{\varepsilon} = \mathtt{tgv} = 10^{30}\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    A_{ij} &amp;=&amp; \left\{\begin{array}{cl} \frac{1}{\varepsilon} &amp; \mbox{if } i \in \Gamma_{24}, \mbox{and} j=i \\
    \displaystyle
        \int_{\Omega} w_j w_i / dt + k (\nabla w_j. \nabla w_i ) + \int_{\Gamma_{13}} \alpha w_j w_i &amp; \mbox{else if } i \not\in \Gamma_{24}, \mbox{or} j\ne i
        \end{array}\right.\\
        M_{ij} &amp;=&amp; \left\{\begin{array}{cl} \frac{1}{\varepsilon} &amp; \mbox{if } i \in \Gamma_{24}, \mbox{and} j=i\\
    \displaystyle
        \int_{\Omega} w_j w_i / dt
        &amp; \mbox{else if }i \not\in \Gamma_{24}, \mbox{or} j\ne i \end{array}\right. \\
        b_{0,i} &amp;=&amp; \int_{\Gamma_{13}} \alpha u_{ue} w_i \\
        b_{cl} &amp;=&amp; u^{0} \quad \mbox{the initial data}
\end{array}\end{split}\]</div>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">func</span> <span class="n">fu0</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">90</span><span class="o">*</span><span class="kr">x</span><span class="o">/</span><span class="mi">6</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">k</span> <span class="o">=</span> <span class="mf">1.8</span><span class="o">*</span><span class="p">(</span><span class="kr">y</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">ue</span> <span class="o">=</span> <span class="mf">25.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">]);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u0</span> <span class="o">=</span> <span class="n">fu0</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">u0</span><span class="p">;</span>
</pre></div>
</div>
<p>Create three variational formulation, and build the matrices <span class="math notranslate nohighlight">\(A\)</span>,<span class="math notranslate nohighlight">\(M\)</span>.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Problem</span>
<span class="kt">varf</span> <span class="nf">vthermic</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="o">/</span><span class="n">dt</span>
        <span class="o">+</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)(</span>
        <span class="n">alpha</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">vthermic0</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)(</span>
        <span class="n">alpha</span><span class="o">*</span><span class="n">ue</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">vMass</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="o">/</span><span class="n">dt</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">real</span> <span class="kp">tgv</span> <span class="o">=</span> <span class="mf">1e30</span><span class="p">;</span>
<span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span> <span class="n">vthermic</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">tgv</span><span class="o">=</span><span class="kp">tgv</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="n">M</span> <span class="o">=</span> <span class="n">vMass</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
</pre></div>
</div>
<p>Now, to build the right hand size we need 4 vectors.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b0</span> <span class="o">=</span> <span class="n">vthermic0</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span> <span class="c1">//constant part of the RHS</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">bcn</span> <span class="o">=</span> <span class="n">vthermic</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span> <span class="c1">//tgv on Dirichlet boundary node ( !=0 )</span>
<span class="c1">//we have for the node i : i in Gamma_24 -&gt; bcn[i] != 0</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">bcl</span> <span class="o">=</span> <span class="kp">tgv</span><span class="o">*</span><span class="n">u0</span><span class="p">[];</span> <span class="c1">//the Dirichlet boundary condition part</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The boundary condition is implemented by penalization and vector <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">bcn</span></code> contains the contribution of the boundary condition <span class="math notranslate nohighlight">\(u=1\)</span>, so to change the boundary condition, we have just to multiply the vector <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">bc</span><span class="p">[]</span></code> by the current value <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">f</span></code> of the new boundary condition term by term with the operator <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">.</span><span class="o">*</span></code>.</p>
<p class="last"><a class="reference internal" href="../model/navierStokesEquations.html#navierstokesuzawaconjugategradients"><span class="std std-ref">Uzawa model</span></a> gives a real example of using all this features.</p>
</div>
<p>And the new version of the algorithm is now:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Time loop</span>
<span class="kt">ofstream</span> <span class="nf">ff</span><span class="p">(</span><span class="s">&quot;thermic.dat&quot;</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="kt">real</span> <span class="kp">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kp">t</span> <span class="o">&lt;</span> <span class="n">T</span><span class="p">;</span> <span class="kp">t</span> <span class="o">+=</span> <span class="n">dt</span><span class="p">){</span>
    <span class="c1">// Update</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b0</span><span class="p">;</span> <span class="c1">//for the RHS</span>
    <span class="n">b</span> <span class="o">+=</span> <span class="n">M</span><span class="o">*</span><span class="n">u</span><span class="p">[];</span> <span class="c1">//add the the time dependent part</span>
    <span class="c1">//lock boundary part:</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">bcn</span> <span class="o">?</span> <span class="nl">bcl</span> <span class="o">:</span> <span class="n">b</span><span class="p">;</span> <span class="c1">//do forall i: b[i] = bcn[i] ? bcl[i] : b[i]</span>

    <span class="c1">// Solve</span>
    <span class="n">u</span><span class="p">[]</span> <span class="o">=</span> <span class="kp">A</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>

    <span class="c1">// Save</span>
    <span class="n">ff</span> <span class="o">&lt;&lt;</span> <span class="kp">t</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="c1">// Plot</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Display</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)(</span><span class="mf">6.0</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="c1">// Plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The functions appearing in the variational form are formal and local to the <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">varf</span></code> definition, the only important thing is the order in the parameter list, like in:</p>
<div class="last highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">varf</span> <span class="nf">vb1</span><span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">],</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)((</span><span class="nf">dy</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u2</span><span class="p">))</span><span class="o">*</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="mi">1</span><span class="o">*</span><span class="n">q</span><span class="p">);</span>
<span class="kt">varf</span> <span class="nf">vb2</span><span class="p">([</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">],</span> <span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)((</span><span class="nf">dy</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">v2</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="mi">1</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>To build matrix <span class="math notranslate nohighlight">\(A\)</span> from the bilinear part the variational form <span class="math notranslate nohighlight">\(a\)</span> of type <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">varf</span></code> simply write:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kp">A</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Wh</span> <span class="p">,</span> <span class="p">[]...]);</span>
<span class="c1">// where</span>
<span class="c1">//Vh is &quot;fespace&quot; for the unknown fields with a correct number of component</span>
<span class="c1">//Wh is &quot;fespace&quot; for the test fields with a correct number of component</span>
</pre></div>
</div>
<p>Possible named parameters in <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="p">,</span> <span class="p">[...]</span></code> are</p>
<ul>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">solver</span><span class="o">=</span></code> <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">LU</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">CG</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Crout</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Cholesky</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">GMRES</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">sparsesolver</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">UMFPACK</span></code> …</p>
<blockquote>
<div><p>The default solver is <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">GMRES</span></code>.</p>
<p>The storage mode of the matrix of the underlying linear system depends on the type of solver chosen; for <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">LU</span></code> the matrix is sky-line non symmetric, for <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Crout</span></code> the matrix is sky-line symmetric, for <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Cholesky</span></code> the matrix is sky-line symmetric positive definite, for <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">CG</span></code> the matrix is sparse symmetric positive, and for <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">GMRES</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">sparsesolver</span></code> or <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">UMFPACK</span></code> the matrix is just sparse.</p>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">factorize</span> <span class="o">=</span></code> If true then do the matrix factorization for <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">LU</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Cholesky</span></code> or <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Crout</span></code>, the default value is <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">false</span></code>.</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">eps</span><span class="o">=</span></code> A real expression.</p>
<blockquote>
<div><p><span class="math notranslate nohighlight">\(\varepsilon\)</span> sets the stopping test for the iterative methods like <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">CG</span></code>.</p>
<p>Note that if <span class="math notranslate nohighlight">\(\varepsilon\)</span> is negative then the stopping test is:</p>
<div class="math notranslate nohighlight">
\[|| A x - b || &lt; |\varepsilon|\]</div>
<p>if it is positive then the stopping test is</p>
<div class="math notranslate nohighlight">
\[|| A x - b || &lt; \frac{|\varepsilon|}{|| A x_{0} - b ||}\]</div>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">precon</span><span class="o">=</span></code> Name of a function (for example <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">P</span></code>) to set the preconditioner.</p>
<p>The prototype for the function <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">P</span></code> must be:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="kr">P</span><span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">xx</span><span class="p">)</span> <span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">tgv</span><span class="o">=</span></code> Huge value (<span class="math notranslate nohighlight">\(10^{30}\)</span>) used to implement Dirichlet boundary conditions.</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">tolpivot</span><span class="o">=</span></code> Set the tolerance of the pivot in <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">UMFPACK</span></code> (<span class="math notranslate nohighlight">\(10^-1\)</span>) and, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">LU</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Crout</span></code>, <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">Cholesky</span></code> factorization (<span class="math notranslate nohighlight">\(10^{-20}\)</span>).</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">tolpivotsym</span><span class="o">=</span></code> Set the tolerance of the pivot sym in <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">UMFPACK</span></code></p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">strategy</span><span class="o">=</span></code> Set the integer UMFPACK strategy (<span class="math notranslate nohighlight">\(0\)</span> by default).</p>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The line of the matrix corresponding to the space <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Wh</span></code> and the column of the matrix corresponding to the space <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Vh</span></code>.</p>
</div>
<p>To build the dual vector <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">b</span></code> (of type <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span></code>) from the linear part of the variational form <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">a</span></code> do simply:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">real</span> <span class="nf">b</span><span class="p">(</span><span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">);</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
</pre></div>
</div>
<p>A first example to compute the area of each triangle <span class="math notranslate nohighlight">\(K\)</span> of mesh <span class="math notranslate nohighlight">\(Th\)</span>, just do:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">fespace</span> <span class="nf">Nh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span> <span class="c1">//the space function constant / triangle</span>
<span class="n">Nh</span> <span class="n">areaK</span><span class="p">;</span>
<span class="kt">varf</span> <span class="nf">varea</span> <span class="p">(</span><span class="kr">unused</span><span class="p">,</span> <span class="n">chiK</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">chiK</span><span class="p">);</span>
<span class="n">etaK</span><span class="p">[]</span> <span class="o">=</span> <span class="n">varea</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Ph</span><span class="p">);</span>
</pre></div>
</div>
<p>Effectively, the basic functions of space <span class="math notranslate nohighlight">\(Nh\)</span>, are the characteristic function of the element of Th, and the numbering is the numeration of the element, so by construction:</p>
<div class="math notranslate nohighlight">
\[\mathtt{etaK}[i] = \int {1}_{|K_i} = \int_{K_i} 1;\]</div>
<p>Now, we can use this to compute error indicators like in example <a class="reference internal" href="../model/staticProblems.html#modelstaticproblemadaptationusingresidualerrorindicator"><span class="std std-ref">Adaptation using residual error indicator</span></a>.</p>
<p>First to compute a continuous approximation to the function <span class="math notranslate nohighlight">\(h\)</span> “density mesh size” of the mesh <span class="math notranslate nohighlight">\(Th\)</span>.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">h</span> <span class="p">;</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">count</span><span class="p">(</span><span class="n">Th</span><span class="p">.</span><span class="kr">nv</span><span class="p">);</span>
<span class="kt">varf</span> <span class="nf">vmeshsizen</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">intalledges</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kr">qfnbpE</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">v</span><span class="p">);</span>
<span class="kt">varf</span> <span class="nf">vedgecount</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">intalledges</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kr">qfnbpE</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">v</span><span class="o">/</span><span class="kr">lenEdge</span><span class="p">);</span>

<span class="c1">// Computation of the mesh size</span>
<span class="n">count</span> <span class="o">=</span> <span class="n">vedgecount</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span> <span class="c1">//number of edge / vertex</span>
<span class="n">h</span><span class="p">[]</span> <span class="o">=</span> <span class="n">vmeshsizen</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span> <span class="c1">//sum length edge / vertex</span>
<span class="n">h</span><span class="p">[]</span> <span class="o">=</span> <span class="n">h</span><span class="p">[].</span><span class="o">/</span><span class="n">count</span><span class="p">;</span> <span class="c1">//mean length edge / vertex</span>
</pre></div>
</div>
<p>To compute error indicator for Poisson equation:</p>
<div class="math notranslate nohighlight">
\[{\eta_K = \int_K h_K^2 |( f + \Delta u_h)|^2 + \int_{\partial K} h_e |[ \frac{\partial u_h}{\partial n} ]|^2 }\]</div>
<p>where <span class="math notranslate nohighlight">\(h_K\)</span> is size of the longest edge (<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">hTriangle</span></code>), <span class="math notranslate nohighlight">\(h_e\)</span> is the size of the current edge (<code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kr">lenEdge</span></code>), <span class="math notranslate nohighlight">\(n\)</span> the normal.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">fespace</span> <span class="nf">Nh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span> <span class="c1">// the space function constant / triangle</span>
<span class="n">Nh</span> <span class="n">etak</span><span class="p">;</span>
<span class="kt">varf</span> <span class="nf">vetaK</span> <span class="p">(</span><span class="kr">unused</span><span class="p">,</span> <span class="n">chiK</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">intalledges</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">chiK</span><span class="o">*</span><span class="kr">lenEdge</span><span class="o">*</span><span class="nf">square</span><span class="p">(</span><span class="nf">jump</span><span class="p">(</span><span class="kr">N</span><span class="p">.</span><span class="kr">x</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="kr">N</span><span class="p">.</span><span class="kr">y</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">chiK</span><span class="o">*</span><span class="nf">square</span><span class="p">(</span><span class="kr">hTriangle</span><span class="o">*</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="nf">dxx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dyy</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="p">;</span>

<span class="n">etak</span><span class="p">[]</span> <span class="o">=</span> <span class="n">vetaK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Ph</span><span class="p">);</span>
</pre></div>
</div>
<p>We add automatic expression optimization by default, if this optimization creates problems, it can be removed with the keyword <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">optimize</span></code> as in the following example:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">varf</span> <span class="nf">a</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">optimize</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span>
        <span class="nf">dx</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span>
        <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">u1</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">;</span>
</pre></div>
</div>
<p>or you can also do optimization and remove the check by setting <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">optimize</span><span class="o">=</span><span class="mi">2</span></code>.</p>
<p>Remark, it is all possible to build interpolation matrix, like in the following example:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">mesh</span> <span class="n">TH</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="kt">mesh</span> <span class="n">th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

<span class="kt">fespace</span> <span class="nf">VH</span><span class="p">(</span><span class="n">TH</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="kt">fespace</span> <span class="nf">Wh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>

<span class="kt">matrix</span> <span class="kp">B</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">VH</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span> <span class="c1">//build interpolation matrix Vh-&gt;VH</span>
<span class="kt">matrix</span> <span class="n">BB</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Wh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span> <span class="c1">//build interpolation matrix Vh-&gt;Wh</span>
</pre></div>
</div>
<p>and after some operations on sparse matrices are available for example:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="kr">N</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">real</span> <span class="p">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">]</span> <span class="kp">A</span><span class="p">(</span><span class="kr">N</span><span class="p">,</span> <span class="kr">N</span><span class="p">);</span> <span class="c1">//a full matrix</span>
<span class="kt">real</span> <span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">a</span><span class="p">(</span><span class="kr">N</span><span class="p">),</span> <span class="n">b</span><span class="p">(</span><span class="kr">N</span><span class="p">);</span>
<span class="kp">A</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kr">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="kp">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="kr">N</span><span class="p">)</span> <span class="kp">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">i</span><span class="p">;</span>
    <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">b</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
<span class="kt">matrix</span> <span class="n">sparseA</span> <span class="o">=</span> <span class="kp">A</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">sparseA</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="n">sparseA</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">sparseA</span> <span class="o">+</span> <span class="n">sparseA</span><span class="o">&#39;</span><span class="p">;</span>
<span class="n">sparseA</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">sparseA</span> <span class="o">+</span> <span class="n">sparseA</span><span class="o">*</span><span class="mi">5</span><span class="p">;</span>
<span class="kt">matrix</span> <span class="n">sparseB</span> <span class="o">=</span> <span class="n">sparseA</span> <span class="o">+</span> <span class="n">sparseA</span> <span class="o">+</span> <span class="n">sparseA</span><span class="p">;</span> <span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sparseB = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sparseB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="interpolation-matrix">
<h2>Interpolation matrix<a class="headerlink" href="#interpolation-matrix" title="Permalink to this headline">¶</a></h2>
<p>It is also possible to store the matrix of a linear interpolation operator from a finite element space <span class="math notranslate nohighlight">\(V_h\)</span> to another <span class="math notranslate nohighlight">\(W_h\)</span> to <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">interpolate</span></code>(<span class="math notranslate nohighlight">\(W_h\)</span>,<span class="math notranslate nohighlight">\(V_h\)</span>,…) a function.</p>
<p>Note that the continuous finite functions are extended by continuity outside of the domain.</p>
<p>The named parameters of function <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">interpolate</span></code> are:</p>
<ul>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">inside</span><span class="o">=</span></code> set true to create zero-extension.</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">t</span><span class="o">=</span></code> set true to get the transposed matrix</p>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">op</span><span class="o">=</span></code> set an integer written below</p>
<blockquote>
<div><ul class="simple">
<li>0 the default value and interpolate of the function</li>
<li>1 interpolate the <span class="math notranslate nohighlight">\(\p_x\)</span></li>
<li>2 interpolate the <span class="math notranslate nohighlight">\(\p_y\)</span></li>
<li>3 interpolate the <span class="math notranslate nohighlight">\(\p_z\)</span></li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kp">U2Vc</span><span class="o">=</span></code> set the which is the component of <span class="math notranslate nohighlight">\(W_h\)</span> come in <span class="math notranslate nohighlight">\(V_h\)</span> in interpolate process in a int array so the size of the array is number of component of <span class="math notranslate nohighlight">\(W_h\)</span>, if the put <span class="math notranslate nohighlight">\(-1\)</span> then component is set to <span class="math notranslate nohighlight">\(0\)</span>, like in the following example: (by default the component number is unchanged).</p>
<blockquote>
<div><div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">fespace</span> <span class="nf">V4h</span><span class="p">(</span><span class="n">Th4</span><span class="p">,</span> <span class="p">[</span><span class="nc">P1</span><span class="p">,</span> <span class="nc">P1</span><span class="p">,</span> <span class="nc">P1</span><span class="p">,</span> <span class="nc">P1</span><span class="p">]);</span>
<span class="kt">fespace</span> <span class="nf">V3h</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="p">[</span><span class="nc">P1</span><span class="p">,</span> <span class="nc">P1</span><span class="p">,</span> <span class="nc">P1</span><span class="p">]);</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">u2vc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">];</span> <span class="c1">//-1 -&gt; put zero on the component</span>
<span class="kt">matrix</span> <span class="n">IV34</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">V3h</span><span class="p">,</span> <span class="n">V4h</span><span class="p">,</span> <span class="kp">inside</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="kp">U2Vc</span><span class="o">=</span><span class="n">u2vc</span><span class="p">);</span> <span class="c1">//V3h &lt;- V4h</span>
<span class="n">V4h</span> <span class="p">[</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">];</span>
<span class="n">V3h</span> <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">];</span>
<span class="n">b1</span><span class="p">[]</span> <span class="o">=</span> <span class="n">IV34</span><span class="o">*</span><span class="n">a1</span><span class="p">[];</span>
</pre></div>
</div>
<p>So here we have: <code class="docutils literal highlight highlight-default"><span></span><span class="n">freefem</span>   <span class="n">b1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="n">b2</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="n">b3</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">...</span></code></p>
</div></blockquote>
</li>
</ul>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Matrix interpolation</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="kt">mesh</span> <span class="n">Th4</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="kr">x</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="kr">y</span><span class="o">*</span><span class="mf">0.5</span><span class="p">]);</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">Th4</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">v</span><span class="p">,</span> <span class="n">vv</span><span class="p">;</span>
<span class="kt">fespace</span> <span class="nf">Vh4</span><span class="p">(</span><span class="n">Th4</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh4</span> <span class="n">v4</span><span class="o">=</span><span class="kr">x</span><span class="o">*</span><span class="kr">y</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Wh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>
<span class="kt">fespace</span> <span class="nf">Wh4</span><span class="p">(</span><span class="n">Th4</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>

<span class="c1">// Interpolation</span>
<span class="kt">matrix</span> <span class="n">IV</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh4</span><span class="p">);</span> <span class="c1">//here the function is exended by continuity</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;IV Vh&lt;-Vh4 &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">IV</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="n">v</span><span class="o">=</span><span class="n">v4</span><span class="p">;</span>
<span class="n">vv</span><span class="p">[]</span><span class="o">=</span> <span class="n">IV</span><span class="o">*</span><span class="n">v4</span><span class="p">[];</span> <span class="c1">//here v == vv</span>

<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">diff</span><span class="o">=</span> <span class="n">vv</span><span class="p">[]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[];</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;|| v - vv || = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">diff</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="nf">assert</span><span class="p">(</span> <span class="n">diff</span><span class="p">.</span><span class="kr">linfty</span><span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">);</span>

<span class="kt">matrix</span> <span class="n">IV0</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh4</span><span class="p">,</span> <span class="kp">inside</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//here the function is exended by zero</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;IV Vh&lt;-Vh4 (inside=1) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">IV0</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">matrix</span> <span class="n">IVt0</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh4</span><span class="p">,</span> <span class="kp">inside</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;IV Vh&lt;-Vh4^t (inside=1) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">IVt0</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">matrix</span> <span class="n">IV4t0</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Vh4</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;IV Vh4&lt;-Vh^t &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">IV4t0</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">matrix</span> <span class="n">IW4</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Wh4</span><span class="p">,</span> <span class="n">Wh</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;IV Wh4&lt;-Wh &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">IW4</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">matrix</span> <span class="n">IW4V</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Wh4</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;IV Wh4&lt;-Vh &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">IW4</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>Build interpolation matrix <span class="math notranslate nohighlight">\(A\)</span> at a array of points <span class="math notranslate nohighlight">\((xx[j],yy[j]),\ i = 0,\ 2\)</span> here:</p>
<div class="math notranslate nohighlight">
\[a_ij = dop(w^i_c (xx[j],yy[j]))\]</div>
<p>where <span class="math notranslate nohighlight">\(w_i\)</span> is the basic finite element function, <span class="math notranslate nohighlight">\(c\)</span> the component number, <span class="math notranslate nohighlight">\(dop\)</span> the type of diff operator like in op def.</p>
<div class="last highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="mf">.3</span><span class="p">,</span> <span class="mf">.4</span><span class="p">],</span> <span class="n">yy</span> <span class="o">=</span> <span class="p">[</span><span class="mf">.1</span><span class="p">,</span> <span class="mf">.4</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">matrix</span> <span class="n">Ixx</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="kp">op</span><span class="o">=</span><span class="n">dop</span><span class="p">,</span> <span class="kp">composante</span><span class="o">=</span><span class="n">c</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">Ixx</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">ww</span><span class="p">;</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="nf">dd</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">];</span>
<span class="n">ww</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Ixx</span><span class="o">*</span><span class="nf">dd</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Schwarz</p>
<p>The following shows how to implement with an interpolation matrix a domain decomposition algorithm based on Schwarz method with Robin conditions.</p>
<p>Given a non-overlapping partition <span class="math notranslate nohighlight">\(\bar\Omega=\bar\Omega_0\cup\bar\Omega_1\)</span> with <span class="math notranslate nohighlight">\(\Omega_0\cap\Omega_1=\emptyset\)</span>, <span class="math notranslate nohighlight">\(\Sigma:=\bar\Omega_0\cap\bar\Omega_1\)</span> the algorithm is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}-\Delta u_i &amp;= f \hbox{ in }\Omega_i,~i=0,1,\\
\frac{\partial(u_1-u_0)}{\partial n} + \alpha (u_1-u_0) &amp;=0\hbox{ on }\Sigma.\end{split}\]</div>
<p>The same in variational form is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl}
    &amp;\int_{\Omega_i}\nabla u_i\cdot\nabla v &amp;+ \int_\Sigma\alpha u_i v = \int_{\Omega_i}f v\\
    - \int_{\Omega_j}(\nabla u_j\cdot\nabla v-f v) + \int_\Sigma\alpha u_j v,~~
    \forall v\in H^1_0(\Omega), i,j=[0,1]\cup[1,0]
\end{array}\end{split}\]</div>
<p>To discretized with the <span class="math notranslate nohighlight">\(P^1\)</span> triangular Lagrangian finite element space <span class="math notranslate nohighlight">\(V_h\)</span> simply replace <span class="math notranslate nohighlight">\(H^1_0(\Omega)\)</span> by <span class="math notranslate nohighlight">\(V_h(\Omega_0)\cup V_h(\Omega_1)\)</span>.</p>
<p>Then difficulty is to compute <span class="math notranslate nohighlight">\(\int_{\Omega_j} \nabla u_j\cdot\nabla v\)</span> when <span class="math notranslate nohighlight">\(v\)</span> is a basis function of <span class="math notranslate nohighlight">\(V_h(\Omega_i)\)</span>, <span class="math notranslate nohighlight">\(i\ne j\)</span>.</p>
<p>It is done as follows (with <span class="math notranslate nohighlight">\(\Gamma=\partial\Omega\)</span>):</p>
<div class="last highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">Gamma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">Sigma</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">Niter</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Th</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">reg</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="kt">border</span> <span class="nf">a0</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">Gamma</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">a1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">Gamma</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">b1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">Gamma</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">c1</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">Gamma</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">c0</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">Gamma</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">b0</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">Gamma</span><span class="p">;}</span>
<span class="kt">border</span> <span class="nf">d</span><span class="p">(</span><span class="kp">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">){</span><span class="kr">x</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="kr">y</span><span class="o">=</span><span class="kp">t</span><span class="p">;</span> <span class="kr">label</span><span class="o">=</span><span class="n">Sigma</span><span class="p">;}</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">a0</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">a1</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">b1</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">c1</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">c0</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">b0</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="nf">d</span><span class="p">(</span><span class="kr">n</span><span class="p">));</span>
<span class="kt">mesh</span> <span class="n">TH</span> <span class="o">=</span> <span class="nf">buildmesh</span><span class="p">(</span><span class="n">a0</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">a1</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">b1</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">c1</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">c0</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">b0</span><span class="p">(</span><span class="kr">n</span><span class="p">)</span> <span class="o">+</span> <span class="nf">d</span><span class="p">(</span><span class="kr">n</span><span class="p">));</span>

<span class="n">reg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">TH</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">).</span><span class="kr">region</span><span class="p">;</span>
<span class="n">reg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">TH</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">).</span><span class="kr">region</span><span class="p">;</span>

<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">Th</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">trunc</span><span class="p">(</span><span class="n">TH</span><span class="p">,</span> <span class="kr">region</span><span class="o">==</span><span class="n">reg</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh0</span><span class="p">(</span><span class="n">Th</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh0</span> <span class="n">u0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">fespace</span> <span class="nf">Vh1</span><span class="p">(</span><span class="n">Th</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh1</span> <span class="n">u1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Macro</span>
<span class="kt">macro</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="c1">//</span>

<span class="c1">// Problem</span>
<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="kt">varf</span> <span class="nf">a</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">[</span><span class="n">i</span><span class="p">])(</span>
        <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">&#39;*</span><span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sigma</span><span class="p">)(</span>
        <span class="n">alpha</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">b</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">[</span><span class="n">i</span><span class="p">])(</span>
        <span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">du1dn</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=-</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">[</span><span class="mi">1</span><span class="p">])(</span>
        <span class="n">grad</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">&#39;*</span><span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Sigma</span><span class="p">)(</span>
        <span class="n">alpha</span><span class="o">*</span><span class="n">u1</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span><span class="nf">on</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">varf</span> <span class="nf">du0dn</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">=-</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span>
        <span class="n">grad</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span><span class="o">&#39;*</span><span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">f</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="nf">int1d</span><span class="p">(</span><span class="n">Th</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Sigma</span><span class="p">)(</span>
        <span class="n">alpha</span><span class="o">*</span><span class="n">u0</span><span class="o">*</span><span class="n">v</span>
    <span class="p">)</span>
    <span class="o">+</span><span class="nf">on</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">;</span>

<span class="kt">matrix</span> <span class="n">I01</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Vh1</span><span class="p">,</span> <span class="n">Vh0</span><span class="p">);</span>
<span class="kt">matrix</span> <span class="n">I10</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">Vh0</span><span class="p">,</span> <span class="n">Vh1</span><span class="p">);</span>

<span class="kt">matrix</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="kp">A</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kp">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">Vh0</span><span class="p">,</span> <span class="n">Vh0</span><span class="p">);</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="kp">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">Vh1</span><span class="p">,</span> <span class="n">Vh1</span><span class="p">);</span>

<span class="c1">// Solving loop</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="n">Niter</span><span class="p">;</span> <span class="n">iter</span><span class="o">++</span><span class="p">){</span>
    <span class="c1">// Solve on Th[0]</span>
    <span class="p">{</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b0</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh0</span><span class="p">);</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Du1dn</span> <span class="o">=</span> <span class="n">du1dn</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh1</span><span class="p">);</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Tdu1dn</span><span class="p">(</span><span class="n">Vh0</span><span class="p">.</span><span class="kr">ndof</span><span class="p">);</span> <span class="n">Tdu1dn</span> <span class="o">=</span> <span class="n">I01</span><span class="o">&#39;*</span><span class="n">Du1dn</span><span class="p">;</span>
        <span class="n">b0</span> <span class="o">+=</span> <span class="n">Tdu1dn</span><span class="p">;</span>
        <span class="n">u0</span><span class="p">[]</span> <span class="o">=</span> <span class="kp">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Solve on Th[1]</span>
    <span class="p">{</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh1</span><span class="p">);</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Du0dn</span> <span class="o">=</span> <span class="n">du0dn</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh0</span><span class="p">);</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Tdu0dn</span><span class="p">(</span><span class="n">Vh1</span><span class="p">.</span><span class="kr">ndof</span><span class="p">);</span> <span class="n">Tdu0dn</span> <span class="o">=</span> <span class="n">I10</span><span class="o">&#39;*</span><span class="n">Du0dn</span><span class="p">;</span>
        <span class="n">b1</span> <span class="o">+=</span> <span class="n">Tdu0dn</span><span class="p">;</span>
        <span class="n">u1</span><span class="p">[]</span> <span class="o">=</span> <span class="kp">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">b1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nf">plot</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;iter=&quot;</span><span class="o">+</span><span class="n">iter</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="finite-elements-connectivity">
<h2>Finite elements connectivity<a class="headerlink" href="#finite-elements-connectivity" title="Permalink to this headline">¶</a></h2>
<p>Here, we show how to get informations on a finite element space <span class="math notranslate nohighlight">\(W_h({\cal T}_n,*)\)</span>, where “*” may be <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nc">P1</span><span class="p">,</span> <span class="nc">P2</span><span class="p">,</span> <span class="nc">P1nc</span></code>, etc.</p>
<ul class="simple">
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Wh</span><span class="p">.</span><span class="kr">nt</span></code> gives the number of element of <span class="math notranslate nohighlight">\(W_h\)</span></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Wh</span><span class="p">.</span><span class="kr">ndof</span></code> gives the number of degrees of freedom or unknown</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Wh</span><span class="p">.</span><span class="kr">ndofK</span></code> gives the number of degrees of freedom on one element</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">Wh</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">)</span></code> gives the number of <span class="math notranslate nohighlight">\(i\)</span>th degrees of freedom of element <span class="math notranslate nohighlight">\(k\)</span>.</li>
</ul>
<p>See the following example:</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Finite element connectivity</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Wh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P2</span><span class="p">);</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number of degree of freedom = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Wh</span><span class="p">.</span><span class="kr">ndof</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number of degree of freedom / ELEMENT = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Wh</span><span class="p">.</span><span class="kr">ndofK</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">kdf</span> <span class="o">=</span> <span class="n">Wh</span><span class="p">.</span><span class="kr">ndofK</span><span class="p">;</span> <span class="c1">//element 2</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Degree of freedom of element &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="o">:</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kdf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="n">Wh</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>The output is:</p>
<div class="last highlight-bash notranslate"><div class="highlight"><pre><span></span>Number of degree of <span class="nv">freedom</span> <span class="o">=</span> <span class="m">121</span>
Number of degree of freedom / <span class="nv">ELEMENT</span> <span class="o">=</span> <span class="m">6</span>
Degree of freedom of element <span class="m">2</span>:
<span class="m">78</span> <span class="m">95</span> <span class="m">83</span> <span class="m">87</span> <span class="m">79</span> <span class="m">92</span>
</pre></div>
</div>
</div>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>