<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Plugins</title>
		<link rel="icon" href="../_static/img/favicon.png">

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

		<!-- FreeFem++ theme specific -->
		<link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

		<!-- css -->
		<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

		<!-- js -->
		<script src="../_static/nav.json"></script>
		<script src="../_static/js/nav.js"></script>
		<script src="../_static/js/common.js"></script>

		<!-- MathJax -->
		<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<div class="header-logo">
    <div>
        <a href="../introduction/introduction.html">
            <img alt="logo" title="FreeFem++ documentation" src="../_static/img/Logo.png" />
        </a>
    </div>
</div>
<div class="header-title">
    <div>
        <a href="../introduction/introduction.html">
            <h2>FreeFem++ documentation</h2>
        </a>
    </div>
</div>
<div class="header-github">
    <a href="https://github.com/FreeFem/FreeFem-sources">
        <div class="header-github-img">
            <img alt="GitHub" title="FreeFem++ on GitHub" src="../_static/img/GitHub-Mark-120px-plus.png" />
        </div>
        <div class="header-github-title">
            <div class="header-github-title-text">
                FreeFem++ on GitHub
            </div>
            <div class="header-github-title-stars">
                <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
            </div>
        </div>
    </a>
</div>
<script src="../_static/js/github.js"></script>
		</header>
		
		<nav>
			<script>nav("../")</script>
			<div class="search">
				<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr_index.js"></script>

<script src="../_static/js/search.js"></script>

<div class="search">
    <input type="search" id="searchInput" placeholder="Search..." oninput="search(this.value);" />
    <div class="searchResults">
        <div id="resultCount">
        </div>
        <div id="searchResults">
        </div>
    </div>
</div>
			</div>
		</nav>
		

		
		<div class="container">
			<div class="toc" id="toc">
				<div>
					<ul>
<li><a class="reference internal" href="#">Plugins</a><ul>
<li><a class="reference internal" href="#gsl">gsl</a></li>
<li><a class="reference internal" href="#ffrandom">ffrandom</a></li>
<li><a class="reference internal" href="#mmap-semaphore">mmap / semaphore</a></li>
</ul>
</li>
</ul>

				</div>
			</div>
			<div class="content">
				<div>
					
    <div class="section" id="plugins">
<h1>Plugins<a class="headerlink" href="#plugins" title="Permalink to this headline">¶</a></h1>
<div class="section" id="gsl">
<h2>gsl<a class="headerlink" href="#gsl" title="Permalink to this headline">¶</a></h2>
<p>The interface with <code class="docutils literal highlight highlight-default"><span></span><span class="n">gsl</span></code> spline is available in <strong>FreeFem++</strong>, the seven kind of spline are</p>
<ol class="arabic simple" start="0">
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">gslinterpcspline</span></code>: default type of spline</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">gslinterpakima</span></code></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">gslinterpsteffen</span></code></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">gslinterplinear</span></code></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">gslinterppolynomial</span></code></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">gslinterpcsplineperiodic</span></code></li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">gslinterpakimaperiodic</span></code></li>
</ol>
<p>A brief wing example given all the syntax:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;gsl&quot;</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="kr">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">]</span> <span class="n">dspline</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="kr">n</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//data points to define the spline</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="kr">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span> <span class="c1">//set data points</span>
   <span class="kt">real</span> <span class="n">xx</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="kr">n</span><span class="p">);</span>
   <span class="kt">real</span> <span class="n">yy</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="n">xx</span><span class="o">*</span><span class="kr">pi</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
   <span class="n">dspline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">xx</span><span class="p">;</span>
   <span class="n">dspline</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">yy</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// GSL splines</span>
<span class="kt">gslspline</span> <span class="n">spline1</span><span class="p">(</span><span class="nf">gslinterpcspline</span><span class="p">,</span> <span class="n">dspline</span><span class="p">);</span> <span class="c1">//define the spline1</span>
<span class="kt">gslspline</span> <span class="nf">spline11</span><span class="p">(</span><span class="n">dspline</span><span class="p">);</span> <span class="c1">//define the spline11</span>
<span class="kt">gslspline</span> <span class="nf">spline2</span><span class="p">(</span><span class="nf">gslinterpsteffen</span><span class="p">,</span> <span class="n">dspline</span><span class="p">);</span> <span class="c1">//define the spline2</span>
<span class="kt">gslspline</span> <span class="nf">spline3</span><span class="p">(</span><span class="nf">gslinterpcspline</span><span class="p">,</span> <span class="n">dspline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">:</span><span class="p">),</span> <span class="n">dspline</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">:</span><span class="p">));</span>
<span class="kt">gslspline</span> <span class="nf">spline33</span><span class="p">(</span><span class="n">dspline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">:</span><span class="p">),</span> <span class="n">dspline</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">:</span><span class="p">));</span> <span class="c1">//define the spline3</span>
<span class="n">spline1</span> <span class="o">=</span> <span class="n">spline2</span><span class="p">;</span> <span class="c1">//copy spline2 in spline1</span>

<span class="kt">real</span> <span class="kp">t</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">spline1</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="c1">//evaluate the function spline1 at t</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;spline1(t) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">s1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">ds1</span> <span class="o">=</span> <span class="n">spline1</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="c1">//evaluate the derivative of function spline1 at t</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;spline1.d(t) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ds1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">dds1</span> <span class="o">=</span> <span class="n">spline1</span><span class="p">.</span><span class="nf">dd</span><span class="p">(</span><span class="kp">t</span><span class="p">);</span> <span class="c1">//evaluate the second derivative of function spline1 at t</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;spline1.dd(t) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dds1</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>This can be usefull to build function from data value.</p>
<p>The list of all <code class="docutils literal highlight highlight-default"><span></span><span class="n">gsl</span></code> functions and the <strong>FreeFem++</strong> equivalent is available in the <a class="reference internal" href="../reference/externalLibraries.html#referenceffgslawk"><span class="std std-ref">Language references</span></a> (same names without <code class="docutils literal highlight highlight-default"><span></span><span class="n">_</span></code>).</p>
</div>
<div class="section" id="ffrandom">
<h2>ffrandom<a class="headerlink" href="#ffrandom" title="Permalink to this headline">¶</a></h2>
<p>Plugin to linux <code class="docutils literal highlight highlight-default"><span></span><span class="n">random</span></code> functions.</p>
<p>The range of the random generator is from <span class="math notranslate nohighlight">\(0\)</span> to <span class="math notranslate nohighlight">\((2^{31})-1\)</span>.</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;ffrandom&quot;</span>

<span class="nf">srandomdev</span><span class="p">();</span> <span class="c1">//set a true random seed</span>
<span class="c1">//warning: under window this command</span>
<span class="c1">//change the seed by randinit(random())) so all</span>
<span class="c1">//FreeFem++ random function are changed</span>

<span class="kt">int</span> <span class="n">maxrang</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; max range &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">maxrang</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="nf">random</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="nf">random</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="nf">random</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

<span class="nf">srandom</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="nf">random</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="nf">random</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="nf">random</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="mmap-semaphore">
<h2>mmap / semaphore<a class="headerlink" href="#mmap-semaphore" title="Permalink to this headline">¶</a></h2>
<p>The idea is just try to use Interprocess communication using POSIX Shared Memory in Linux.</p>
<p>We build a small library <code class="docutils literal highlight highlight-default"><span></span><span class="n">libff</span><span class="o">-</span><span class="n">mmap</span><span class="o">-</span><span class="n">semaphore</span><span class="o">.</span><span class="n">c</span></code> and <code class="docutils literal highlight highlight-default"><span></span><span class="n">libff</span><span class="o">-</span><span class="n">mmap</span><span class="o">-</span><span class="n">semaphore</span><span class="o">.</span><span class="n">h</span></code> to easily interface.</p>
<ul>
<li><p class="first">mmap - allocate memory, or map files or devices into memory</p>
</li>
<li><p class="first">semaphore - allow processes and threads to synchronize their actions</p>
<p>A semaphore is an integer whose value is never allowed to fall below zero.
Two operations can be performed on semaphores: increment the semaphore value by one (<code class="docutils literal highlight highlight-default"><span></span><span class="n">sem_post</span></code>); and decrement the semaphore value by one (<code class="docutils literal highlight highlight-default"><span></span><span class="n">sem_wait</span></code>).</p>
<p>If the value of a semaphore is currently zero, then a <code class="docutils literal highlight highlight-default"><span></span><span class="n">sem_wait</span></code> operation will block until the value becomes greater than zero.</p>
</li>
</ul>
<p><strong>The functions of library</strong></p>
<p>First the <code class="docutils literal highlight highlight-default"><span></span><span class="n">semaphore</span></code> interface to make synchronization:</p>
<ul>
<li><p class="first"><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">FF_P_sem</span> <span class="o">*</span><span class="n">ff_Psem</span><span class="p">;</span></code> the pointer to data structure</p>
</li>
<li><p class="first"><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="n">ff_Psem</span> <span class="nf">ffsem_malloc</span><span class="p">();</span></code> malloc an empty data structure</p>
</li>
<li><p class="first"><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">void</span> <span class="nf">ffsem_del</span><span class="p">(</span><span class="n">ff_Psem</span> <span class="n">sem</span><span class="p">);</span></code> clean and free the pointer</p>
</li>
<li><p class="first"><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">void</span> <span class="nf">ffsem_destroy</span><span class="p">(</span><span class="n">ff_Psem</span> <span class="n">sem</span><span class="p">);</span></code> clean, close the data structure</p>
</li>
<li><p class="first"><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">void</span> <span class="nf">ffsem_init0</span><span class="p">(</span><span class="n">ff_Psem</span> <span class="n">sem</span><span class="p">);</span></code> make a correct empty of the data structure</p>
</li>
<li><p class="first"><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">void</span> <span class="nf">ffsem_init</span><span class="p">(</span><span class="n">ff_Psem</span> <span class="n">sem</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nmm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crea</span><span class="p">);</span></code> create or use a new semaphore</p>
</li>
<li><p class="first"><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">long</span> <span class="nf">ffsem_post</span><span class="p">(</span><span class="n">ff_Psem</span> <span class="n">sem</span><span class="p">);</span></code> <code class="docutils literal highlight highlight-default"><span></span><span class="n">nlocked</span></code>, the value of the semaphore is incremented, and all threads which are waiting on the semaphore are awakened</p>
</li>
<li><p class="first"><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">long</span> <span class="nf">ffsem_wait</span><span class="p">(</span><span class="n">ff_Psem</span> <span class="n">sem</span><span class="p">);</span></code> the semaphore referenced by <code class="docutils literal highlight highlight-default"><span></span><span class="n">sem</span></code> is locked.
When calling <code class="docutils literal highlight highlight-default"><span></span><span class="n">sem_wait</span><span class="p">()</span></code>, if the semaphore’s value is zero, the calling thread will block until the lock is acquired or until the call is interrupted by a signal.</p>
<p>Alternatively, the <code class="docutils literal highlight highlight-default"><span></span><span class="n">sem_trywait</span><span class="p">()</span></code> function will fail if the semaphore is already locked, rather than blocking on the semaphore</p>
</li>
<li><p class="first"><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">long</span> <span class="nf">ffsem_trywait</span><span class="p">(</span><span class="n">ff_Psem</span> <span class="n">p</span><span class="p">);</span></code></p>
</li>
</ul>
<p>Secondly, the <code class="docutils literal highlight highlight-default"><span></span><span class="n">mmap</span></code> functions:</p>
<ul class="simple">
<li><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">FF_P_mmap</span> <span class="o">*</span><span class="n">ff_Pmmap</span><span class="p">;</span></code> the pointer to data structure</li>
<li><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="n">ff_Psem</span> <span class="nf">ffmmap_malloc</span><span class="p">();</span></code> malloc an empty data structure</li>
<li><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">void</span> <span class="nf">ffmmap_del</span><span class="p">(</span><span class="n">ff_Pmmap</span> <span class="n">p</span><span class="p">);</span></code> clean and free the pointer</li>
<li><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">void</span> <span class="nf">ffmmap_destroy</span><span class="p">(</span><span class="n">ff_Pmmap</span> <span class="n">p</span><span class="p">);</span></code> clean, close the data structure</li>
<li><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">void</span> <span class="nf">ffmmap_init0</span><span class="p">(</span><span class="n">ff_Pmmap</span> <span class="n">p</span><span class="p">);</span></code> make a correct empty of the data structure</li>
<li><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">long</span> <span class="nf">ffmmap_msync</span><span class="p">(</span><span class="n">ff_Pmmap</span> <span class="n">p</span><span class="p">,</span> <span class="kt">long</span> <span class="n">off</span><span class="p">,</span> <span class="kt">long</span> <span class="n">ln</span><span class="p">);</span></code> call writes modified whole pages back to the filesystem and updates the file modification time.
Only those pages containing <code class="docutils literal highlight highlight-default"><span></span><span class="n">addr</span></code> and <code class="docutils literal highlight highlight-default"><span></span><span class="nb">len</span><span class="o">-</span><span class="mi">1</span></code> succeeding locations will be examined.</li>
<li><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">void</span> <span class="nf">ffmmap_init</span><span class="p">(</span><span class="n">ff_Pmmap</span> <span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nmm</span><span class="p">,</span> <span class="kt">long</span> <span class="n">len</span><span class="p">);</span></code> allocate memory, or map files or devices into memory.</li>
<li><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">long</span> <span class="nf">ffmmap_read</span><span class="p">(</span><span class="n">ff_Pmmap</span> <span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">off</span><span class="p">);</span></code> read <code class="docutils literal highlight highlight-default"><span></span><span class="n">n</span></code> bytes from the <code class="docutils literal highlight highlight-default"><span></span><span class="n">mmap</span></code> at memory <code class="docutils literal highlight highlight-default"><span></span><span class="n">off</span></code> in pointer <code class="docutils literal highlight highlight-default"><span></span><span class="n">t</span></code>.</li>
<li><code class="code cpp docutils literal highlight highlight-cpp"><span></span><span class="kt">long</span> <span class="nf">ffmmap_write</span><span class="p">(</span><span class="n">ff_Pmmap</span> <span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">off</span><span class="p">);</span></code> write <code class="docutils literal highlight highlight-default"><span></span><span class="n">n</span></code> bytes to the <code class="docutils literal highlight highlight-default"><span></span><span class="n">mmap</span></code> at memory <code class="docutils literal highlight highlight-default"><span></span><span class="n">off</span></code> in pointer <code class="docutils literal highlight highlight-default"><span></span><span class="n">t</span></code>.</li>
</ul>
<p>The <strong>FreeFem++</strong> corresponding functions:</p>
<ul class="simple">
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">Pmmap</span> <span class="nf">sharedata</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span></code> new type to store the <code class="docutils literal highlight highlight-default"><span></span><span class="n">mmap</span></code> informations of name store in string <code class="docutils literal highlight highlight-default"><span></span><span class="n">filename</span></code> with 1024 is the size the <code class="docutils literal highlight highlight-default"><span></span><span class="n">sharedata</span></code> zone and file.</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="kt">Psemaphore</span> <span class="nf">smff</span><span class="p">(</span><span class="s">&quot;ff-slave&quot;</span><span class="p">,</span> <span class="n">creat</span><span class="p">);</span></code> new type to store the semaphore of name <code class="docutils literal highlight highlight-default"><span></span><span class="n">ff</span><span class="o">-</span><span class="n">slave</span></code> where <code class="docutils literal highlight highlight-default"><span></span><span class="n">creat</span></code> is a boolean to create or use a existing semaphore.</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">Wait</span><span class="p">(</span><span class="n">sem</span><span class="p">)</span></code> the semaphore referenced by <code class="docutils literal highlight highlight-default"><span></span><span class="n">sem</span></code> is locked.
When calling <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">Wait</span><span class="p">(</span><span class="n">sem</span><span class="p">)</span></code>, if the semaphore’s value is zero, the calling thread will block until the lock is acquired or until the call is interrupted by a signal.
Alternatively, the <code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">trywait</span><span class="p">(</span><span class="n">sem</span><span class="p">)</span></code> function will fail if the semaphore is already locked, rather than blocking on the semaphore.</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">Post</span><span class="p">(</span><span class="n">sem</span><span class="p">)</span></code> the semaphore referenced by <code class="docutils literal highlight highlight-default"><span></span><span class="n">sem</span></code> is unlocked, the value of the semaphore is incremented, and all threads which are waiting on the semaphore are awakened.</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">Read</span><span class="p">(</span><span class="n">sharedata</span> <span class="p">,</span><span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span></code> read the variable <code class="docutils literal highlight highlight-default"><span></span><span class="n">data</span></code> from the place <code class="docutils literal highlight highlight-default"><span></span><span class="n">offset</span></code> in <code class="docutils literal highlight highlight-default"><span></span><span class="n">sharedata</span></code> mmap.</li>
<li><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="nf">Write</span><span class="p">(</span><span class="n">sharedata</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span></code> write the variable <code class="docutils literal highlight highlight-default"><span></span><span class="n">data</span></code> at the place <code class="docutils literal highlight highlight-default"><span></span><span class="n">offset</span></code> in <code class="docutils literal highlight highlight-default"><span></span><span class="n">sharedata</span></code> mmap.</li>
</ul>
<p>The full example:</p>
<p>The <code class="docutils literal highlight highlight-default"><span></span><span class="n">FFMaster</span><span class="o">.</span><span class="n">c</span></code> file:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;libff-mmap-semaphore.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="n">ff_Psem</span> <span class="n">sem_ff</span><span class="p">,</span> <span class="n">sem_c</span><span class="p">;</span> <span class="c1">//the semaphore for mutex</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">ff_Pmmap</span> <span class="n">shd</span><span class="p">;</span>
   <span class="kt">double</span> <span class="n">cff</span><span class="p">,</span> <span class="n">rff</span><span class="p">;</span>
   <span class="kt">long</span> <span class="n">status</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
   <span class="n">ff_mmap_sem_verb</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

   <span class="n">sem_ff</span> <span class="o">=</span> <span class="n">ffsem_malloc</span><span class="p">();</span>
   <span class="n">sem_c</span> <span class="o">=</span> <span class="n">ffsem_malloc</span><span class="p">();</span>
   <span class="n">shd</span> <span class="o">=</span> <span class="n">ffmmap_malloc</span><span class="p">();</span>

   <span class="n">ffsem_init</span><span class="p">(</span><span class="n">sem_ff</span><span class="p">,</span> <span class="s">&quot;ff-slave1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
   <span class="n">ffsem_init</span><span class="p">(</span><span class="n">sem_c</span><span class="p">,</span> <span class="s">&quot;ff-master1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
   <span class="n">ffmmap_init</span><span class="p">(</span><span class="n">shd</span><span class="p">,</span> <span class="s">&quot;shared-data&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>

   <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">ffmmap_write</span><span class="p">(</span><span class="n">shd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>
   <span class="n">ffmmap_msync</span><span class="p">(</span><span class="n">shd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

   <span class="kt">char</span> <span class="n">ff</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
   <span class="n">sprintf</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="s">&quot;FreeFem++ FFSlave.edp -nw -ns -v %d&amp;&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="p">);</span>
   <span class="n">system</span><span class="p">(</span><span class="n">ff</span><span class="p">);</span> <span class="c1">//lauch FF++ in batch no graphics</span>
   <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;cc: before wait</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;cc: before wait 0 ff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="n">ffsem_wait</span><span class="p">(</span><span class="n">sem_ff</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot; iter : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
      <span class="n">cff</span> <span class="o">=</span> <span class="mi">10</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
      <span class="n">ffmmap_write</span><span class="p">(</span><span class="n">shd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cff</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
      <span class="n">ffsem_post</span><span class="p">(</span><span class="n">sem_c</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot; cc: before wait 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">ffsem_wait</span><span class="p">(</span><span class="n">sem_ff</span><span class="p">);</span>
      <span class="n">ffmmap_read</span><span class="p">(</span><span class="n">shd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rff</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot; iter = %d rff= %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rff</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//end</span>
   <span class="n">ffmmap_write</span><span class="p">(</span><span class="n">shd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>
   <span class="n">ffsem_post</span><span class="p">(</span><span class="n">sem_c</span><span class="p">);</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;End Master </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="n">ffsem_wait</span><span class="p">(</span><span class="n">sem_ff</span><span class="p">);</span>
   <span class="n">ffsem_del</span><span class="p">(</span><span class="n">sem_ff</span><span class="p">);</span>
   <span class="n">ffsem_del</span><span class="p">(</span><span class="n">sem_c</span><span class="p">);</span>
   <span class="n">ffmmap_del</span><span class="p">(</span><span class="n">shd</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal highlight highlight-default"><span></span><span class="n">FFSlave</span><span class="o">.</span><span class="n">edp</span></code> file:</p>
<div class="highlight-freefem notranslate"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;ff-mmap-semaphore&quot;</span>

<span class="kt">Psemaphore</span> <span class="n">smff</span><span class="p">(</span><span class="s">&quot;ff-slave1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="kt">Psemaphore</span> <span class="nf">smc</span><span class="p">(</span><span class="s">&quot;ff-master1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="kt">Pmmap</span> <span class="nf">sharedata</span><span class="p">(</span><span class="s">&quot;shared-data&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="kr">verbosity</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="kr">verbosity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Lab</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">];</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

<span class="c1">// Macro</span>
<span class="kt">macro</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">[</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="c1">//</span>

<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; FF status = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">status</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">cff</span><span class="p">,</span> <span class="n">rff</span><span class="p">;</span>

<span class="c1">// Problem</span>
<span class="kt">problem</span> <span class="nf">Pb</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
   <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">&#39;*</span><span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
   <span class="p">)</span>
   <span class="o">-</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
        <span class="n">cff</span><span class="o">*</span><span class="n">v</span>
   <span class="p">)</span>
   <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="n">Lab</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
   <span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="kr">verbosity</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; FF: before FF post</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="nf">Post</span><span class="p">(</span><span class="n">smff</span><span class="p">);</span> <span class="c1">//unlock master end init</span>

<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">){</span>
   <span class="k">if</span> <span class="p">(</span><span class="kr">verbosity</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; FF: before FF wait </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
   <span class="nf">Wait</span><span class="p">(</span><span class="n">smc</span><span class="p">);</span> <span class="c1">//wait from cint write ok</span>
   <span class="nf">Read</span><span class="p">(</span><span class="n">sharedata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cff</span><span class="p">);</span>
   <span class="nf">Read</span><span class="p">(</span><span class="n">sharedata</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

   <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; After wait .. FF &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">cff</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">status</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

   <span class="c1">// Solve</span>
   <span class="n">Pb</span><span class="p">;</span>
   <span class="n">rff</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">);</span>
   <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ** FF &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">cff</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rff</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

   <span class="c1">// Write</span>
   <span class="nf">Write</span><span class="p">(</span><span class="n">sharedata</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">rff</span><span class="p">);</span>
   <span class="nf">Post</span><span class="p">(</span><span class="n">smff</span><span class="p">);</span> <span class="c1">//unlock cc</span>
<span class="p">}</span>

<span class="nf">Post</span><span class="p">(</span><span class="n">smff</span><span class="p">);</span> <span class="c1">//wait from cint</span>
<span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; End FreeFem++ &quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>To test this example of coupling <code class="docutils literal highlight highlight-default"><span></span><span class="n">C</span></code> program and <strong>FreeFem++</strong> script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cc -c libff-mmap-semaphore.c
cc FFMaster.c -o FFMaster libff-mmap-semaphore.o -g -pthread
ff-c++ -auto ff-mmap-semaphore.cpp
./FFMaster
</pre></div>
</div>
<p>The output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>len <span class="m">1024</span> size <span class="m">0</span>
len <span class="m">1024</span> size <span class="m">1024</span>
FF <span class="nv">status</span> <span class="o">=</span> <span class="m">1</span>
iter : <span class="m">0</span>
After <span class="nb">wait</span> .. FF <span class="m">10</span> <span class="m">1</span>
** FF <span class="m">10</span> <span class="m">0</span>.161797
<span class="nv">iter</span> <span class="o">=</span> <span class="m">0</span> <span class="nv">rff</span><span class="o">=</span> <span class="m">0</span>.161797
iter : <span class="m">1</span>
After <span class="nb">wait</span> .. FF <span class="m">11</span> <span class="m">1</span>
** FF <span class="m">11</span> <span class="m">0</span>.195774
<span class="nv">iter</span> <span class="o">=</span> <span class="m">1</span> <span class="nv">rff</span><span class="o">=</span> <span class="m">0</span>.195774
iter : <span class="m">2</span>
After <span class="nb">wait</span> .. FF <span class="m">12</span> <span class="m">1</span>
** FF <span class="m">12</span> <span class="m">0</span>.232987
<span class="nv">iter</span> <span class="o">=</span> <span class="m">2</span> <span class="nv">rff</span><span class="o">=</span> <span class="m">0</span>.232987
iter : <span class="m">3</span>
After <span class="nb">wait</span> .. FF <span class="m">13</span> <span class="m">1</span>
** FF <span class="m">13</span> <span class="m">0</span>.273436
<span class="nv">iter</span> <span class="o">=</span> <span class="m">3</span> <span class="nv">rff</span><span class="o">=</span> <span class="m">0</span>.273436
iter : <span class="m">4</span>
After <span class="nb">wait</span> .. FF <span class="m">14</span> <span class="m">1</span>
** FF <span class="m">14</span> <span class="m">0</span>.317121
<span class="nv">iter</span> <span class="o">=</span> <span class="m">4</span> <span class="nv">rff</span><span class="o">=</span> <span class="m">0</span>.317121
iter : <span class="m">5</span>
After <span class="nb">wait</span> .. FF <span class="m">15</span> <span class="m">1</span>
** FF <span class="m">15</span> <span class="m">0</span>.364042
<span class="nv">iter</span> <span class="o">=</span> <span class="m">5</span> <span class="nv">rff</span><span class="o">=</span> <span class="m">0</span>.364042
iter : <span class="m">6</span>
After <span class="nb">wait</span> .. FF <span class="m">16</span> <span class="m">1</span>
** FF <span class="m">16</span> <span class="m">0</span>.414199
<span class="nv">iter</span> <span class="o">=</span> <span class="m">6</span> <span class="nv">rff</span><span class="o">=</span> <span class="m">0</span>.414199
iter : <span class="m">7</span>
After <span class="nb">wait</span> .. FF <span class="m">17</span> <span class="m">1</span>
** FF <span class="m">17</span> <span class="m">0</span>.467592
<span class="nv">iter</span> <span class="o">=</span> <span class="m">7</span> <span class="nv">rff</span><span class="o">=</span> <span class="m">0</span>.467592
iter : <span class="m">8</span>
After <span class="nb">wait</span> .. FF <span class="m">18</span> <span class="m">1</span>
** FF <span class="m">18</span> <span class="m">0</span>.524221
<span class="nv">iter</span> <span class="o">=</span> <span class="m">8</span> <span class="nv">rff</span><span class="o">=</span> <span class="m">0</span>.524221
iter : <span class="m">9</span>
After <span class="nb">wait</span> .. FF <span class="m">19</span> <span class="m">1</span>
** FF <span class="m">19</span> <span class="m">0</span>.584086
<span class="nv">iter</span> <span class="o">=</span> <span class="m">9</span> <span class="nv">rff</span><span class="o">=</span> <span class="m">0</span>.584086
End Master
After <span class="nb">wait</span> .. FF <span class="m">19</span> <span class="m">0</span>
</pre></div>
</div>
</div>
</div>


				</div>
			</div>
		</div>
		
		<footer>
			<script>
    let date = new Date()
    let currentYear = date.getFullYear()
</script>
<div class="footer-text">
    <a href="https://freefem.org/">FreeFem++</a> 1987-<script>document.write(currentYear)</script>
</div>
<div class="footer-img">
    <p>
        Made with <i class="fas fa-heart"></i> on
    </p>
    <span class="separator"></span>
    <a href="https://github.com/FreeFem">
        <img alt="Github" title="Github" src="../_static/img/GitHub_Logo_White.png" />
    </a>
</div>
		</footer>
		

		<script src="../_static/js/toc.js"></script>
	</body>
</html>